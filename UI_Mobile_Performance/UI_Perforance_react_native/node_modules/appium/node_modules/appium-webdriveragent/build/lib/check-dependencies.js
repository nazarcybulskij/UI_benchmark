"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.checkForDependencies = checkForDependencies;
exports.bundleWDASim = bundleWDASim;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _nodeSimctl = _interopRequireDefault(require("node-simctl"));

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _os = require("os");

var _utils = require("./utils");

var _xcodebuild = _interopRequireDefault(require("./xcodebuild"));

var _constants = require("./constants");

var _logger = _interopRequireDefault(require("./logger"));

const execLogger = {
  logNonEmptyLines(data, fn) {
    data = Buffer.isBuffer(data) ? data.toString() : data;

    for (const line of data.split(_os.EOL)) {
      if (line) {
        fn(line);
      }
    }
  },

  debug(data) {
    this.logNonEmptyLines(data, _logger.default.debug.bind(_logger.default));
  },

  error(data) {
    this.logNonEmptyLines(data, _logger.default.error.bind(_logger.default));
  }

};
const IOS = 'iOS';
const TVOS = 'tvOS';
const CARTHAGE_CMD = 'carthage';
const CARTFILE = 'Cartfile.resolved';

async function hasTvOSSims() {
  const devices = _lodash.default.flatten(Object.values((await new _nodeSimctl.default().getDevices(null, TVOS))));

  return !_lodash.default.isEmpty(devices);
}

function getCartfileLocations() {
  const cartfile = _path.default.resolve(_constants.BOOTSTRAP_PATH, CARTFILE);

  const installedCartfile = _path.default.resolve(_constants.BOOTSTRAP_PATH, _constants.CARTHAGE_ROOT, CARTFILE);

  return {
    cartfile,
    installedCartfile
  };
}

async function needsUpdate(cartfile, installedCartfile) {
  return !(await (0, _utils.fileCompare)(cartfile, installedCartfile));
}

async function fetchDependencies(useSsl = false) {
  _logger.default.info('Fetching dependencies');

  if (!(await _appiumSupport.fs.which(CARTHAGE_CMD))) {
    _logger.default.errorAndThrow('Please make sure that you have Carthage installed ' + '(https://github.com/Carthage/Carthage), and that it is ' + 'available in the PATH for the environment running Appium');
  }

  const {
    cartfile,
    installedCartfile
  } = getCartfileLocations();

  if (!(await needsUpdate(cartfile, installedCartfile))) {
    _logger.default.info('Dependencies up-to-date');

    return false;
  }

  let platforms = [IOS];

  if (await hasTvOSSims()) {
    platforms.push(TVOS);
  } else {
    _logger.default.debug('tvOS platform will not be included into Carthage bootstrap, because no Simulator devices have been created for it');
  }

  _logger.default.info(`Installing/updating dependencies for platforms ${platforms.map(p => `'${p}'`).join(', ')}`);

  let args = ['bootstrap'];

  if (useSsl) {
    args.push('--use-ssh');
  }

  args.push('--platform', platforms.join(','));

  try {
    await (0, _teen_process.exec)(CARTHAGE_CMD, args, {
      logger: execLogger,
      cwd: _constants.BOOTSTRAP_PATH
    });
  } catch (err) {
    await _appiumSupport.fs.rimraf(_path.default.resolve(_constants.BOOTSTRAP_PATH, _constants.CARTHAGE_ROOT));
    throw err;
  }

  await _appiumSupport.fs.copyFile(cartfile, installedCartfile);

  _logger.default.debug(`Finished fetching dependencies`);

  return true;
}

async function buildWDASim() {
  const args = ['-project', _constants.WDA_PROJECT, '-scheme', _constants.WDA_SCHEME, '-sdk', _constants.SDK_SIMULATOR, 'CODE_SIGN_IDENTITY=""', 'CODE_SIGNING_REQUIRED="NO"', 'GCC_TREAT_WARNINGS_AS_ERRORS=0'];
  await (0, _teen_process.exec)('xcodebuild', args);
}

async function checkForDependencies(opts = {}) {
  return await fetchDependencies(opts.useSsl);
}

async function bundleWDASim(opts) {
  const xcodebuild = new _xcodebuild.default();
  const derivedDataPath = await xcodebuild.retrieveDerivedDataPath();

  const wdaBundlePath = _path.default.join(derivedDataPath, 'Debug-iphonesimulator', _constants.WDA_RUNNER_APP);

  if (await _appiumSupport.fs.exists(wdaBundlePath)) {
    return wdaBundlePath;
  }

  await checkForDependencies(opts);
  await buildWDASim();
  return wdaBundlePath;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jaGVjay1kZXBlbmRlbmNpZXMuanMiXSwibmFtZXMiOlsiZXhlY0xvZ2dlciIsImxvZ05vbkVtcHR5TGluZXMiLCJkYXRhIiwiZm4iLCJCdWZmZXIiLCJpc0J1ZmZlciIsInRvU3RyaW5nIiwibGluZSIsInNwbGl0IiwiRU9MIiwiZGVidWciLCJsb2ciLCJiaW5kIiwiZXJyb3IiLCJJT1MiLCJUVk9TIiwiQ0FSVEhBR0VfQ01EIiwiQ0FSVEZJTEUiLCJoYXNUdk9TU2ltcyIsImRldmljZXMiLCJfIiwiZmxhdHRlbiIsIk9iamVjdCIsInZhbHVlcyIsIlNpbWN0bCIsImdldERldmljZXMiLCJpc0VtcHR5IiwiZ2V0Q2FydGZpbGVMb2NhdGlvbnMiLCJjYXJ0ZmlsZSIsInBhdGgiLCJyZXNvbHZlIiwiQk9PVFNUUkFQX1BBVEgiLCJpbnN0YWxsZWRDYXJ0ZmlsZSIsIkNBUlRIQUdFX1JPT1QiLCJuZWVkc1VwZGF0ZSIsImZldGNoRGVwZW5kZW5jaWVzIiwidXNlU3NsIiwiaW5mbyIsImZzIiwid2hpY2giLCJlcnJvckFuZFRocm93IiwicGxhdGZvcm1zIiwicHVzaCIsIm1hcCIsInAiLCJqb2luIiwiYXJncyIsImxvZ2dlciIsImN3ZCIsImVyciIsInJpbXJhZiIsImNvcHlGaWxlIiwiYnVpbGRXREFTaW0iLCJXREFfUFJPSkVDVCIsIldEQV9TQ0hFTUUiLCJTREtfU0lNVUxBVE9SIiwiY2hlY2tGb3JEZXBlbmRlbmNpZXMiLCJvcHRzIiwiYnVuZGxlV0RBU2ltIiwieGNvZGVidWlsZCIsIlhjb2RlQnVpbGQiLCJkZXJpdmVkRGF0YVBhdGgiLCJyZXRyaWV2ZURlcml2ZWREYXRhUGF0aCIsIndkYUJ1bmRsZVBhdGgiLCJXREFfUlVOTkVSX0FQUCIsImV4aXN0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBSUE7O0FBR0EsTUFBTUEsVUFBVSxHQUFH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RDs7QUFFRCxlQUFlc0IsWUFBZixDQUE2QkQsSUFBN0IsRUFBbUM7QUFDakMsUUFBTUUsVUFBVSxHQUFHLElBQUlDLG1CQUFKLEVBQW5CO0FBQ0EsUUFBTUMsZUFBZSxHQUFHLE1BQU1GLFVBQVUsQ0FBQ0csdUJBQVgsRUFBOUI7O0FBQ0EsUUFBTUMsYUFBYSxHQUFHbEMsY0FBS2dCLElBQUwsQ0FBVWdCLGVBQVYsRUFBMkIsdUJBQTNCLEVBQW9ERyx5QkFBcEQsQ0FBdEI7O0FBQ0EsTUFBSSxNQUFNMUIsa0JBQUcyQixNQUFILENBQVVGLGFBQVYsQ0FBVixFQUFvQztBQUNsQyxXQUFPQSxhQUFQO0FBQ0Q7O0FBQ0QsUUFBTVAsb0JBQW9CLENBQUNDLElBQUQsQ0FBMUI7QUFDQSxRQUFNTCxXQUFXLEVBQWpCO0FBQ0EsU0FBT1csYUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgU2ltY3RsIGZyb20gJ25vZGUtc2ltY3RsJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgRU9MIH0gZnJvbSAnb3MnO1xuaW1wb3J0IHsgZmlsZUNvbXBhcmUgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBYY29kZUJ1aWxkIGZyb20gJy4veGNvZGVidWlsZCc7XG5pbXBvcnQge1xuICBCT09UU1RSQVBfUEFUSCwgV0RBX1BST0pFQ1QsIFdEQV9TQ0hFTUUsIENBUlRIQUdFX1JPT1QsIFNES19TSU1VTEFUT1IsXG4gIFdEQV9SVU5ORVJfQVBQLFxufSBmcm9tICcuL2NvbnN0YW50cyc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcblxuXG5jb25zdCBleGVjTG9nZ2VyID0ge1xuICAvLyBsb2dnZXIgdGhhdCBnZXRzIHJpZCBvZiBlbXB0eSBsaW5lc1xuICBsb2dOb25FbXB0eUxpbmVzIChkYXRhLCBmbikge1xuICAgIGRhdGEgPSBCdWZmZXIuaXNCdWZmZXIoZGF0YSkgPyBkYXRhLnRvU3RyaW5nKCkgOiBkYXRhO1xuICAgIGZvciAoY29uc3QgbGluZSBvZiBkYXRhLnNwbGl0KEVPTCkpIHtcbiAgICAgIGlmIChsaW5lKSB7XG4gICAgICAgIGZuKGxpbmUpO1xuICAgICAgfVxuICAgIH1cbiAgfSxcbiAgZGVidWcgKGRhdGEpIHtcbiAgICB0aGlzLmxvZ05vbkVtcHR5TGluZXMoZGF0YSwgbG9nLmRlYnVnLmJpbmQobG9nKSk7XG4gIH0sXG4gIGVycm9yIChkYXRhKSB7XG4gICAgdGhpcy5sb2dOb25FbXB0eUxpbmVzKGRhdGEsIGxvZy5lcnJvci5iaW5kKGxvZykpO1xuICB9LFxufTtcblxuY29uc3QgSU9TID0gJ2lPUyc7XG5jb25zdCBUVk9TID0gJ3R2T1MnO1xuXG5jb25zdCBDQVJUSEFHRV9DTUQgPSAnY2FydGhhZ2UnO1xuY29uc3QgQ0FSVEZJTEUgPSAnQ2FydGZpbGUucmVzb2x2ZWQnO1xuXG5hc3luYyBmdW5jdGlvbiBoYXNUdk9TU2ltcyAoKSB7XG4gIGNvbnN0IGRldmljZXMgPSBfLmZsYXR0ZW4oT2JqZWN0LnZhbHVlcyhhd2FpdCBuZXcgU2ltY3RsKCkuZ2V0RGV2aWNlcyhudWxsLCBUVk9TKSkpO1xuICByZXR1cm4gIV8uaXNFbXB0eShkZXZpY2VzKTtcbn1cblxuZnVuY3Rpb24gZ2V0Q2FydGZpbGVMb2NhdGlvbnMgKCkge1xuICBjb25zdCBjYXJ0ZmlsZSA9IHBhdGgucmVzb2x2ZShCT09UU1RSQVBfUEFUSCwgQ0FSVEZJTEUpO1xuICBjb25zdCBpbnN0YWxsZWRDYXJ0ZmlsZSA9IHBhdGgucmVzb2x2ZShCT09UU1RSQVBfUEFUSCwgQ0FSVEhBR0VfUk9PVCwgQ0FSVEZJTEUpO1xuXG4gIHJldHVybiB7XG4gICAgY2FydGZpbGUsXG4gICAgaW5zdGFsbGVkQ2FydGZpbGUsXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIG5lZWRzVXBkYXRlIChjYXJ0ZmlsZSwgaW5zdGFsbGVkQ2FydGZpbGUpIHtcbiAgcmV0dXJuICFhd2FpdCBmaWxlQ29tcGFyZShjYXJ0ZmlsZSwgaW5zdGFsbGVkQ2FydGZpbGUpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmZXRjaERlcGVuZGVuY2llcyAodXNlU3NsID0gZmFsc2UpIHtcbiAgbG9nLmluZm8oJ0ZldGNoaW5nIGRlcGVuZGVuY2llcycpO1xuICBpZiAoIWF3YWl0IGZzLndoaWNoKENBUlRIQUdFX0NNRCkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdygnUGxlYXNlIG1ha2Ugc3VyZSB0aGF0IHlvdSBoYXZlIENhcnRoYWdlIGluc3RhbGxlZCAnICtcbiAgICAgICAgICAgICAgICAgICAgICAnKGh0dHBzOi8vZ2l0aHViLmNvbS9DYXJ0aGFnZS9DYXJ0aGFnZSksIGFuZCB0aGF0IGl0IGlzICcgK1xuICAgICAgICAgICAgICAgICAgICAgICdhdmFpbGFibGUgaW4gdGhlIFBBVEggZm9yIHRoZSBlbnZpcm9ubWVudCBydW5uaW5nIEFwcGl1bScpO1xuICB9XG5cbiAgLy8gY2hlY2sgdGhhdCB0aGUgZGVwZW5kZW5jaWVzIGRvIG5vdCBuZWVkIHRvIGJlIHVwZGF0ZWRcbiAgY29uc3Qge1xuICAgIGNhcnRmaWxlLFxuICAgIGluc3RhbGxlZENhcnRmaWxlLFxuICB9ID0gZ2V0Q2FydGZpbGVMb2NhdGlvbnMoKTtcblxuICBpZiAoIWF3YWl0IG5lZWRzVXBkYXRlKGNhcnRmaWxlLCBpbnN0YWxsZWRDYXJ0ZmlsZSkpIHtcbiAgICAvLyBmaWxlcyBhcmUgaWRlbnRpY2FsXG4gICAgbG9nLmluZm8oJ0RlcGVuZGVuY2llcyB1cC10by1kYXRlJyk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgbGV0IHBsYXRmb3JtcyA9IFtJT1NdO1xuICBpZiAoYXdhaXQgaGFzVHZPU1NpbXMoKSkge1xuICAgIHBsYXRmb3Jtcy5wdXNoKFRWT1MpO1xuICB9IGVsc2Uge1xuICAgIGxvZy5kZWJ1ZygndHZPUyBwbGF0Zm9ybSB3aWxsIG5vdCBiZSBpbmNsdWRlZCBpbnRvIENhcnRoYWdlIGJvb3RzdHJhcCwgYmVjYXVzZSBubyBTaW11bGF0b3IgZGV2aWNlcyBoYXZlIGJlZW4gY3JlYXRlZCBmb3IgaXQnKTtcbiAgfVxuXG4gIGxvZy5pbmZvKGBJbnN0YWxsaW5nL3VwZGF0aW5nIGRlcGVuZGVuY2llcyBmb3IgcGxhdGZvcm1zICR7cGxhdGZvcm1zLm1hcCgocCkgPT4gYCcke3B9J2ApLmpvaW4oJywgJyl9YCk7XG5cbiAgbGV0IGFyZ3MgPSBbJ2Jvb3RzdHJhcCddO1xuICBpZiAodXNlU3NsKSB7XG4gICAgYXJncy5wdXNoKCctLXVzZS1zc2gnKTtcbiAgfVxuICBhcmdzLnB1c2goJy0tcGxhdGZvcm0nLCBwbGF0Zm9ybXMuam9pbignLCcpKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKENBUlRIQUdFX0NNRCwgYXJncywge1xuICAgICAgbG9nZ2VyOiBleGVjTG9nZ2VyLFxuICAgICAgY3dkOiBCT09UU1RSQVBfUEFUSCxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gcmVtb3ZlIHRoZSBjYXJ0aGFnZSBkaXJlY3RvcnksIG9yIGVsc2Ugc3Vic2VxdWVudCBydW5zIHdpbGwgc2VlIGl0IGFuZFxuICAgIC8vIGFzc3VtZSB0aGUgZGVwZW5kZW5jaWVzIGFyZSBhbHJlYWR5IGRvd25sb2FkZWRcbiAgICBhd2FpdCBmcy5yaW1yYWYocGF0aC5yZXNvbHZlKEJPT1RTVFJBUF9QQVRILCBDQVJUSEFHRV9ST09UKSk7XG4gICAgdGhyb3cgZXJyO1xuICB9XG5cbiAgLy8gcHV0IHRoZSByZXNvbHZlZCBjYXJ0ZmlsZSBpbnRvIHRoZSBDYXJ0aGFnZSBkaXJlY3RvcnlcbiAgYXdhaXQgZnMuY29weUZpbGUoY2FydGZpbGUsIGluc3RhbGxlZENhcnRmaWxlKTtcblxuICBsb2cuZGVidWcoYEZpbmlzaGVkIGZldGNoaW5nIGRlcGVuZGVuY2llc2ApO1xuICByZXR1cm4gdHJ1ZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gYnVpbGRXREFTaW0gKCkge1xuICBjb25zdCBhcmdzID0gW1xuICAgICctcHJvamVjdCcsIFdEQV9QUk9KRUNULFxuICAgICctc2NoZW1lJywgV0RBX1NDSEVNRSxcbiAgICAnLXNkaycsIFNES19TSU1VTEFUT1IsXG4gICAgJ0NPREVfU0lHTl9JREVOVElUWT1cIlwiJyxcbiAgICAnQ09ERV9TSUdOSU5HX1JFUVVJUkVEPVwiTk9cIicsXG4gICAgJ0dDQ19UUkVBVF9XQVJOSU5HU19BU19FUlJPUlM9MCcsXG4gIF07XG4gIGF3YWl0IGV4ZWMoJ3hjb2RlYnVpbGQnLCBhcmdzKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tGb3JEZXBlbmRlbmNpZXMgKG9wdHMgPSB7fSkge1xuICByZXR1cm4gYXdhaXQgZmV0Y2hEZXBlbmRlbmNpZXMob3B0cy51c2VTc2wpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBidW5kbGVXREFTaW0gKG9wdHMpIHtcbiAgY29uc3QgeGNvZGVidWlsZCA9IG5ldyBYY29kZUJ1aWxkKCk7XG4gIGNvbnN0IGRlcml2ZWREYXRhUGF0aCA9IGF3YWl0IHhjb2RlYnVpbGQucmV0cmlldmVEZXJpdmVkRGF0YVBhdGgoKTtcbiAgY29uc3Qgd2RhQnVuZGxlUGF0aCA9IHBhdGguam9pbihkZXJpdmVkRGF0YVBhdGgsICdEZWJ1Zy1pcGhvbmVzaW11bGF0b3InLCBXREFfUlVOTkVSX0FQUCk7XG4gIGlmIChhd2FpdCBmcy5leGlzdHMod2RhQnVuZGxlUGF0aCkpIHtcbiAgICByZXR1cm4gd2RhQnVuZGxlUGF0aDtcbiAgfVxuICBhd2FpdCBjaGVja0ZvckRlcGVuZGVuY2llcyhvcHRzKTtcbiAgYXdhaXQgYnVpbGRXREFTaW0oKTtcbiAgcmV0dXJuIHdkYUJ1bmRsZVBhdGg7XG59XG5cbmV4cG9ydCB7IGNoZWNrRm9yRGVwZW5kZW5jaWVzLCBidW5kbGVXREFTaW0gfTtcbiJdLCJmaWxlIjoibGliL2NoZWNrLWRlcGVuZGVuY2llcy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
