"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _asyncbox = require("asyncbox");

const commands = {};

commands.startBootMonitor = async function startBootMonitor(opts = {}) {
  const {
    timeout = 240000,
    onWaitingDataMigration,
    onWaitingSystemApp,
    onFinished,
    onError
  } = opts;
  const udid = this.requireUdid('bootstatus');
  let status = '';
  let isBootingFinished = false;
  let error = null;
  let timeoutHandler = null;
  const bootMonitor = await this.exec('bootstatus', {
    args: [udid],
    asynchronous: true
  });
  bootMonitor.on('output', (stdout, stderr) => {
    status += stdout || stderr;

    if (stdout) {
      if (stdout.includes('Waiting on Data Migration') && onWaitingDataMigration) {
        onWaitingDataMigration();
      } else if (stdout.includes('Waiting on System App') && onWaitingSystemApp) {
        onWaitingSystemApp();
      }
    }
  });
  bootMonitor.on('exit', (code, signal) => {
    if (timeoutHandler) {
      clearTimeout(timeoutHandler);
    }

    if (code === 0) {
      if (onFinished) {
        onFinished();
      }

      isBootingFinished = true;
    } else {
      status = status || signal;
      error = new Error(status);

      if (onError) {
        onError(error);
      }
    }
  });
  await bootMonitor.start(0);

  const stopMonitor = async () => {
    if (bootMonitor.isRunning) {
      try {
        await bootMonitor.stop();
      } catch (e) {
        _logger.default.warn(e.message);
      }
    }
  };

  const timer = new _appiumSupport.timing.Timer().start();

  if (onFinished) {
    timeoutHandler = setTimeout(stopMonitor, timeout);
  } else {
    try {
      await (0, _asyncbox.waitForCondition)(() => {
        if (error) {
          throw error;
        }

        return isBootingFinished;
      }, {
        waitMs: timeout,
        intervalMs: 500
      });
    } catch (err) {
      await stopMonitor();
      throw new Error(`The simulator ${udid} has failed to finish booting after ${timer.getDuration().asSeconds.toFixed(3)}s. ` + `Original status: ${status}`);
    }
  }

  return bootMonitor;
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zdWJjb21tYW5kcy9ib290c3RhdHVzLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwic3RhcnRCb290TW9uaXRvciIsIm9wdHMiLCJ0aW1lb3V0Iiwib25XYWl0aW5nRGF0YU1pZ3JhdGlvbiIsIm9uV2FpdGluZ1N5c3RlbUFwcCIsIm9uRmluaXNoZWQiLCJvbkVycm9yIiwidWRpZCIsInJlcXVpcmVVZGlkIiwic3RhdHVzIiwiaXNCb290aW5nRmluaXNoZWQiLCJlcnJvciIsInRpbWVvdXRIYW5kbGVyIiwiYm9vdE1vbml0b3IiLCJleGVjIiwiYXJncyIsImFzeW5jaHJvbm91cyIsIm9uIiwic3Rkb3V0Iiwic3RkZXJyIiwiaW5jbHVkZXMiLCJjb2RlIiwic2lnbmFsIiwiY2xlYXJUaW1lb3V0IiwiRXJyb3IiLCJzdGFydCIsInN0b3BNb25pdG9yIiwiaXNSdW5uaW5nIiwic3RvcCIsImUiLCJsb2ciLCJ3YXJuIiwibWVzc2FnZSIsInRpbWVyIiwidGltaW5nIiwiVGltZXIiLCJzZXRUaW1lb3V0Iiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImVyciIsImdldER1cmF0aW9uIiwiYXNTZWNvbmRzIiwidG9GaXhlZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxRQUFRLEdBQUcsRUFBakI7O0FBd0JBQSxRQUFRLENBQUNDLGdCQUFULEdBQTRCLGVBQWVBLGdCQUFmLENBQWlDQyxJQUFJLEdBQUcsRUFBeEMsRUFBNEM7QUFDdEUsUUFBTTtBQUNKQyxJQUFBQSxPQUFPLEdBQUcsTUFETjtBQUVKQyxJQUFBQSxzQkFGSTtBQUdKQyxJQUFBQSxrQkFISTtBQUlKQyxJQUFBQSxVQUpJO0FBS0pDLElBQUFBO0FBTEksTUFNRkwsSUFOSjtBQU9BLFFBQU1NLElBQUksR0FBRyxLQUFLQyxXQUFMLENBQWlCLFlBQWpCLENBQWI7QUFFQSxNQUFJQyxNQUFNLEdBQUcsRUFBYjtBQUNBLE1BQUlDLGlCQUFpQixHQUFH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b20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyB0aW1pbmcgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuXG5cbmNvbnN0IGNvbW1hbmRzID0ge307XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gQm9vdE1vbml0b3JPcHRpb25zXG4gKiBAcHJvcGVydHkgez9udW1iZXJ9IHRpbWVvdXQgWzI0MDAwMF0gLSBTaW11bGF0b3IgYm9vdGluZyB0aW1lb3V0IGluIG1zLlxuICogQHByb3BlcnR5IHs/RnVuY3Rpb259IG9uV2FpdGluZ0RhdGFNaWdyYXRpb24gLSBUaGlzIGV2ZW50IGlzIGZpcmVkIHdoZW4gZGF0YSBtaWdyYXRpb24gc3RhZ2Ugc3RhcnRzLlxuICogQHByb3BlcnR5IHs/RnVuY3Rpb259IG9uV2FpdGluZ1N5c3RlbUFwcCAtIFRoaXMgZXZlbnQgaXMgZmlyZWQgd2hlbiBzeXN0ZW0gYXBwIHdhaXQgc3RhZ2Ugc3RhcnRzLlxuICogQHByb3BlcnR5IHs/RnVuY3Rpb259IG9uRmluaXNoZWQgLSBUaGlzIGV2ZW50IGlzIGZpcmVkIHdoZW4gU2ltdWxhdG9yIGlzIGZ1bGx5IGJvb3RlZC5cbiAqIEBwcm9wZXJ0eSB7P0Z1bmN0aW9ufSBvbkVycm9yIC0gVGhpcyBldmVudCBpcyBmaXJlZCB3aGVuIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBtb25pdG9yaW5nIHRoZSBib290aW5nIHByb2Nlc3NcbiAqIG9yIHdoZW4gdGhlIHRpbWVvdXQgaGFzIGV4cGlyZWQuXG4gKi9cblxuLyoqXG4gKiBTdGFydCBtb25pdG9yaW5nIGZvciBib290IHN0YXR1cyBvZiB0aGUgcGFydGljdWxhciBTaW11bGF0b3IuXG4gKiBJZiBvbkZpbmlzaGVkIHByb3BlcnR5IGlzIG5vdCBzZXQgdGhlbiB0aGUgbWV0aG9kIHdpbGwgYmxvY2tcbiAqIHVudGlsIFNpbXVsYXRvciBib290aW5nIGlzIGNvbXBsZXRlZC5cbiAqIFRoZSBtZXRob2QgaXMgb25seSBhdmFpbGFibGUgc2luY2UgWGNvZGU4LlxuICpcbiAqIEBwYXJhbSB7P0Jvb3RNb25pdG9yT3B0aW9uc30gb3B0cyAtIE1vbml0b3Jpbmcgb3B0aW9ucy5cbiAqIEByZXR1cm5zIHtTdWJQcm9jZXNzfSBUaGUgaW5zdGFuY2Ugb2YgdGhlIGNvcnJlc3BvbmRpbmcgbW9uaXRvcmluZyBwcm9jZXNzLlxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBTaW11bGF0b3IgZmFpbHMgdG8gZmluaXNoIGJvb3Rpbmcgd2l0aGluIHRoZSBnaXZlbiB0aW1lb3V0IGFuZCBvbkZpbmlzaGVkXG4gKiBwcm9wZXJ0eSBpcyBub3Qgc2V0LlxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBgdWRpZGAgaW5zdGFuY2UgcHJvcGVydHkgaXMgdW5zZXRcbiAqL1xuY29tbWFuZHMuc3RhcnRCb290TW9uaXRvciA9IGFzeW5jIGZ1bmN0aW9uIHN0YXJ0Qm9vdE1vbml0b3IgKG9wdHMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgdGltZW91dCA9IDI0MDAwMCxcbiAgICBvbldhaXRpbmdEYXRhTWlncmF0aW9uLFxuICAgIG9uV2FpdGluZ1N5c3RlbUFwcCxcbiAgICBvbkZpbmlzaGVkLFxuICAgIG9uRXJyb3IsXG4gIH0gPSBvcHRzO1xuICBjb25zdCB1ZGlkID0gdGhpcy5yZXF1aXJlVWRpZCgnYm9vdHN0YXR1cycpO1xuXG4gIGxldCBzdGF0dXMgPSAnJztcbiAgbGV0IGlzQm9vdGluZ0ZpbmlzaGVkID0gZmFsc2U7XG4gIGxldCBlcnJvciA9IG51bGw7XG4gIGxldCB0aW1lb3V0SGFuZGxlciA9IG51bGw7XG4gIGNvbnN0IGJvb3RNb25pdG9yID0gYXdhaXQgdGhpcy5leGVjKCdib290c3RhdHVzJywge1xuICAgIGFyZ3M6IFt1ZGlkXSxcbiAgICBhc3luY2hyb25vdXM6IHRydWUsXG4gIH0pO1xuICBib290TW9uaXRvci5vbignb3V0cHV0JywgKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgc3RhdHVzICs9IHN0ZG91dCB8fCBzdGRlcnI7XG4gICAgaWYgKHN0ZG91dCkge1xuICAgICAgaWYgKHN0ZG91dC5pbmNsdWRlcygnV2FpdGluZyBvbiBEYXRhIE1pZ3JhdGlvbicpICYmIG9uV2FpdGluZ0RhdGFNaWdyYXRpb24pIHtcbiAgICAgICAgb25XYWl0aW5nRGF0YU1pZ3JhdGlvbigpO1xuICAgICAgfSBlbHNlIGlmIChzdGRvdXQuaW5jbHVkZXMoJ1dhaXRpbmcgb24gU3lzdGVtIEFwcCcpICYmIG9uV2FpdGluZ1N5c3RlbUFwcCkge1xuICAgICAgICBvbldhaXRpbmdTeXN0ZW1BcHAoKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuICBib290TW9uaXRvci5vbignZXhpdCcsIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICBpZiAodGltZW91dEhhbmRsZXIpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SGFuZGxlcik7XG4gICAgfVxuICAgIGlmIChjb2RlID09PSAwKSB7XG4gICAgICBpZiAob25GaW5pc2hlZCkge1xuICAgICAgICBvbkZpbmlzaGVkKCk7XG4gICAgICB9XG4gICAgICBpc0Jvb3RpbmdGaW5pc2hlZCA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN0YXR1cyA9IHN0YXR1cyB8fCBzaWduYWw7XG4gICAgICBlcnJvciA9IG5ldyBFcnJvcihzdGF0dXMpO1xuICAgICAgaWYgKG9uRXJyb3IpIHtcbiAgICAgICAgb25FcnJvcihlcnJvcik7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbiAgYXdhaXQgYm9vdE1vbml0b3Iuc3RhcnQoMCk7XG4gIGNvbnN0IHN0b3BNb25pdG9yID0gYXN5bmMgKCkgPT4ge1xuICAgIGlmIChib290TW9uaXRvci5pc1J1bm5pbmcpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGJvb3RNb25pdG9yLnN0b3AoKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nLndhcm4oZS5tZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG4gIGNvbnN0IHRpbWVyID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG4gIGlmIChvbkZpbmlzaGVkKSB7XG4gICAgdGltZW91dEhhbmRsZXIgPSBzZXRUaW1lb3V0KHN0b3BNb25pdG9yLCB0aW1lb3V0KTtcbiAgfSBlbHNlIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbigoKSA9PiB7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpc0Jvb3RpbmdGaW5pc2hlZDtcbiAgICAgIH0sIHt3YWl0TXM6IHRpbWVvdXQsIGludGVydmFsTXM6IDUwMH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgYXdhaXQgc3RvcE1vbml0b3IoKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFRoZSBzaW11bGF0b3IgJHt1ZGlkfSBoYXMgZmFpbGVkIHRvIGZpbmlzaCBib290aW5nIGFmdGVyICR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc1NlY29uZHMudG9GaXhlZCgzKX1zLiBgICtcbiAgICAgICAgYE9yaWdpbmFsIHN0YXR1czogJHtzdGF0dXN9YCk7XG4gICAgfVxuICB9XG4gIHJldHVybiBib290TW9uaXRvcjtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sImZpbGUiOiJsaWIvc3ViY29tbWFuZHMvYm9vdHN0YXR1cy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
