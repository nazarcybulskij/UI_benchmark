"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Simctl = exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _index = _interopRequireDefault(require("./subcommands/index.js"));

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("./logger"));

var _helpers = require("./helpers");

var _teen_process = require("teen_process");

const SIMCTL_ENV_PREFIX = 'SIMCTL_CHILD_';
const DEFAULT_OPTS = {
  xcrun: {
    path: null
  },
  execTimeout: _helpers.DEFAULT_EXEC_TIMEOUT,
  logErrors: true
};

class Simctl {
  constructor(opts = {}) {
    opts = _lodash.default.cloneDeep(opts);

    _lodash.default.defaultsDeep(opts, DEFAULT_OPTS);

    for (const key of _lodash.default.keys(DEFAULT_OPTS)) {
      this[key] = opts[key];
    }

    this._udid = _lodash.default.isNil(opts.udid) ? null : opts.udid;
  }

  set udid(value) {
    this._udid = value;
  }

  get udid() {
    return this._udid;
  }

  requireUdid(commandName = null) {
    if (!this.udid) {
      throw new Error(`udid is required to be set for ` + (commandName ? `the '${commandName}' command` : 'this simctl command'));
    }

    return this.udid;
  }

  async requireXcrun() {
    if (!this.xcrun.path) {
      try {
        this.xcrun.path = await _appiumSupport.fs.which(_helpers.XCRUN_BINARY);
      } catch (e) {
        throw new Error(`${_helpers.XCRUN_BINARY} tool has not been found in PATH. ` + `Are Xcode developers tools installed?`);
      }
    }

    return this.xcrun.path;
  }

  async exec(subcommand, opts = {}) {
    let {
      args = [],
      env = {},
      asynchronous = false,
      encoding
    } = opts;
    args = ['simctl', subcommand, ...args];
    env = _lodash.default.defaults(_lodash.default.mapKeys(env, (value, key) => _lodash.default.startsWith(key, SIMCTL_ENV_PREFIX) ? key : `${SIMCTL_ENV_PREFIX}${key}`), process.env);
    const execOpts = {
      env,
      encoding
    };

    if (!asynchronous) {
      execOpts.timeout = this.execTimeout;
    }

    const xcrun = await this.requireXcrun();

    try {
      return asynchronous ? new _teen_process.SubProcess(xcrun, args, execOpts) : await (0, _teen_process.exec)(xcrun, args, execOpts);
    } catch (e) {
      if (!this.logErrors) {
        throw e;
      } else if (e.stderr) {
        const msg = `simctl error running '${subcommand}': ${e.stderr.trim()}`;

        _logger.default.debug(msg);

        throw Error(msg);
      } else {
        _logger.default.debug(e.message);

        throw e;
      }
    }
  }

}

exports.Simctl = Simctl;

for (const [fnName, fn] of _lodash.default.toPairs(_index.default)) {
  Simctl.prototype[fnName] = fn;
}

var _default = Simctl;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW1jdGwuanMiXSwibmFtZXMiOlsiU0lNQ1RMX0VOVl9QUkVGSVgiLCJERUZBVUxUX09QVFMiLCJ4Y3J1biIsInBhdGgiLCJleGVjVGltZW91dCIsIkRFRkFVTFRfRVhFQ19USU1FT1VUIiwibG9nRXJyb3JzIiwiU2ltY3RsIiwiY29uc3RydWN0b3IiLCJvcHRzIiwiXyIsImNsb25lRGVlcCIsImRlZmF1bHRzRGVlcCIsImtleSIsImtleXMiLCJfdWRpZCIsImlzTmlsIiwidWRpZCIsInZhbHVlIiwicmVxdWlyZVVkaWQiLCJjb21tYW5kTmFtZSIsIkVycm9yIiwicmVxdWlyZVhjcnVuIiwiZnMiLCJ3aGljaCIsIlhDUlVOX0JJTkFSWSIsImUiLCJleGVjIiwic3ViY29tbWFuZCIsImFyZ3MiLCJlbnYiLCJhc3luY2hyb25vdXMiLCJlbmNvZGluZyIsImRlZmF1bHRzIiwibWFwS2V5cyIsInN0YXJ0c1dpdGgiLCJwcm9jZXNzIiwiZXhlY09wdHMiLCJ0aW1lb3V0IiwiU3ViUHJvY2VzcyIsInN0ZGVyciIsIm1zZyIsInRyaW0iLCJsb2ciLCJkZWJ1ZyIsIm1lc3NhZ2UiLCJmbk5hbWUiLCJmbiIsInRvUGFpcnMiLCJzdWJjb21tYW5kcyIsInByb3RvdHlwZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFFQSxNQUFNQSxpQkFBaUIsR0FBRyxlQUExQjtBQUNBLE1BQU1DLFlBQVksR0FBRztBQUNuQkMsRUFBQUEsS0FBSyxFQUFFO0FBQ0xDLElBQUFBLElBQUksRUFBRTtBQURELEdBRFk7QUFJbkJDLEVBQUFBLFdBQVcsRUFBRUMsNkJBSk07QUFLbkJDLEVBQUFBLFNBQVMsRUFBRTtBQUxRLENBQXJCOztBQXlDQSxNQUFNQyxNQUFOLENBQWE7QUFJWEMsRUFBQUEsV0FBVyxDQUFFQyxJQUFJLEdBQUcsRUFBVCxFQUFhO0FBQ3RCQSxJQUFBQSxJQUFJLEdBQUdDLGdCQUFFQyxTQUFG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YztBQUNuQixjQUFNQyxHQUFHLEdBQUkseUJBQXdCYixVQUFXLE1BQUtGLENBQUMsQ0FBQ2MsTUFBRixDQUFTRSxJQUFULEVBQWdCLEVBQXJFOztBQUNBQyx3QkFBSUMsS0FBSixDQUFVSCxHQUFWOztBQUNBLGNBQU1wQixLQUFLLENBQUNvQixHQUFELENBQVg7QUFDRCxPQUpNLE1BSUE7QUFDTEUsd0JBQUlDLEtBQUosQ0FBVWxCLENBQUMsQ0FBQ21CLE9BQVo7O0FBQ0EsY0FBTW5CLENBQU47QUFDRDtBQUNGO0FBQ0Y7O0FBNUZVOzs7O0FBaUdiLEtBQUssTUFBTSxDQUFDb0IsTUFBRCxFQUFTQyxFQUFULENBQVgsSUFBMkJyQyxnQkFBRXNDLE9BQUYsQ0FBVUMsY0FBVixDQUEzQixFQUFtRDtBQUNqRDFDLEVBQUFBLE1BQU0sQ0FBQzJDLFNBQVAsQ0FBaUJKLE1BQWpCLElBQTJCQyxFQUEzQjtBQUNEOztlQUVjeEMsTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgc3ViY29tbWFuZHMgZnJvbSAnLi9zdWJjb21tYW5kcy9pbmRleC5qcyc7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHtcbiAgREVGQVVMVF9FWEVDX1RJTUVPVVQsIFhDUlVOX0JJTkFSWSxcbn0gZnJvbSAnLi9oZWxwZXJzJztcbmltcG9ydCB7IGV4ZWMgYXMgdHBFeGVjLCBTdWJQcm9jZXNzIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcblxuY29uc3QgU0lNQ1RMX0VOVl9QUkVGSVggPSAnU0lNQ1RMX0NISUxEXyc7XG5jb25zdCBERUZBVUxUX09QVFMgPSB7XG4gIHhjcnVuOiB7XG4gICAgcGF0aDogbnVsbCxcbiAgfSxcbiAgZXhlY1RpbWVvdXQ6IERFRkFVTFRfRVhFQ19USU1FT1VULFxuICBsb2dFcnJvcnM6IHRydWUsXG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IEV4ZWNPcHRzXG4gKiBAcHJvcGVydHkge0FycmF5LjxzdHJpbmc+fSBhcmdzIFtbXV0gLSBUaGUgbGlzdCBvZiBhZGRpdGlvbmFsIHN1YmNvbW1hbmQgYXJndW1lbnRzLlxuICogSXQncyBlbXB0eSBieSBkZWZhdWx0LlxuICogQHByb3BlcnR5IHtPYmplY3R9IGVudiBbe31dIC0gRW52aXJvbm1lbnQgdmFyaWFibGVzIG1hcHBpbmcuIEFsbCB0aGVzZSB2YXJpYWJsZXNcbiAqIHdpbGwgYmUgcGFzc2VkIFNpbXVsYXRvciBhbmQgdXNlZCBpbiB0aGUgZXhlY3V0aW5nIGZ1bmN0aW9uLlxuICogQHByb3BlcnR5IHtib29sZWFufSBsb2dFcnJvcnMgW3RydWVdIC0gU2V0IGl0IHRvIF9mYWxzZV8gdG8gdGhyb3cgZXhlY3V0aW9uIGVycm9yc1xuICogaW1tZWRpYXRlbHkgd2l0aG91dCBsb2dnaW5nIGFueSBhZGRpdGlvbmFsIGluZm9ybWF0aW9uLlxuICogQHByb3BlcnR5IHtib29sZWFufSBhc3luY2hyb25vdXMgW2ZhbHNlXSAtIFdoZXRoZXIgdG8gZXhlY3V0ZSB0aGUgZ2l2ZW4gY29tbWFuZFxuICogJ3N5bmNocm9ub3VzbHknIG9yICdhc3luY2hyb25vdXNseScuIEFmZmVjdHMgdGhlIHJldHVybmVkIHJlc3VsdCBvZiB0aGUgZnVuY3Rpb24uXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IGVuY29kaW5nIC0gRXhwbGljaXRseSBzZXRzIHN0cmVhbXMgZW5jb2RpbmcgZm9yIHRoZSBleGVjdXRlZFxuICogY29tbWFuZCBpbnB1dCBhbmQgb3V0cHV0cy5cbiAqL1xuXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU2ltY3RsT3B0c1xuICogQHByb3BlcnR5IHs/T2JqZWN0fSB4Y3J1biAtIFRoZSB4Y3J1biBwcm9wZXJ0aWVzLiBDdXJyZW50bHkgb25seSBvbmUgcHJvcGVydHlcbiAqIGlzIHN1cHBvcnRlZCwgd2hpY2ggaXMgYHBhdGhgIGFuZCBpdCBieSBkZWZhdWx0IGNvbnRhaW5zIGBudWxsYCwgd2hpY2ggZW5mb3JjZXNcbiAqIHRoZSBpbnN0YW5jZSB0byBhdXRvbWF0aWNhbGx5IGRldGVjdCB0aGUgZnVsbCBwYXRoIHRvIGB4Y3J1bmAgdG9vbCBhbmQgdG8gdGhyb3dcbiAqIGFuIGV4Y2VwdGlvbiBpZiBpdCBjYW5ub3QgYmUgZGV0ZWN0ZWQuIElmIHRoZSBwYXRoIGlzIHNldCB1cG9uIGluc3RhbmNlIGNyZWF0aW9uXG4gKiB0aGVuIGl0IGlzIGdvaW5nIHRvIGJlIHVzZWQgYnkgYGV4ZWNgIGFuZCBubyBhdXRvZGV0ZWN0aW9uIHdpbGwgaGFwcGVuLlxuICogQHByb3BlcnR5IHs/bnVtYmVyfSBleGVjVGltZW91dCBbNjAwMDAwXSAtIFRoZSBtYXhpbXVtIG51bWJlciBvZiBtaXVsbGlzZWNvbmRzXG4gKiB0byB3YWl0IGZvciBzaW5nbGUgc3luY2hyb25vdXMgeGNydW4gY29tbWFuZC5cbiAqIEBwcm9wZXJ0eSB7P2Jvb2xlYW59IGxvZ0Vycm9ycyBbdHJ1ZV0gLSBXaGV0aGVyIHRvIHdpcmUgeGNydW4gZXJyb3IgbWVzc2FnZXNcbiAqIGludG8gZGVidWcgbG9nIGJlZm9yZSB0aHJvd2luZyB0aGVtLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB1ZGlkIFtudWxsXSAtIFRoZSB1bmlxdWUgaWRlbnRpZmllciBvZiB0aGUgY3VycmVudCBkZXZpY2UsIHdoaWNoIGlzXG4gKiBnb2luZyB0byBiZSBpbXBsaWN0bHkgcGFzc2VkIHRvIGFsbCBtZXRob2RzLCB3aGljaCByZXF1aXJlIGl0LiBJdCBjYW4gZWl0aGVyIGJlIHNldFxuICogdXBvbiBpbnN0YW5jZSBjcmVhdGlvbiBpZiBpdCBpcyBhbHJlYWR5IGtub3duIGluIGRhdm5jZSBvciBsYXRlciB3aGVuL2lmIG5lZWRlZCB2aWEgdGhlXG4gKiBjb3JyZXNwb25kaW5nIGluc3RhbmNlIHNldHRlci5cbiAqL1xuXG5cbmNsYXNzIFNpbWN0bCB7XG4gIC8qKlxuICAgKiBAcGFyYW0gez9TaW1jdGxPcHRzfSBvcHRzXG4gICAqL1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgb3B0cyA9IF8uY2xvbmVEZWVwKG9wdHMpO1xuICAgIF8uZGVmYXVsdHNEZWVwKG9wdHMsIERFRkFVTFRfT1BUUyk7XG4gICAgZm9yIChjb25zdCBrZXkgb2YgXy5rZXlzKERFRkFVTFRfT1BUUykpIHtcbiAgICAgIHRoaXNba2V5XSA9IG9wdHNba2V5XTtcbiAgICB9XG4gICAgdGhpcy5fdWRpZCA9IF8uaXNOaWwob3B0cy51ZGlkKSA/IG51bGwgOiBvcHRzLnVkaWQ7XG4gIH1cblxuICBzZXQgdWRpZCAodmFsdWUpIHtcbiAgICB0aGlzLl91ZGlkID0gdmFsdWU7XG4gIH1cblxuICBnZXQgdWRpZCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3VkaWQ7XG4gIH1cblxuICByZXF1aXJlVWRpZCAoY29tbWFuZE5hbWUgPSBudWxsKSB7XG4gICAgaWYgKCF0aGlzLnVkaWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgdWRpZCBpcyByZXF1aXJlZCB0byBiZSBzZXQgZm9yIGAgK1xuICAgICAgICAoY29tbWFuZE5hbWUgPyBgdGhlICcke2NvbW1hbmROYW1lfScgY29tbWFuZGAgOiAndGhpcyBzaW1jdGwgY29tbWFuZCcpKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudWRpZDtcbiAgfVxuXG4gIGFzeW5jIHJlcXVpcmVYY3J1biAoKSB7XG4gICAgaWYgKCF0aGlzLnhjcnVuLnBhdGgpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHRoaXMueGNydW4ucGF0aCA9IGF3YWl0IGZzLndoaWNoKFhDUlVOX0JJTkFSWSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgJHtYQ1JVTl9CSU5BUll9IHRvb2wgaGFzIG5vdCBiZWVuIGZvdW5kIGluIFBBVEguIGAgK1xuICAgICAgICAgIGBBcmUgWGNvZGUgZGV2ZWxvcGVycyB0b29scyBpbnN0YWxsZWQ/YCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnhjcnVuLnBhdGg7XG4gIH1cblxuICAvKipcbiAgICogRXhlY3V0ZSB0aGUgcGFydGljdWxhciBzaW1jdGwgY29tbWFuZC5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHN1YmNvbW1hbmQgLSBPbmUgb2YgYXZhaWxhYmxlIHNpbWN0bCBzdWJjb21tYW5kcy5cbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICBFeGVjdXRlIGB4Y3J1biBzaW1jdGxgIGluIFRlcm1pbmFsIHRvIHNlZSB0aGUgZnVsbCBsaXN0XG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgb2YgYXZhaWxhYmxlIHN1YmNvbW1hbmRzLlxuICAgKiBAcGFyYW0gez9FeGVjT3B0c30gb3B0c1xuICAgKiBAcmV0dXJuIHtFeGVjUmVzdWx0fFN1YlByb2Nlc3N9IEVpdGhlciB0aGUgcmVzdWx0IG9mIHRlZW4gcHJvY2VzcydzIGBleGVjYCBvclxuICAgKiBgU3ViUHJvY2Vzc2AgaW5zdGFuY2UgZGVwZW5kaW5nIG9mIGBvcHRzLmFzeW5jaHJvbm91c2AgdmFsdWUuXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgc2ltY3RsIHN1YmNvbW1hbmQgY29tbWFuZCByZXR1cm5zIG5vbi16ZXJvIHJldHVybiBjb2RlLlxuICAgKi9cbiAgYXN5bmMgZXhlYyAoc3ViY29tbWFuZCwgb3B0cyA9IHt9KSB7XG4gICAgbGV0IHtcbiAgICAgIGFyZ3MgPSBbXSxcbiAgICAgIGVudiA9IHt9LFxuICAgICAgYXN5bmNocm9ub3VzID0gZmFsc2UsXG4gICAgICBlbmNvZGluZyxcbiAgICB9ID0gb3B0cztcbiAgICAvLyBydW4gYSBwYXJ0aWN1bGFyIHNpbWN0bCBjb21tYW5kXG4gICAgYXJncyA9IFsnc2ltY3RsJywgc3ViY29tbWFuZCwgLi4uYXJnc107XG4gICAgLy8gUHJlZml4IGFsbCBwYXNzZWQgaW4gZW52aXJvbm1lbnQgdmFyaWFibGVzIHdpdGggJ1NJTUNUTF9DSElMRF8nLCBzaW1jdGxcbiAgICAvLyB3aWxsIHRoZW4gcGFzcyB0aGVzZSB0byB0aGUgY2hpbGQgKHNwYXduZWQpIHByb2Nlc3MuXG4gICAgZW52ID0gXy5kZWZhdWx0cyhcbiAgICAgIF8ubWFwS2V5cyhlbnYsXG4gICAgICAgICh2YWx1ZSwga2V5KSA9PiBfLnN0YXJ0c1dpdGgoa2V5LCBTSU1DVExfRU5WX1BSRUZJWCkgPyBrZXkgOiBgJHtTSU1DVExfRU5WX1BSRUZJWH0ke2tleX1gKSxcbiAgICAgIHByb2Nlc3MuZW52KTtcblxuICAgIGNvbnN0IGV4ZWNPcHRzID0ge1xuICAgICAgZW52LFxuICAgICAgZW5jb2RpbmcsXG4gICAgfTtcbiAgICBpZiAoIWFzeW5jaHJvbm91cykge1xuICAgICAgZXhlY09wdHMudGltZW91dCA9IHRoaXMuZXhlY1RpbWVvdXQ7XG4gICAgfVxuICAgIGNvbnN0IHhjcnVuID0gYXdhaXQgdGhpcy5yZXF1aXJlWGNydW4oKTtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGFzeW5jaHJvbm91cyA/IG5ldyBTdWJQcm9jZXNzKHhjcnVuLCBhcmdzLCBleGVjT3B0cykgOiBhd2FpdCB0cEV4ZWMoeGNydW4sIGFyZ3MsIGV4ZWNPcHRzKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoIXRoaXMubG9nRXJyb3JzKSB7XG4gICAgICAgIC8vIGlmIHdlIGRvbid0IHdhbnQgdG8gc2VlIHRoZSBlcnJvcnMsIGp1c3QgdGhyb3cgYW5kIGFsbG93IHRoZSBjYWxsaW5nXG4gICAgICAgIC8vIGNvZGUgZG8gd2hhdCBpdCB3YW50c1xuICAgICAgICB0aHJvdyBlO1xuICAgICAgfSBlbHNlIGlmIChlLnN0ZGVycikge1xuICAgICAgICBjb25zdCBtc2cgPSBgc2ltY3RsIGVycm9yIHJ1bm5pbmcgJyR7c3ViY29tbWFuZH0nOiAke2Uuc3RkZXJyLnRyaW0oKX1gO1xuICAgICAgICBsb2cuZGVidWcobXNnKTtcbiAgICAgICAgdGhyb3cgRXJyb3IobXNnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhlLm1lc3NhZ2UpO1xuICAgICAgICB0aHJvdyBlO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5cbi8vIGFkZCBhbGwgdGhlIHN1YmNvbW1hbmRzIHRvIHRoZSBTaW1jdGwgcHJvdG90eXBlXG5mb3IgKGNvbnN0IFtmbk5hbWUsIGZuXSBvZiBfLnRvUGFpcnMoc3ViY29tbWFuZHMpKSB7XG4gIFNpbWN0bC5wcm90b3R5cGVbZm5OYW1lXSA9IGZuO1xufVxuXG5leHBvcnQgZGVmYXVsdCBTaW1jdGw7XG5leHBvcnQgeyBTaW1jdGwgfTsiXSwiZmlsZSI6ImxpYi9zaW1jdGwuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
