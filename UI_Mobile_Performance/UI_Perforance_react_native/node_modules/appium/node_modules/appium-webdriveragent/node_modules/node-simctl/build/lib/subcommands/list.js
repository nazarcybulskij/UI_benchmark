"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _helpers = require("../helpers");

var _logger = _interopRequireDefault(require("../logger"));

const commands = {};

commands.getDevicesByParsing = async function getDevicesByParsing(platform) {
  const {
    stdout
  } = await this.exec('list', {
    args: ['devices']
  });
  const deviceSectionRe = _lodash.default.isEmpty(platform) ? new RegExp(`\\-\\-\\s+(\\S+)\\s+(\\S+)\\s+\\-\\-(\\n\\s{4}.+)*`, 'mgi') : new RegExp(`\\-\\-\\s+${_lodash.default.escapeRegExp(platform)}\\s+(\\S+)\\s+\\-\\-(\\n\\s{4}.+)*`, 'mgi');
  const matches = [];
  let match;

  while (match = deviceSectionRe.exec(stdout)) {
    matches.push(match);
  }

  if (_lodash.default.isEmpty(matches)) {
    throw new Error('Could not find device section');
  }

  const lineRe = /([^\s].+) \((\w+-.+\w+)\) \((\w+\s?\w+)\)/;
  const devices = {};

  for (match of matches) {
    const sdk = platform ? match[1] : match[2];
    devices[sdk] = devices[sdk] || [];

    for (const line of match[0].split('\n').slice(1)) {
      if (line.includes('(unavailable, ')) {
        continue;
      }

      const lineMatch = lineRe.exec(line);

      if (!lineMatch) {
        throw new Error(`Could not match line: ${line}`);
      }

      devices[sdk].push({
        name: lineMatch[1],
        udid: lineMatch[2],
        state: lineMatch[3],
        sdk,
        platform: platform || match[1]
      });
    }
  }

  return devices;
};

commands.getDevices = async function getDevices(forSdk, platform) {
  let devices = {};

  try {
    const {
      stdout
    } = await this.exec('list', {
      args: ['devices', '-j']
    });
    const versionMatchRe = _lodash.default.isEmpty(platform) ? new RegExp(`^([^\\s-]+)[\\s-](\\S+)`, 'i') : new RegExp(`^${_lodash.default.escapeRegExp(platform)}[\\s-](\\S+)`, 'i');

    for (let [sdkName, entries] of _lodash.default.toPairs(JSON.parse(stdout).devices)) {
      sdkName = sdkName.replace(_helpers.SIM_RUNTIME_NAME, '');
      const versionMatch = versionMatchRe.exec(sdkName);

      if (!versionMatch) {
        continue;
      }

      const sdk = (platform ? versionMatch[1] : versionMatch[2]).replace('-', '.');
      devices[sdk] = devices[sdk] || [];
      devices[sdk].push(...entries.filter(el => _lodash.default.isUndefined(el.isAvailable) || el.isAvailable).map(el => {
        delete el.availability;
        return {
          sdk,
          ...el,
          platform: platform || versionMatch[1]
        };
      }));
    }
  } catch (err) {
    _logger.default.debug(`Unable to get JSON device list: ${err.stack}`);

    _logger.default.debug('Falling back to manual parsing');

    devices = await this.getDevicesByParsing(platform);
  }

  if (!forSdk) {
    return devices;
  }

  if (devices[forSdk]) {
    return devices[forSdk];
  }

  let errMsg = `'${forSdk}' does not exist in the list of simctl SDKs.`;

  const availableSDKs = _lodash.default.keys(devices);

  errMsg += availableSDKs.length ? ` Only the following Simulator SDK versions are available on your system: ${availableSDKs.join(', ')}` : ` No Simulator SDK versions are available on your system. Please install some via Xcode preferences.`;
  throw new Error(errMsg);
};

commands.getRuntimeForPlatformVersionViaJson = async function getRuntimeForPlatformVersionViaJson(platformVersion, platform = 'iOS') {
  const {
    stdout
  } = await this.exec('list', {
    args: ['runtimes', '--json']
  });

  for (const {
    version,
    identifier,
    name
  } of JSON.parse(stdout).runtimes) {
    if ((0, _helpers.normalizeVersion)(version) === (0, _helpers.normalizeVersion)(platformVersion) && name.toLowerCase().startsWith(platform.toLowerCase())) {
      return identifier;
    }
  }

  throw new Error(`Could not use --json flag to parse platform version`);
};

commands.getRuntimeForPlatformVersion = async function getRuntimeForPlatformVersion(platformVersion, platform = 'iOS') {
  try {
    const {
      stdout
    } = await this.exec('list', {
      args: ['runtimes']
    });
    const runtimeRe = new RegExp(`${_lodash.default.escapeRegExp(platform)}\\s+(\\d+\\.\\d+)\\s+\\((\\d+\\.\\d+\\.*\\d*)`, 'i');

    for (const line of stdout.split('\n')) {
      const match = runtimeRe.exec(line);

      if (match && match[1] === platformVersion) {
        return match[2];
      }
    }
  } catch (ign) {}

  return platformVersion;
};

commands.getDeviceTypes = async function getDeviceTypes() {
  const {
    stdout
  } = await this.exec('list', {
    args: ['devicetypes', '-j']
  });

  try {
    const deviceTypes = JSON.parse(stdout.trim());
    return deviceTypes.devicetypes.map(type => type.name);
  } catch (err) {
    throw new Error(`Unable to get list of device types: ${err.message}`);
  }
};

commands.list = async function list() {
  const {
    stdout
  } = await this.exec('list', {
    args: ['-j']
  });

  try {
    return JSON.parse(stdout.trim());
  } catch (e) {
    throw new Error(`Unable to parse simctl list: ${e.message}`);
  }
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zdWJjb21tYW5kcy9saXN0LmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiZ2V0RGV2aWNlc0J5UGFyc2luZyIsInBsYXRmb3JtIiwic3Rkb3V0IiwiZXhlYyIsImFyZ3MiLCJkZXZpY2VTZWN0aW9uUmUiLCJfIiwiaXNFbXB0eSIsIlJlZ0V4cCIsImVzY2FwZVJlZ0V4cCIsIm1hdGNoZXMiLCJtYXRjaCIsInB1c2giLCJFcnJvciIsImxpbmVSZSIsImRldmljZXMiLCJzZGsiLCJsaW5lIiwic3BsaXQiLCJzbGljZSIsImluY2x1ZGVzIiwibGluZU1hdGNoIiwibmFtZSIsInVkaWQiLCJzdGF0ZSIsImdldERldmljZXMiLCJmb3JTZGsiLCJ2ZXJzaW9uTWF0Y2hSZSIsInNka05hbWUiLCJlbnRyaWVzIiwidG9QYWlycyIsIkpTT04iLCJwYXJzZSIsInJlcGxhY2UiLCJTSU1fUlVOVElNRV9OQU1FIiwidmVyc2lvbk1hdGNoIiwiZmlsdGVyIiwiZWwiLCJpc1VuZGVmaW5lZCIsImlzQXZhaWxhYmxlIiwibWFwIiwiYXZhaWxhYmlsaXR5IiwiZXJyIiwibG9nIiwiZGVidWciLCJzdGFjayIsImVyck1zZyIsImF2YWlsYWJsZVNES3MiLCJrZXlzIiwibGVuZ3RoIiwiam9pbiIsImdldFJ1bnRpbWVGb3JQbGF0Zm9ybVZlcnNpb25WaWFKc29uIiwicGxhdGZvcm1WZXJzaW9uIiwidmVyc2lvbiIsImlkZW50aWZpZXIiLCJydW50aW1lcyIsInRvTG93ZXJDYXNlIiwic3RhcnRzV2l0aCIsImdldFJ1bnRpbWVGb3JQbGF0Zm9ybVZlcnNpb24iLCJydW50aW1lUmUiLCJpZ24iLCJnZXREZXZpY2VUeXBlcyIsImRldmljZVR5cGVzIiwidHJpbSIsImRldmljZXR5cGVzIiwidHlwZSIsIm1lc3NhZ2UiLCJsaXN0IiwiZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxRQUFRLEdBQUcsRUFBakI7O0FBcUJBQSxR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TUFBVixFQUFrQjtBQUN2Q0MsSUFBQUEsSUFBSSxFQUFFLENBQUMsYUFBRCxFQUFnQixJQUFoQjtBQURpQyxHQUFsQixDQUF2Qjs7QUFjQSxNQUFJO0FBQ0YsVUFBTTBELFdBQVcsR0FBRy9CLElBQUksQ0FBQ0MsS0FBTCxDQUFXOUIsTUFBTSxDQUFDNkQsSUFBUCxFQUFYLENBQXBCO0FBQ0EsV0FBT0QsV0FBVyxDQUFDRSxXQUFaLENBQXdCeEIsR0FBeEIsQ0FBNkJ5QixJQUFELElBQVVBLElBQUksQ0FBQzNDLElBQTNDLENBQVA7QUFDRCxHQUhELENBR0UsT0FBT29CLEdBQVAsRUFBWTtBQUNaLFVBQU0sSUFBSTdCLEtBQUosQ0FBVyx1Q0FBc0M2QixHQUFHLENBQUN3QixPQUFRLEVBQTdELENBQU47QUFDRDtBQUNGLENBckJEOztBQXlEQW5FLFFBQVEsQ0FBQ29FLElBQVQsR0FBZ0IsZUFBZUEsSUFBZixHQUF1QjtBQUNyQyxRQUFNO0FBQUNqRSxJQUFBQTtBQUFELE1BQVcsTUFBTSxLQUFLQyxJQUFMLENBQVUsTUFBVixFQUFrQjtBQUN2Q0MsSUFBQUEsSUFBSSxFQUFFLENBQUMsSUFBRDtBQURpQyxHQUFsQixDQUF2Qjs7QUFHQSxNQUFJO0FBQ0YsV0FBTzJCLElBQUksQ0FBQ0MsS0FBTCxDQUFXOUIsTUFBTSxDQUFDNkQsSUFBUCxFQUFYLENBQVA7QUFDRCxHQUZELENBRUUsT0FBT0ssQ0FBUCxFQUFVO0FBQ1YsVUFBTSxJQUFJdkQsS0FBSixDQUFXLGdDQUErQnVELENBQUMsQ0FBQ0YsT0FBUSxFQUFwRCxDQUFOO0FBQ0Q7QUFDRixDQVREOztlQVdlbkUsUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBTSU1fUlVOVElNRV9OQU1FLCBub3JtYWxpemVWZXJzaW9uIH0gZnJvbSAnLi4vaGVscGVycyc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5cblxuY29uc3QgY29tbWFuZHMgPSB7fTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBEZXZpY2VJbmZvXG4gKiBAcHJvcGVydHkge3N0cmluZ30gbmFtZSAtIFRoZSBkZXZpY2UgbmFtZS5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB1ZGlkIC0gVGhlIGRldmljZSBVRElELlxuICogQHByb3BlcnR5IHtzdHJpbmd9IHN0YXRlIC0gVGhlIGN1cnJlbnQgU2ltdWxhdG9yIHN0YXRlLCBmb3IgZXhhbXBsZSAnYm9vdGVkJyBvciAnc2h1dGRvd24nLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IHNkayAtIFRoZSBTREsgdmVyc2lvbiwgZm9yIGV4YW1wbGUgJzEwLjMnLlxuICovXG5cbi8qKlxuICogUGFyc2UgdGhlIGxpc3Qgb2YgZXhpc3RpbmcgU2ltdWxhdG9yIGRldmljZXMgdG8gcmVwcmVzZW50XG4gKiBpdCBhcyBjb252ZW5pZW50IG1hcHBpbmcuXG4gKlxuICogQHBhcmFtIHs/c3RyaW5nfSBwbGF0Zm9ybSAtIFRoZSBwbGF0Zm9ybSBuYW1lLCBmb3IgZXhhbXBsZSAnd2F0Y2hPUycuXG4gKiBAcmV0dXJuIHtPYmplY3R9IFRoZSByZXN1bHRpbmcgbWFwcGluZy4gRWFjaCBrZXkgaXMgcGxhdGZvcm0gdmVyc2lvbixcbiAqICAgICAgICAgICAgICAgICAgZm9yIGV4YW1wbGUgJzEwLjMnIGFuZCB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZSBpcyBhblxuICogICAgICAgICAgICAgICAgICBhcnJheSBvZiB0aGUgbWF0Y2hpbmcge0BsaW5rIERldmljZUluZm99IGluc3RhbmNlcy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgY29ycmVzcG9uZGluZyBzaW1jdGwgc3ViY29tbWFuZCBjb21tYW5kXG4gKiAgICAgICAgICAgICAgICAgcmV0dXJucyBub24temVybyByZXR1cm4gY29kZS5cbiAqL1xuY29tbWFuZHMuZ2V0RGV2aWNlc0J5UGFyc2luZyA9IGFzeW5jIGZ1bmN0aW9uIGdldERldmljZXNCeVBhcnNpbmcgKHBsYXRmb3JtKSB7XG4gIC8vIGdldCB0aGUgbGlzdCBvZiBkZXZpY2VzXG4gIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgdGhpcy5leGVjKCdsaXN0Jywge1xuICAgIGFyZ3M6IFsnZGV2aWNlcyddLFxuICB9KTtcblxuICAvLyBleHBlY3QgdG8gZ2V0IGEgbGlzdGluZyBsaWtlXG4gIC8vIC0tIGlPUyA4LjEgLS1cbiAgLy8gICAgIGlQaG9uZSA0cyAoM0NBNkU3REQtMjIwRS00NUU1LUI3MTYtMUU5OTJCM0E0MjlDKSAoU2h1dGRvd24pXG4gIC8vICAgICAuLi5cbiAgLy8gLS0gaU9TIDguMiAtLVxuICAvLyAgICAgaVBob25lIDRzIChBOTlGRkZDMy04RTE5LTREQ0YtQjU4NS03RDlENDZCNEMxNkUpIChTaHV0ZG93bilcbiAgLy8gICAgIC4uLlxuICAvLyBzbywgZ2V0IHRoZSBgLS0gaU9TIFguWCAtLWAgbGluZSB0byBmaW5kIHRoZSBzZGsgKFguWClcbiAgLy8gYW5kIHRoZSByZXN0IG9mIHRoZSBsaXN0aW5nIGluIG9yZGVyIHRvIGxhdGVyIGZpbmQgdGhlIGRldmljZXNcbiAgY29uc3QgZGV2aWNlU2VjdGlvblJlID0gXy5pc0VtcHR5KHBsYXRmb3JtKVxuICAgID8gbmV3IFJlZ0V4cChgXFxcXC1cXFxcLVxcXFxzKyhcXFxcUyspXFxcXHMrKFxcXFxTKylcXFxccytcXFxcLVxcXFwtKFxcXFxuXFxcXHN7NH0uKykqYCwgJ21naScpXG4gICAgOiBuZXcgUmVnRXhwKGBcXFxcLVxcXFwtXFxcXHMrJHtfLmVzY2FwZVJlZ0V4cChwbGF0Zm9ybSl9XFxcXHMrKFxcXFxTKylcXFxccytcXFxcLVxcXFwtKFxcXFxuXFxcXHN7NH0uKykqYCwgJ21naScpO1xuICBjb25zdCBtYXRjaGVzID0gW107XG4gIGxldCBtYXRjaDtcbiAgLy8gbWFrZSBhbiBlbnRyeSBmb3IgZWFjaCBzZGsgdmVyc2lvblxuICB3aGlsZSAoKG1hdGNoID0gZGV2aWNlU2VjdGlvblJlLmV4ZWMoc3Rkb3V0KSkpIHtcbiAgICBtYXRjaGVzLnB1c2gobWF0Y2gpO1xuICB9XG4gIGlmIChfLmlzRW1wdHkobWF0Y2hlcykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kIGRldmljZSBzZWN0aW9uJyk7XG4gIH1cblxuICBjb25zdCBsaW5lUmUgPSAvKFteXFxzXS4rKSBcXCgoXFx3Ky0uK1xcdyspXFwpIFxcKChcXHcrXFxzP1xcdyspXFwpLzsgLy8gaHR0cHM6Ly9yZWdleDEwMS5jb20vci9sRzdtSzYvM1xuICAvLyBnZXQgYWxsIHRoZSBkZXZpY2VzIGZvciBlYWNoIHNka1xuICBjb25zdCBkZXZpY2VzID0ge307XG4gIGZvciAobWF0Y2ggb2YgbWF0Y2hlcykge1xuICAgIGNvbnN0IHNkayA9IHBsYXRmb3JtID8gbWF0Y2hbMV0gOiBtYXRjaFsyXTtcbiAgICBkZXZpY2VzW3Nka10gPSBkZXZpY2VzW3Nka10gfHwgW107XG4gICAgLy8gc3BsaXQgdGhlIGZ1bGwgbWF0Y2ggaW50byBsaW5lcyBhbmQgcmVtb3ZlIHRoZSBmaXJzdFxuICAgIGZvciAoY29uc3QgbGluZSBvZiBtYXRjaFswXS5zcGxpdCgnXFxuJykuc2xpY2UoMSkpIHtcbiAgICAgIGlmIChsaW5lLmluY2x1ZGVzKCcodW5hdmFpbGFibGUsICcpKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgLy8gYSBsaW5lIGlzIHNvbWV0aGluZyBsaWtlXG4gICAgICAvLyAgICBpUGhvbmUgNHMgKEE5OUZGRkMzLThFMTktNERDRi1CNTg1LTdEOUQ0NkI0QzE2RSkgKFNodXRkb3duKVxuICAgICAgLy8gcmV0cmlldmU6XG4gICAgICAvLyAgIGlQaG9uZSA0c1xuICAgICAgLy8gICBBOTlGRkZDMy04RTE5LTREQ0YtQjU4NS03RDlENDZCNEMxNkVcbiAgICAgIC8vICAgU2h1dGRvd25cbiAgICAgIGNvbnN0IGxpbmVNYXRjaCA9IGxpbmVSZS5leGVjKGxpbmUpO1xuICAgICAgaWYgKCFsaW5lTWF0Y2gpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgbWF0Y2ggbGluZTogJHtsaW5lfWApO1xuICAgICAgfVxuICAgICAgLy8gc2F2ZSB0aGUgd2hvbGUgdGhpbmcgYXMgYWIgb2JqZWN0IGluIHRoZSBsaXN0IGZvciB0aGlzIHNka1xuICAgICAgZGV2aWNlc1tzZGtdLnB1c2goe1xuICAgICAgICBuYW1lOiBsaW5lTWF0Y2hbMV0sXG4gICAgICAgIHVkaWQ6IGxpbmVNYXRjaFsyXSxcbiAgICAgICAgc3RhdGU6IGxpbmVNYXRjaFszXSxcbiAgICAgICAgc2RrLFxuICAgICAgICBwbGF0Zm9ybTogcGxhdGZvcm0gfHwgbWF0Y2hbMV0sXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGRldmljZXM7XG59O1xuXG4vKipcbiAqIFBhcnNlIHRoZSBsaXN0IG9mIGV4aXN0aW5nIFNpbXVsYXRvciBkZXZpY2VzIHRvIHJlcHJlc2VudFxuICogaXQgYXMgY29udmVuaWVudCBtYXBwaW5nIGZvciB0aGUgcGFydGljdWxhciBwbGF0Zm9ybSB2ZXJzaW9uLlxuICpcbiAqIEBwYXJhbSB7P3N0cmluZ30gZm9yU2RrIC0gVGhlIHNkayB2ZXJzaW9uLFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICBmb3Igd2hpY2ggdGhlIGRldmljZXMgbGlzdCBzaG91bGQgYmUgcGFyc2VkLFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgZXhhbXBsZSAnMTAuMycuXG4gKiBAcGFyYW0gez9zdHJpbmd9IHBsYXRmb3JtIC0gVGhlIHBsYXRmb3JtIG5hbWUsIGZvciBleGFtcGxlICd3YXRjaE9TJy5cbiAqIEByZXR1cm4ge09iamVjdHxBcnJheTxEZXZpY2VJbmZvPn0gSWYgX2ZvclNka18gaXMgc2V0IHRoZW4gdGhlIGxpc3RcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2YgZGV2aWNlcyBmb3IgdGhlIHBhcnRpY3VsYXIgcGxhdGZvcm0gdmVyc2lvbi5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT3RoZXJ3aXNlIHRoZSBzYW1lIHJlc3VsdCBhcyBmb3Ige0BsaW5rIGdldERldmljZXNCeVBhcnNpbmd9XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uLlxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBjb3JyZXNwb25kaW5nIHNpbWN0bCBzdWJjb21tYW5kIGNvbW1hbmRcbiAqICAgICAgICAgICAgICAgICByZXR1cm5zIG5vbi16ZXJvIHJldHVybiBjb2RlIG9yIGlmIG5vIG1hdGNoaW5nXG4gKiAgICAgICAgICAgICAgICAgcGxhdGZvcm0gdmVyc2lvbiBpcyBmb3VuZCBpbiB0aGUgc3lzdGVtLlxuICovXG5jb21tYW5kcy5nZXREZXZpY2VzID0gYXN5bmMgZnVuY3Rpb24gZ2V0RGV2aWNlcyAoZm9yU2RrLCBwbGF0Zm9ybSkge1xuICBsZXQgZGV2aWNlcyA9IHt9O1xuICB0cnkge1xuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgdGhpcy5leGVjKCdsaXN0Jywge1xuICAgICAgYXJnczogWydkZXZpY2VzJywgJy1qJ10sXG4gICAgfSk7XG4gICAgLyogSlNPTiBzaG91bGQgYmVcbiAgICAgKiB7XG4gICAgICogICBcImRldmljZXNcIiA6IHtcbiAgICAgKiAgICAgXCJpT1MgPHNkaz5cIiA6IFsgLy8gb3JcbiAgICAgKiAgICAgXCJjb20uYXBwbGUuQ29yZVNpbXVsYXRvci5TaW1SdW50aW1lLmlPUy08c2RrPiA6IFtcbiAgICAgKiAgICAgICB7XG4gICAgICogICAgICAgICBcInN0YXRlXCIgOiBcIkJvb3RlZFwiLFxuICAgICAqICAgICAgICAgXCJhdmFpbGFiaWxpdHlcIiA6IFwiKGF2YWlsYWJsZSlcIixcbiAgICAgKiAgICAgICAgIFwiaXNBdmFpbGFibGVcIiA6IHRydWUsXG4gICAgICogICAgICAgICBcIm5hbWVcIiA6IFwiaVBob25lIDZcIixcbiAgICAgKiAgICAgICAgIFwidWRpZFwiIDogXCI3NUUzNDE0MC0xOEU4LTREMUEtOUY0NS1BQUM3MzVERjc1REZcIlxuICAgICAqICAgICAgIH1cbiAgICAgKiAgICAgXVxuICAgICAqICAgfVxuICAgICAqIH1cbiAgICAgKi9cbiAgICBjb25zdCB2ZXJzaW9uTWF0Y2hSZSA9IF8uaXNFbXB0eShwbGF0Zm9ybSlcbiAgICAgID8gbmV3IFJlZ0V4cChgXihbXlxcXFxzLV0rKVtcXFxccy1dKFxcXFxTKylgLCAnaScpXG4gICAgICA6IG5ldyBSZWdFeHAoYF4ke18uZXNjYXBlUmVnRXhwKHBsYXRmb3JtKX1bXFxcXHMtXShcXFxcUyspYCwgJ2knKTtcbiAgICBmb3IgKGxldCBbc2RrTmFtZSwgZW50cmllc10gb2YgXy50b1BhaXJzKEpTT04ucGFyc2Uoc3Rkb3V0KS5kZXZpY2VzKSkge1xuICAgICAgLy8gdGhlcmUgY291bGQgYmUgYSBsb25nZXIgbmFtZSwgc28gcmVtb3ZlIGl0XG4gICAgICBzZGtOYW1lID0gc2RrTmFtZS5yZXBsYWNlKFNJTV9SVU5USU1FX05BTUUsICcnKTtcbiAgICAgIGNvbnN0IHZlcnNpb25NYXRjaCA9IHZlcnNpb25NYXRjaFJlLmV4ZWMoc2RrTmFtZSk7XG4gICAgICBpZiAoIXZlcnNpb25NYXRjaCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgLy8gdGhlIHNkayBjYW4gaGF2ZSBkYXNoZXMgKGAxMi0yYCkgb3IgZG90cyAoYDEyLjFgKVxuICAgICAgY29uc3Qgc2RrID0gKHBsYXRmb3JtID8gdmVyc2lvbk1hdGNoWzFdIDogdmVyc2lvbk1hdGNoWzJdKS5yZXBsYWNlKCctJywgJy4nKTtcbiAgICAgIGRldmljZXNbc2RrXSA9IGRldmljZXNbc2RrXSB8fCBbXTtcbiAgICAgIGRldmljZXNbc2RrXS5wdXNoKC4uLmVudHJpZXMuZmlsdGVyKChlbCkgPT4gXy5pc1VuZGVmaW5lZChlbC5pc0F2YWlsYWJsZSkgfHwgZWwuaXNBdmFpbGFibGUpXG4gICAgICAgIC5tYXAoKGVsKSA9PiB7XG4gICAgICAgICAgZGVsZXRlIGVsLmF2YWlsYWJpbGl0eTtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc2RrLFxuICAgICAgICAgICAgLi4uZWwsXG4gICAgICAgICAgICBwbGF0Zm9ybTogcGxhdGZvcm0gfHwgdmVyc2lvbk1hdGNoWzFdLFxuICAgICAgICAgIH07XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmRlYnVnKGBVbmFibGUgdG8gZ2V0IEpTT04gZGV2aWNlIGxpc3Q6ICR7ZXJyLnN0YWNrfWApO1xuICAgIGxvZy5kZWJ1ZygnRmFsbGluZyBiYWNrIHRvIG1hbnVhbCBwYXJzaW5nJyk7XG4gICAgZGV2aWNlcyA9IGF3YWl0IHRoaXMuZ2V0RGV2aWNlc0J5UGFyc2luZyhwbGF0Zm9ybSk7XG4gIH1cblxuICBpZiAoIWZvclNkaykge1xuICAgIHJldHVybiBkZXZpY2VzO1xuICB9XG4gIC8vIGlmIGEgYGZvclNka2Agd2FzIHBhc3NlZCBpbiwgcmV0dXJuIG9ubHkgdGhlIGNvcnJlc3BvbmRpbmcgbGlzdFxuICBpZiAoZGV2aWNlc1tmb3JTZGtdKSB7XG4gICAgcmV0dXJuIGRldmljZXNbZm9yU2RrXTtcbiAgfVxuXG4gIGxldCBlcnJNc2cgPSBgJyR7Zm9yU2RrfScgZG9lcyBub3QgZXhpc3QgaW4gdGhlIGxpc3Qgb2Ygc2ltY3RsIFNES3MuYDtcbiAgY29uc3QgYXZhaWxhYmxlU0RLcyA9IF8ua2V5cyhkZXZpY2VzKTtcbiAgZXJyTXNnICs9IGF2YWlsYWJsZVNES3MubGVuZ3RoXG4gICAgPyBgIE9ubHkgdGhlIGZvbGxvd2luZyBTaW11bGF0b3IgU0RLIHZlcnNpb25zIGFyZSBhdmFpbGFibGUgb24geW91ciBzeXN0ZW06ICR7YXZhaWxhYmxlU0RLcy5qb2luKCcsICcpfWBcbiAgICA6IGAgTm8gU2ltdWxhdG9yIFNESyB2ZXJzaW9ucyBhcmUgYXZhaWxhYmxlIG9uIHlvdXIgc3lzdGVtLiBQbGVhc2UgaW5zdGFsbCBzb21lIHZpYSBYY29kZSBwcmVmZXJlbmNlcy5gO1xuICB0aHJvdyBuZXcgRXJyb3IoZXJyTXNnKTtcbn07XG5cbi8qKlxuICogR2V0IHRoZSBydW50aW1lIGZvciB0aGUgcGFydGljdWxhciBwbGF0Zm9ybSB2ZXJzaW9uIHVzaW5nIC0tanNvbiBmbGFnXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHBsYXRmb3JtVmVyc2lvbiAtIFRoZSBwbGF0Zm9ybSB2ZXJzaW9uIG5hbWUsXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGV4YW1wbGUgJzEwLjMnLlxuICogQHBhcmFtIHs/c3RyaW5nfSBwbGF0Zm9ybSAtIFRoZSBwbGF0Zm9ybSBuYW1lLCBmb3IgZXhhbXBsZSAnd2F0Y2hPUycuXG4gKiBAcmV0dXJuIHtzdHJpbmd9IFRoZSBjb3JyZXNwb25kaW5nIHJ1bnRpbWUgbmFtZSBmb3IgdGhlIGdpdmVuXG4gKiAgICAgICAgICAgICAgICAgIHBsYXRmb3JtIHZlcnNpb24uXG4gKi9cbmNvbW1hbmRzLmdldFJ1bnRpbWVGb3JQbGF0Zm9ybVZlcnNpb25WaWFKc29uID0gYXN5bmMgZnVuY3Rpb24gZ2V0UnVudGltZUZvclBsYXRmb3JtVmVyc2lvblZpYUpzb24gKFxuICBwbGF0Zm9ybVZlcnNpb24sIHBsYXRmb3JtID0gJ2lPUycpIHtcbiAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCB0aGlzLmV4ZWMoJ2xpc3QnLCB7XG4gICAgYXJnczogWydydW50aW1lcycsICctLWpzb24nXSxcbiAgfSk7XG4gIGZvciAoY29uc3Qge3ZlcnNpb24sIGlkZW50aWZpZXIsIG5hbWV9IG9mIEpTT04ucGFyc2Uoc3Rkb3V0KS5ydW50aW1lcykge1xuICAgIGlmIChub3JtYWxpemVWZXJzaW9uKHZlcnNpb24pID09PSBub3JtYWxpemVWZXJzaW9uKHBsYXRmb3JtVmVyc2lvbilcbiAgICAgICYmIG5hbWUudG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKHBsYXRmb3JtLnRvTG93ZXJDYXNlKCkpKSB7XG4gICAgICByZXR1cm4gaWRlbnRpZmllcjtcbiAgICB9XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgdXNlIC0tanNvbiBmbGFnIHRvIHBhcnNlIHBsYXRmb3JtIHZlcnNpb25gKTtcbn07XG5cbi8qKlxuICogR2V0IHRoZSBydW50aW1lIGZvciB0aGUgcGFydGljdWxhciBwbGF0Zm9ybSB2ZXJzaW9uLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBwbGF0Zm9ybVZlcnNpb24gLSBUaGUgcGxhdGZvcm0gdmVyc2lvbiBuYW1lLFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBleGFtcGxlICcxMC4zJy5cbiAqIEBwYXJhbSB7P3N0cmluZ30gcGxhdGZvcm0gLSBUaGUgcGxhdGZvcm0gbmFtZSwgZm9yIGV4YW1wbGUgJ3dhdGNoT1MnLlxuICogQHJldHVybiB7c3RyaW5nfSBUaGUgY29ycmVzcG9uZGluZyBydW50aW1lIG5hbWUgZm9yIHRoZSBnaXZlblxuICogICAgICAgICAgICAgICAgICBwbGF0Zm9ybSB2ZXJzaW9uLlxuICovXG5jb21tYW5kcy5nZXRSdW50aW1lRm9yUGxhdGZvcm1WZXJzaW9uID0gYXN5bmMgZnVuY3Rpb24gZ2V0UnVudGltZUZvclBsYXRmb3JtVmVyc2lvbiAoXG4gIHBsYXRmb3JtVmVyc2lvbiwgcGxhdGZvcm0gPSAnaU9TJykge1xuICAvLyBUcnkgd2l0aCBwYXJzaW5nXG4gIHRyeSB7XG4gICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCB0aGlzLmV4ZWMoJ2xpc3QnLCB7XG4gICAgICBhcmdzOiBbJ3J1bnRpbWVzJ10sXG4gICAgfSk7XG4gICAgLy8gaHR0cHM6Ly9yZWdleDEwMS5jb20vci9VeWtqUVovMVxuICAgIGNvbnN0IHJ1bnRpbWVSZSA9XG4gICAgICBuZXcgUmVnRXhwKGAke18uZXNjYXBlUmVnRXhwKHBsYXRmb3JtKX1cXFxccysoXFxcXGQrXFxcXC5cXFxcZCspXFxcXHMrXFxcXCgoXFxcXGQrXFxcXC5cXFxcZCtcXFxcLipcXFxcZCopYCwgJ2knKTtcbiAgICBmb3IgKGNvbnN0IGxpbmUgb2Ygc3Rkb3V0LnNwbGl0KCdcXG4nKSkge1xuICAgICAgY29uc3QgbWF0Y2ggPSBydW50aW1lUmUuZXhlYyhsaW5lKTtcbiAgICAgIGlmIChtYXRjaCAmJiBtYXRjaFsxXSA9PT0gcGxhdGZvcm1WZXJzaW9uKSB7XG4gICAgICAgIHJldHVybiBtYXRjaFsyXTtcbiAgICAgIH1cbiAgICB9XG4gIH0gY2F0Y2ggKGlnbikge31cblxuICAvLyBpZiBub3RoaW5nIHdhcyBmb3VuZCwgcGFzcyBwbGF0Zm9ybSB2ZXJzaW9uIGJhY2tcbiAgcmV0dXJuIHBsYXRmb3JtVmVyc2lvbjtcbn07XG5cbi8qKlxuICogR2V0IHRoZSBsaXN0IG9mIGRldmljZSB0eXBlcyBhdmFpbGFibGUgaW4gdGhlIGN1cnJlbnQgWGNvZGUgaW5zdGFsbGF0aW9uXG4gKlxuICogQHJldHVybiB7QXJyYXk8c3RyaW5nPn0gTGlzdCBvZiB0aGUgdHlwZXMgb2YgZGV2aWNlcyBhdmFpbGFibGVcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgY29ycmVzcG9uZGluZyBzaW1jdGwgY29tbWFuZCBmYWlsc1xuICovXG5jb21tYW5kcy5nZXREZXZpY2VUeXBlcyA9IGFzeW5jIGZ1bmN0aW9uIGdldERldmljZVR5cGVzICgpIHtcbiAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCB0aGlzLmV4ZWMoJ2xpc3QnLCB7XG4gICAgYXJnczogWydkZXZpY2V0eXBlcycsICctaiddLFxuICB9KTtcbiAgLypcbiAgICogSlNPTiB3aWxsIGJlIGxpa2U6XG4gICAqICAge1xuICAgKiAgICAgXCJkZXZpY2V0eXBlc1wiIDogW1xuICAgKiAgICAgICB7XG4gICAqICAgICAgICAgXCJuYW1lXCIgOiBcImlQaG9uZSA0c1wiLFxuICAgKiAgICAgICAgIFwiaWRlbnRpZmllclwiIDogXCJjb20uYXBwbGUuQ29yZVNpbXVsYXRvci5TaW1EZXZpY2VUeXBlLmlQaG9uZS00c1wiXG4gICAqICAgICAgIH0sXG4gICAqICAgICAgIC4uLlxuICAgKiAgIH1cbiAgICovXG4gIHRyeSB7XG4gICAgY29uc3QgZGV2aWNlVHlwZXMgPSBKU09OLnBhcnNlKHN0ZG91dC50cmltKCkpO1xuICAgIHJldHVybiBkZXZpY2VUeXBlcy5kZXZpY2V0eXBlcy5tYXAoKHR5cGUpID0+IHR5cGUubmFtZSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIGdldCBsaXN0IG9mIGRldmljZSB0eXBlczogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxufTtcblxuLyoqXG4gKiBHZXQgdGhlIGZ1bGwgbGlzdCBvZiBydW50aW1lcywgZGV2aWNldHlwZXMsIGRldmljZXMgYW5kIHBhaXJzIGFzIE9iamVjdFxuICpcbiAqIEByZXR1cm4ge09iamVjdH0gT2JqZWN0IGNvbnRhaW5pbmcgZGV2aWNlIHR5cGVzLCBydW50aW1lcyBkZXZpY2VzIGFuZCBwYWlycy5cbiAqIFRoZSByZXN1bHRpbmcgSlNPTiB3aWxsIGJlIGxpa2U6XG4gKiAgIHtcbiAqICAgICBcImRldmljZXR5cGVzXCIgOiBbXG4gKiAgICAgICB7XG4gKiAgICAgICAgIFwibmFtZVwiIDogXCJpUGhvbmUgNHNcIixcbiAqICAgICAgICAgXCJpZGVudGlmaWVyXCIgOiBcImNvbS5hcHBsZS5Db3JlU2ltdWxhdG9yLlNpbURldmljZVR5cGUuaVBob25lLTRzXCJcbiAqICAgICAgIH0sXG4gKiAgICAgICAuLi5cbiAqICAgICAgXSxcbiAqICAgICBcInJ1bnRpbWVzXCIgOiBbXG4gKiAgICAgICB7XG4gKiAgICAgICAgIFwidmVyc2lvblwiIDogJzEzLjAnLFxuICogICAgICAgICBcImJ1bmRsZVBhdGhcIiA6ICcvQXBwbGljYXRpb25zL1hjb2RlMTFiZXRhNC5hcHAvQ29udGVudHMvRGV2ZWxvcGVyL1BsYXRmb3Jtcy9pUGhvbmVPUy5wbGF0Zm9ybS9MaWJyYXJ5L0RldmVsb3Blci9Db3JlU2ltdWxhdG9yL1Byb2ZpbGVzL1J1bnRpbWVzL2lPUy5zaW1ydW50aW1lJyxcbiAqICAgICAgICAgXCJpc0F2YWlsYWJsZVwiIDogdHJ1ZSxcbiAqICAgICAgICAgXCJuYW1lXCIgOiAnaU9TIDEzLjAnLFxuICogICAgICAgICBcImlkZW50aWZpZXJcIiA6ICdjb20uYXBwbGUuQ29yZVNpbXVsYXRvci5TaW1SdW50aW1lLmlPUy0xMy0wJyxcbiAqICAgICAgICAgXCJidWlsZHZlcnNpb25cIiA6ICcxN0E1NTM0ZCdcbiAqICAgICAgIH0sXG4gKiAgICAgICAuLi5cbiAqICAgICAgfSxcbiAqICAgICBcImRldmljZXNcIiA6XG4gKiAgICAgICB7XG4gKiAgICAgICAgICdjb20uYXBwbGUuQ29yZVNpbXVsYXRvci5TaW1SdW50aW1lLmlPUy0xMy0wJzogWyBbT2JqZWN0XSwgW09iamVjdF0gXSB9LFxuICogICAgICAgICAuLi5cbiAqICAgICAgIH0sXG4gKiAgICAgXCJwYWlyc1wiIDoge30gfVxuICpcbiAqICAgfVxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBjb3JyZXNwb25kaW5nIHNpbWN0bCBjb21tYW5kIGZhaWxzXG4gKi9cbmNvbW1hbmRzLmxpc3QgPSBhc3luYyBmdW5jdGlvbiBsaXN0ICgpIHtcbiAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCB0aGlzLmV4ZWMoJ2xpc3QnLCB7XG4gICAgYXJnczogWyctaiddLFxuICB9KTtcbiAgdHJ5IHtcbiAgICByZXR1cm4gSlNPTi5wYXJzZShzdGRvdXQudHJpbSgpKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIHBhcnNlIHNpbWN0bCBsaXN0OiAke2UubWVzc2FnZX1gKTtcbiAgfVxufTtcblxuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwiZmlsZSI6ImxpYi9zdWJjb21tYW5kcy9saXN0LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
