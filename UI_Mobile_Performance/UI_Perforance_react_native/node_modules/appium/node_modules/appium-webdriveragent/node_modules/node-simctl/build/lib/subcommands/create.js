"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("../logger"));

var _asyncbox = require("asyncbox");

var _helpers = require("../helpers");

const SIM_RUNTIME_NAME_SUFFIX_IOS = 'iOS';
const DEFAULT_CREATE_SIMULATOR_TIMEOUT = 10000;
const commands = {};

commands.createDevice = async function createDevice(name, deviceTypeId, platformVersion, opts = {}) {
  const {
    platform = SIM_RUNTIME_NAME_SUFFIX_IOS,
    timeout = DEFAULT_CREATE_SIMULATOR_TIMEOUT
  } = opts;
  let runtimeIds = [];

  try {
    runtimeIds.push((await this.getRuntimeForPlatformVersionViaJson(platformVersion, platform)));
  } catch (ign) {}

  if (_lodash.default.isEmpty(runtimeIds)) {
    let runtimeId;

    try {
      runtimeId = await this.getRuntimeForPlatformVersion(platformVersion, platform);
    } catch (err) {
      _logger.default.warn(`Unable to find runtime for iOS '${platformVersion}'. Continuing`);

      runtimeId = platformVersion;
    }

    let potentialRuntimeIds = [(0, _helpers.normalizeVersion)(runtimeId)];

    if (runtimeId.split('.').length === 3) {
      potentialRuntimeIds.push(runtimeId);
    }

    runtimeIds.push(...potentialRuntimeIds.map(id => `${_helpers.SIM_RUNTIME_NAME}${platform}-${id.replace(/\./g, '-')}`), ...potentialRuntimeIds);
  }

  let udid;

  for (const runtimeId of runtimeIds) {
    _logger.default.debug(`Creating simulator with name '${name}', device type id '${deviceTypeId}' and runtime id '${runtimeId}'`);

    try {
      const {
        stdout
      } = await this.exec('create', {
        args: [name, deviceTypeId, runtimeId]
      });
      udid = stdout.trim();
      break;
    } catch (ign) {}
  }

  if (!udid) {
    throw new Error(`Could not create simulator with name '${name}', device ` + `type id '${deviceTypeId}', with runtime ids ` + `${runtimeIds.map(id => `'${id}'`).join(', ')}`);
  }

  const retries = parseInt(timeout / 1000, 10);
  await (0, _asyncbox.retryInterval)(retries, 1000, async () => {
    const devices = _lodash.default.values((await this.getDevices()));

    for (const deviceArr of _lodash.default.values(devices)) {
      for (const device of deviceArr) {
        if (device.udid === udid) {
          if (device.state === 'Creating') {
            throw new Error(`Device with udid '${udid}' still being created`);
          } else {
            return;
          }
        }
      }
    }

    throw new Error(`Device with udid '${udid}' not yet created`);
  });
  return udid;
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zdWJjb21tYW5kcy9jcmVhdGUuanMiXSwibmFtZXMiOlsiU0lNX1JVTlRJTUVfTkFNRV9TVUZGSVhfSU9TIiwiREVGQVVMVF9DUkVBVEVfU0lNVUxBVE9SX1RJTUVPVVQiLCJjb21tYW5kcyIsImNyZWF0ZURldmljZSIsIm5hbWUiLCJkZXZpY2VUeXBlSWQiLCJwbGF0Zm9ybVZlcnNpb24iLCJvcHRzIiwicGxhdGZvcm0iLCJ0aW1lb3V0IiwicnVudGltZUlkcyIsInB1c2giLCJnZXRSdW50aW1lRm9yUGxhdGZvcm1WZXJzaW9uVmlhSnNvbiIsImlnbiIsIl8iLCJpc0VtcHR5IiwicnVudGltZUlkIiwiZ2V0UnVudGltZUZvclBsYXRmb3JtVmVyc2lvbiIsImVyciIsImxvZyIsIndhcm4iLCJwb3RlbnRpYWxSdW50aW1lSWRzIiwic3BsaXQiLCJsZW5ndGgiLCJtYXAiLCJpZCIsIlNJTV9SVU5USU1FX05BTUUiLCJyZXBsYWNlIiwidWRpZCIsImRlYnVnIiwic3Rkb3V0IiwiZXhlYyIsImFyZ3MiLCJ0cmltIiwiRXJyb3IiLCJqb2luIiwicmV0cmllcyIsInBhcnNlSW50IiwiZGV2aWNlcyIsInZhbHVlcyIsImdldERldmljZXMiLCJkZXZpY2VBcnIiLCJkZXZpY2UiLCJzdGF0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSwyQkFBMkIsR0FBRyxLQUFwQztBQUNBLE1BQU1DLGdDQUFnQyxHQUFHLEtBQXpDO0FBRUEsTUFBTUMsUUFBUSxHQUFHLEVBQWpCOztBQXFCQUEsUUFBUSxDQUFDQyxZQUFULEdBQXdCLGVBQWVBLFlBQWYsQ0FBNkJDLElBQTdCLEVBQW1DQyxZQUFuQyxFQUFpREMsZUFBakQsRUFBa0VDLElBQUksR0FBRyxFQUF6RSxFQUE2RTtBQUNuRyxRQUFNO0FBQ0pDLElBQUFBLFFBQVEsR0FBR1IsMkJBRFA7QUFFSlMsSUFBQUEsT0FBTyxHQUFHUjtBQUZOLE1BR0ZNLElB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QUVMO0FBQ0Q7QUFDRjtBQUNGO0FBQ0Y7O0FBQ0QsVUFBTSxJQUFJTSxLQUFKLENBQVcscUJBQW9CTixJQUFLLG1CQUFwQyxDQUFOO0FBQ0QsR0FoQkssQ0FBTjtBQWtCQSxTQUFPQSxJQUFQO0FBQ0QsQ0FuRkQ7O2VBcUZlMUIsUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgU0lNX1JVTlRJTUVfTkFNRSwgbm9ybWFsaXplVmVyc2lvbiB9IGZyb20gJy4uL2hlbHBlcnMnO1xuXG5cbmNvbnN0IFNJTV9SVU5USU1FX05BTUVfU1VGRklYX0lPUyA9ICdpT1MnO1xuY29uc3QgREVGQVVMVF9DUkVBVEVfU0lNVUxBVE9SX1RJTUVPVVQgPSAxMDAwMDtcblxuY29uc3QgY29tbWFuZHMgPSB7fTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTaW1DcmVhdGlvbk9wdHNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBwbGF0Zm9ybSBbaU9TXSAtIFBsYXRmb3JtIG5hbWUgaW4gb3JkZXIgdG8gc3BlY2lmeSBydW50aW1lIHN1Y2ggYXMgJ2lPUycsICd0dk9TJywgJ3dhdGNoT1MnXG4gKiBAcHJvcGVydHkge251bWJlcn0gdGltZW91dCBbMTAwMDBdIC0gVGhlIG1heGltdW0gbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5pdCBkZXZpY2UgY3JlYXRpb24gaXMgY29tcGxldGVkLlxuICovXG5cbi8qKlxuICogQ3JlYXRlIFNpbXVsYXRvciBkZXZpY2Ugd2l0aCBnaXZlbiBuYW1lIGZvciB0aGUgcGFydGljdWxhclxuICogcGxhdGZvcm0gdHlwZSBhbmQgdmVyc2lvbi5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBkZXZpY2UgbmFtZSB0byBiZSBjcmVhdGVkLlxuICogQHBhcmFtIHtzdHJpbmd9IGRldmljZVR5cGVJZCAtIERldmljZSB0eXBlLCBmb3IgZXhhbXBsZSAnaVBob25lIDYnLlxuICogQHBhcmFtIHtzdHJpbmd9IHBsYXRmb3JtVmVyc2lvbiAtIFBsYXRmb3JtIHZlcnNpb24sIGZvciBleGFtcGxlICcxMC4zJy5cbiAqIEBwYXJhbSB7P1NpbUNyZWF0aW9uT3B0c30gb3B0cyAtIFNpbXVsYXRvciBvcHRpb25zIGZvciBjcmVhdGluZyBkZXZpY2VzLlxuICogQHJldHVybiB7c3RyaW5nfSBUaGUgVURJRCBvZiB0aGUgbmV3bHkgY3JlYXRlZCBkZXZpY2UuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIGNvcnJlc3BvbmRpbmcgc2ltY3RsIHN1YmNvbW1hbmQgY29tbWFuZFxuICogICAgICAgICAgICAgICAgIHJldHVybnMgbm9uLXplcm8gcmV0dXJuIGNvZGUuXG4gKi9cbmNvbW1hbmRzLmNyZWF0ZURldmljZSA9IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZURldmljZSAobmFtZSwgZGV2aWNlVHlwZUlkLCBwbGF0Zm9ybVZlcnNpb24sIG9wdHMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgcGxhdGZvcm0gPSBTSU1fUlVOVElNRV9OQU1FX1NVRkZJWF9JT1MsXG4gICAgdGltZW91dCA9IERFRkFVTFRfQ1JFQVRFX1NJTVVMQVRPUl9USU1FT1VUXG4gIH0gPSBvcHRzO1xuXG4gIGxldCBydW50aW1lSWRzID0gW107XG5cbiAgLy8gVHJ5IGdldHRpbmcgcnVudGltZUlkIHVzaW5nIEpTT04gZmxhZ1xuICB0cnkge1xuICAgIHJ1bnRpbWVJZHMucHVzaChhd2FpdCB0aGlzLmdldFJ1bnRpbWVGb3JQbGF0Zm9ybVZlcnNpb25WaWFKc29uKHBsYXRmb3JtVmVyc2lvbiwgcGxhdGZvcm0pKTtcbiAgfSBjYXRjaCAoaWduKSB7fVxuXG4gIGlmIChfLmlzRW1wdHkocnVudGltZUlkcykpIHtcbiAgICAvLyBhdCBmaXJzdCBtYWtlIHN1cmUgdGhhdCB0aGUgcnVudGltZSBpZCBpcyB0aGUgcmlnaHQgb25lXG4gICAgLy8gaW4gc29tZSB2ZXJzaW9ucyBvZiBYY29kZSBpdCB3aWxsIGJlIGEgcGF0Y2ggdmVyc2lvblxuICAgIGxldCBydW50aW1lSWQ7XG4gICAgdHJ5IHtcbiAgICAgIHJ1bnRpbWVJZCA9IGF3YWl0IHRoaXMuZ2V0UnVudGltZUZvclBsYXRmb3JtVmVyc2lvbihwbGF0Zm9ybVZlcnNpb24sIHBsYXRmb3JtKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGBVbmFibGUgdG8gZmluZCBydW50aW1lIGZvciBpT1MgJyR7cGxhdGZvcm1WZXJzaW9ufScuIENvbnRpbnVpbmdgKTtcbiAgICAgIHJ1bnRpbWVJZCA9IHBsYXRmb3JtVmVyc2lvbjtcbiAgICB9XG5cbiAgICAvLyBnZXQgdGhlIHBvc3NpYmxlIHJ1bnRpbWVzLCB3aGljaCB3aWxsIGJlIGl0ZXJhdGVkIG92ZXJcblxuICAgIC8vIHN0YXJ0IHdpdGggbWFqb3ItbWlub3IgdmVyc2lvblxuICAgIGxldCBwb3RlbnRpYWxSdW50aW1lSWRzID0gW25vcm1hbGl6ZVZlcnNpb24ocnVudGltZUlkKV07XG4gICAgaWYgKHJ1bnRpbWVJZC5zcGxpdCgnLicpLmxlbmd0aCA9PT0gMykge1xuICAgICAgLy8gYWRkIHBhdGNoIHZlcnNpb24gaWYgaXQgZXhpc3RzXG4gICAgICBwb3RlbnRpYWxSdW50aW1lSWRzLnB1c2gocnVudGltZUlkKTtcbiAgICB9XG5cbiAgICAvLyBhZGQgbW9kaWZpZWQgdmVyc2lvbnMsIHNpbmNlIG1vZGVybiBYY29kZXMgdXNlIHRoaXMsIHRoZW4gdGhlIGJhcmVcbiAgICAvLyB2ZXJzaW9ucywgdG8gYWNjb21vZGF0ZSBvbGRlciBYY29kZXNcbiAgICBydW50aW1lSWRzLnB1c2goXG4gICAgICAuLi4ocG90ZW50aWFsUnVudGltZUlkcy5tYXAoKGlkKSA9PiBgJHtTSU1fUlVOVElNRV9OQU1FfSR7cGxhdGZvcm19LSR7aWQucmVwbGFjZSgvXFwuL2csICctJyl9YCkpLFxuICAgICAgLi4ucG90ZW50aWFsUnVudGltZUlkc1xuICAgICk7XG4gIH1cblxuICAvLyBnbyB0aHJvdWdoIHRoZSBydW50aW1lIGlkcyBhbmQgdHJ5IHRvIGNyZWF0ZSBhIHNpbXVsYXRvciB3aXRoIGVhY2hcbiAgbGV0IHVkaWQ7XG4gIGZvciAoY29uc3QgcnVudGltZUlkIG9mIHJ1bnRpbWVJZHMpIHtcbiAgICBsb2cuZGVidWcoYENyZWF0aW5nIHNpbXVsYXRvciB3aXRoIG5hbWUgJyR7bmFtZX0nLCBkZXZpY2UgdHlwZSBpZCAnJHtkZXZpY2VUeXBlSWR9JyBhbmQgcnVudGltZSBpZCAnJHtydW50aW1lSWR9J2ApO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IHRoaXMuZXhlYygnY3JlYXRlJywge1xuICAgICAgICBhcmdzOiBbbmFtZSwgZGV2aWNlVHlwZUlkLCBydW50aW1lSWRdXG4gICAgICB9KTtcbiAgICAgIHVkaWQgPSBzdGRvdXQudHJpbSgpO1xuICAgICAgYnJlYWs7XG4gICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAvLyB0aGUgZXJyb3IgZ2V0cyBsb2dnZWQgaW4gYHNpbUV4ZWNgXG4gICAgfVxuICB9XG5cbiAgaWYgKCF1ZGlkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgY3JlYXRlIHNpbXVsYXRvciB3aXRoIG5hbWUgJyR7bmFtZX0nLCBkZXZpY2UgYCArXG4gICAgICBgdHlwZSBpZCAnJHtkZXZpY2VUeXBlSWR9Jywgd2l0aCBydW50aW1lIGlkcyBgICtcbiAgICAgIGAke3J1bnRpbWVJZHMubWFwKChpZCkgPT4gYCcke2lkfSdgKS5qb2luKCcsICcpfWApO1xuICB9XG5cbiAgLy8gbWFrZSBzdXJlIHRoYXQgaXQgZ2V0cyBvdXQgb2YgdGhlIFwiQ3JlYXRpbmdcIiBzdGF0ZVxuICBjb25zdCByZXRyaWVzID0gcGFyc2VJbnQodGltZW91dCAvIDEwMDAsIDEwKTtcbiAgYXdhaXQgcmV0cnlJbnRlcnZhbChyZXRyaWVzLCAxMDAwLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgZGV2aWNlcyA9IF8udmFsdWVzKGF3YWl0IHRoaXMuZ2V0RGV2aWNlcygpKTtcbiAgICBmb3IgKGNvbnN0IGRldmljZUFyciBvZiBfLnZhbHVlcyhkZXZpY2VzKSkge1xuICAgICAgZm9yIChjb25zdCBkZXZpY2Ugb2YgZGV2aWNlQXJyKSB7XG4gICAgICAgIGlmIChkZXZpY2UudWRpZCA9PT0gdWRpZCkge1xuICAgICAgICAgIGlmIChkZXZpY2Uuc3RhdGUgPT09ICdDcmVhdGluZycpIHtcbiAgICAgICAgICAgIC8vIG5lZWQgdG8gcmV0cnlcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRGV2aWNlIHdpdGggdWRpZCAnJHt1ZGlkfScgc3RpbGwgYmVpbmcgY3JlYXRlZGApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBzdG9wIGxvb2tpbmcsIHdlJ3JlIGRvbmVcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKGBEZXZpY2Ugd2l0aCB1ZGlkICcke3VkaWR9JyBub3QgeWV0IGNyZWF0ZWRgKTtcbiAgfSk7XG5cbiAgcmV0dXJuIHVkaWQ7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL3N1YmNvbW1hbmRzL2NyZWF0ZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
