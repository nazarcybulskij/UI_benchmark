"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.TEST_APK_PKG = exports.REQUIRED_PARAMS = exports.EspressoRunner = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("./logger"));

var _serverBuilder = require("./server-builder");

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _package = require("../../package.json");

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

var _utils = require("./utils");

const TEST_SERVER_ROOT = _path.default.resolve(__dirname, '..', '..', 'espresso-server');

const TEST_APK_PKG = 'io.appium.espressoserver.test';
exports.TEST_APK_PKG = TEST_APK_PKG;
const REQUIRED_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort', 'appPackage', 'forceEspressoRebuild'];
exports.REQUIRED_PARAMS = REQUIRED_PARAMS;
const ESPRESSO_SERVER_LAUNCH_TIMEOUT = 30000;
const TARGET_PACKAGE_CONTAINER = '/data/local/tmp/espresso.apppackage';

class EspressoRunner {
  constructor(opts = {}) {
    for (let req of REQUIRED_PARAMS) {
      if (!opts || !_appiumSupport.util.hasValue(opts[req])) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.host,
      port: this.systemPort,
      base: '',
      keepAlive: true
    });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);

    const modServerName = _appiumSupport.fs.sanitizeName(`${TEST_APK_PKG}_${_package.version}_${this.appPackage}_${this.adb.curDeviceId}.apk`, {
      replacement: '-'
    });

    this.modServerPath = _path.default.resolve(this.tmpDir, modServerName);
    this.showGradleLog = opts.showGradleLog;
    this.espressoBuildConfig = opts.espressoBuildConfig;
    this.serverLaunchTimeout = opts.serverLaunchTimeout || ESPRESSO_SERVER_LAUNCH_TIMEOUT;
    this.androidInstallTimeout = opts.androidInstallTimeout;
    this.disableSuppressAccessibilityService = opts.disableSuppressAccessibilityService;

    if (opts.useKeystore && opts.keystorePath && opts.keystorePassword && opts.keyAlias && opts.keyPassword) {
      this.signingConfig = (0, _serverBuilder.buildServerSigningConfig)({
        keystoreFile: opts.keystorePath,
        keystorePassword: opts.keystorePassword,
        keyAlias: opts.keyAlias,
        keyPassword: opts.keyPassword
      });
    } else {
      this.signingConfig = null;
    }
  }

  async isAppPackageChanged() {
    if (!(await this.adb.fileExists(TARGET_PACKAGE_CONTAINER))) {
      _logger.default.debug('The previous target application package is unknown');

      return true;
    }

    const previousAppPackage = (await this.adb.shell(['cat', TARGET_PACKAGE_CONTAINER])).trim();

    _logger.default.debug(`The previous target application package was '${previousAppPackage}'. ` + `The current package is '${this.appPackage}'`);

    return previousAppPackage !== this.appPackage;
  }

  async installServer() {
    const appState = await this.adb.getApplicationInstallState(this.modServerPath, TEST_APK_PKG);
    const shouldUninstallApp = [this.adb.APP_INSTALL_STATE.OLDER_VERSION_INSTALLED, this.adb.APP_INSTALL_STATE.NEWER_VERSION_INSTALLED].includes(appState);
    const shouldInstallApp = shouldUninstallApp || [this.adb.APP_INSTALL_STATE.NOT_INSTALLED].includes(appState);

    if (shouldUninstallApp) {
      _logger.default.info(`Uninstalling Espresso Test Server apk from the target device (pkg: '${TEST_APK_PKG}')`);

      try {
        await this.adb.uninstallApk(TEST_APK_PKG);
      } catch (err) {
        _logger.default.warn(`Error uninstalling '${TEST_APK_PKG}': ${err.message}`);
      }
    }

    if (shouldInstallApp) {
      _logger.default.info(`Installing Espresso Test Server apk from the target device (path: '${this.modServerPath}')`);

      try {
        await this.adb.install(this.modServerPath, {
          replace: false,
          timeout: this.androidInstallTimeout
        });

        _logger.default.info(`Installed Espresso Test Server apk '${this.modServerPath}' (pkg: '${TEST_APK_PKG}')`);
      } catch (err) {
        _logger.default.errorAndThrow(`Cannot install '${this.modServerPath}' because of '${err.message}'`);
      }
    }
  }

  async installTestApk() {
    let rebuild = this.forceEspressoRebuild;

    if (rebuild) {
      _logger.default.debug(`'forceEspressoRebuild' capability is enabled`);
    } else if (await this.isAppPackageChanged()) {
      _logger.default.info(`Forcing Espresso server rebuild because of changed application package`);

      rebuild = true;
    }

    if (rebuild && (await _appiumSupport.fs.exists(this.modServerPath))) {
      _logger.default.debug(`Deleting the obsolete Espresso server package '${this.modServerPath}'`);

      await _appiumSupport.fs.unlink(this.modServerPath);
    }

    if (!(await _appiumSupport.fs.exists(this.modServerPath))) {
      await this.buildNewModServer();
    }

    const isSigned = await this.adb.checkApkCert(this.modServerPath, TEST_APK_PKG);

    if (!isSigned) {
      await this.adb.sign(this.modServerPath);
    }

    if ((rebuild || !isSigned) && (await this.adb.uninstallApk(TEST_APK_PKG))) {
      _logger.default.info('Uninstalled the obsolete Espresso server package from the device under test');
    }

    await this.installServer();
  }

  async buildNewModServer() {
    let buildConfiguration = {};

    if (this.espressoBuildConfig) {
      _logger.default.info(`Using build configuration JSON from: '${this.espressoBuildConfig}'`);

      try {
        buildConfiguration = JSON.parse((await _appiumSupport.fs.readFile(this.espressoBuildConfig, 'utf8')));
      } catch (e) {
        _logger.default.error('Failed to parse build configuration JSON', e);

        throw e;
      }
    }

    const dirName = _appiumSupport.fs.sanitizeName(`espresso-server-${this.adb.curDeviceId}`, {
      replacement: '-'
    });

    const serverPath = _path.default.resolve(this.tmpDir, dirName);

    _logger.default.info(`Building espresso server in '${serverPath}'`);

    _logger.default.debug(`The build folder root could be customized by changing the 'tmpDir' capability`);

    await _appiumSupport.fs.rimraf(serverPath);
    await (0, _appiumSupport.mkdirp)(serverPath);

    _logger.default.debug(`Copying espresso server template from ('${TEST_SERVER_ROOT}' to '${serverPath}')`);

    await (0, _utils.copyGradleProjectRecursively)(TEST_SERVER_ROOT, serverPath);

    _logger.default.debug('Bulding espresso server');

    await new _serverBuilder.ServerBuilder({
      serverPath,
      buildConfiguration,
      showGradleLog: this.showGradleLog,
      testAppPackage: this.appPackage,
      signingConfig: this.signingConfig
    }).build();

    const apkPath = _path.default.resolve(serverPath, 'app', 'build', 'outputs', 'apk', 'androidTest', 'debug', 'app-debug-androidTest.apk');

    _logger.default.debug(`Copying built apk from '${apkPath}' to '${this.modServerPath}'`);

    await _appiumSupport.fs.copyFile(apkPath, this.modServerPath);
  }

  async cleanupSessionLeftovers() {
    _logger.default.debug('Performing cleanup of automation leftovers');

    try {
      const {
        value
      } = await _requestPromise.default.get({
        url: `http://${this.host}:${this.systemPort}/sessions`,
        timeout: 500,
        json: true
      });
      const activeSessionIds = value.map(sess => sess.id);

      if (activeSessionIds.length) {
        _logger.default.debug(`The following obsolete sessions are still running: ${JSON.stringify(activeSessionIds)}`);

        _logger.default.debug('Cleaning up the obsolete sessions');

        await _bluebird.default.all(activeSessionIds.map(id => _requestPromise.default.delete({
          url: `http://${this.host}:${this.systemPort}/session/${id}`
        })));
        await _bluebird.default.delay(1000);
      } else {
        _logger.default.debug('No obsolete sessions have been detected');
      }
    } catch (e) {
      _logger.default.debug(`No obsolete sessions have been detected (${e.message})`);
    }
  }

  async startSession(caps) {
    await this.cleanupSessionLeftovers();
    const cmd = ['shell', 'am', 'instrument', '-w', '-e', 'debug', process.env.ESPRESSO_JAVA_DEBUG === 'true'];

    if (_lodash.default.isBoolean(this.disableSuppressAccessibilityService)) {
      cmd.push('-e', 'DISABLE_SUPPRESS_ACCESSIBILITY_SERVICES', this.disableSuppressAccessibilityService);
    }

    cmd.push(`${TEST_APK_PKG}/androidx.test.runner.AndroidJUnitRunner`);

    _logger.default.info(`Starting Espresso Server v${_package.version} with cmd: adb ${cmd.join(' ')}`);

    let hasSocketError = false;
    this.instProcess = this.adb.createSubProcess(cmd);
    this.instProcess.on('exit', (code, signal) => {
      _logger.default.info(`Instrumentation process exited with code ${code} from signal ${signal}`);
    });
    this.instProcess.on('die', (code, signal) => {
      _logger.default.error(`Instrumentation process died with code ${code} and signal ${signal}`);
    });
    this.instProcess.on('stream-line', line => {
      if (_lodash.default.isEmpty(line.trim())) {
        return;
      }

      _logger.default.debug(`[Instrumentation] ${line.trim()}`);

      if (line.toLowerCase().includes('java.net.socketexception')) {
        hasSocketError = true;
      }
    });
    await this.instProcess.start((stdout, stderr) => {
      const out = stdout.trim() || stderr.trim();

      if (out.includes('io.appium.espressoserver.EspressoServerRunnerTest:')) {
        return true;
      }

      if (out.toLowerCase().includes('exception')) {
        throw new Error(out);
      }
    }, this.serverLaunchTimeout);

    _logger.default.info('Waiting for Espresso to be online...');

    try {
      await (0, _asyncbox.retryInterval)(20, 1000, async () => {
        await this.jwproxy.command('/status', 'GET');
      });
    } catch (e) {
      if (hasSocketError) {
        _logger.default.errorAndThrow(`Timed out waiting for Espresso Server to start due to Socket exception. Espresso Server requires the 'INTERNET' permission to be set in the Android manifest for the app-under-test (<uses-permission android:name="android.permission.INTERNET" />)`);
      } else {
        _logger.default.errorAndThrow(`Timed out waiting for Espresso Server to start. Original error: ${e.message}`);
      }
    }

    await this.jwproxy.command('/session', 'POST', {
      capabilities: {
        firstMatch: [caps],
        alwaysMatch: {}
      }
    });
    await this.recordTargetAppPackage();
  }

  async recordTargetAppPackage() {
    await this.adb.shell([`echo "${this.appPackage}" > "${TARGET_PACKAGE_CONTAINER}"`]);

    _logger.default.info(`Recorded the target application package '${this.appPackage}' to ${TARGET_PACKAGE_CONTAINER}`);
  }

  async deleteSession() {
    _logger.default.debug('Deleting Espresso server session');

    try {
      await this.jwproxy.command('/', 'DELETE');
    } catch (err) {
      _logger.default.warn(`Did not get confirmation Espresso deleteSession worked; ` + `Error was: ${err}`);
    }

    if (this.instProcess && this.instProcess.isRunning) {
      await this.instProcess.stop();
    }
  }

}

exports.EspressoRunner = EspressoRunner;
var _default = EspressoRunner;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9lc3ByZXNzby1ydW5uZXIuanMiXSwibmFtZXMiOlsiVEVTVF9TRVJWRVJfUk9PVCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiVEVTVF9BUEtfUEtHIiwiUkVRVUlSRURfUEFSQU1TIiwiRVNQUkVTU09fU0VSVkVSX0xBVU5DSF9USU1FT1VUIiwiVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSIiwiRXNwcmVzc29SdW5uZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJyZXEiLCJ1dGlsIiwiaGFzVmFsdWUiLCJFcnJvciIsImp3cHJveHkiLCJKV1Byb3h5Iiwic2VydmVyIiwiaG9zdCIsInBvcnQiLCJzeXN0ZW1Qb3J0IiwiYmFzZSIsImtlZXBBbGl2ZSIsInByb3h5UmVxUmVzIiwiYmluZCIsIm1vZFNlcnZlck5hbWUiLCJmcyIsInNhbml0aXplTmFtZSIsInZlcnNpb24iLCJhcHBQYWNrYWdlIiwiYWRiIiwiY3VyRGV2aWNlSWQiLCJyZXBsYWNlbWVudCIsIm1vZFNlcnZlclBhdGgiLCJ0bXBEaXIiLCJzaG93R3JhZGxlTG9nIiwiZXNwcmVzc29CdWlsZENvbmZpZyIsInNlcnZlckxhdW5jaFRpbWVvdXQiLCJhbmRyb2lkSW5zdGFsbFRpbWVvdXQiLCJkaXNhYmxlU3VwcHJlc3NBY2Nlc3NpYmlsaXR5U2VydmljZSIsInVzZUtleXN0b3JlIiwia2V5c3RvcmVQYXRoIiwia2V5c3RvcmVQYXNzd29yZCIsImtleUFsaWFzIiwia2V5UGFzc3dvcmQiLCJzaWduaW5nQ29uZmlnIiwia2V5c3RvcmVGaWxlIiwiaXNBcHBQYWNrYWdlQ2hhbmdlZCIsImZpbGVFeGlzdHMiLCJsb2dnZXIiLCJkZWJ1ZyIsInByZXZpb3VzQXBwUGFja2FnZSIsInNoZWxsIiwidHJpbSIsImluc3RhbGxTZXJ2ZXIiLCJhcHBTdGF0ZSIsImdldEFwcGxpY2F0aW9uSW5zdGFsbFN0YXRlIiwic2hvdWxkVW5pbnN0YWxsQXBwIiwiQVBQX0lOU1RBTExfU1RBVEUiLCJPTERFUl9WRVJTSU9OX0lOU1RBTExFRCIsIk5FV0VSX1ZFUlNJT05fSU5TVEFMTEVEIiwiaW5jbHVkZXMiLCJzaG91bGRJbnN0YWxsQXBwIiwiTk9UX0lOU1RBTExFRCIsImluZm8iLCJ1bmluc3RhbGxBcGsiLCJlcnIiLCJ3YXJuIiwibWVzc2FnZSIsImluc3RhbGwiLCJyZXBsYWNlIiwidGltZW91dCIsImVycm9yQW5kVGhyb3ciLCJpbnN0YWxsVGVzdEFwayIsInJlYnVpbGQiLCJmb3JjZUVzcHJlc3NvUmVidWlsZCIsImV4aXN0cyIsInVubGluayIsImJ1aWxkTmV3TW9kU2VydmVyIiwiaXNTaWduZWQiLCJjaGVja0Fwa0NlcnQiLCJzaWduIiwiYnVpbGRDb25maWd1cmF0aW9uIiwiSlNPTiIsInBhcnNlIiwicmVhZEZpbGUiLCJlIiwiZXJyb3IiLCJkaXJOYW1lIiwic2VydmVyUGF0aCIsInJpbXJhZiIsIlNlcnZlckJ1aWxkZXIiLCJ0ZXN0QXBwUGFja2FnZSIsImJ1aWxkIiwiYXBrUGF0aCIsImNvcHlGaWxlIiwiY2xlYW51cFNlc3Npb25MZWZ0b3ZlcnMiLCJ2YWx1ZSIsInJlcXVlc3QiLCJnZXQiLCJ1cmwiLCJqc29uIiwiYWN0aXZlU2Vzc2lvbklkcyIsIm1hcCIsInNlc3MiLCJpZCIsImxlbmd0aCIsInN0cmluZ2lmeSIsIkIiLCJhbGwiLCJkZWxldGUiLCJkZWxheSIsInN0YXJ0U2Vzc2lvbiIsImNhcHMiLCJjbWQiLCJwcm9jZXNzIiwiZW52IiwiRVNQUkVTU09fSkFWQV9ERUJVRyIsIl8iLCJpc0Jvb2xlYW4iLCJwdXNoIiwiam9pbiIsImhhc1NvY2tldEVycm9yIiwiaW5zdFByb2Nlc3MiLCJjcmVhdGVTdWJQcm9jZXNzIiwib24iLCJjb2RlIiwic2lnbmFsIiwibGluZSIsImlzRW1wdHkiLCJ0b0xvd2VyQ2FzZSIsInN0YXJ0Iiwic3Rkb3V0Iiwic3RkZXJyIiwib3V0IiwiY29tbWFuZCIsImNhcGFiaWxpdGllcyIsImZpcnN0TWF0Y2giLCJhbHdheXNNYXRjaCIsInJlY29yZFRhcmdl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OztBQUVELFVBQU0sS0FBS3JELE9BQUwsQ0FBYXdILE9BQWIsQ0FBcUIsVUFBckIsRUFBaUMsTUFBakMsRUFBeUM7QUFDN0NDLE1BQUFBLFlBQVksRUFBRTtBQUNaQyxRQUFBQSxVQUFVLEVBQUUsQ0FBQ3hCLElBQUQsQ0FEQTtBQUVaeUIsUUFBQUEsV0FBVyxFQUFFO0FBRkQ7QUFEK0IsS0FBekMsQ0FBTjtBQU1BLFVBQU0sS0FBS0Msc0JBQUwsRUFBTjtBQUNEOztBQUVELFFBQU1BLHNCQUFOLEdBQWdDO0FBQzlCLFVBQU0sS0FBSzdHLEdBQUwsQ0FBU3NCLEtBQVQsQ0FBZSxDQUFFLFNBQVEsS0FBS3ZCLFVBQVcsUUFBT3RCLHdCQUF5QixHQUExRCxDQUFmLENBQU47O0FBQ0EwQyxvQkFBT2UsSUFBUCxDQUFhLDRDQUEyQyxLQUFLbkMsVUFBVyxRQUFPdEIsd0JBQXlCLEVBQXhHO0FBQ0Q7O0FBRUQsUUFBTXFJLGFBQU4sR0FBdUI7QUFDckIzRixvQkFBT0MsS0FBUCxDQUFhLGtDQUFiOztBQUdBLFFBQUk7QUFDRixZQUFNLEtBQUtuQyxPQUFMLENBQWF3SCxPQUFiLENBQXFCLEdBQXJCLEVBQTBCLFFBQTFCLENBQU47QUFDRCxLQUZELENBRUUsT0FBT3JFLEdBQVAsRUFBWTtBQUNaakIsc0JBQU9rQixJQUFQLENBQWEsMERBQUQsR0FDUCxjQUFhRCxHQUFJLEVBRHRCO0FBRUQ7O0FBRUQsUUFBSSxLQUFLeUQsV0FBTCxJQUFvQixLQUFLQSxXQUFMLENBQWlCa0IsU0FBekMsRUFBb0Q7QUFDbEQsWUFBTSxLQUFLbEIsV0FBTCxDQUFpQm1CLElBQWpCLEVBQU47QUFDRDtBQUNGOztBQWxSa0I7OztlQXNSTnRJLGMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBKV1Byb3h5IH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IFNlcnZlckJ1aWxkZXIsIGJ1aWxkU2VydmVyU2lnbmluZ0NvbmZpZyB9IGZyb20gJy4vc2VydmVyLWJ1aWxkZXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBmcywgdXRpbCwgbWtkaXJwIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgdmVyc2lvbiB9IGZyb20gJy4uLy4uL3BhY2thZ2UuanNvbic7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgaW1wb3J0L25vLXVucmVzb2x2ZWRcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgY29weUdyYWRsZVByb2plY3RSZWN1cnNpdmVseSB9IGZyb20gJy4vdXRpbHMnO1xuXG5cbmNvbnN0IFRFU1RfU0VSVkVSX1JPT1QgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnZXNwcmVzc28tc2VydmVyJyk7XG5jb25zdCBURVNUX0FQS19QS0cgPSAnaW8uYXBwaXVtLmVzcHJlc3Nvc2VydmVyLnRlc3QnO1xuY29uc3QgUkVRVUlSRURfUEFSQU1TID0gW1xuICAnYWRiJyxcbiAgJ3RtcERpcicsXG4gICdob3N0JyxcbiAgJ3N5c3RlbVBvcnQnLFxuICAnZGV2aWNlUG9ydCcsXG4gICdhcHBQYWNrYWdlJyxcbiAgJ2ZvcmNlRXNwcmVzc29SZWJ1aWxkJyxcbl07XG5jb25zdCBFU1BSRVNTT19TRVJWRVJfTEFVTkNIX1RJTUVPVVQgPSAzMDAwMDtcbmNvbnN0IFRBUkdFVF9QQUNLQUdFX0NPTlRBSU5FUiA9ICcvZGF0YS9sb2NhbC90bXAvZXNwcmVzc28uYXBwcGFja2FnZSc7XG5cbmNsYXNzIEVzcHJlc3NvUnVubmVyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIGZvciAobGV0IHJlcSBvZiBSRVFVSVJFRF9QQVJBTVMpIHtcbiAgICAgIGlmICghb3B0cyB8fCAhdXRpbC5oYXNWYWx1ZShvcHRzW3JlcV0pKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgT3B0aW9uICcke3JlcX0nIGlzIHJlcXVpcmVkIWApO1xuICAgICAgfVxuICAgICAgdGhpc1tyZXFdID0gb3B0c1tyZXFdO1xuICAgIH1cbiAgICB0aGlzLmp3cHJveHkgPSBuZXcgSldQcm94eSh7XG4gICAgICBzZXJ2ZXI6IHRoaXMuaG9zdCxcbiAgICAgIHBvcnQ6IHRoaXMuc3lzdGVtUG9ydCxcbiAgICAgIGJhc2U6ICcnLFxuICAgICAga2VlcEFsaXZlOiB0cnVlLFxuICAgIH0pO1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xuXG4gICAgY29uc3QgbW9kU2VydmVyTmFtZSA9IGZzLnNhbml0aXplTmFtZShgJHtURVNUX0FQS19QS0d9XyR7dmVyc2lvbn1fJHt0aGlzLmFwcFBhY2thZ2V9XyR7dGhpcy5hZGIuY3VyRGV2aWNlSWR9LmFwa2AsIHtcbiAgICAgIHJlcGxhY2VtZW50OiAnLScsXG4gICAgfSk7XG4gICAgdGhpcy5tb2RTZXJ2ZXJQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCBtb2RTZXJ2ZXJOYW1lKTtcbiAgICB0aGlzLnNob3dHcmFkbGVMb2cgPSBvcHRzLnNob3dHcmFkbGVMb2c7XG4gICAgdGhpcy5lc3ByZXNzb0J1aWxkQ29uZmlnID0gb3B0cy5lc3ByZXNzb0J1aWxkQ29uZmlnO1xuXG4gICAgdGhpcy5zZXJ2ZXJMYXVuY2hUaW1lb3V0ID0gb3B0cy5zZXJ2ZXJMYXVuY2hUaW1lb3V0IHx8IEVTUFJFU1NPX1NFUlZFUl9MQVVOQ0hfVElNRU9VVDtcbiAgICB0aGlzLmFuZHJvaWRJbnN0YWxsVGltZW91dCA9IG9wdHMuYW5kcm9pZEluc3RhbGxUaW1lb3V0O1xuXG4gICAgdGhpcy5kaXNhYmxlU3VwcHJlc3NBY2Nlc3NpYmlsaXR5U2VydmljZSA9IG9wdHMuZGlzYWJsZVN1cHByZXNzQWNjZXNzaWJpbGl0eVNlcnZpY2U7XG5cbiAgICAvLyBFc3ByZXNzbyBTZXJ2ZXIgYXBwIG5lZWRzIHRvIGJlIHNpZ25lZCB3aXRoIHNhbWUga2V5U3RvcmUgYXMgYXBwUGFja2FnZVxuICAgIGlmIChvcHRzLnVzZUtleXN0b3JlICYmIG9wdHMua2V5c3RvcmVQYXRoICYmIG9wdHMua2V5c3RvcmVQYXNzd29yZCAmJiBvcHRzLmtleUFsaWFzICYmIG9wdHMua2V5UGFzc3dvcmQpIHtcbiAgICAgIHRoaXMuc2lnbmluZ0NvbmZpZyA9IGJ1aWxkU2VydmVyU2lnbmluZ0NvbmZpZyh7XG4gICAgICAgIGtleXN0b3JlRmlsZTogb3B0cy5rZXlzdG9yZVBhdGgsXG4gICAgICAgIGtleXN0b3JlUGFzc3dvcmQ6IG9wdHMua2V5c3RvcmVQYXNzd29yZCxcbiAgICAgICAga2V5QWxpYXM6IG9wdHMua2V5QWxpYXMsXG4gICAgICAgIGtleVBhc3N3b3JkOiBvcHRzLmtleVBhc3N3b3JkXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zaWduaW5nQ29uZmlnID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBhc3luYyBpc0FwcFBhY2thZ2VDaGFuZ2VkICgpIHtcbiAgICBpZiAoIWF3YWl0IHRoaXMuYWRiLmZpbGVFeGlzdHMoVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSKSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdUaGUgcHJldmlvdXMgdGFyZ2V0IGFwcGxpY2F0aW9uIHBhY2thZ2UgaXMgdW5rbm93bicpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGNvbnN0IHByZXZpb3VzQXBwUGFja2FnZSA9IChhd2FpdCB0aGlzLmFkYi5zaGVsbChbJ2NhdCcsIFRBUkdFVF9QQUNLQUdFX0NPTlRBSU5FUl0pKS50cmltKCk7XG4gICAgbG9nZ2VyLmRlYnVnKGBUaGUgcHJldmlvdXMgdGFyZ2V0IGFwcGxpY2F0aW9uIHBhY2thZ2Ugd2FzICcke3ByZXZpb3VzQXBwUGFja2FnZX0nLiBgICtcbiAgICAgIGBUaGUgY3VycmVudCBwYWNrYWdlIGlzICcke3RoaXMuYXBwUGFja2FnZX0nYCk7XG4gICAgcmV0dXJuIHByZXZpb3VzQXBwUGFja2FnZSAhPT0gdGhpcy5hcHBQYWNrYWdlO1xuICB9XG5cbiAgLyoqXG4gICAqIEluc3RhbGxzIEVzcHJlc3NvIHNlcnZlciBhcGsgb24gdG8gdGhlIGRldmljZSBvciBlbXVsYXRvci5cbiAgICogRWFjaCBhZGIgY29tbWFuZCB1c2VzIGRlZmF1bHQgdGltZW91dCBieSB0aGVtLlxuICAgKi9cbiAgYXN5bmMgaW5zdGFsbFNlcnZlciAoKSB7XG4gICAgY29uc3QgYXBwU3RhdGUgPSBhd2FpdCB0aGlzLmFkYi5nZXRBcHBsaWNhdGlvbkluc3RhbGxTdGF0ZSh0aGlzLm1vZFNlcnZlclBhdGgsIFRFU1RfQVBLX1BLRyk7XG5cbiAgICBjb25zdCBzaG91bGRVbmluc3RhbGxBcHAgPSBbXG4gICAgICB0aGlzLmFkYi5BUFBfSU5TVEFMTF9TVEFURS5PTERFUl9WRVJTSU9OX0lOU1RBTExFRCxcbiAgICAgIHRoaXMuYWRiLkFQUF9JTlNUQUxMX1NUQVRFLk5FV0VSX1ZFUlNJT05fSU5TVEFMTEVEXG4gICAgXS5pbmNsdWRlcyhhcHBTdGF0ZSk7XG4gICAgY29uc3Qgc2hvdWxkSW5zdGFsbEFwcCA9IHNob3VsZFVuaW5zdGFsbEFwcCB8fCBbXG4gICAgICB0aGlzLmFkYi5BUFBfSU5TVEFMTF9TVEFURS5OT1RfSU5TVEFMTEVEXG4gICAgXS5pbmNsdWRlcyhhcHBTdGF0ZSk7XG5cbiAgICBpZiAoc2hvdWxkVW5pbnN0YWxsQXBwKSB7XG4gICAgICBsb2dnZXIuaW5mbyhgVW5pbnN0YWxsaW5nIEVzcHJlc3NvIFRlc3QgU2VydmVyIGFwayBmcm9tIHRoZSB0YXJnZXQgZGV2aWNlIChwa2c6ICcke1RFU1RfQVBLX1BLR30nKWApO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5hZGIudW5pbnN0YWxsQXBrKFRFU1RfQVBLX1BLRyk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nZ2VyLndhcm4oYEVycm9yIHVuaW5zdGFsbGluZyAnJHtURVNUX0FQS19QS0d9JzogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoc2hvdWxkSW5zdGFsbEFwcCkge1xuICAgICAgbG9nZ2VyLmluZm8oYEluc3RhbGxpbmcgRXNwcmVzc28gVGVzdCBTZXJ2ZXIgYXBrIGZyb20gdGhlIHRhcmdldCBkZXZpY2UgKHBhdGg6ICcke3RoaXMubW9kU2VydmVyUGF0aH0nKWApO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5hZGIuaW5zdGFsbCh0aGlzLm1vZFNlcnZlclBhdGgsIHsgcmVwbGFjZTogZmFsc2UsIHRpbWVvdXQ6IHRoaXMuYW5kcm9pZEluc3RhbGxUaW1lb3V0IH0pO1xuICAgICAgICBsb2dnZXIuaW5mbyhgSW5zdGFsbGVkIEVzcHJlc3NvIFRlc3QgU2VydmVyIGFwayAnJHt0aGlzLm1vZFNlcnZlclBhdGh9JyAocGtnOiAnJHtURVNUX0FQS19QS0d9JylgKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgQ2Fubm90IGluc3RhbGwgJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofScgYmVjYXVzZSBvZiAnJHtlcnIubWVzc2FnZX0nYCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaW5zdGFsbFRlc3RBcGsgKCkge1xuICAgIGxldCByZWJ1aWxkID0gdGhpcy5mb3JjZUVzcHJlc3NvUmVidWlsZDtcbiAgICBpZiAocmVidWlsZCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGAnZm9yY2VFc3ByZXNzb1JlYnVpbGQnIGNhcGFiaWxpdHkgaXMgZW5hYmxlZGApO1xuICAgIH0gZWxzZSBpZiAoYXdhaXQgdGhpcy5pc0FwcFBhY2thZ2VDaGFuZ2VkKCkpIHtcbiAgICAgIGxvZ2dlci5pbmZvKGBGb3JjaW5nIEVzcHJlc3NvIHNlcnZlciByZWJ1aWxkIGJlY2F1c2Ugb2YgY2hhbmdlZCBhcHBsaWNhdGlvbiBwYWNrYWdlYCk7XG4gICAgICByZWJ1aWxkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBpZiAocmVidWlsZCAmJiBhd2FpdCBmcy5leGlzdHModGhpcy5tb2RTZXJ2ZXJQYXRoKSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBEZWxldGluZyB0aGUgb2Jzb2xldGUgRXNwcmVzc28gc2VydmVyIHBhY2thZ2UgJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofSdgKTtcbiAgICAgIGF3YWl0IGZzLnVubGluayh0aGlzLm1vZFNlcnZlclBhdGgpO1xuICAgIH1cbiAgICBpZiAoIShhd2FpdCBmcy5leGlzdHModGhpcy5tb2RTZXJ2ZXJQYXRoKSkpIHtcbiAgICAgIGF3YWl0IHRoaXMuYnVpbGROZXdNb2RTZXJ2ZXIoKTtcbiAgICB9XG4gICAgY29uc3QgaXNTaWduZWQgPSBhd2FpdCB0aGlzLmFkYi5jaGVja0Fwa0NlcnQodGhpcy5tb2RTZXJ2ZXJQYXRoLCBURVNUX0FQS19QS0cpO1xuICAgIGlmICghaXNTaWduZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnNpZ24odGhpcy5tb2RTZXJ2ZXJQYXRoKTtcbiAgICB9XG4gICAgaWYgKChyZWJ1aWxkIHx8ICFpc1NpZ25lZCkgJiYgYXdhaXQgdGhpcy5hZGIudW5pbnN0YWxsQXBrKFRFU1RfQVBLX1BLRykpIHtcbiAgICAgIGxvZ2dlci5pbmZvKCdVbmluc3RhbGxlZCB0aGUgb2Jzb2xldGUgRXNwcmVzc28gc2VydmVyIHBhY2thZ2UgZnJvbSB0aGUgZGV2aWNlIHVuZGVyIHRlc3QnKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLmluc3RhbGxTZXJ2ZXIoKTtcbiAgfVxuXG4gIGFzeW5jIGJ1aWxkTmV3TW9kU2VydmVyICgpIHtcbiAgICBsZXQgYnVpbGRDb25maWd1cmF0aW9uID0ge307XG4gICAgaWYgKHRoaXMuZXNwcmVzc29CdWlsZENvbmZpZykge1xuICAgICAgbG9nZ2VyLmluZm8oYFVzaW5nIGJ1aWxkIGNvbmZpZ3VyYXRpb24gSlNPTiBmcm9tOiAnJHt0aGlzLmVzcHJlc3NvQnVpbGRDb25maWd9J2ApO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYnVpbGRDb25maWd1cmF0aW9uID0gSlNPTi5wYXJzZShhd2FpdCBmcy5yZWFkRmlsZSh0aGlzLmVzcHJlc3NvQnVpbGRDb25maWcsICd1dGY4JykpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBwYXJzZSBidWlsZCBjb25maWd1cmF0aW9uIEpTT04nLCBlKTtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgZGlyTmFtZSA9IGZzLnNhbml0aXplTmFtZShgZXNwcmVzc28tc2VydmVyLSR7dGhpcy5hZGIuY3VyRGV2aWNlSWR9YCwge1xuICAgICAgcmVwbGFjZW1lbnQ6ICctJyxcbiAgICB9KTtcbiAgICBjb25zdCBzZXJ2ZXJQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCBkaXJOYW1lKTtcbiAgICBsb2dnZXIuaW5mbyhgQnVpbGRpbmcgZXNwcmVzc28gc2VydmVyIGluICcke3NlcnZlclBhdGh9J2ApO1xuICAgIGxvZ2dlci5kZWJ1ZyhgVGhlIGJ1aWxkIGZvbGRlciByb290IGNvdWxkIGJlIGN1c3RvbWl6ZWQgYnkgY2hhbmdpbmcgdGhlICd0bXBEaXInIGNhcGFiaWxpdHlgKTtcbiAgICBhd2FpdCBmcy5yaW1yYWYoc2VydmVyUGF0aCk7XG4gICAgYXdhaXQgbWtkaXJwKHNlcnZlclBhdGgpO1xuICAgIGxvZ2dlci5kZWJ1ZyhgQ29weWluZyBlc3ByZXNzbyBzZXJ2ZXIgdGVtcGxhdGUgZnJvbSAoJyR7VEVTVF9TRVJWRVJfUk9PVH0nIHRvICcke3NlcnZlclBhdGh9JylgKTtcbiAgICBhd2FpdCBjb3B5R3JhZGxlUHJvamVjdFJlY3Vyc2l2ZWx5KFRFU1RfU0VSVkVSX1JPT1QsIHNlcnZlclBhdGgpO1xuICAgIGxvZ2dlci5kZWJ1ZygnQnVsZGluZyBlc3ByZXNzbyBzZXJ2ZXInKTtcbiAgICBhd2FpdCBuZXcgU2VydmVyQnVpbGRlcih7XG4gICAgICBzZXJ2ZXJQYXRoLCBidWlsZENvbmZpZ3VyYXRpb24sXG4gICAgICBzaG93R3JhZGxlTG9nOiB0aGlzLnNob3dHcmFkbGVMb2csXG4gICAgICB0ZXN0QXBwUGFja2FnZTogdGhpcy5hcHBQYWNrYWdlLFxuICAgICAgc2lnbmluZ0NvbmZpZzogdGhpcy5zaWduaW5nQ29uZmlnXG4gICAgfSkuYnVpbGQoKTtcbiAgICBjb25zdCBhcGtQYXRoID0gcGF0aC5yZXNvbHZlKHNlcnZlclBhdGgsICdhcHAnLCAnYnVpbGQnLCAnb3V0cHV0cycsICdhcGsnLCAnYW5kcm9pZFRlc3QnLCAnZGVidWcnLCAnYXBwLWRlYnVnLWFuZHJvaWRUZXN0LmFwaycpO1xuICAgIGxvZ2dlci5kZWJ1ZyhgQ29weWluZyBidWlsdCBhcGsgZnJvbSAnJHthcGtQYXRofScgdG8gJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofSdgKTtcbiAgICBhd2FpdCBmcy5jb3B5RmlsZShhcGtQYXRoLCB0aGlzLm1vZFNlcnZlclBhdGgpO1xuICB9XG5cbiAgYXN5bmMgY2xlYW51cFNlc3Npb25MZWZ0b3ZlcnMgKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnUGVyZm9ybWluZyBjbGVhbnVwIG9mIGF1dG9tYXRpb24gbGVmdG92ZXJzJyk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3Qge3ZhbHVlfSA9IGF3YWl0IHJlcXVlc3QuZ2V0KHtcbiAgICAgICAgdXJsOiBgaHR0cDovLyR7dGhpcy5ob3N0fToke3RoaXMuc3lzdGVtUG9ydH0vc2Vzc2lvbnNgLFxuICAgICAgICB0aW1lb3V0OiA1MDAsXG4gICAgICAgIGpzb246IHRydWUsXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IGFjdGl2ZVNlc3Npb25JZHMgPSB2YWx1ZS5tYXAoKHNlc3MpID0+IHNlc3MuaWQpO1xuICAgICAgaWYgKGFjdGl2ZVNlc3Npb25JZHMubGVuZ3RoKSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgVGhlIGZvbGxvd2luZyBvYnNvbGV0ZSBzZXNzaW9ucyBhcmUgc3RpbGwgcnVubmluZzogJHtKU09OLnN0cmluZ2lmeShhY3RpdmVTZXNzaW9uSWRzKX1gKTtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKCdDbGVhbmluZyB1cCB0aGUgb2Jzb2xldGUgc2Vzc2lvbnMnKTtcbiAgICAgICAgYXdhaXQgQi5hbGwoYWN0aXZlU2Vzc2lvbklkcy5tYXAoKGlkKSA9PlxuICAgICAgICAgIHJlcXVlc3QuZGVsZXRlKHtcbiAgICAgICAgICAgIHVybDogYGh0dHA6Ly8ke3RoaXMuaG9zdH06JHt0aGlzLnN5c3RlbVBvcnR9L3Nlc3Npb24vJHtpZH1gLFxuICAgICAgICAgIH0pXG4gICAgICAgICkpO1xuICAgICAgICAvLyBMZXQgYWxsIHNlc3Npb25zIHRvIGJlIHByb3Blcmx5IHRlcm1pbmF0ZWQgYmVmb3JlIGNvbnRpbnVpbmdcbiAgICAgICAgYXdhaXQgQi5kZWxheSgxMDAwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZygnTm8gb2Jzb2xldGUgc2Vzc2lvbnMgaGF2ZSBiZWVuIGRldGVjdGVkJyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBObyBvYnNvbGV0ZSBzZXNzaW9ucyBoYXZlIGJlZW4gZGV0ZWN0ZWQgKCR7ZS5tZXNzYWdlfSlgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzdGFydFNlc3Npb24gKGNhcHMpIHtcbiAgICBhd2FpdCB0aGlzLmNsZWFudXBTZXNzaW9uTGVmdG92ZXJzKCk7XG5cbiAgICBjb25zdCBjbWQgPSBbXG4gICAgICAnc2hlbGwnLFxuICAgICAgJ2FtJywgJ2luc3RydW1lbnQnLFxuICAgICAgJy13JyxcbiAgICAgICctZScsICdkZWJ1ZycsIHByb2Nlc3MuZW52LkVTUFJFU1NPX0pBVkFfREVCVUcgPT09ICd0cnVlJyxcbiAgICBdO1xuXG4gICAgaWYgKF8uaXNCb29sZWFuKHRoaXMuZGlzYWJsZVN1cHByZXNzQWNjZXNzaWJpbGl0eVNlcnZpY2UpKSB7XG4gICAgICBjbWQucHVzaCgnLWUnLCAnRElTQUJMRV9TVVBQUkVTU19BQ0NFU1NJQklMSVRZX1NFUlZJQ0VTJywgdGhpcy5kaXNhYmxlU3VwcHJlc3NBY2Nlc3NpYmlsaXR5U2VydmljZSk7XG4gICAgfVxuXG4gICAgY21kLnB1c2goYCR7VEVTVF9BUEtfUEtHfS9hbmRyb2lkeC50ZXN0LnJ1bm5lci5BbmRyb2lkSlVuaXRSdW5uZXJgKTtcblxuICAgIGxvZ2dlci5pbmZvKGBTdGFydGluZyBFc3ByZXNzbyBTZXJ2ZXIgdiR7dmVyc2lvbn0gd2l0aCBjbWQ6IGFkYiAke2NtZC5qb2luKCcgJyl9YCk7XG5cbiAgICBsZXQgaGFzU29ja2V0RXJyb3IgPSBmYWxzZTtcblxuICAgIC8vIHN0YXJ0IHRoZSBpbnN0cnVtZW50YXRpb24gcHJvY2Vzc1xuICAgIHRoaXMuaW5zdFByb2Nlc3MgPSB0aGlzLmFkYi5jcmVhdGVTdWJQcm9jZXNzKGNtZCk7XG4gICAgdGhpcy5pbnN0UHJvY2Vzcy5vbignZXhpdCcsIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgIGxvZ2dlci5pbmZvKGBJbnN0cnVtZW50YXRpb24gcHJvY2VzcyBleGl0ZWQgd2l0aCBjb2RlICR7Y29kZX0gZnJvbSBzaWduYWwgJHtzaWduYWx9YCk7XG4gICAgfSk7XG4gICAgdGhpcy5pbnN0UHJvY2Vzcy5vbignZGllJywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgbG9nZ2VyLmVycm9yKGBJbnN0cnVtZW50YXRpb24gcHJvY2VzcyBkaWVkIHdpdGggY29kZSAke2NvZGV9IGFuZCBzaWduYWwgJHtzaWduYWx9YCk7XG4gICAgfSk7XG4gICAgdGhpcy5pbnN0UHJvY2Vzcy5vbignc3RyZWFtLWxpbmUnLCAobGluZSkgPT4ge1xuICAgICAgaWYgKF8uaXNFbXB0eShsaW5lLnRyaW0oKSkpIHtcbiAgICAgICAgLy8gRG8gbm90IHByaW50IGVtcHR5IGxpbmVzIGludG8gdGhlIHN5c3RlbSBsb2dcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBsb2dnZXIuZGVidWcoYFtJbnN0cnVtZW50YXRpb25dICR7bGluZS50cmltKCl9YCk7XG4gICAgICAvLyBBICdTb2NrZXRFeGNlcHRpb24nIGluZGljYXRlcyB0aGF0IHdlIGNvdWxkbid0IGNvbm5lY3QgdG8gdGhlIEVzcHJlc3NvIFNlcnZlciwgYmVjYXVzZSB0aGUgSU5URVJORVQgcGVybWlzc2lvbiBpcyBub3Qgc2V0XG4gICAgICBpZiAobGluZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdqYXZhLm5ldC5zb2NrZXRleGNlcHRpb24nKSkge1xuICAgICAgICBoYXNTb2NrZXRFcnJvciA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBhd2FpdCB0aGlzLmluc3RQcm9jZXNzLnN0YXJ0KChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgLy8gZm9yIGFueSBjYWxsIHRvIHRoZSBzdGFydCBkZXRlY3Rvciwgb25lIG9mIHN0ZG91dCBvciBzdGRlcnIgd2lsbCBoYXZlXG4gICAgICAvLyBjb250ZW50LCBzbyBtZXJnZSBmb3IgY2hlY2tzIGhlcmVcbiAgICAgIGNvbnN0IG91dCA9IHN0ZG91dC50cmltKCkgfHwgc3RkZXJyLnRyaW0oKTtcblxuICAgICAgLy8gYWRiIGFsd2F5cyBwcmludHMgdGhpcyBvdXQgb24gc3VjY2Vzcy4gSWYgdGhpcyBpcyBmb3VuZCBub3QgdG8gYmUgdGhlXG4gICAgICAvLyBjYXNlLCBhZGQgb3RoZXIgY29uZGl0aW9uc1xuICAgICAgaWYgKG91dC5pbmNsdWRlcygnaW8uYXBwaXVtLmVzcHJlc3Nvc2VydmVyLkVzcHJlc3NvU2VydmVyUnVubmVyVGVzdDonKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGlmIChvdXQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnZXhjZXB0aW9uJykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKG91dCk7XG4gICAgICB9XG4gICAgfSwgdGhpcy5zZXJ2ZXJMYXVuY2hUaW1lb3V0KTtcblxuICAgIGxvZ2dlci5pbmZvKCdXYWl0aW5nIGZvciBFc3ByZXNzbyB0byBiZSBvbmxpbmUuLi4nKTtcblxuICAgIC8vIHdhaXQgMjBzIGZvciBlc3ByZXNzbyB0byBiZSBvbmxpbmVcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcmV0cnlJbnRlcnZhbCgyMCwgMTAwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChoYXNTb2NrZXRFcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgVGltZWQgb3V0IHdhaXRpbmcgZm9yIEVzcHJlc3NvIFNlcnZlciB0byBzdGFydCBkdWUgdG8gU29ja2V0IGV4Y2VwdGlvbi4gRXNwcmVzc28gU2VydmVyIHJlcXVpcmVzIHRoZSAnSU5URVJORVQnIHBlcm1pc3Npb24gdG8gYmUgc2V0IGluIHRoZSBBbmRyb2lkIG1hbmlmZXN0IGZvciB0aGUgYXBwLXVuZGVyLXRlc3QgKDx1c2VzLXBlcm1pc3Npb24gYW5kcm9pZDpuYW1lPVwiYW5kcm9pZC5wZXJtaXNzaW9uLklOVEVSTkVUXCIgLz4pYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgVGltZWQgb3V0IHdhaXRpbmcgZm9yIEVzcHJlc3NvIFNlcnZlciB0byBzdGFydC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywge1xuICAgICAgY2FwYWJpbGl0aWVzOiB7XG4gICAgICAgIGZpcnN0TWF0Y2g6IFtjYXBzXSxcbiAgICAgICAgYWx3YXlzTWF0Y2g6IHt9XG4gICAgICB9XG4gICAgfSk7XG4gICAgYXdhaXQgdGhpcy5yZWNvcmRUYXJnZXRBcHBQYWNrYWdlKCk7XG4gIH1cblxuICBhc3luYyByZWNvcmRUYXJnZXRBcHBQYWNrYWdlICgpIHtcbiAgICBhd2FpdCB0aGlzLmFkYi5zaGVsbChbYGVjaG8gXCIke3RoaXMuYXBwUGFja2FnZX1cIiA+IFwiJHtUQVJHRVRfUEFDS0FHRV9DT05UQUlORVJ9XCJgXSk7XG4gICAgbG9nZ2VyLmluZm8oYFJlY29yZGVkIHRoZSB0YXJnZXQgYXBwbGljYXRpb24gcGFja2FnZSAnJHt0aGlzLmFwcFBhY2thZ2V9JyB0byAke1RBUkdFVF9QQUNLQUdFX0NPTlRBSU5FUn1gKTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnRGVsZXRpbmcgRXNwcmVzc28gc2VydmVyIHNlc3Npb24nKTtcbiAgICAvLyByZWx5IG9uIGp3cHJveHkncyBpbnRlbGxpZ2VuY2UgdG8ga25vdyB3aGF0IHdlJ3JlIHRhbGtpbmcgYWJvdXQgYW5kXG4gICAgLy8gZGVsZXRlIHRoZSBjdXJyZW50IHNlc3Npb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy8nLCAnREVMRVRFJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIud2FybihgRGlkIG5vdCBnZXQgY29uZmlybWF0aW9uIEVzcHJlc3NvIGRlbGV0ZVNlc3Npb24gd29ya2VkOyBgICtcbiAgICAgICAgICBgRXJyb3Igd2FzOiAke2Vycn1gKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pbnN0UHJvY2VzcyAmJiB0aGlzLmluc3RQcm9jZXNzLmlzUnVubmluZykge1xuICAgICAgYXdhaXQgdGhpcy5pbnN0UHJvY2Vzcy5zdG9wKCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCB7IEVzcHJlc3NvUnVubmVyLCBSRVFVSVJFRF9QQVJBTVMsIFRFU1RfQVBLX1BLRyB9O1xuZXhwb3J0IGRlZmF1bHQgRXNwcmVzc29SdW5uZXI7XG4iXSwiZmlsZSI6ImxpYi9lc3ByZXNzby1ydW5uZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
