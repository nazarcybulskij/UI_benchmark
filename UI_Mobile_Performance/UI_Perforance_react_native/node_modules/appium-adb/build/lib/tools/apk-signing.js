"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _fs2 = _interopRequireDefault(require("fs"));

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _logger = _interopRequireDefault(require("../logger.js"));

var _appiumSupport = require("appium-support");

var _helpers = require("../helpers.js");

var _shellQuote = require("shell-quote");

const DEFAULT_PRIVATE_KEY = _path.default.resolve(_helpers.rootDir, 'keys', 'testkey.pk8');

const DEFAULT_CERTIFICATE = _path.default.resolve(_helpers.rootDir, 'keys', 'testkey.x509.pem');

const DEFAULT_CERT_DIGEST = 'a40da80a59d170caa950cf15c18c454d47a39b26989d8b640ecd745ba71bf5dc';
const BUNDLETOOL_TUTORIAL = 'https://developer.android.com/studio/command-line/bundletool';
const APKSIGNER_VERIFY_FAIL = 'DOES NOT VERIFY';
let apkSigningMethods = {};

apkSigningMethods.executeApksigner = async function executeApksigner(args = []) {
  const apkSignerJar = await (0, _helpers.getApksignerForOs)(this);
  const fullCmd = [(0, _helpers.getJavaForOs)(), '-Xmx1024M', '-Xss1m', '-jar', apkSignerJar, ...args];

  _logger.default.debug(`Starting apksigner: ${(0, _shellQuote.quote)(fullCmd)}`);

  const {
    stdout,
    stderr
  } = await (0, _teen_process.exec)(fullCmd[0], fullCmd.slice(1));

  for (let [name, stream] of [['stdout', stdout], ['stderr', stderr]]) {
    if (!_lodash.default.trim(stream)) {
      continue;
    }

    if (name === 'stdout') {
      stream = stream.split('\n').filter(line => !line.includes('WARNING:')).join('\n');
    }

    _logger.default.debug(`apksigner ${name}: ${stream}`);
  }

  return stdout;
};

apkSigningMethods.signWithDefaultCert = async function signWithDefaultCert(apk) {
  _logger.default.debug(`Signing '${apk}' with default cert`);

  if (!(await _appiumSupport.fs.exists(apk))) {
    throw new Error(`${apk} file doesn't exist.`);
  }

  try {
    const args = ['sign', '--key', DEFAULT_PRIVATE_KEY, '--cert', DEFAULT_CERTIFICATE, apk];
    await this.executeApksigner(args);
  } catch (err) {
    _logger.default.warn(`Cannot use apksigner tool for signing. Defaulting to sign.jar. ` + `Original error: ${err.stderr || err.message}`);

    const signPath = _path.default.resolve(this.helperJarPath, 'sign.jar');

    const fullCmd = [(0, _helpers.getJavaForOs)(), '-jar', signPath, apk, '--override'];

    _logger.default.debug(`Starting sign.jar: ${(0, _shellQuote.quote)(fullCmd)}`);

    try {
      await (0, _teen_process.exec)(fullCmd[0], fullCmd.slice(1));
    } catch (e) {
      throw new Error(`Could not sign with default certificate. ` + `Original error ${e.stderr || e.message}`);
    }
  }
};

apkSigningMethods.signWithCustomCert = async function signWithCustomCert(apk) {
  _logger.default.debug(`Signing '${apk}' with custom cert`);

  if (!(await _appiumSupport.fs.exists(this.keystorePath))) {
    throw new Error(`Keystore: ${this.keystorePath} doesn't exist.`);
  }

  if (!(await _appiumSupport.fs.exists(apk))) {
    throw new Error(`'${apk}' doesn't exist.`);
  }

  try {
    await this.executeApksigner(['sign', '--ks', this.keystorePath, '--ks-key-alias', this.keyAlias, '--ks-pass', `pass:${this.keystorePassword}`, '--key-pass', `pass:${this.keyPassword}`, apk]);
  } catch (err) {
    _logger.default.warn(`Cannot use apksigner tool for signing. Defaulting to jarsigner. ` + `Original error: ${err.stderr || err.message}`);

    try {
      if (await (0, _helpers.unsignApk)(apk)) {
        _logger.default.debug(`'${apk}' has been successfully unsigned`);
      } else {
        _logger.default.debug(`'${apk}' does not need to be unsigned`);
      }

      const jarsigner = _path.default.resolve((0, _helpers.getJavaHome)(), 'bin', `jarsigner${_appiumSupport.system.isWindows() ? '.exe' : ''}`);

      const fullCmd = [jarsigner, '-sigalg', 'MD5withRSA', '-digestalg', 'SHA1', '-keystore', this.keystorePath, '-storepass', this.keystorePassword, '-keypass', this.keyPassword, apk, this.keyAlias];

      _logger.default.debug(`Starting jarsigner: ${(0, _shellQuote.quote)(fullCmd)}`);

      await (0, _teen_process.exec)(fullCmd[0], fullCmd.slice(1));
    } catch (e) {
      throw new Error(`Could not sign with custom certificate. ` + `Original error: ${e.stderr || e.message}`);
    }
  }
};

apkSigningMethods.sign = async function sign(appPath) {
  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    let message = 'Signing of .apks-files is not supported. ';

    if (this.useKeystore) {
      message += 'Consider manual application bundle signing with the custom keystore ' + `like it is described at ${BUNDLETOOL_TUTORIAL}`;
    } else {
      message += `Consider manual application bundle signing with the key at '${DEFAULT_PRIVATE_KEY}' ` + `and the certificate at '${DEFAULT_CERTIFICATE}'. Read ${BUNDLETOOL_TUTORIAL} for more details.`;
    }

    _logger.default.warn(message);

    return;
  }

  let apksignerFound = true;

  try {
    await (0, _helpers.getApksignerForOs)(this);
  } catch (err) {
    apksignerFound = false;
  }

  if (apksignerFound) {
    await this.zipAlignApk(appPath);
  }

  if (this.useKeystore) {
    await this.signWithCustomCert(appPath);
  } else {
    await this.signWithDefaultCert(appPath);
  }

  if (!apksignerFound) {
    await this.zipAlignApk(appPath);
  }
};

apkSigningMethods.zipAlignApk = async function zipAlignApk(apk) {
  await this.initZipAlign();

  try {
    await (0, _teen_process.exec)(this.binaries.zipalign, ['-c', '4', apk]);

    _logger.default.debug(`${apk}' is already zip-aligned. Doing nothing`);

    return false;
  } catch (e) {
    _logger.default.debug(`'${apk}' is not zip-aligned. Aligning`);
  }

  try {
    await _appiumSupport.fs.access(apk, _fs2.default.W_OK);
  } catch (e) {
    throw new Error(`The file at '${apk}' is not writeable. ` + `Please grant write permissions to this file or to its parent folder '${_path.default.dirname(apk)}' ` + `for the Appium process, so it can zip-align the file`);
  }

  const alignedApk = await _appiumSupport.tempDir.path({
    prefix: 'appium',
    suffix: '.tmp'
  });
  await (0, _appiumSupport.mkdirp)(_path.default.dirname(alignedApk));

  try {
    await (0, _teen_process.exec)(this.binaries.zipalign, ['-f', '4', apk, alignedApk]);
    await _appiumSupport.fs.mv(alignedApk, apk, {
      mkdirp: true
    });
    return true;
  } catch (e) {
    if (await _appiumSupport.fs.exists(alignedApk)) {
      await _appiumSupport.fs.unlink(alignedApk);
    }

    throw new Error(`zipAlignApk failed. Original error: ${e.stderr || e.message}`);
  }
};

apkSigningMethods.checkApkCert = async function checkApkCert(appPath, pkg, opts = {}) {
  _logger.default.debug(`Checking app cert for ${appPath}`);

  if (!(await _appiumSupport.fs.exists(appPath))) {
    _logger.default.debug(`'${appPath}' does not exist`);

    return false;
  }

  if (this.useKeystore) {
    return await this.checkCustomApkCert(appPath, pkg);
  }

  if (_path.default.extname(appPath) === _helpers.APKS_EXTENSION) {
    appPath = await this.extractBaseApk(appPath);
  }

  const {
    requireDefaultCert = true
  } = opts;

  try {
    await (0, _helpers.getApksignerForOs)(this);
    const output = await this.executeApksigner(['verify', '--print-certs', appPath]);

    if (_lodash.default.includes(output, DEFAULT_CERT_DIGEST)) {
      _logger.default.debug(`'${appPath}' is signed with the default certificate`);
    } else {
      _logger.default.debug(`'${appPath}' is signed with a non-default certificate`);
    }

    return !requireDefaultCert || _lodash.default.includes(output, DEFAULT_CERT_DIGEST);
  } catch (err) {
    if (_lodash.default.includes(err.stderr, APKSIGNER_VERIFY_FAIL)) {
      _logger.default.debug(`'${appPath}' is not signed`);

      return false;
    }

    _logger.default.warn(`Cannot use apksigner tool for signature verification. ` + `Original error: ${err.message}`);
  }

  _logger.default.debug(`Defaulting to verify.jar`);

  try {
    await (0, _teen_process.exec)((0, _helpers.getJavaForOs)(), ['-jar', _path.default.resolve(this.helperJarPath, 'verify.jar'), appPath]);

    _logger.default.debug(`'${appPath}' is signed with the default certificate`);

    return true;
  } catch (err) {
    if (!requireDefaultCert && _lodash.default.includes(_lodash.default.toLower(err.stderr), 'invalid cert')) {
      _logger.default.debug(`'${appPath}' is signed with a non-default certificate`);

      return true;
    }

    _logger.default.debug(`'${appPath}' is not signed with the default certificate`);

    _logger.default.debug(err.stderr ? err.stderr : err.message);

    return false;
  }
};

apkSigningMethods.checkCustomApkCert = async function checkCustomApkCert(appPath, pkg) {
  _logger.default.debug(`Checking custom app cert for ${appPath}`);

  if (_path.default.extname(appPath) === _helpers.APKS_EXTENSION) {
    appPath = await this.extractBaseApk(appPath);
  }

  let h = 'a-fA-F0-9';
  let md5Str = [`.*MD5.*((?:[${h}]{2}:){15}[${h}]{2})`];
  let md5 = new RegExp(md5Str, 'mi');

  let keytool = _path.default.resolve((0, _helpers.getJavaHome)(), 'bin', `keytool${_appiumSupport.system.isWindows() ? '.exe' : ''}`);

  let keystoreHash = await this.getKeystoreMd5(keytool, md5);
  return await this.checkApkKeystoreMatch(keytool, md5, keystoreHash, pkg, appPath);
};

apkSigningMethods.getKeystoreMd5 = async function getKeystoreMd5(keytool, md5re) {
  _logger.default.debug('Printing keystore md5.');

  try {
    let {
      stdout
    } = await (0, _teen_process.exec)(keytool, ['-v', '-list', '-alias', this.keyAlias, '-keystore', this.keystorePath, '-storepass', this.keystorePassword]);
    let keystoreHash = md5re.exec(stdout);
    keystoreHash = keystoreHash ? keystoreHash[1] : null;

    _logger.default.debug(`Keystore MD5: ${keystoreHash}`);

    return keystoreHash;
  } catch (e) {
    throw new Error(`getKeystoreMd5 failed. Original error: ${e.message}`);
  }
};

apkSigningMethods.checkApkKeystoreMatch = async function checkApkKeystoreMatch(keytool, md5re, keystoreHash, pkg, apk) {
  let entryHash = null;
  let rsa = /^META-INF\/.*\.[rR][sS][aA]$/;
  let foundKeystoreMatch = false;
  await _appiumSupport.zip.readEntries(apk, async ({
    entry,
    extractEntryTo
  }) => {
    entry = entry.fileName;

    if (!rsa.test(entry)) {
      return;
    }

    _logger.default.debug(`Entry: ${entry}`);

    let entryPath = _path.default.join(this.tmpDir, pkg, 'cert');

    _logger.default.debug(`entryPath: ${entryPath}`);

    let entryFile = _path.default.join(entryPath, entry);

    _logger.default.debug(`entryFile: ${entryFile}`);

    await _appiumSupport.fs.rimraf(entryPath);
    await extractEntryTo(entryPath);

    _logger.default.debug('extracted!');

    _logger.default.debug('Printing apk md5.');

    let {
      stdout
    } = await (0, _teen_process.exec)(keytool, ['-v', '-printcert', '-file', entryFile]);
    entryHash = md5re.exec(stdout);
    entryHash = entryHash ? entryHash[1] : null;

    _logger.default.debug(`entryHash MD5: ${entryHash}`);

    _logger.default.debug(`keystore MD5: ${keystoreHash}`);

    let matchesKeystore = entryHash && entryHash === keystoreHash;

    _logger.default.debug(`Matches keystore? ${matchesKeystore}`);

    if (matchesKeystore) {
      foundKeystoreMatch = true;
      return false;
    }
  });
  return foundKeystoreMatch;
};

var _default = apkSigningMethods;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9hcGstc2lnbmluZy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1BSSVZBVEVfS0VZIiwicGF0aCIsInJlc29sdmUiLCJyb290RGlyIiwiREVGQVVMVF9DRVJUSUZJQ0FURSIsIkRFRkFVTFRfQ0VSVF9ESUdFU1QiLCJCVU5ETEVUT09MX1RVVE9SSUFMIiwiQVBLU0lHTkVSX1ZFUklGWV9GQUlMIiwiYXBrU2lnbmluZ01ldGhvZHMiLCJleGVjdXRlQXBrc2lnbmVyIiwiYXJncyIsImFwa1NpZ25lckphciIsImZ1bGxDbWQiLCJsb2ciLCJkZWJ1ZyIsInN0ZG91dCIsInN0ZGVyciIsInNsaWNlIiwibmFtZSIsInN0cmVhbSIsIl8iLCJ0cmltIiwic3BsaXQiLCJmaWx0ZXIiLCJsaW5lIiwiaW5jbHVkZXMiLCJqb2luIiwic2lnbldpdGhEZWZhdWx0Q2VydCIsImFwayIsImZzIiwiZXhpc3RzIiwiRXJyb3IiLCJlcnIiLCJ3YXJuIiwibWVzc2FnZSIsInNpZ25QYXRoIiwiaGVscGVySmFyUGF0aCIsImUiLCJzaWduV2l0aEN1c3RvbUNlcnQiLCJrZXlzdG9yZVBhdGgiLCJrZXlBbGlhcyIsImtleXN0b3JlUGFzc3dvcmQiLCJrZXlQYXNzd29yZCIsImphcnNpZ25lciIsInN5c3RlbSIsImlzV2luZG93cyIsInNpZ24iLCJhcHBQYXRoIiwiZW5kc1dpdGgiLCJBUEtTX0VYVEVOU0lPTiIsInVzZUtleXN0b3JlIiwiYXBrc2lnbmVyRm91bmQiLCJ6aXBBbGlnbkFwayIsImluaXRaaXBBbGlnbiIsImJpbmFyaWVzIiwiemlwYWxpZ24iLCJhY2Nlc3MiLCJfZnMiLCJXX09LIiwiZGlybmFtZSIsImFsaWduZWRBcGsiLCJ0ZW1wRGlyIiwicHJlZml4Iiwic3VmZml4IiwibXYiLCJta2RpcnAiLCJ1bmxpbmsiLCJjaGVja0Fwa0NlcnQiLCJwa2ciLCJvcHRzIiwiY2hlY2tDdXN0b21BcGtDZXJ0IiwiZXh0bmFtZSIsImV4dHJhY3RCYXNlQXBrIiwicmVxdWlyZURlZmF1bHRDZXJ0Iiwib3V0cHV0IiwidG9Mb3dlciIsImgiLCJtZDVTdHIiLCJtZDUiLCJSZWdFeHAiLCJrZXl0b29sIiwia2V5c3RvcmVIYXNoIiwiZ2V0S2V5c3RvcmVNZDUiLCJjaGVja0Fwa0tleXN0b3JlTWF0Y2giLCJtZDVyZSIsImV4ZWMiLCJlbnRyeUhhc2giLCJyc2EiLCJmb3VuZEtleXN0b3JlTWF0Y2giLCJ6aXAiLCJyZWFkRW50cmllcyIsImVudHJ5IiwiZXh0cmFjdEVudHJ5VG8iLCJmaWxlTmFtZSIsInRlc3QiLCJlbnRyeVBhdGgiLCJ0bXBEaXIiLCJlbnRyeUZpbGUiLCJyaW1yYWYiLCJtYXRjaGVzS2V5c3RvcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBSUE7O0FBRUEsTUFBTUEsbUJBQW1CLEdBQUdDLGNBQUtDLE9BQUwsQ0FBYUMsZ0JBQWIsRUFBc0IsTUFBdEIsRUFBOEIsYUFBOUIsQ0FBNUI7O0FBQ0EsTUFBTUMsbUJBQW1CLEdBQUdILGNBQUtDLE9BQUwsQ0FBYUMsZ0JBQWIsRUFBc0IsTUFBdEIsRUFBOEIsa0JBQTlCLENBQTVCOztBQUNBLE1BQU1FLG1CQUFtQixHQUFHLGtFQUE1QjtBQUNBLE1BQU1DLG1CQUFtQixHQUFHLDhEQUE1QjtBQUNBLE1BQU1DLHFCQUFxQixHQUFHLGlCQUE5QjtBQUVBLElBQUlDLGlCQUFpQixHQUFHLEVBQXhCOztBQVVBQSxpQkFBaUIsQ0FBQ0MsZ0JBQWxCLEdBQXFDLGVBQWVBLGdCQUFmLENBQWlDQyxJQUFJLEdBQUcsRUFBeEMsRUFBNEM7QUFDL0UsUUFBTUMsWUFBWSxHQUFHLE1BQU0sZ0NBQWtCLElBQWxCLENBQTNCO0FBQ0EsUUFBTUMsT0FBTyxHQUFHLENBQ2QsNEJBRGMsRUFDRSxXQURGLEVBQ2UsUUFEZixFQUVkLE1BRmMsRUFFTkQsWUFGTSxFQUdkLEdBQUdELElBSFcsQ0FBaEI7O0FBS0FHLGtCQUFJQyxLQUFKLENBQVcsdUJBQXNC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R0EsU0FBUyxDQUFDLENBQUQsQ0FBWixHQUFrQixJQUF2Qzs7QUFDQXpFLG9CQUFJQyxLQUFKLENBQVcsa0JBQWlCd0UsU0FBVSxFQUF0Qzs7QUFDQXpFLG9CQUFJQyxLQUFKLENBQVcsaUJBQWdCbUUsWUFBYSxFQUF4Qzs7QUFDQSxRQUFJa0IsZUFBZSxHQUFHYixTQUFTLElBQUlBLFNBQVMsS0FBS0wsWUFBakQ7O0FBQ0FwRSxvQkFBSUMsS0FBSixDQUFXLHFCQUFvQnFGLGVBQWdCLEVBQS9DOztBQUdBLFFBQUlBLGVBQUosRUFBcUI7QUFDbkJYLE1BQUFBLGtCQUFrQixHQUFHLElBQXJCO0FBQ0EsYUFBTyxLQUFQO0FBQ0Q7QUFDRixHQTlCSyxDQUFOO0FBK0JBLFNBQU9BLGtCQUFQO0FBQ0QsQ0F0Q0Q7O2VBd0NlaEYsaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IF9mcyBmcm9tICdmcyc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXIuanMnO1xuaW1wb3J0IHsgdGVtcERpciwgc3lzdGVtLCBta2RpcnAsIGZzLCB6aXAgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQge1xuICBnZXRKYXZhRm9yT3MsIGdldEFwa3NpZ25lckZvck9zLCBnZXRKYXZhSG9tZSxcbiAgcm9vdERpciwgQVBLU19FWFRFTlNJT04sIHVuc2lnbkFwayxcbn0gZnJvbSAnLi4vaGVscGVycy5qcyc7XG5pbXBvcnQgeyBxdW90ZSB9IGZyb20gJ3NoZWxsLXF1b3RlJztcblxuY29uc3QgREVGQVVMVF9QUklWQVRFX0tFWSA9IHBhdGgucmVzb2x2ZShyb290RGlyLCAna2V5cycsICd0ZXN0a2V5LnBrOCcpO1xuY29uc3QgREVGQVVMVF9DRVJUSUZJQ0FURSA9IHBhdGgucmVzb2x2ZShyb290RGlyLCAna2V5cycsICd0ZXN0a2V5Lng1MDkucGVtJyk7XG5jb25zdCBERUZBVUxUX0NFUlRfRElHRVNUID0gJ2E0MGRhODBhNTlkMTcwY2FhOTUwY2YxNWMxOGM0NTRkNDdhMzliMjY5ODlkOGI2NDBlY2Q3NDViYTcxYmY1ZGMnO1xuY29uc3QgQlVORExFVE9PTF9UVVRPUklBTCA9ICdodHRwczovL2RldmVsb3Blci5hbmRyb2lkLmNvbS9zdHVkaW8vY29tbWFuZC1saW5lL2J1bmRsZXRvb2wnO1xuY29uc3QgQVBLU0lHTkVSX1ZFUklGWV9GQUlMID0gJ0RPRVMgTk9UIFZFUklGWSc7XG5cbmxldCBhcGtTaWduaW5nTWV0aG9kcyA9IHt9O1xuXG4vKipcbiAqIEV4ZWN1dGUgYXBrc2lnbmVyIHV0aWxpdHkgd2l0aCBnaXZlbiBhcmd1bWVudHMuXG4gKlxuICogQHBhcmFtIHs/QXJyYXk8U3RyaW5nPn0gYXJncyAtIFRoZSBsaXN0IG9mIHRvb2wgYXJndW1lbnRzLlxuICogQHJldHVybiB7c3RyaW5nfSAtIENvbW1hbmQgc3Rkb3V0XG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgYXBrc2lnbmVyIGJpbmFyeSBpcyBub3QgcHJlc2VudCBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW1cbiAqICAgICAgICAgICAgICAgICBvciB0aGUgcmV0dXJuIGNvZGUgaXMgbm90IGVxdWFsIHRvIHplcm8uXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLmV4ZWN1dGVBcGtzaWduZXIgPSBhc3luYyBmdW5jdGlvbiBleGVjdXRlQXBrc2lnbmVyIChhcmdzID0gW10pIHtcbiAgY29uc3QgYXBrU2lnbmVySmFyID0gYXdhaXQgZ2V0QXBrc2lnbmVyRm9yT3ModGhpcyk7XG4gIGNvbnN0IGZ1bGxDbWQgPSBbXG4gICAgZ2V0SmF2YUZvck9zKCksICctWG14MTAyNE0nLCAnLVhzczFtJyxcbiAgICAnLWphcicsIGFwa1NpZ25lckphcixcbiAgICAuLi5hcmdzXG4gIF07XG4gIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgYXBrc2lnbmVyOiAke3F1b3RlKGZ1bGxDbWQpfWApO1xuICBjb25zdCB7c3Rkb3V0LCBzdGRlcnJ9ID0gYXdhaXQgZXhlYyhmdWxsQ21kWzBdLCBmdWxsQ21kLnNsaWNlKDEpKTtcbiAgZm9yIChsZXQgW25hbWUsIHN0cmVhbV0gb2YgW1snc3Rkb3V0Jywgc3Rkb3V0XSwgWydzdGRlcnInLCBzdGRlcnJdXSkge1xuICAgIGlmICghXy50cmltKHN0cmVhbSkpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGlmIChuYW1lID09PSAnc3Rkb3V0Jykge1xuICAgICAgLy8gTWFrZSB0aGUgb3V0cHV0IGxlc3MgdGFsa2F0aXZlXG4gICAgICBzdHJlYW0gPSBzdHJlYW0uc3BsaXQoJ1xcbicpXG4gICAgICAgIC5maWx0ZXIoKGxpbmUpID0+ICFsaW5lLmluY2x1ZGVzKCdXQVJOSU5HOicpKVxuICAgICAgICAuam9pbignXFxuJyk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgYXBrc2lnbmVyICR7bmFtZX06ICR7c3RyZWFtfWApO1xuICB9XG4gIHJldHVybiBzdGRvdXQ7XG59O1xuXG4vKipcbiAqIChSZSlzaWduIHRoZSBnaXZlbiBhcGsgZmlsZSBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW0gd2l0aCB0aGUgZGVmYXVsdCBjZXJ0aWZpY2F0ZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgYXBrIGZpbGUuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgc2lnbmluZyBmYWlscy5cbiAqL1xuYXBrU2lnbmluZ01ldGhvZHMuc2lnbldpdGhEZWZhdWx0Q2VydCA9IGFzeW5jIGZ1bmN0aW9uIHNpZ25XaXRoRGVmYXVsdENlcnQgKGFwaykge1xuICBsb2cuZGVidWcoYFNpZ25pbmcgJyR7YXBrfScgd2l0aCBkZWZhdWx0IGNlcnRgKTtcbiAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKGFwaykpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGAke2Fwa30gZmlsZSBkb2Vzbid0IGV4aXN0LmApO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBhcmdzID0gWydzaWduJyxcbiAgICAgICctLWtleScsIERFRkFVTFRfUFJJVkFURV9LRVksXG4gICAgICAnLS1jZXJ0JywgREVGQVVMVF9DRVJUSUZJQ0FURSxcbiAgICAgIGFwa107XG4gICAgYXdhaXQgdGhpcy5leGVjdXRlQXBrc2lnbmVyKGFyZ3MpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgQ2Fubm90IHVzZSBhcGtzaWduZXIgdG9vbCBmb3Igc2lnbmluZy4gRGVmYXVsdGluZyB0byBzaWduLmphci4gYCArXG4gICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZXJyLnN0ZGVyciB8fCBlcnIubWVzc2FnZX1gKTtcbiAgICBjb25zdCBzaWduUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLmhlbHBlckphclBhdGgsICdzaWduLmphcicpO1xuICAgIGNvbnN0IGZ1bGxDbWQgPSBbZ2V0SmF2YUZvck9zKCksICctamFyJywgc2lnblBhdGgsIGFwaywgJy0tb3ZlcnJpZGUnXTtcbiAgICBsb2cuZGVidWcoYFN0YXJ0aW5nIHNpZ24uamFyOiAke3F1b3RlKGZ1bGxDbWQpfWApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjKGZ1bGxDbWRbMF0sIGZ1bGxDbWQuc2xpY2UoMSkpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IHNpZ24gd2l0aCBkZWZhdWx0IGNlcnRpZmljYXRlLiBgICtcbiAgICAgICAgYE9yaWdpbmFsIGVycm9yICR7ZS5zdGRlcnIgfHwgZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxufTtcblxuLyoqXG4gKiAoUmUpc2lnbiB0aGUgZ2l2ZW4gYXBrIGZpbGUgb24gdGhlIGxvY2FsIGZpbGUgc3lzdGVtIHdpdGggYSBjdXN0b20gY2VydGlmaWNhdGUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwayAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGxvY2FsIGFwayBmaWxlLlxuICogQHRocm93cyB7RXJyb3J9IElmIHNpZ25pbmcgZmFpbHMuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLnNpZ25XaXRoQ3VzdG9tQ2VydCA9IGFzeW5jIGZ1bmN0aW9uIHNpZ25XaXRoQ3VzdG9tQ2VydCAoYXBrKSB7XG4gIGxvZy5kZWJ1ZyhgU2lnbmluZyAnJHthcGt9JyB3aXRoIGN1c3RvbSBjZXJ0YCk7XG4gIGlmICghKGF3YWl0IGZzLmV4aXN0cyh0aGlzLmtleXN0b3JlUGF0aCkpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBLZXlzdG9yZTogJHt0aGlzLmtleXN0b3JlUGF0aH0gZG9lc24ndCBleGlzdC5gKTtcbiAgfVxuICBpZiAoIShhd2FpdCBmcy5leGlzdHMoYXBrKSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYCcke2Fwa30nIGRvZXNuJ3QgZXhpc3QuYCk7XG4gIH1cblxuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZUFwa3NpZ25lcihbJ3NpZ24nLFxuICAgICAgJy0ta3MnLCB0aGlzLmtleXN0b3JlUGF0aCxcbiAgICAgICctLWtzLWtleS1hbGlhcycsIHRoaXMua2V5QWxpYXMsXG4gICAgICAnLS1rcy1wYXNzJywgYHBhc3M6JHt0aGlzLmtleXN0b3JlUGFzc3dvcmR9YCxcbiAgICAgICctLWtleS1wYXNzJywgYHBhc3M6JHt0aGlzLmtleVBhc3N3b3JkfWAsXG4gICAgICBhcGtdKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYENhbm5vdCB1c2UgYXBrc2lnbmVyIHRvb2wgZm9yIHNpZ25pbmcuIERlZmF1bHRpbmcgdG8gamFyc2lnbmVyLiBgICtcbiAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlcnIuc3RkZXJyIHx8IGVyci5tZXNzYWdlfWApO1xuICAgIHRyeSB7XG4gICAgICBpZiAoYXdhaXQgdW5zaWduQXBrKGFwaykpIHtcbiAgICAgICAgbG9nLmRlYnVnKGAnJHthcGt9JyBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgdW5zaWduZWRgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgJyR7YXBrfScgZG9lcyBub3QgbmVlZCB0byBiZSB1bnNpZ25lZGApO1xuICAgICAgfVxuICAgICAgY29uc3QgamFyc2lnbmVyID0gcGF0aC5yZXNvbHZlKGdldEphdmFIb21lKCksICdiaW4nLFxuICAgICAgICBgamFyc2lnbmVyJHtzeXN0ZW0uaXNXaW5kb3dzKCkgPyAnLmV4ZScgOiAnJ31gKTtcbiAgICAgIGNvbnN0IGZ1bGxDbWQgPSBbamFyc2lnbmVyLFxuICAgICAgICAnLXNpZ2FsZycsICdNRDV3aXRoUlNBJyxcbiAgICAgICAgJy1kaWdlc3RhbGcnLCAnU0hBMScsXG4gICAgICAgICcta2V5c3RvcmUnLCB0aGlzLmtleXN0b3JlUGF0aCxcbiAgICAgICAgJy1zdG9yZXBhc3MnLCB0aGlzLmtleXN0b3JlUGFzc3dvcmQsXG4gICAgICAgICcta2V5cGFzcycsIHRoaXMua2V5UGFzc3dvcmQsXG4gICAgICAgIGFwaywgdGhpcy5rZXlBbGlhc107XG4gICAgICBsb2cuZGVidWcoYFN0YXJ0aW5nIGphcnNpZ25lcjogJHtxdW90ZShmdWxsQ21kKX1gKTtcbiAgICAgIGF3YWl0IGV4ZWMoZnVsbENtZFswXSwgZnVsbENtZC5zbGljZSgxKSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3Qgc2lnbiB3aXRoIGN1c3RvbSBjZXJ0aWZpY2F0ZS4gYCArXG4gICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLnN0ZGVyciB8fCBlLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG59O1xuXG4vKipcbiAqIChSZSlzaWduIHRoZSBnaXZlbiBhcGsgZmlsZSBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW0gd2l0aCBlaXRoZXJcbiAqIGN1c3RvbSBvciBkZWZhdWx0IGNlcnRpZmljYXRlIGJhc2VkIG9uIF90aGlzLnVzZUtleXN0b3JlXyBwcm9wZXJ0eSB2YWx1ZVxuICogYW5kIFppcC1hbGlnbnMgaXQgYWZ0ZXIgc2lnbmluZy5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBwUGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGxvY2FsIC5hcGsocykgZmlsZS5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzaWduaW5nIGZhaWxzLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5zaWduID0gYXN5bmMgZnVuY3Rpb24gc2lnbiAoYXBwUGF0aCkge1xuICBpZiAoYXBwUGF0aC5lbmRzV2l0aChBUEtTX0VYVEVOU0lPTikpIHtcbiAgICBsZXQgbWVzc2FnZSA9ICdTaWduaW5nIG9mIC5hcGtzLWZpbGVzIGlzIG5vdCBzdXBwb3J0ZWQuICc7XG4gICAgaWYgKHRoaXMudXNlS2V5c3RvcmUpIHtcbiAgICAgIG1lc3NhZ2UgKz0gJ0NvbnNpZGVyIG1hbnVhbCBhcHBsaWNhdGlvbiBidW5kbGUgc2lnbmluZyB3aXRoIHRoZSBjdXN0b20ga2V5c3RvcmUgJyArXG4gICAgICAgIGBsaWtlIGl0IGlzIGRlc2NyaWJlZCBhdCAke0JVTkRMRVRPT0xfVFVUT1JJQUx9YDtcbiAgICB9IGVsc2Uge1xuICAgICAgbWVzc2FnZSArPSBgQ29uc2lkZXIgbWFudWFsIGFwcGxpY2F0aW9uIGJ1bmRsZSBzaWduaW5nIHdpdGggdGhlIGtleSBhdCAnJHtERUZBVUxUX1BSSVZBVEVfS0VZfScgYCArXG4gICAgICAgIGBhbmQgdGhlIGNlcnRpZmljYXRlIGF0ICcke0RFRkFVTFRfQ0VSVElGSUNBVEV9Jy4gUmVhZCAke0JVTkRMRVRPT0xfVFVUT1JJQUx9IGZvciBtb3JlIGRldGFpbHMuYDtcbiAgICB9XG4gICAgbG9nLndhcm4obWVzc2FnZSk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbGV0IGFwa3NpZ25lckZvdW5kID0gdHJ1ZTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBnZXRBcGtzaWduZXJGb3JPcyh0aGlzKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgYXBrc2lnbmVyRm91bmQgPSBmYWxzZTtcbiAgfVxuXG4gIGlmIChhcGtzaWduZXJGb3VuZCkge1xuICAgIC8vIGl0IGlzIG5lY2Vzc2FyeSB0byBhcHBseSB6aXBhbGlnbiBvbmx5IGJlZm9yZSBzaWduaW5nXG4gICAgLy8gaWYgYXBrc2lnbmVyIGlzIHVzZWQgb3Igb25seSBhZnRlciBzaWduaW5nIGlmIHdlIG9ubHkgaGF2ZVxuICAgIC8vIHNpZ24uamFyIHV0aWxpdHlcbiAgICBhd2FpdCB0aGlzLnppcEFsaWduQXBrKGFwcFBhdGgpO1xuICB9XG5cbiAgaWYgKHRoaXMudXNlS2V5c3RvcmUpIHtcbiAgICBhd2FpdCB0aGlzLnNpZ25XaXRoQ3VzdG9tQ2VydChhcHBQYXRoKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCB0aGlzLnNpZ25XaXRoRGVmYXVsdENlcnQoYXBwUGF0aCk7XG4gIH1cblxuICBpZiAoIWFwa3NpZ25lckZvdW5kKSB7XG4gICAgYXdhaXQgdGhpcy56aXBBbGlnbkFwayhhcHBQYXRoKTtcbiAgfVxufTtcblxuLyoqXG4gKiBQZXJmb3JtIHppcC1hbGlnbmluZyB0byB0aGUgZ2l2ZW4gbG9jYWwgYXBrIGZpbGUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwayAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGxvY2FsIGFwayBmaWxlLlxuICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgdGhlIGFwayBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgYWxpZ25lZFxuICogb3IgZmFsc2UgaWYgdGhlIGFwayBoYXMgYmVlbiBhbHJlYWR5IGFsaWduZWQuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgemlwLWFsaWduIGZhaWxzLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy56aXBBbGlnbkFwayA9IGFzeW5jIGZ1bmN0aW9uIHppcEFsaWduQXBrIChhcGspIHtcbiAgYXdhaXQgdGhpcy5pbml0WmlwQWxpZ24oKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKHRoaXMuYmluYXJpZXMuemlwYWxpZ24sIFsnLWMnLCAnNCcsIGFwa10pO1xuICAgIGxvZy5kZWJ1ZyhgJHthcGt9JyBpcyBhbHJlYWR5IHppcC1hbGlnbmVkLiBEb2luZyBub3RoaW5nYCk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmRlYnVnKGAnJHthcGt9JyBpcyBub3QgemlwLWFsaWduZWQuIEFsaWduaW5nYCk7XG4gIH1cbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy5hY2Nlc3MoYXBrLCBfZnMuV19PSyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBmaWxlIGF0ICcke2Fwa30nIGlzIG5vdCB3cml0ZWFibGUuIGAgK1xuICAgICAgYFBsZWFzZSBncmFudCB3cml0ZSBwZXJtaXNzaW9ucyB0byB0aGlzIGZpbGUgb3IgdG8gaXRzIHBhcmVudCBmb2xkZXIgJyR7cGF0aC5kaXJuYW1lKGFwayl9JyBgICtcbiAgICAgIGBmb3IgdGhlIEFwcGl1bSBwcm9jZXNzLCBzbyBpdCBjYW4gemlwLWFsaWduIHRoZSBmaWxlYCk7XG4gIH1cbiAgY29uc3QgYWxpZ25lZEFwayA9IGF3YWl0IHRlbXBEaXIucGF0aCh7cHJlZml4OiAnYXBwaXVtJywgc3VmZml4OiAnLnRtcCd9KTtcbiAgYXdhaXQgbWtkaXJwKHBhdGguZGlybmFtZShhbGlnbmVkQXBrKSk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYyh0aGlzLmJpbmFyaWVzLnppcGFsaWduLCBbJy1mJywgJzQnLCBhcGssIGFsaWduZWRBcGtdKTtcbiAgICBhd2FpdCBmcy5tdihhbGlnbmVkQXBrLCBhcGssIHsgbWtkaXJwOiB0cnVlIH0pO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhhbGlnbmVkQXBrKSkge1xuICAgICAgYXdhaXQgZnMudW5saW5rKGFsaWduZWRBcGspO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYHppcEFsaWduQXBrIGZhaWxlZC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5zdGRlcnIgfHwgZS5tZXNzYWdlfWApO1xuICB9XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IENlcnRDaGVja09wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcmVxdWlyZURlZmF1bHRDZXJ0IFt0cnVlXSBXaGV0aGVyIHRvIHJlcXVpcmUgdGhhdCB0aGUgZGVzdGluYXRpb24gQVBLXG4gKiBpcyBzaWduZWQgd2l0aCB0aGUgZGVmYXVsdCBBcHBpdW0gY2VydGlmaWNhdGUgb3IgYW55IHZhbGlkIGNlcnRpZmljYXRlLiBUaGlzIG9wdGlvblxuICogb25seSBoYXMgZWZmZWN0IGlmIGB1c2VLZXlzdG9yZWAgcHJvcGVydHkgaXMgdW5zZXQuXG4gKi9cblxuLyoqXG4gKiBDaGVjayBpZiB0aGUgYXBwIGlzIGFscmVhZHkgc2lnbmVkIHdpdGggdGhlIGRlZmF1bHQgQXBwaXVtIGNlcnRpZmljYXRlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBQYXRoIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgLmFwayhzKSBmaWxlLlxuICogQHBhcmFtIHtzdHJpbmd9IHBnayAtIFRoZSBuYW1lIG9mIGFwcGxpY2F0aW9uIHBhY2thZ2UuXG4gKiBAcGFyYW0ge0NlcnRDaGVja09wdGlvbnN9IG9wdHMgLSBDZXJ0aWZpY2F0ZSBjaGVja2luZyBvcHRpb25zXG4gKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGdpdmVuIGFwcGxpY2F0aW9uIGlzIGFscmVhZHkgc2lnbmVkLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5jaGVja0Fwa0NlcnQgPSBhc3luYyBmdW5jdGlvbiBjaGVja0Fwa0NlcnQgKGFwcFBhdGgsIHBrZywgb3B0cyA9IHt9KSB7XG4gIGxvZy5kZWJ1ZyhgQ2hlY2tpbmcgYXBwIGNlcnQgZm9yICR7YXBwUGF0aH1gKTtcbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMoYXBwUGF0aCkpIHtcbiAgICBsb2cuZGVidWcoYCcke2FwcFBhdGh9JyBkb2VzIG5vdCBleGlzdGApO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGlmICh0aGlzLnVzZUtleXN0b3JlKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuY2hlY2tDdXN0b21BcGtDZXJ0KGFwcFBhdGgsIHBrZyk7XG4gIH1cblxuICBpZiAocGF0aC5leHRuYW1lKGFwcFBhdGgpID09PSBBUEtTX0VYVEVOU0lPTikge1xuICAgIGFwcFBhdGggPSBhd2FpdCB0aGlzLmV4dHJhY3RCYXNlQXBrKGFwcFBhdGgpO1xuICB9XG5cbiAgY29uc3Qge1xuICAgIHJlcXVpcmVEZWZhdWx0Q2VydCA9IHRydWUsXG4gIH0gPSBvcHRzO1xuICB0cnkge1xuICAgIGF3YWl0IGdldEFwa3NpZ25lckZvck9zKHRoaXMpO1xuICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IHRoaXMuZXhlY3V0ZUFwa3NpZ25lcihbJ3ZlcmlmeScsICctLXByaW50LWNlcnRzJywgYXBwUGF0aF0pO1xuICAgIGlmIChfLmluY2x1ZGVzKG91dHB1dCwgREVGQVVMVF9DRVJUX0RJR0VTVCkpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgJyR7YXBwUGF0aH0nIGlzIHNpZ25lZCB3aXRoIHRoZSBkZWZhdWx0IGNlcnRpZmljYXRlYCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZyhgJyR7YXBwUGF0aH0nIGlzIHNpZ25lZCB3aXRoIGEgbm9uLWRlZmF1bHQgY2VydGlmaWNhdGVgKTtcbiAgICB9XG4gICAgcmV0dXJuICFyZXF1aXJlRGVmYXVsdENlcnQgfHwgXy5pbmNsdWRlcyhvdXRwdXQsIERFRkFVTFRfQ0VSVF9ESUdFU1QpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICAvLyBjaGVjayBpZiB0aGVyZSBpcyBubyBzaWduYXR1cmVcbiAgICBpZiAoXy5pbmNsdWRlcyhlcnIuc3RkZXJyLCBBUEtTSUdORVJfVkVSSUZZX0ZBSUwpKSB7XG4gICAgICBsb2cuZGVidWcoYCcke2FwcFBhdGh9JyBpcyBub3Qgc2lnbmVkYCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGxvZy53YXJuKGBDYW5ub3QgdXNlIGFwa3NpZ25lciB0b29sIGZvciBzaWduYXR1cmUgdmVyaWZpY2F0aW9uLiBgICtcbiAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZyhgRGVmYXVsdGluZyB0byB2ZXJpZnkuamFyYCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYyhnZXRKYXZhRm9yT3MoKSwgWyctamFyJywgcGF0aC5yZXNvbHZlKHRoaXMuaGVscGVySmFyUGF0aCwgJ3ZlcmlmeS5qYXInKSwgYXBwUGF0aF0pO1xuICAgIGxvZy5kZWJ1ZyhgJyR7YXBwUGF0aH0nIGlzIHNpZ25lZCB3aXRoIHRoZSBkZWZhdWx0IGNlcnRpZmljYXRlYCk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmICghcmVxdWlyZURlZmF1bHRDZXJ0ICYmIF8uaW5jbHVkZXMoXy50b0xvd2VyKGVyci5zdGRlcnIpLCAnaW52YWxpZCBjZXJ0JykpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgJyR7YXBwUGF0aH0nIGlzIHNpZ25lZCB3aXRoIGEgbm9uLWRlZmF1bHQgY2VydGlmaWNhdGVgKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYCcke2FwcFBhdGh9JyBpcyBub3Qgc2lnbmVkIHdpdGggdGhlIGRlZmF1bHQgY2VydGlmaWNhdGVgKTtcbiAgICBsb2cuZGVidWcoZXJyLnN0ZGVyciA/IGVyci5zdGRlcnIgOiBlcnIubWVzc2FnZSk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59O1xuXG4vKipcbiAqIENoZWNrIGlmIHRoZSBhcHAgaXMgYWxyZWFkeSBzaWduZWQgd2l0aCBhIGN1c3RvbSBjZXJ0aWZpY2F0ZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBwUGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGxvY2FsIGFwayhzKSBmaWxlLlxuICogQHBhcmFtIHtzdHJpbmd9IHBnayAtIFRoZSBuYW1lIG9mIGFwcGxpY2F0aW9uIHBhY2thZ2UuXG4gKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGdpdmVuIGFwcGxpY2F0aW9uIGlzIGFscmVhZHkgc2lnbmVkIHdpdGggYSBjdXN0b20gY2VydGlmaWNhdGUuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLmNoZWNrQ3VzdG9tQXBrQ2VydCA9IGFzeW5jIGZ1bmN0aW9uIGNoZWNrQ3VzdG9tQXBrQ2VydCAoYXBwUGF0aCwgcGtnKSB7XG4gIGxvZy5kZWJ1ZyhgQ2hlY2tpbmcgY3VzdG9tIGFwcCBjZXJ0IGZvciAke2FwcFBhdGh9YCk7XG5cbiAgaWYgKHBhdGguZXh0bmFtZShhcHBQYXRoKSA9PT0gQVBLU19FWFRFTlNJT04pIHtcbiAgICBhcHBQYXRoID0gYXdhaXQgdGhpcy5leHRyYWN0QmFzZUFwayhhcHBQYXRoKTtcbiAgfVxuXG4gIGxldCBoID0gJ2EtZkEtRjAtOSc7XG4gIGxldCBtZDVTdHIgPSBbYC4qTUQ1LiooKD86WyR7aH1dezJ9Oil7MTV9WyR7aH1dezJ9KWBdO1xuICBsZXQgbWQ1ID0gbmV3IFJlZ0V4cChtZDVTdHIsICdtaScpO1xuICBsZXQga2V5dG9vbCA9IHBhdGgucmVzb2x2ZShnZXRKYXZhSG9tZSgpLCAnYmluJywgYGtleXRvb2wke3N5c3RlbS5pc1dpbmRvd3MoKSA/ICcuZXhlJyA6ICcnfWApO1xuICBsZXQga2V5c3RvcmVIYXNoID0gYXdhaXQgdGhpcy5nZXRLZXlzdG9yZU1kNShrZXl0b29sLCBtZDUpO1xuICByZXR1cm4gYXdhaXQgdGhpcy5jaGVja0Fwa0tleXN0b3JlTWF0Y2goa2V5dG9vbCwgbWQ1LCBrZXlzdG9yZUhhc2gsIHBrZywgYXBwUGF0aCk7XG59O1xuXG4vKipcbiAqIEdldCB0aGUgTUQ1IGhhc2ggb2YgdGhlIGtleXN0b3JlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBrZXl0b29sIC0gVGhlIG5hbWUgb2YgdGhlIGtleXRvb2wgdXRpbGl0eS5cbiAqIEBwYXJhbSB7UmVnRXhwfSBtZDVyZSAtIFRoZSBwYXR0ZXJuIHVzZWQgdG8gbWF0Y2ggdGhlIHJlc3VsdCBpbiBfa2V5dG9vbF8gb3V0cHV0LlxuICogQHJldHVybiB7P3N0cmluZ30gS2V5c3RvcmUgTUQ1IGhhc2ggb3IgX251bGxfIGlmIHRoZSBoYXNoIGNhbm5vdCBiZSBwYXJzZWQuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgZ2V0dGluZyBrZXlzdG9yZSBNRDUgaGFzaCBmYWlscy5cbiAqL1xuYXBrU2lnbmluZ01ldGhvZHMuZ2V0S2V5c3RvcmVNZDUgPSBhc3luYyBmdW5jdGlvbiBnZXRLZXlzdG9yZU1kNSAoa2V5dG9vbCwgbWQ1cmUpIHtcbiAgbG9nLmRlYnVnKCdQcmludGluZyBrZXlzdG9yZSBtZDUuJyk7XG4gIHRyeSB7XG4gICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyhrZXl0b29sLCBbJy12JywgJy1saXN0JyxcbiAgICAgICctYWxpYXMnLCB0aGlzLmtleUFsaWFzLFxuICAgICAgJy1rZXlzdG9yZScsIHRoaXMua2V5c3RvcmVQYXRoLFxuICAgICAgJy1zdG9yZXBhc3MnLCB0aGlzLmtleXN0b3JlUGFzc3dvcmRdKTtcbiAgICBsZXQga2V5c3RvcmVIYXNoID0gbWQ1cmUuZXhlYyhzdGRvdXQpO1xuICAgIGtleXN0b3JlSGFzaCA9IGtleXN0b3JlSGFzaCA/IGtleXN0b3JlSGFzaFsxXSA6IG51bGw7XG4gICAgbG9nLmRlYnVnKGBLZXlzdG9yZSBNRDU6ICR7a2V5c3RvcmVIYXNofWApO1xuICAgIHJldHVybiBrZXlzdG9yZUhhc2g7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYGdldEtleXN0b3JlTWQ1IGZhaWxlZC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICB9XG59O1xuXG4vKipcbiAqIENoZWNrIGlmIHRoZSBNRDUgaGFzaCBvZiB0aGUgcGFydGljdWxhciBhcHBsaWNhdGlvbiBtYXRjaGVzIHRvIHRoZSBnaXZlbiBoYXNoLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBrZXl0b29sIC0gVGhlIG5hbWUgb2YgdGhlIGtleXRvb2wgdXRpbGl0eS5cbiAqIEBwYXJhbSB7UmVnRXhwfSBtZDVyZSAtIFRoZSBwYXR0ZXJuIHVzZWQgdG8gbWF0Y2ggdGhlIHJlc3VsdCBpbiBfa2V5dG9vbF8gb3V0cHV0LlxuICogQHBhcmFtIHtzdHJpbmd9IGtleXN0b3JlSGFzaCAtIFRoZSBleHBlY3RlZCBoYXNoIHZhbHVlLlxuICogQHBhcmFtIHtzdHJpbmd9IHBrZyAtIFRoZSBuYW1lIG9mIHRoZSBpbnN0YWxsZWQgcGFja2FnZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGsgLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBleGlzdGluZyBhcGsgZmlsZS5cbiAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgYm90aCBoYXNoZXMgYXJlIGVxdWFsLlxuICogQHRocm93cyB7RXJyb3J9IElmIGdldHRpbmcga2V5c3RvcmUgTUQ1IGhhc2ggZmFpbHMuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLmNoZWNrQXBrS2V5c3RvcmVNYXRjaCA9IGFzeW5jIGZ1bmN0aW9uIGNoZWNrQXBrS2V5c3RvcmVNYXRjaCAoa2V5dG9vbCwgbWQ1cmUsIGtleXN0b3JlSGFzaCwgcGtnLCBhcGspIHtcbiAgbGV0IGVudHJ5SGFzaCA9IG51bGw7XG4gIGxldCByc2EgPSAvXk1FVEEtSU5GXFwvLipcXC5bclJdW3NTXVthQV0kLztcbiAgbGV0IGZvdW5kS2V5c3RvcmVNYXRjaCA9IGZhbHNlO1xuXG4gIC8vZm9yIChsZXQgZW50cnkgb2YgZW50cmllcykge1xuICBhd2FpdCB6aXAucmVhZEVudHJpZXMoYXBrLCBhc3luYyAoe2VudHJ5LCBleHRyYWN0RW50cnlUb30pID0+IHtcbiAgICBlbnRyeSA9IGVudHJ5LmZpbGVOYW1lO1xuICAgIGlmICghcnNhLnRlc3QoZW50cnkpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgRW50cnk6ICR7ZW50cnl9YCk7XG4gICAgbGV0IGVudHJ5UGF0aCA9IHBhdGguam9pbih0aGlzLnRtcERpciwgcGtnLCAnY2VydCcpO1xuICAgIGxvZy5kZWJ1ZyhgZW50cnlQYXRoOiAke2VudHJ5UGF0aH1gKTtcbiAgICBsZXQgZW50cnlGaWxlID0gcGF0aC5qb2luKGVudHJ5UGF0aCwgZW50cnkpO1xuICAgIGxvZy5kZWJ1ZyhgZW50cnlGaWxlOiAke2VudHJ5RmlsZX1gKTtcbiAgICAvLyBlbnN1cmUgL3RtcC9wa2cvY2VydC8gZG9lc24ndCBleGlzdCBvciBleHRyYWN0IHdpbGwgZmFpbC5cbiAgICBhd2FpdCBmcy5yaW1yYWYoZW50cnlQYXRoKTtcbiAgICAvLyBNRVRBLUlORi9DRVJULlJTQVxuICAgIGF3YWl0IGV4dHJhY3RFbnRyeVRvKGVudHJ5UGF0aCk7XG4gICAgbG9nLmRlYnVnKCdleHRyYWN0ZWQhJyk7XG4gICAgLy8gY2hlY2sgZm9yIG1hdGNoXG4gICAgbG9nLmRlYnVnKCdQcmludGluZyBhcGsgbWQ1LicpO1xuICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoa2V5dG9vbCwgWyctdicsICctcHJpbnRjZXJ0JywgJy1maWxlJywgZW50cnlGaWxlXSk7XG4gICAgZW50cnlIYXNoID0gbWQ1cmUuZXhlYyhzdGRvdXQpO1xuICAgIGVudHJ5SGFzaCA9IGVudHJ5SGFzaCA/IGVudHJ5SGFzaFsxXSA6IG51bGw7XG4gICAgbG9nLmRlYnVnKGBlbnRyeUhhc2ggTUQ1OiAke2VudHJ5SGFzaH1gKTtcbiAgICBsb2cuZGVidWcoYGtleXN0b3JlIE1ENTogJHtrZXlzdG9yZUhhc2h9YCk7XG4gICAgbGV0IG1hdGNoZXNLZXlzdG9yZSA9IGVudHJ5SGFzaCAmJiBlbnRyeUhhc2ggPT09IGtleXN0b3JlSGFzaDtcbiAgICBsb2cuZGVidWcoYE1hdGNoZXMga2V5c3RvcmU/ICR7bWF0Y2hlc0tleXN0b3JlfWApO1xuXG4gICAgLy8gSWYgd2UgaGF2ZSBhIGtleXN0b3JlIG1hdGNoLCBzdG9wIGl0ZXJhdGluZ1xuICAgIGlmIChtYXRjaGVzS2V5c3RvcmUpIHtcbiAgICAgIGZvdW5kS2V5c3RvcmVNYXRjaCA9IHRydWU7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIGZvdW5kS2V5c3RvcmVNYXRjaDtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGFwa1NpZ25pbmdNZXRob2RzO1xuIl0sImZpbGUiOiJsaWIvdG9vbHMvYXBrLXNpZ25pbmcuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
