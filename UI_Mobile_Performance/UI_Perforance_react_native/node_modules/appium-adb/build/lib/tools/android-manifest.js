"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger.js"));

var _helpers = require("../helpers.js");

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _shellQuote = require("shell-quote");

var _adbkitApkreader = _interopRequireDefault(require("adbkit-apkreader"));

let manifestMethods = {};

manifestMethods.packageAndLaunchActivityFromManifest = async function packageAndLaunchActivityFromManifest(appPath) {
  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  const apkReader = await _adbkitApkreader.default.open(appPath);
  const manifest = await apkReader.readManifest();
  const {
    pkg,
    activity
  } = (0, _helpers.parseManifest)(manifest);

  _logger.default.info(`Package name: '${pkg}'`);

  _logger.default.info(`Main activity name: '${activity}'`);

  return {
    apkPackage: pkg,
    apkActivity: activity
  };
};

manifestMethods.targetSdkVersionFromManifest = async function targetSdkVersionFromManifest(appPath) {
  _logger.default.debug(`Extracting target SDK version of '${appPath}'`);

  const originalAppPath = appPath;

  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  const getTargetSdkViaApkReader = async () => {
    const apkReader = await _adbkitApkreader.default.open(appPath);
    const manifest = await apkReader.readManifest();

    if (manifest.usesSdk && _lodash.default.isInteger(manifest.usesSdk.targetSdkVersion)) {
      return manifest.usesSdk.targetSdkVersion;
    }

    throw new Error('Cannot find the information about targetSdkVersion in the manifest');
  };

  const getTargetSdkViaAapt = async () => {
    await this.initAapt();
    const args = ['dump', 'badging', appPath];
    const {
      stdout
    } = await (0, _teen_process.exec)(this.binaries.aapt, args);
    const targetSdkVersion = /targetSdkVersion:'([^']+)'/g.exec(stdout);

    if (!targetSdkVersion) {
      _logger.default.debug(stdout);

      throw new Error('Cannot parse the command output');
    }

    return parseInt(targetSdkVersion[1], 10);
  };

  const versionGetters = [['ApkReader', getTargetSdkViaApkReader], ['aapt', getTargetSdkViaAapt]];

  for (const [toolName, versionGetter] of versionGetters) {
    try {
      return await versionGetter();
    } catch (e) {
      _logger.default.info(`Cannot extract targetSdkVersion of '${originalAppPath}' using ${toolName}. ` + `Original error: ${e.message}`);
    }
  }

  throw new Error(`Cannot extract the target SDK version number of '${originalAppPath}' using either of ` + `${JSON.stringify(versionGetters.map(pair => pair[0]))} tools. ` + `Check the server log for more details`);
};

manifestMethods.targetSdkVersionUsingPKG = async function targetSdkVersionUsingPKG(pkg, cmdOutput = null) {
  let stdout = cmdOutput || (await this.shell(['dumpsys', 'package', pkg]));
  let targetSdkVersion = new RegExp(/targetSdk=([^\s\s]+)/g).exec(stdout);

  if (targetSdkVersion && targetSdkVersion.length >= 2) {
    targetSdkVersion = targetSdkVersion[1];
  } else {
    targetSdkVersion = 0;
  }

  return parseInt(targetSdkVersion, 10);
};

manifestMethods.compileManifest = async function compileManifest(manifest, manifestPackage, targetPackage) {
  const {
    platform,
    platformPath
  } = await (0, _helpers.getAndroidPlatformAndPath)();

  if (!platform) {
    throw new Error('Cannot compile the manifest. The required platform does not exist (API level >= 17)');
  }

  const resultPath = `${manifest}.apk`;

  const androidJarPath = _path.default.resolve(platformPath, 'android.jar');

  if (await _appiumSupport.fs.exists(resultPath)) {
    await _appiumSupport.fs.rimraf(resultPath);
  }

  try {
    await this.initAapt2();
    const args = ['link', '-o', resultPath, '--manifest', manifest, '--rename-manifest-package', manifestPackage, '--rename-instrumentation-target-package', targetPackage, '-I', androidJarPath, '-v'];

    _logger.default.debug(`Compiling the manifest using '${(0, _shellQuote.quote)([this.binaries.aapt2, ...args])}'`);

    await (0, _teen_process.exec)(this.binaries.aapt2, args);
  } catch (e) {
    _logger.default.debug('Cannot compile the manifest using aapt2. Defaulting to aapt. ' + `Original error: ${e.stderr || e.message}`);

    await this.initAapt();
    const args = ['package', '-M', manifest, '--rename-manifest-package', manifestPackage, '--rename-instrumentation-target-package', targetPackage, '-I', androidJarPath, '-F', resultPath, '-f'];

    _logger.default.debug(`Compiling the manifest using '${(0, _shellQuote.quote)([this.binaries.aapt, ...args])}'`);

    try {
      await (0, _teen_process.exec)(this.binaries.aapt, args);
    } catch (e1) {
      throw new Error(`Cannot compile the manifest. Original error: ${e1.stderr || e1.message}`);
    }
  }

  _logger.default.debug(`Compiled the manifest at '${resultPath}'`);
};

manifestMethods.insertManifest = async function insertManifest(manifest, srcApk, dstApk) {
  _logger.default.debug(`Inserting manifest '${manifest}', src: '${srcApk}', dst: '${dstApk}'`);

  await _appiumSupport.zip.assertValidZip(srcApk);
  await (0, _helpers.unzipFile)(`${manifest}.apk`);

  const manifestName = _path.default.basename(manifest);

  try {
    await this.initAapt();
    await _appiumSupport.fs.copyFile(srcApk, dstApk);

    _logger.default.debug('Moving manifest');

    try {
      await (0, _teen_process.exec)(this.binaries.aapt, ['remove', dstApk, manifestName]);
    } catch (ign) {}

    await (0, _teen_process.exec)(this.binaries.aapt, ['add', dstApk, manifestName], {
      cwd: _path.default.dirname(manifest)
    });
  } catch (e) {
    _logger.default.debug('Cannot insert manifest using aapt. Defaulting to zip. ' + `Original error: ${e.stderr || e.message}`);

    const tmpRoot = await _appiumSupport.tempDir.openDir();

    try {
      _logger.default.debug(`Extracting the source apk at '${srcApk}'`);

      await _appiumSupport.zip.extractAllTo(srcApk, tmpRoot);

      _logger.default.debug('Moving manifest');

      await _appiumSupport.fs.mv(manifest, _path.default.resolve(tmpRoot, manifestName));

      _logger.default.debug(`Collecting the destination apk at '${dstApk}'`);

      await _appiumSupport.zip.toArchive(dstApk, {
        cwd: tmpRoot
      });
    } finally {
      await _appiumSupport.fs.rimraf(tmpRoot);
    }
  }

  _logger.default.debug(`Manifest insertion into '${dstApk}' is completed`);
};

manifestMethods.hasInternetPermissionFromManifest = async function hasInternetPermissionFromManifest(appPath) {
  _logger.default.debug(`Checking if '${appPath}' requires internet access permission in the manifest`);

  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  const apkReader = await _adbkitApkreader.default.open(appPath);
  const manifest = await apkReader.readManifest();
  return (manifest.usesPermissions || []).some(({
    name
  }) => name === 'android.permission.INTERNET');
};

var _default = manifestMethods;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9hbmRyb2lkLW1hbmlmZXN0LmpzIl0sIm5hbWVzIjpbIm1hbmlmZXN0TWV0aG9kcyIsInBhY2thZ2VBbmRMYXVuY2hBY3Rpdml0eUZyb21NYW5pZmVzdCIsImFwcFBhdGgiLCJlbmRzV2l0aCIsIkFQS1NfRVhURU5TSU9OIiwiZXh0cmFjdEJhc2VBcGsiLCJhcGtSZWFkZXIiLCJBcGtSZWFkZXIiLCJvcGVuIiwibWFuaWZlc3QiLCJyZWFkTWFuaWZlc3QiLCJwa2ciLCJhY3Rpdml0eSIsImxvZyIsImluZm8iLCJhcGtQYWNrYWdlIiwiYXBrQWN0aXZpdHkiLCJ0YXJnZXRTZGtWZXJzaW9uRnJvbU1hbmlmZXN0IiwiZGVidWciLCJvcmlnaW5hbEFwcFBhdGgiLCJnZXRUYXJnZXRTZGtWaWFBcGtSZWFkZXIiLCJ1c2VzU2RrIiwiXyIsImlzSW50ZWdlciIsInRhcmdldFNka1ZlcnNpb24iLCJFcnJvciIsImdldFRhcmdldFNka1ZpYUFhcHQiLCJpbml0QWFwdCIsImFyZ3MiLCJzdGRvdXQiLCJiaW5hcmllcyIsImFhcHQiLCJleGVjIiwicGFyc2VJbnQiLCJ2ZXJzaW9uR2V0dGVycyIsInRvb2xOYW1lIiwidmVyc2lvbkdldHRlciIsImUiLCJtZXNzYWdlIiwiSlNPTiIsInN0cmluZ2lmeSIsIm1hcCIsInBhaXIiLCJ0YXJnZXRTZGtWZXJzaW9uVXNpbmdQS0ciLCJjbWRPdXRwdXQiLCJzaGVsbCIsIlJlZ0V4cCIsImxlbmd0aCIsImNvbXBpbGVNYW5pZmVzdCIsIm1hbmlmZXN0UGFja2FnZSIsInRhcmdldFBhY2thZ2UiLCJwbGF0Zm9ybSIsInBsYXRmb3JtUGF0aCIsInJlc3VsdFBhdGgiLCJhbmRyb2lkSmFyUGF0aCIsInBhdGgiLCJyZXNvbHZlIiwiZnMiLCJleGlzdHMiLCJyaW1yYWYiLCJpbml0QWFwdDIiLCJhYXB0MiIsInN0ZGVyciIsImUxIiwiaW5zZXJ0TWFuaWZlc3QiLCJzcmNBcGsiLCJkc3RBcGsiLCJ6aXAiLCJhc3NlcnRWYWxpZFppcCIsIm1hbmlmZXN0TmFtZSIsImJhc2VuYW1lIiwiY29weUZpbGUiLCJpZ24iLCJjd2QiLCJkaXJuYW1lIiwidG1wUm9vdCIsInRlbXBEaXIiLCJvcGVuRGlyIiwiZXh0cmFjdEFsbFRvIiwibXYiLCJ0b0FyY2hpdmUiLCJoYXNJbnRlcm5ldFBlcm1pc3Npb25Gcm9tTWFuaWZlc3QiLCJ1c2VzUGVybWlzc2lvbnMiLCJzb21lIiwibmFtZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFJQSxlQUFlLEdBQUcsRUFBdEI7O0FBZ0JBQSxlQUFlLENBQUNDLG9DQUFoQixHQUF1RCxlQUFlQSxvQ0FBZixDQUFxREMsT0FBckQsRUFBOEQ7QUFDbkgsTUFBSUEsT0FBTyxDQUFDQyxRQUFSLENBQWlCQyx1QkFBakIsQ0FBSixFQUFzQztBQUNwQ0YsSUFBQUEsT0FBTyxHQUFHLE1BQU0sS0FBS0csY0FBTCxDQUFvQkgsT0FBcEIsQ0FBaEI7QUFDRDs7QUFFRCxRQUFNSSxTQUFTLEdBQUcsTUFBTUMseUJBQVVDLElBQVYsQ0FBZU4sT0FBZixDQUF4QjtBQUNBLFFBQU1PLFFBQVEsR0FBRyxNQUFNSCxTQUFTLENBQUNJLFlBQVYsRUFBdkI7QUFDQSxRQUFNO0FBQUNDLElBQUFBLEdBQUQ7QUFBTUMsSUFBQUE7QUFBTixNQUFrQiw0QkFBY0gsUUFBZCxDQUF4Qjs7QUFDQUksa0JBQUlDLElBQUosQ0FBVSxrQkFBaUJILEdBQUksR0FBL0I7O0FBQ0FFLGtCQUFJQyxJQUFKLENBQVUsd0JBQXVCRixRQUFTLEdBQTFDOztBQUNBLFNBQU87QUFDTEcsSUFBQUEsVUFBVSxFQUFFSixHQURQO0FBRUxLLElBQUFBLFdBQVcsRUFBRUo7QUFGUixHQUFQO0FBSUQsQ0FkRDs7QUF3QkFaLGVBQWUsQ0FBQ2lCLDRCQUFoQixHQUErQyxlQUFlQSw0QkFBZixDQUE2Q2YsT0FBN0MsRUFBc0Q7QUFDbkdXLGtCQUFJSyxLQUFK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SixDQUFXLHNDQUFxQ2dELE1BQU8sR0FBdkQ7O0FBQ0EsWUFBTUMsbUJBQUlhLFNBQUosQ0FBY2QsTUFBZCxFQUFzQjtBQUMxQk8sUUFBQUEsR0FBRyxFQUFFRTtBQURxQixPQUF0QixDQUFOO0FBR0QsS0FaRCxTQVlVO0FBQ1IsWUFBTWxCLGtCQUFHRSxNQUFILENBQVVnQixPQUFWLENBQU47QUFDRDtBQUNGOztBQUNEOUQsa0JBQUlLLEtBQUosQ0FBVyw0QkFBMkJnRCxNQUFPLGdCQUE3QztBQUNELENBdENEOztBQThDQWxFLGVBQWUsQ0FBQ2lGLGlDQUFoQixHQUFvRCxlQUFlQSxpQ0FBZixDQUFrRC9FLE9BQWxELEVBQTJEO0FBQzdHVyxrQkFBSUssS0FBSixDQUFXLGdCQUFlaEIsT0FBUSx1REFBbEM7O0FBQ0EsTUFBSUEsT0FBTyxDQUFDQyxRQUFSLENBQWlCQyx1QkFBakIsQ0FBSixFQUFzQztBQUNwQ0YsSUFBQUEsT0FBTyxHQUFHLE1BQU0sS0FBS0csY0FBTCxDQUFvQkgsT0FBcEIsQ0FBaEI7QUFDRDs7QUFFRCxRQUFNSSxTQUFTLEdBQUcsTUFBTUMseUJBQVVDLElBQVYsQ0FBZU4sT0FBZixDQUF4QjtBQUNBLFFBQU1PLFFBQVEsR0FBRyxNQUFNSCxTQUFTLENBQUNJLFlBQVYsRUFBdkI7QUFDQSxTQUFPLENBQUNELFFBQVEsQ0FBQ3lFLGVBQVQsSUFBNEIsRUFBN0IsRUFBaUNDLElBQWpDLENBQXNDLENBQUM7QUFBQ0MsSUFBQUE7QUFBRCxHQUFELEtBQVlBLElBQUksS0FBSyw2QkFBM0QsQ0FBUDtBQUNELENBVEQ7O2VBV2VwRixlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlci5qcyc7XG5pbXBvcnQge1xuICBnZXRBbmRyb2lkUGxhdGZvcm1BbmRQYXRoLCB1bnppcEZpbGUsXG4gIEFQS1NfRVhURU5TSU9OLCBwYXJzZU1hbmlmZXN0IH0gZnJvbSAnLi4vaGVscGVycy5qcyc7XG5pbXBvcnQgeyBmcywgemlwLCB0ZW1wRGlyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgcXVvdGUgfSBmcm9tICdzaGVsbC1xdW90ZSc7XG5pbXBvcnQgQXBrUmVhZGVyIGZyb20gJ2FkYmtpdC1hcGtyZWFkZXInO1xuXG5sZXQgbWFuaWZlc3RNZXRob2RzID0ge307XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gQVBLSW5mb1xuICogQHByb3BlcnR5IHtzdHJpbmd9IGFwa1BhY2thZ2UgLSBUaGUgbmFtZSBvZiBhcHBsaWNhdGlvbiBwYWNrYWdlLCBmb3IgZXhhbXBsZSAnY29tLmFjbWUuYXBwJy5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBhcGtBY3Rpdml0eSAtIFRoZSBuYW1lIG9mIG1haW4gYXBwbGljYXRpb24gYWN0aXZpdHkuXG4gKi9cblxuLyoqXG4gKiBFeHRyYWN0IHBhY2thZ2UgYW5kIG1haW4gYWN0aXZpdHkgbmFtZSBmcm9tIGFwcGxpY2F0aW9uIG1hbmlmZXN0LlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBQYXRoIC0gVGhlIGZ1bGwgcGF0aCB0byBhcHBsaWNhdGlvbiAuYXBrKHMpIHBhY2thZ2VcbiAqIEByZXR1cm4ge0FQS0luZm99IFRoZSBwYXJzZWQgYXBwbGljYXRpb24gaW5mby5cbiAqIEB0aHJvd3Mge2Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgZ2V0dGluZyB0aGUgZGF0YSBmcm9tIHRoZSBnaXZlblxuICogICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uIHBhY2thZ2UuXG4gKi9cbm1hbmlmZXN0TWV0aG9kcy5wYWNrYWdlQW5kTGF1bmNoQWN0aXZpdHlGcm9tTWFuaWZlc3QgPSBhc3luYyBmdW5jdGlvbiBwYWNrYWdlQW5kTGF1bmNoQWN0aXZpdHlGcm9tTWFuaWZlc3QgKGFwcFBhdGgpIHtcbiAgaWYgKGFwcFBhdGguZW5kc1dpdGgoQVBLU19FWFRFTlNJT04pKSB7XG4gICAgYXBwUGF0aCA9IGF3YWl0IHRoaXMuZXh0cmFjdEJhc2VBcGsoYXBwUGF0aCk7XG4gIH1cblxuICBjb25zdCBhcGtSZWFkZXIgPSBhd2FpdCBBcGtSZWFkZXIub3BlbihhcHBQYXRoKTtcbiAgY29uc3QgbWFuaWZlc3QgPSBhd2FpdCBhcGtSZWFkZXIucmVhZE1hbmlmZXN0KCk7XG4gIGNvbnN0IHtwa2csIGFjdGl2aXR5fSA9IHBhcnNlTWFuaWZlc3QobWFuaWZlc3QpO1xuICBsb2cuaW5mbyhgUGFja2FnZSBuYW1lOiAnJHtwa2d9J2ApO1xuICBsb2cuaW5mbyhgTWFpbiBhY3Rpdml0eSBuYW1lOiAnJHthY3Rpdml0eX0nYCk7XG4gIHJldHVybiB7XG4gICAgYXBrUGFja2FnZTogcGtnLFxuICAgIGFwa0FjdGl2aXR5OiBhY3Rpdml0eSxcbiAgfTtcbn07XG5cbi8qKlxuICogRXh0cmFjdCB0YXJnZXQgU0RLIHZlcnNpb24gZnJvbSBhcHBsaWNhdGlvbiBtYW5pZmVzdC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBwUGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gLmFwayhzKSBwYWNrYWdlLlxuICogQHJldHVybiB7bnVtYmVyfSBUaGUgdmVyc2lvbiBvZiB0aGUgdGFyZ2V0IFNESy5cbiAqIEB0aHJvd3Mge2Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgZ2V0dGluZyB0aGUgZGF0YSBmcm9tIHRoZSBnaXZlblxuICogICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uIHBhY2thZ2UuXG4gKi9cbm1hbmlmZXN0TWV0aG9kcy50YXJnZXRTZGtWZXJzaW9uRnJvbU1hbmlmZXN0ID0gYXN5bmMgZnVuY3Rpb24gdGFyZ2V0U2RrVmVyc2lvbkZyb21NYW5pZmVzdCAoYXBwUGF0aCkge1xuICBsb2cuZGVidWcoYEV4dHJhY3RpbmcgdGFyZ2V0IFNESyB2ZXJzaW9uIG9mICcke2FwcFBhdGh9J2ApO1xuICBjb25zdCBvcmlnaW5hbEFwcFBhdGggPSBhcHBQYXRoO1xuICBpZiAoYXBwUGF0aC5lbmRzV2l0aChBUEtTX0VYVEVOU0lPTikpIHtcbiAgICBhcHBQYXRoID0gYXdhaXQgdGhpcy5leHRyYWN0QmFzZUFwayhhcHBQYXRoKTtcbiAgfVxuXG4gIGNvbnN0IGdldFRhcmdldFNka1ZpYUFwa1JlYWRlciA9IGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBhcGtSZWFkZXIgPSBhd2FpdCBBcGtSZWFkZXIub3BlbihhcHBQYXRoKTtcbiAgICBjb25zdCBtYW5pZmVzdCA9IGF3YWl0IGFwa1JlYWRlci5yZWFkTWFuaWZlc3QoKTtcbiAgICBpZiAobWFuaWZlc3QudXNlc1NkayAmJiBfLmlzSW50ZWdlcihtYW5pZmVzdC51c2VzU2RrLnRhcmdldFNka1ZlcnNpb24pKSB7XG4gICAgICByZXR1cm4gbWFuaWZlc3QudXNlc1Nkay50YXJnZXRTZGtWZXJzaW9uO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBmaW5kIHRoZSBpbmZvcm1hdGlvbiBhYm91dCB0YXJnZXRTZGtWZXJzaW9uIGluIHRoZSBtYW5pZmVzdCcpO1xuICB9O1xuICBjb25zdCBnZXRUYXJnZXRTZGtWaWFBYXB0ID0gYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IHRoaXMuaW5pdEFhcHQoKTtcbiAgICBjb25zdCBhcmdzID0gWydkdW1wJywgJ2JhZGdpbmcnLCBhcHBQYXRoXTtcbiAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy5hYXB0LCBhcmdzKTtcbiAgICBjb25zdCB0YXJnZXRTZGtWZXJzaW9uID0gL3RhcmdldFNka1ZlcnNpb246JyhbXiddKyknL2cuZXhlYyhzdGRvdXQpO1xuICAgIGlmICghdGFyZ2V0U2RrVmVyc2lvbikge1xuICAgICAgbG9nLmRlYnVnKHN0ZG91dCk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBwYXJzZSB0aGUgY29tbWFuZCBvdXRwdXQnKTtcbiAgICB9XG4gICAgcmV0dXJuIHBhcnNlSW50KHRhcmdldFNka1ZlcnNpb25bMV0sIDEwKTtcbiAgfTtcbiAgY29uc3QgdmVyc2lvbkdldHRlcnMgPSBbXG4gICAgWydBcGtSZWFkZXInLCBnZXRUYXJnZXRTZGtWaWFBcGtSZWFkZXJdLFxuICAgIFsnYWFwdCcsIGdldFRhcmdldFNka1ZpYUFhcHRdLFxuICBdO1xuICBmb3IgKGNvbnN0IFt0b29sTmFtZSwgdmVyc2lvbkdldHRlcl0gb2YgdmVyc2lvbkdldHRlcnMpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHZlcnNpb25HZXR0ZXIoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cuaW5mbyhgQ2Fubm90IGV4dHJhY3QgdGFyZ2V0U2RrVmVyc2lvbiBvZiAnJHtvcmlnaW5hbEFwcFBhdGh9JyB1c2luZyAke3Rvb2xOYW1lfS4gYCArXG4gICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG4gIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGV4dHJhY3QgdGhlIHRhcmdldCBTREsgdmVyc2lvbiBudW1iZXIgb2YgJyR7b3JpZ2luYWxBcHBQYXRofScgdXNpbmcgZWl0aGVyIG9mIGAgK1xuICAgIGAke0pTT04uc3RyaW5naWZ5KHZlcnNpb25HZXR0ZXJzLm1hcCgocGFpcikgPT4gcGFpclswXSkpfSB0b29scy4gYCArXG4gICAgYENoZWNrIHRoZSBzZXJ2ZXIgbG9nIGZvciBtb3JlIGRldGFpbHNgKTtcbn07XG5cbi8qKlxuICogRXh0cmFjdCB0YXJnZXQgU0RLIHZlcnNpb24gZnJvbSBwYWNrYWdlIGluZm9ybWF0aW9uLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBwa2cgLSBUaGUgY2xhc3MgbmFtZSBvZiB0aGUgcGFja2FnZSBpbnN0YWxsZWQgb24gdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogQHBhcmFtIHs/c3RyaW5nfSBjbWRPdXRwdXQgLSBPcHRpb25hbCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgb3V0cHV0IG9mXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9kdW1wc3lzIHBhY2thZ2VfIGNvbW1hbmQuIEl0IG1heSBzcGVlZCB1cCB0aGUgbWV0aG9kIGV4ZWN1dGlvbi5cbiAqIEByZXR1cm4ge251bWJlcn0gVGhlIHZlcnNpb24gb2YgdGhlIHRhcmdldCBTREsuXG4gKi9cbm1hbmlmZXN0TWV0aG9kcy50YXJnZXRTZGtWZXJzaW9uVXNpbmdQS0cgPSBhc3luYyBmdW5jdGlvbiB0YXJnZXRTZGtWZXJzaW9uVXNpbmdQS0cgKHBrZywgY21kT3V0cHV0ID0gbnVsbCkge1xuICBsZXQgc3Rkb3V0ID0gY21kT3V0cHV0IHx8IGF3YWl0IHRoaXMuc2hlbGwoWydkdW1wc3lzJywgJ3BhY2thZ2UnLCBwa2ddKTtcbiAgbGV0IHRhcmdldFNka1ZlcnNpb24gPSBuZXcgUmVnRXhwKC90YXJnZXRTZGs9KFteXFxzXFxzXSspL2cpLmV4ZWMoc3Rkb3V0KTtcbiAgaWYgKHRhcmdldFNka1ZlcnNpb24gJiYgdGFyZ2V0U2RrVmVyc2lvbi5sZW5ndGggPj0gMikge1xuICAgIHRhcmdldFNka1ZlcnNpb24gPSB0YXJnZXRTZGtWZXJzaW9uWzFdO1xuICB9IGVsc2Uge1xuICAgIC8vIHRhcmdldFNkayBub3QgZm91bmQgaW4gdGhlIGR1bXAsIGFzc2lnbmluZyAwIHRvIHRhcmdldFNka1ZlcnNpb25cbiAgICB0YXJnZXRTZGtWZXJzaW9uID0gMDtcbiAgfVxuICByZXR1cm4gcGFyc2VJbnQodGFyZ2V0U2RrVmVyc2lvbiwgMTApO1xufTtcblxuLyoqXG4gKiBDcmVhdGUgYmluYXJ5IHJlcHJlc2VudGF0aW9uIG9mIHBhY2thZ2UgbWFuaWZlc3QgKHVzdWFsbHkgQW5kcm9pZE1hbmlmZXN0LnhtbCkuXG4gKiBgJHttYW5pZmVzdH0uYXBrYCBmaWxlIHdpbGwgYmUgY3JlYXRlZCBhcyB0aGUgcmVzdWx0IG9mIHRoaXMgbWV0aG9kXG4gKiBjb250YWluaW5nIHRoZSBjb21waWxlZCBtYW5pZmVzdC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gbWFuaWZlc3QgLSBGdWxsIHBhdGggdG8gdGhlIGluaXRpYWwgbWFuaWZlc3QgdGVtcGxhdGVcbiAqIEBwYXJhbSB7c3RyaW5nfSBtYW5pZmVzdFBhY2thZ2UgLSBUaGUgbmFtZSBvZiB0aGUgbWFuaWZlc3QgcGFja2FnZVxuICogQHBhcmFtIHtzdHJpbmd9IHRhcmdldFBhY2thZ2UgLSBUaGUgbmFtZSBvZiB0aGUgZGVzdGluYXRpb24gcGFja2FnZVxuICovXG5tYW5pZmVzdE1ldGhvZHMuY29tcGlsZU1hbmlmZXN0ID0gYXN5bmMgZnVuY3Rpb24gY29tcGlsZU1hbmlmZXN0IChtYW5pZmVzdCwgbWFuaWZlc3RQYWNrYWdlLCB0YXJnZXRQYWNrYWdlKSB7XG4gIGNvbnN0IHtwbGF0Zm9ybSwgcGxhdGZvcm1QYXRofSA9IGF3YWl0IGdldEFuZHJvaWRQbGF0Zm9ybUFuZFBhdGgoKTtcbiAgaWYgKCFwbGF0Zm9ybSkge1xuICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGNvbXBpbGUgdGhlIG1hbmlmZXN0LiBUaGUgcmVxdWlyZWQgcGxhdGZvcm0gZG9lcyBub3QgZXhpc3QgKEFQSSBsZXZlbCA+PSAxNyknKTtcbiAgfVxuICBjb25zdCByZXN1bHRQYXRoID0gYCR7bWFuaWZlc3R9LmFwa2A7XG4gIGNvbnN0IGFuZHJvaWRKYXJQYXRoID0gcGF0aC5yZXNvbHZlKHBsYXRmb3JtUGF0aCwgJ2FuZHJvaWQuamFyJyk7XG4gIGlmIChhd2FpdCBmcy5leGlzdHMocmVzdWx0UGF0aCkpIHtcbiAgICBhd2FpdCBmcy5yaW1yYWYocmVzdWx0UGF0aCk7XG4gIH1cbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmluaXRBYXB0MigpO1xuICAgIC8vIGh0dHBzOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3N0dWRpby9jb21tYW5kLWxpbmUvYWFwdDJcbiAgICBjb25zdCBhcmdzID0gW1xuICAgICAgJ2xpbmsnLFxuICAgICAgJy1vJywgcmVzdWx0UGF0aCxcbiAgICAgICctLW1hbmlmZXN0JywgbWFuaWZlc3QsXG4gICAgICAnLS1yZW5hbWUtbWFuaWZlc3QtcGFja2FnZScsIG1hbmlmZXN0UGFja2FnZSxcbiAgICAgICctLXJlbmFtZS1pbnN0cnVtZW50YXRpb24tdGFyZ2V0LXBhY2thZ2UnLCB0YXJnZXRQYWNrYWdlLFxuICAgICAgJy1JJywgYW5kcm9pZEphclBhdGgsXG4gICAgICAnLXYnLFxuICAgIF07XG4gICAgbG9nLmRlYnVnKGBDb21waWxpbmcgdGhlIG1hbmlmZXN0IHVzaW5nICcke3F1b3RlKFt0aGlzLmJpbmFyaWVzLmFhcHQyLCAuLi5hcmdzXSl9J2ApO1xuICAgIGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy5hYXB0MiwgYXJncyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZGVidWcoJ0Nhbm5vdCBjb21waWxlIHRoZSBtYW5pZmVzdCB1c2luZyBhYXB0Mi4gRGVmYXVsdGluZyB0byBhYXB0LiAnICtcbiAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLnN0ZGVyciB8fCBlLm1lc3NhZ2V9YCk7XG4gICAgYXdhaXQgdGhpcy5pbml0QWFwdCgpO1xuICAgIGNvbnN0IGFyZ3MgPSBbXG4gICAgICAncGFja2FnZScsXG4gICAgICAnLU0nLCBtYW5pZmVzdCxcbiAgICAgICctLXJlbmFtZS1tYW5pZmVzdC1wYWNrYWdlJywgbWFuaWZlc3RQYWNrYWdlLFxuICAgICAgJy0tcmVuYW1lLWluc3RydW1lbnRhdGlvbi10YXJnZXQtcGFja2FnZScsIHRhcmdldFBhY2thZ2UsXG4gICAgICAnLUknLCBhbmRyb2lkSmFyUGF0aCxcbiAgICAgICctRicsIHJlc3VsdFBhdGgsXG4gICAgICAnLWYnLFxuICAgIF07XG4gICAgbG9nLmRlYnVnKGBDb21waWxpbmcgdGhlIG1hbmlmZXN0IHVzaW5nICcke3F1b3RlKFt0aGlzLmJpbmFyaWVzLmFhcHQsIC4uLmFyZ3NdKX0nYCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy5hYXB0LCBhcmdzKTtcbiAgICB9IGNhdGNoIChlMSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgY29tcGlsZSB0aGUgbWFuaWZlc3QuIE9yaWdpbmFsIGVycm9yOiAke2UxLnN0ZGVyciB8fCBlMS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuICBsb2cuZGVidWcoYENvbXBpbGVkIHRoZSBtYW5pZmVzdCBhdCAnJHtyZXN1bHRQYXRofSdgKTtcbn07XG5cbi8qKlxuICogUmVwbGFjZS9pbnNlcnQgdGhlIHNwZWNpYWxseSBwcmVjb21waWxlZCBtYW5pZmVzdCBmaWxlIGludG8gdGhlXG4gKiBwYXJ0aWN1bGFyIHBhY2thZ2UuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IG1hbmlmZXN0IC0gRnVsbCBwYXRoIHRvIHRoZSBwcmVjb21waWxlZCBtYW5pZmVzdFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlZCBieSBgY29tcGlsZU1hbmlmZXN0YCBtZXRob2QgY2FsbFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aG91dCAuYXBrIGV4dGVuc2lvblxuICogQHBhcmFtIHtzdHJpbmd9IHNyY0FwayAtIEZ1bGwgcGF0aCB0byB0aGUgZXhpc3RpbmcgdmFsaWQgYXBwbGljYXRpb24gcGFja2FnZSwgd2hlcmVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzIG1hbmlmZXN0IGhhcyB0byBiZSBpbnNldHJlZCB0by4gVGhpcyBwYWNrYWdlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgd2lsbCBOT1QgYmUgbW9kaWZpZWQuXG4gKiBAcGFyYW0ge3N0cmluZ30gZHN0QXBrIC0gRnVsbCBwYXRoIHRvIHRoZSByZXN1bHRpbmcgcGFja2FnZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZmlsZSB3aWxsIGJlIG92ZXJyaWRkZW4gaWYgaXQgYWxyZWFkeSBleGlzdHMuXG4gKi9cbm1hbmlmZXN0TWV0aG9kcy5pbnNlcnRNYW5pZmVzdCA9IGFzeW5jIGZ1bmN0aW9uIGluc2VydE1hbmlmZXN0IChtYW5pZmVzdCwgc3JjQXBrLCBkc3RBcGspIHtcbiAgbG9nLmRlYnVnKGBJbnNlcnRpbmcgbWFuaWZlc3QgJyR7bWFuaWZlc3R9Jywgc3JjOiAnJHtzcmNBcGt9JywgZHN0OiAnJHtkc3RBcGt9J2ApO1xuICBhd2FpdCB6aXAuYXNzZXJ0VmFsaWRaaXAoc3JjQXBrKTtcbiAgYXdhaXQgdW56aXBGaWxlKGAke21hbmlmZXN0fS5hcGtgKTtcbiAgY29uc3QgbWFuaWZlc3ROYW1lID0gcGF0aC5iYXNlbmFtZShtYW5pZmVzdCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5pbml0QWFwdCgpO1xuICAgIGF3YWl0IGZzLmNvcHlGaWxlKHNyY0FwaywgZHN0QXBrKTtcbiAgICBsb2cuZGVidWcoJ01vdmluZyBtYW5pZmVzdCcpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjKHRoaXMuYmluYXJpZXMuYWFwdCwgW1xuICAgICAgICAncmVtb3ZlJywgZHN0QXBrLCBtYW5pZmVzdE5hbWVcbiAgICAgIF0pO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICBhd2FpdCBleGVjKHRoaXMuYmluYXJpZXMuYWFwdCwgW1xuICAgICAgJ2FkZCcsIGRzdEFwaywgbWFuaWZlc3ROYW1lXG4gICAgXSwge2N3ZDogcGF0aC5kaXJuYW1lKG1hbmlmZXN0KX0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmRlYnVnKCdDYW5ub3QgaW5zZXJ0IG1hbmlmZXN0IHVzaW5nIGFhcHQuIERlZmF1bHRpbmcgdG8gemlwLiAnICtcbiAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLnN0ZGVyciB8fCBlLm1lc3NhZ2V9YCk7XG4gICAgY29uc3QgdG1wUm9vdCA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICAgIHRyeSB7XG4gICAgICAvLyBVbmZvcnR1bmF0ZWx5IE5vZGVKUyBkb2VzIG5vdCBwcm92aWRlIGFueSByZWxpYWJsZSBtZXRob2RzXG4gICAgICAvLyB0byByZXBsYWNlIGZpbGVzIGluc2lkZSB6aXAgYXJjaGl2ZXMgd2l0aG91dCBsb2FkaW5nIHRoZVxuICAgICAgLy8gd2hvbGUgYXJjaGl2ZSBjb250ZW50IGludG8gUkFNXG4gICAgICBsb2cuZGVidWcoYEV4dHJhY3RpbmcgdGhlIHNvdXJjZSBhcGsgYXQgJyR7c3JjQXBrfSdgKTtcbiAgICAgIGF3YWl0IHppcC5leHRyYWN0QWxsVG8oc3JjQXBrLCB0bXBSb290KTtcbiAgICAgIGxvZy5kZWJ1ZygnTW92aW5nIG1hbmlmZXN0Jyk7XG4gICAgICBhd2FpdCBmcy5tdihtYW5pZmVzdCwgcGF0aC5yZXNvbHZlKHRtcFJvb3QsIG1hbmlmZXN0TmFtZSkpO1xuICAgICAgbG9nLmRlYnVnKGBDb2xsZWN0aW5nIHRoZSBkZXN0aW5hdGlvbiBhcGsgYXQgJyR7ZHN0QXBrfSdgKTtcbiAgICAgIGF3YWl0IHppcC50b0FyY2hpdmUoZHN0QXBrLCB7XG4gICAgICAgIGN3ZDogdG1wUm9vdCxcbiAgICAgIH0pO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYodG1wUm9vdCk7XG4gICAgfVxuICB9XG4gIGxvZy5kZWJ1ZyhgTWFuaWZlc3QgaW5zZXJ0aW9uIGludG8gJyR7ZHN0QXBrfScgaXMgY29tcGxldGVkYCk7XG59O1xuXG4vKipcbiAqIENoZWNrIHdoZXRoZXIgcGFja2FnZSBtYW5pZmVzdCBjb250YWlucyBJbnRlcm5ldCBwZXJtaXNzaW9ucy5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBwUGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gLmFwayhzKSBwYWNrYWdlLlxuICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgbWFuaWZlc3QgcmVxdWlyZXMgSW50ZXJuZXQgYWNjZXNzIHBlcm1pc3Npb24uXG4gKi9cbm1hbmlmZXN0TWV0aG9kcy5oYXNJbnRlcm5ldFBlcm1pc3Npb25Gcm9tTWFuaWZlc3QgPSBhc3luYyBmdW5jdGlvbiBoYXNJbnRlcm5ldFBlcm1pc3Npb25Gcm9tTWFuaWZlc3QgKGFwcFBhdGgpIHtcbiAgbG9nLmRlYnVnKGBDaGVja2luZyBpZiAnJHthcHBQYXRofScgcmVxdWlyZXMgaW50ZXJuZXQgYWNjZXNzIHBlcm1pc3Npb24gaW4gdGhlIG1hbmlmZXN0YCk7XG4gIGlmIChhcHBQYXRoLmVuZHNXaXRoKEFQS1NfRVhURU5TSU9OKSkge1xuICAgIGFwcFBhdGggPSBhd2FpdCB0aGlzLmV4dHJhY3RCYXNlQXBrKGFwcFBhdGgpO1xuICB9XG5cbiAgY29uc3QgYXBrUmVhZGVyID0gYXdhaXQgQXBrUmVhZGVyLm9wZW4oYXBwUGF0aCk7XG4gIGNvbnN0IG1hbmlmZXN0ID0gYXdhaXQgYXBrUmVhZGVyLnJlYWRNYW5pZmVzdCgpO1xuICByZXR1cm4gKG1hbmlmZXN0LnVzZXNQZXJtaXNzaW9ucyB8fCBbXSkuc29tZSgoe25hbWV9KSA9PiBuYW1lID09PSAnYW5kcm9pZC5wZXJtaXNzaW9uLklOVEVSTkVUJyk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBtYW5pZmVzdE1ldGhvZHM7XG4iXSwiZmlsZSI6ImxpYi90b29scy9hbmRyb2lkLW1hbmlmZXN0LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
