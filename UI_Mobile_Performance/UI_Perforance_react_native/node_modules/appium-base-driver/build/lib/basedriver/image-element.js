"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getImgElFromArgs = getImgElFromArgs;
exports.makeImageElementCache = makeImageElementCache;
exports.DEFAULT_TEMPLATE_IMAGE_SCALE = exports.IMAGE_EL_TAP_STRATEGY_W3C = exports.IMAGE_EL_TAP_STRATEGY_MJSONWP = exports.ImageElement = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _2 = require("../..");

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _protocol = require("../protocol/protocol");

var _logger = _interopRequireDefault(require("./logger"));

var _appiumSupport = require("appium-support");

const MAX_CACHE_SIZE = 1024 * 1024 * 40;
const TAP_DURATION_MS = 125;
const IMAGE_EL_TAP_STRATEGY_W3C = 'w3cActions';
exports.IMAGE_EL_TAP_STRATEGY_W3C = IMAGE_EL_TAP_STRATEGY_W3C;
const IMAGE_EL_TAP_STRATEGY_MJSONWP = 'touchActions';
exports.IMAGE_EL_TAP_STRATEGY_MJSONWP = IMAGE_EL_TAP_STRATEGY_MJSONWP;
const IMAGE_TAP_STRATEGIES = [IMAGE_EL_TAP_STRATEGY_MJSONWP, IMAGE_EL_TAP_STRATEGY_W3C];
const DEFAULT_TEMPLATE_IMAGE_SCALE = 1.0;
exports.DEFAULT_TEMPLATE_IMAGE_SCALE = DEFAULT_TEMPLATE_IMAGE_SCALE;

class ImageElement {
  constructor(b64Template, rect, score, b64Result = null) {
    this.template = b64Template;
    this.rect = rect;
    this.id = `${_protocol.IMAGE_ELEMENT_PREFIX}${_appiumSupport.util.uuidV4()}`;
    this.b64MatchedImage = b64Result;
    this.score = score;
  }

  get size() {
    return {
      width: this.rect.width,
      height: this.rect.height
    };
  }

  get location() {
    return {
      x: this.rect.x,
      y: this.rect.y
    };
  }

  get center() {
    return {
      x: this.rect.x + this.rect.width / 2,
      y: this.rect.y + this.rect.height / 2
    };
  }

  get matchedImage() {
    return this.b64MatchedImage;
  }

  asElement(protocolKey) {
    return {
      [protocolKey]: this.id
    };
  }

  equals(other) {
    return this.rect.x === other.rect.x && this.rect.y === other.rect.y && this.rect.width === other.rect.width && this.rect.height === other.rect.height;
  }

  async click(driver) {
    let newImgEl;
    const {
      autoUpdateImageElementPosition: updatePos,
      checkForImageElementStaleness,
      imageElementTapStrategy
    } = driver.settings.getSettings();

    if (!IMAGE_TAP_STRATEGIES.includes(imageElementTapStrategy)) {
      throw new Error(`Incorrect imageElementTapStrategy setting ` + `'${imageElementTapStrategy}'. Must be one of ` + JSON.stringify(IMAGE_TAP_STRATEGIES));
    }

    if (checkForImageElementStaleness || updatePos) {
      _logger.default.info('Checking image element for staleness before clicking');

      try {
        newImgEl = await driver.findByImage(this.template, {
          shouldCheckStaleness: true,
          ignoreDefaultImageTemplateScale: true
        });
      } catch (err) {
        throw new _2.errors.StaleElementReferenceError();
      }

      if (!this.equals(newImgEl)) {
        _logger.default.warn(`When trying to click on an image element, the image changed ` + `position from where it was originally found. It is now at ` + `${JSON.stringify(newImgEl.rect)} and was originally at ` + `${JSON.stringify(this.rect)}.`);

        if (updatePos) {
          _logger.default.warn('Click will proceed at new coordinates');

          this.rect = _lodash.default.clone(newImgEl.rect);
        } else {
          _logger.default.warn('Click will take place at original coordinates. If you ' + 'would like Appium to automatically click the new ' + "coordinates, set the 'autoUpdateImageElementPosition' " + 'setting to true');
        }
      }
    }

    const {
      x,
      y
    } = this.center;

    _logger.default.info(`Will tap on image element at coordinate [${x}, ${y}]`);

    if (imageElementTapStrategy === IMAGE_EL_TAP_STRATEGY_W3C) {
      _logger.default.info('Will tap using W3C actions');

      const action = {
        type: 'pointer',
        id: 'mouse',
        parameters: {
          pointerType: 'touch'
        },
        actions: [{
          type: 'pointerMove',
          x,
          y,
          duration: 0
        }, {
          type: 'pointerDown',
          button: 0
        }, {
          type: 'pause',
          duration: TAP_DURATION_MS
        }, {
          type: 'pointerUp',
          button: 0
        }]
      };

      if (driver.performActions) {
        return await driver.performActions([action]);
      }

      _logger.default.warn('Driver does not seem to implement W3C actions, falling back ' + 'to TouchActions');
    }

    _logger.default.info('Will tap using MJSONWP TouchActions');

    const action = {
      action: 'tap',
      options: {
        x,
        y
      }
    };

    if (driver.performTouch) {
      return await driver.performTouch([action]);
    }

    throw new Error("Driver did not implement the 'performTouch' command. " + 'For drivers to support finding image elements, they ' + "should support 'performTouch' and 'performActions'");
  }

  static async execute(driver, cmd, imgElId, ...args) {
    if (!driver._imgElCache.has(imgElId)) {
      throw new _2.errors.NoSuchElementError();
    }

    const imgEl = driver._imgElCache.get(imgElId);

    switch (cmd) {
      case 'click':
        return await imgEl.click(driver);

      case 'elementDisplayed':
        return true;

      case 'getSize':
        return imgEl.size;

      case 'getLocation':
      case 'getLocationInView':
        return imgEl.location;

      case 'getElementRect':
        return imgEl.rect;

      case 'getAttribute':
        switch (args[0]) {
          case 'visual':
            return imgEl.matchedImage;

          case 'score':
            return imgEl.score;

          default:
            throw new _2.errors.NotYetImplementedError();
        }

      default:
        throw new _2.errors.NotYetImplementedError();
    }
  }

}

exports.ImageElement = ImageElement;

function makeImageElementCache(max = MAX_CACHE_SIZE) {
  return new _lruCache.default({
    max,
    length: el => el.template.length
  });
}

function getImgElFromArgs(args) {
  for (let arg of args) {
    if (_lodash.default.isString(arg) && arg.startsWith(_protocol.IMAGE_ELEMENT_PREFIX)) {
      return arg;
    }
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2ltYWdlLWVsZW1lbnQuanMiXSwibmFtZXMiOlsiTUFYX0NBQ0hFX1NJWkUiLCJUQVBfRFVSQVRJT05fTVMiLCJJTUFHRV9FTF9UQVBfU1RSQVRFR1lfVzNDIiwiSU1BR0VfRUxfVEFQX1NUUkFURUdZX01KU09OV1AiLCJJTUFHRV9UQVBfU1RSQVRFR0lFUyIsIkRFRkFVTFRfVEVNUExBVEVfSU1BR0VfU0NBTEUiLCJJbWFnZUVsZW1lbnQiLCJjb25zdHJ1Y3RvciIsImI2NFRlbXBsYXRlIiwicmVjdCIsInNjb3JlIiwiYjY0UmVzdWx0IiwidGVtcGxhdGUiLCJpZCIsIklNQUdFX0VMRU1FTlRfUFJFRklYIiwidXRpbCIsInV1aWRWNCIsImI2NE1hdGNoZWRJbWFnZSIsInNpemUiLCJ3aWR0aCIsImhlaWdodCIsImxvY2F0aW9uIiwieCIsInkiLCJjZW50ZXIiLCJtYXRjaGVkSW1hZ2UiLCJhc0VsZW1lbnQiLCJwcm90b2NvbEtleSIsImVxdWFscyIsIm90aGVyIiwiY2xpY2siLCJkcml2ZXIiLCJuZXdJbWdFbCIsImF1dG9VcGRhdGVJbWFnZUVsZW1lbnRQb3NpdGlvbiIsInVwZGF0ZVBvcyIsImNoZWNrRm9ySW1hZ2VFbGVtZW50U3RhbGVuZXNzIiwiaW1hZ2VFbGVtZW50VGFwU3RyYXRlZ3kiLCJzZXR0aW5ncyIsImdldFNldHRpbmdzIiwiaW5jbHVkZXMiLCJFcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJsb2ciLCJpbmZvIiwiZmluZEJ5SW1hZ2UiLCJzaG91bGRDaGVja1N0YWxlbmVzcyIsImlnbm9yZURlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUiLCJlcnIiLCJlcnJvcnMiLCJTdGFsZUVsZW1lbnRSZWZlcmVuY2VFcnJvciIsIndhcm4iLCJfIiwiY2xvbmUiLCJhY3Rpb24iLCJ0eXBlIiwicGFyYW1ldGVycyIsInBvaW50ZXJUeXBlIiwiYWN0aW9ucyIsImR1cmF0aW9uIiwiYnV0dG9uIiwicGVyZm9ybUFjdGlvbnMiLCJvcHRpb25zIiwicGVyZm9ybVRvdWNoIiwiZXhlY3V0ZSIsImNtZCIsImltZ0VsSWQiLCJhcmdzIiwiX2ltZ0VsQ2FjaGUiLCJoYXMiLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJpbWdFbCIsImdldCIsIk5vdFlldEltcGxlbWVudGVkRXJyb3IiLCJtYWtlSW1hZ2VFbGVtZW50Q2FjaGUiLCJtYXgiLCJMUlUiLCJsZW5ndGgiLCJlbCIsImdldEltZ0VsRnJvbUFyZ3MiLCJhcmciLCJpc1N0cmluZyIsInN0YXJ0c1dpdGgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxjQUFjLEdBQUcsT0FBTyxJQUFQLEdBQWMsRUFBckM7QUFDQSxNQUFNQyxlQUFlLEdBQUcsR0FBeEI7QUFDQSxNQUFNQyx5QkFBeUIsR0FBRyxZQUFsQzs7QUFDQSxNQUFNQyw2QkFBNkIsR0FBRyxjQUF0Qzs7QUFDQSxNQUFNQyxvQkFBb0IsR0FBRyxDQUMzQkQsNkJBRDJCLEVBRTNCRCx5QkFGMkIsQ0FBN0I7QUFJQSxNQUFNRyw0QkFBNEIsR0FBRyxHQUFyQzs7O0FBMEJBLE1BQU1DLFlBQU4sQ0FBbUI7QUFhakJDLEVBQUFBLFdBQVcsQ0FBRUMsV0FBRixFQUFlQyxJQUFmLEVBQXFCQyxLQUFyQixFQUE0QkMsU0FBUyxHQUFHLElBQXhDLEVBQThDO0FBQ3ZELFNBQUtDLFFBQUwsR0FBZ0JKLFdBQWhCO0FBQ0EsU0FBS0MsSUFBTCxHQUFZQSxJQUFaO0FBQ0EsU0FBS0ksRUFBTCxHQUFXLEdBQUVDLDhCQUFxQixHQUFFQyxvQkFBS0MsTUFBTCxFQUFjLEVBQWxEO0FBQ0EsU0FBS0MsZUFBTCxHQUF1Qk4sU0FBdkI7QUFDQSxTQUFLRCxLQUFMLEdBQWFBLEtBQWI7QUFDRDs7QUFLRCxNQUFJUSxJQUFKLEdBQVk7QUFDVixXQUFPO0FBQUNDLE1BQUFBLEtBQUssRUFBRSxLQUFLVixJQUFMLENBQVVVLEtBQWxCO0FBQXlCQyxNQUFBQSxNQUFNLEVB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Yjs7QUFDRixlQUFLLE9BQUw7QUFDRSxtQkFBTzhDLEtBQUssQ0FBQzdELEtBQWI7O0FBQ0Y7QUFDRSxrQkFBTSxJQUFJdUMsVUFBT3dCLHNCQUFYLEVBQU47QUFOSjs7QUFRRjtBQUFTLGNBQU0sSUFBSXhCLFVBQU93QixzQkFBWCxFQUFOO0FBeEJYO0FBMEJEOztBQXhOZ0I7Ozs7QUEyTm5CLFNBQVNDLHFCQUFULENBQWdDQyxHQUFHLEdBQUczRSxjQUF0QyxFQUFzRDtBQUNwRCxTQUFPLElBQUk0RSxpQkFBSixDQUFRO0FBQ2JELElBQUFBLEdBRGE7QUFFYkUsSUFBQUEsTUFBTSxFQUFHQyxFQUFELElBQVFBLEVBQUUsQ0FBQ2xFLFFBQUgsQ0FBWWlFO0FBRmYsR0FBUixDQUFQO0FBSUQ7O0FBRUQsU0FBU0UsZ0JBQVQsQ0FBMkJaLElBQTNCLEVBQWlDO0FBQy9CLE9BQUssSUFBSWEsR0FBVCxJQUFnQmIsSUFBaEIsRUFBc0I7QUFDcEIsUUFBSWYsZ0JBQUU2QixRQUFGLENBQVdELEdBQVgsS0FBbUJBLEdBQUcsQ0FBQ0UsVUFBSixDQUFlcEUsOEJBQWYsQ0FBdkIsRUFBNkQ7QUFDM0QsYUFBT2tFLEdBQVA7QUFDRDtBQUNGO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnLi4vLi4nO1xuaW1wb3J0IExSVSBmcm9tICdscnUtY2FjaGUnO1xuaW1wb3J0IHsgSU1BR0VfRUxFTUVOVF9QUkVGSVggfSBmcm9tICcuLi9wcm90b2NvbC9wcm90b2NvbCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cbmNvbnN0IE1BWF9DQUNIRV9TSVpFID0gMTAyNCAqIDEwMjQgKiA0MDsgLy8gNDBtYlxuY29uc3QgVEFQX0RVUkFUSU9OX01TID0gMTI1O1xuY29uc3QgSU1BR0VfRUxfVEFQX1NUUkFURUdZX1czQyA9ICd3M2NBY3Rpb25zJztcbmNvbnN0IElNQUdFX0VMX1RBUF9TVFJBVEVHWV9NSlNPTldQID0gJ3RvdWNoQWN0aW9ucyc7XG5jb25zdCBJTUFHRV9UQVBfU1RSQVRFR0lFUyA9IFtcbiAgSU1BR0VfRUxfVEFQX1NUUkFURUdZX01KU09OV1AsXG4gIElNQUdFX0VMX1RBUF9TVFJBVEVHWV9XM0Ncbl07XG5jb25zdCBERUZBVUxUX1RFTVBMQVRFX0lNQUdFX1NDQUxFID0gMS4wO1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFJlY3RcbiAqIEBwcm9wZXJ0eSB7aW50fSB4IC0geC1jb29yZGluYXRlIG9mIHRvcC1sZWZ0IGNvcm5lclxuICogQHByb3BlcnR5IHtpbnR9IHkgLSB5LWNvb3JkaW5hdGUgb2YgdG9wLWxlZnQgY29ybmVyXG4gKiBAcHJvcGVydHkge2ludH0gd2lkdGggLSB3aWR0aCBvZiByZWN0XG4gKiBAcHJvcGVydHkge2ludH0gaGVpZ2h0IC0gaGVpZ2h0IG9mIHJlY3RcbiAqL1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IERpbWVuc2lvblxuICogQHByb3BlcnR5IHtpbnR9IHdpZHRoIC0gd2lkdGggb2YgcmVjdFxuICogQHByb3BlcnR5IHtpbnR9IGhlaWdodCAtIGhlaWdodCBvZiByZWN0XG4gKi9cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBQb3NpdGlvblxuICogQHByb3BlcnR5IHtpbnR9IHggLSB4IGNvb3JkaW5hdGVcbiAqIEBwcm9wZXJ0eSB7aW50fSB5IC0geSBjb29yZGluYXRlXG4gKi9cblxuLyoqXG4gKiBSZXByZXNlbnRhdGlvbiBvZiBhbiBcImltYWdlIGVsZW1lbnRcIiwgd2hpY2ggaXMgc2ltcGx5IGEgc2V0IG9mIGNvb3JkaW5hdGVzXG4gKiBhbmQgbWV0aG9kcyB0aGF0IGNhbiBiZSB1c2VkIG9uIHRoYXQgc2V0IG9mIGNvb3JkaW5hdGVzIHZpYSB0aGUgZHJpdmVyXG4gKi9cbmNsYXNzIEltYWdlRWxlbWVudCB7XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBiNjRUZW1wbGF0ZSAtIHRoZSBiYXNlNjQtZW5jb2RlZCBpbWFnZSB3aGljaCB3YXMgdXNlZCB0b1xuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5kIHRoaXMgSW1hZ2VFbGVtZW50XG4gICAqIEBwYXJhbSB7UmVjdH0gcmVjdCAtIGJvdW5kcyBvZiBtYXRjaGVkIGltYWdlIGVsZW1lbnRcbiAgICogQHBhcmFtIHtudW1iZXJ9IHNjb3JlIFRoZSBzaW1pbGFyaXR5IHNjb3JlIGFzIGEgZmxvYXQgbnVtYmVyIGluIHJhbmdlIFswLjAsIDEuMF0uXG4gICAqIDEuMCBpcyB0aGUgaGlnaGVzdCBzY29yZSAobWVhbnMgYm90aCBpbWFnZXMgYXJlIHRvdGFsbHkgZXF1YWwpLlxuICAgKiBAcGFyYW0gez9zdHJpbmd9IGI2NFJlc3VsdCAtIHRoZSBiYXNlNjQtZW5jb2RlZCBpbWFnZSB3aGljaCBoYXMgbWF0Y2hlZCBtYXJrcy5cbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBEZWZhdWx0cyB0byBudWxsLlxuICAgKlxuICAgKiBAcmV0dXJucyB7SW1hZ2VFbGVtZW50fVxuICAgKi9cbiAgY29uc3RydWN0b3IgKGI2NFRlbXBsYXRlLCByZWN0LCBzY29yZSwgYjY0UmVzdWx0ID0gbnVsbCkge1xuICAgIHRoaXMudGVtcGxhdGUgPSBiNjRUZW1wbGF0ZTtcbiAgICB0aGlzLnJlY3QgPSByZWN0O1xuICAgIHRoaXMuaWQgPSBgJHtJTUFHRV9FTEVNRU5UX1BSRUZJWH0ke3V0aWwudXVpZFY0KCl9YDtcbiAgICB0aGlzLmI2NE1hdGNoZWRJbWFnZSA9IGI2NFJlc3VsdDtcbiAgICB0aGlzLnNjb3JlID0gc2NvcmU7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMge0RpbWVuc2lvbn0gLSBkaW1lbnNpb24gb2YgZWxlbWVudFxuICAgKi9cbiAgZ2V0IHNpemUgKCkge1xuICAgIHJldHVybiB7d2lkdGg6IHRoaXMucmVjdC53aWR0aCwgaGVpZ2h0OiB0aGlzLnJlY3QuaGVpZ2h0fTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyB7UG9zaXRpb259IC0gY29vcmRpbmF0ZXMgb2YgdG9wLWxlZnQgY29ybmVyIG9mIGVsZW1lbnRcbiAgICovXG4gIGdldCBsb2NhdGlvbiAoKSB7XG4gICAgcmV0dXJuIHt4OiB0aGlzLnJlY3QueCwgeTogdGhpcy5yZWN0Lnl9O1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHtQb3NpdGlvbn0gLSBjb29yZGluYXRlcyBvZiBjZW50ZXIgb2YgZWxlbWVudFxuICAgKi9cbiAgZ2V0IGNlbnRlciAoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHg6IHRoaXMucmVjdC54ICsgdGhpcy5yZWN0LndpZHRoIC8gMixcbiAgICAgIHk6IHRoaXMucmVjdC55ICsgdGhpcy5yZWN0LmhlaWdodCAvIDIsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyB7P3N0cmluZ30gLSB0aGUgYmFzZTY0LWVuY29kZWQgaW1hZ2Ugd2hpY2ggaGFzIG1hdGNoZWQgbWFya3NcbiAgICovXG4gIGdldCBtYXRjaGVkSW1hZ2UgKCkge1xuICAgIHJldHVybiB0aGlzLmI2NE1hdGNoZWRJbWFnZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvdG9jb2xLZXkgLSB0aGUgcHJvdG9jb2wtc3BlY2lmaWMgSlNPTiBrZXkgZm9yXG4gICAqIGEgV2ViRWxlbWVudFxuICAgKlxuICAgKiBAcmV0dXJucyB7V2ViRWxlbWVudH0gLSB0aGlzIGltYWdlIGVsZW1lbnQgYXMgYSBXZWJFbGVtZW50XG4gICAqL1xuICBhc0VsZW1lbnQgKHByb3RvY29sS2V5KSB7XG4gICAgcmV0dXJuIHtbcHJvdG9jb2xLZXldOiB0aGlzLmlkfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge0ltYWdlRWxlbWVudH0gb3RoZXIgLSBhbiBJbWFnZUVsZW1lbnQgdG8gY29tcGFyZSB3aXRoIHRoaXMgb25lXG4gICAqXG4gICAqIEByZXR1cm5zIHtib29sZWFufSAtIHdoZXRoZXIgdGhlIG90aGVyIGVsZW1lbnQgYW5kIHRoaXMgb25lIGhhdmUgdGhlIHNhbWVcbiAgICogcHJvcGVydGllc1xuICAgKi9cbiAgZXF1YWxzIChvdGhlcikge1xuICAgIHJldHVybiB0aGlzLnJlY3QueCA9PT0gb3RoZXIucmVjdC54ICYmXG4gICAgICAgICAgIHRoaXMucmVjdC55ID09PSBvdGhlci5yZWN0LnkgJiZcbiAgICAgICAgICAgdGhpcy5yZWN0LndpZHRoID09PSBvdGhlci5yZWN0LndpZHRoICYmXG4gICAgICAgICAgIHRoaXMucmVjdC5oZWlnaHQgPT09IG90aGVyLnJlY3QuaGVpZ2h0O1xuICB9XG5cbiAgLyoqXG4gICAqIFVzZSBhIGRyaXZlciB0byB0YXAgdGhlIHNjcmVlbiBhdCB0aGUgY2VudGVyIG9mIHRoaXMgSW1hZ2VFbGVtZW50J3NcbiAgICogcG9zaXRpb25cbiAgICpcbiAgICogQHBhcmFtIHtCYXNlRHJpdmVyfSBkcml2ZXIgLSBkcml2ZXIgZm9yIGNhbGxpbmcgYWN0aW9ucyB3aXRoXG4gICAqL1xuICBhc3luYyBjbGljayAoZHJpdmVyKSB7XG4gICAgLy8gYmVmb3JlIHdlIGNsaWNrIHdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBlbGVtZW50IGlzIGFjdHVhbGx5IHN0aWxsIHRoZXJlXG4gICAgLy8gd2hlcmUgd2UgZXhwZWN0IGl0IHRvIGJlXG4gICAgbGV0IG5ld0ltZ0VsO1xuICAgIGNvbnN0IHtcbiAgICAgIGF1dG9VcGRhdGVJbWFnZUVsZW1lbnRQb3NpdGlvbjogdXBkYXRlUG9zLFxuICAgICAgY2hlY2tGb3JJbWFnZUVsZW1lbnRTdGFsZW5lc3MsXG4gICAgICBpbWFnZUVsZW1lbnRUYXBTdHJhdGVneSxcbiAgICB9ID0gZHJpdmVyLnNldHRpbmdzLmdldFNldHRpbmdzKCk7XG5cbiAgICAvLyB2YWxpZGF0ZSB0YXAgc3RyYXRlZ3lcbiAgICBpZiAoIUlNQUdFX1RBUF9TVFJBVEVHSUVTLmluY2x1ZGVzKGltYWdlRWxlbWVudFRhcFN0cmF0ZWd5KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbmNvcnJlY3QgaW1hZ2VFbGVtZW50VGFwU3RyYXRlZ3kgc2V0dGluZyBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgJyR7aW1hZ2VFbGVtZW50VGFwU3RyYXRlZ3l9Jy4gTXVzdCBiZSBvbmUgb2YgYCArXG4gICAgICAgICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoSU1BR0VfVEFQX1NUUkFURUdJRVMpKTtcbiAgICB9XG5cbiAgICBpZiAoY2hlY2tGb3JJbWFnZUVsZW1lbnRTdGFsZW5lc3MgfHwgdXBkYXRlUG9zKSB7XG4gICAgICBsb2cuaW5mbygnQ2hlY2tpbmcgaW1hZ2UgZWxlbWVudCBmb3Igc3RhbGVuZXNzIGJlZm9yZSBjbGlja2luZycpO1xuICAgICAgdHJ5IHtcbiAgICAgICAgbmV3SW1nRWwgPSBhd2FpdCBkcml2ZXIuZmluZEJ5SW1hZ2UodGhpcy50ZW1wbGF0ZSwge1xuICAgICAgICAgIHNob3VsZENoZWNrU3RhbGVuZXNzOiB0cnVlLFxuICAgICAgICAgIC8vIFNldCBpZ25vcmVEZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlIGJlY2F1c2UgdGhpcy50ZW1wbGF0ZSBpcyBkZXZpY2Ugc2NyZWVuc2hvdCBiYXNlZCBpbWFnZVxuICAgICAgICAgIC8vIG1hbmFnZWQgaW5zaWRlIEFwcGl1bSBhZnRlciBmaW5pZG5nIGltYWdlIGJ5IHRlbXBsYXRlIHdoaWNoIG1hbmFnZWQgYnkgYSB1c2VyXG4gICAgICAgICAgaWdub3JlRGVmYXVsdEltYWdlVGVtcGxhdGVTY2FsZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLlN0YWxlRWxlbWVudFJlZmVyZW5jZUVycm9yKCk7XG4gICAgICB9XG5cbiAgICAgIGlmICghdGhpcy5lcXVhbHMobmV3SW1nRWwpKSB7XG4gICAgICAgIGxvZy53YXJuKGBXaGVuIHRyeWluZyB0byBjbGljayBvbiBhbiBpbWFnZSBlbGVtZW50LCB0aGUgaW1hZ2UgY2hhbmdlZCBgICtcbiAgICAgICAgICAgICAgICAgYHBvc2l0aW9uIGZyb20gd2hlcmUgaXQgd2FzIG9yaWdpbmFsbHkgZm91bmQuIEl0IGlzIG5vdyBhdCBgICtcbiAgICAgICAgICAgICAgICAgYCR7SlNPTi5zdHJpbmdpZnkobmV3SW1nRWwucmVjdCl9IGFuZCB3YXMgb3JpZ2luYWxseSBhdCBgICtcbiAgICAgICAgICAgICAgICAgYCR7SlNPTi5zdHJpbmdpZnkodGhpcy5yZWN0KX0uYCk7XG4gICAgICAgIGlmICh1cGRhdGVQb3MpIHtcbiAgICAgICAgICBsb2cud2FybignQ2xpY2sgd2lsbCBwcm9jZWVkIGF0IG5ldyBjb29yZGluYXRlcycpO1xuICAgICAgICAgIHRoaXMucmVjdCA9IF8uY2xvbmUobmV3SW1nRWwucmVjdCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbG9nLndhcm4oJ0NsaWNrIHdpbGwgdGFrZSBwbGFjZSBhdCBvcmlnaW5hbCBjb29yZGluYXRlcy4gSWYgeW91ICcgK1xuICAgICAgICAgICAgICAgICAgICd3b3VsZCBsaWtlIEFwcGl1bSB0byBhdXRvbWF0aWNhbGx5IGNsaWNrIHRoZSBuZXcgJyArXG4gICAgICAgICAgICAgICAgICAgXCJjb29yZGluYXRlcywgc2V0IHRoZSAnYXV0b1VwZGF0ZUltYWdlRWxlbWVudFBvc2l0aW9uJyBcIiArXG4gICAgICAgICAgICAgICAgICAgJ3NldHRpbmcgdG8gdHJ1ZScpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3Qge3gsIHl9ID0gdGhpcy5jZW50ZXI7XG4gICAgbG9nLmluZm8oYFdpbGwgdGFwIG9uIGltYWdlIGVsZW1lbnQgYXQgY29vcmRpbmF0ZSBbJHt4fSwgJHt5fV1gKTtcblxuICAgIGlmIChpbWFnZUVsZW1lbnRUYXBTdHJhdGVneSA9PT0gSU1BR0VfRUxfVEFQX1NUUkFURUdZX1czQykge1xuICAgICAgLy8gc2V0IHVwIGEgVzNDIGFjdGlvbiB0byBjbGljayBvbiB0aGUgaW1hZ2UgYnkgcG9zaXRpb25cbiAgICAgIGxvZy5pbmZvKCdXaWxsIHRhcCB1c2luZyBXM0MgYWN0aW9ucycpO1xuICAgICAgY29uc3QgYWN0aW9uID0ge1xuICAgICAgICB0eXBlOiAncG9pbnRlcicsXG4gICAgICAgIGlkOiAnbW91c2UnLFxuICAgICAgICBwYXJhbWV0ZXJzOiB7cG9pbnRlclR5cGU6ICd0b3VjaCd9LFxuICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAge3R5cGU6ICdwb2ludGVyTW92ZScsIHgsIHksIGR1cmF0aW9uOiAwfSxcbiAgICAgICAgICB7dHlwZTogJ3BvaW50ZXJEb3duJywgYnV0dG9uOiAwfSxcbiAgICAgICAgICB7dHlwZTogJ3BhdXNlJywgZHVyYXRpb246IFRBUF9EVVJBVElPTl9NU30sXG4gICAgICAgICAge3R5cGU6ICdwb2ludGVyVXAnLCBidXR0b246IDB9LFxuICAgICAgICBdXG4gICAgICB9O1xuXG4gICAgICAvLyBjaGVjayBpZiB0aGUgZHJpdmVyIGhhcyB0aGUgYXBwcm9wcmlhdGUgcGVyZm9ybUFjdGlvbnMgbWV0aG9kXG4gICAgICBpZiAoZHJpdmVyLnBlcmZvcm1BY3Rpb25zKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBkcml2ZXIucGVyZm9ybUFjdGlvbnMoW2FjdGlvbl0pO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiBub3QsIHdhcm4gYW5kIGZhbGwgYmFjayB0byB0aGUgb3RoZXIgbWV0aG9kXG4gICAgICBsb2cud2FybignRHJpdmVyIGRvZXMgbm90IHNlZW0gdG8gaW1wbGVtZW50IFczQyBhY3Rpb25zLCBmYWxsaW5nIGJhY2sgJyArXG4gICAgICAgICAgICAgICAndG8gVG91Y2hBY3Rpb25zJyk7XG4gICAgfVxuXG4gICAgLy8gaWYgdGhlIHczYyBzdHJhdGVneSB3YXMgbm90IHJlcXVlc3RlZCwgZG8gdGhlIG9ubHkgb3RoZXIgb3B0aW9uIChtanNvbndwXG4gICAgLy8gdG91Y2ggYWN0aW9ucylcbiAgICBsb2cuaW5mbygnV2lsbCB0YXAgdXNpbmcgTUpTT05XUCBUb3VjaEFjdGlvbnMnKTtcbiAgICBjb25zdCBhY3Rpb24gPSB7XG4gICAgICBhY3Rpb246ICd0YXAnLFxuICAgICAgb3B0aW9uczoge3gsIHl9XG4gICAgfTtcblxuICAgIGlmIChkcml2ZXIucGVyZm9ybVRvdWNoKSB7XG4gICAgICByZXR1cm4gYXdhaXQgZHJpdmVyLnBlcmZvcm1Ub3VjaChbYWN0aW9uXSk7XG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiRHJpdmVyIGRpZCBub3QgaW1wbGVtZW50IHRoZSAncGVyZm9ybVRvdWNoJyBjb21tYW5kLiBcIiArXG4gICAgICAgICAgICAgICAgICAgICdGb3IgZHJpdmVycyB0byBzdXBwb3J0IGZpbmRpbmcgaW1hZ2UgZWxlbWVudHMsIHRoZXkgJyArXG4gICAgICAgICAgICAgICAgICAgIFwic2hvdWxkIHN1cHBvcnQgJ3BlcmZvcm1Ub3VjaCcgYW5kICdwZXJmb3JtQWN0aW9ucydcIik7XG4gIH1cblxuICAvKipcbiAgICogSGFuZGxlIHZhcmlvdXMgQXBwaXVtIGNvbW1hbmRzIHRoYXQgaW52b2x2ZSBhbiBpbWFnZSBlbGVtZW50XG4gICAqXG4gICAqIEBwYXJhbSB7QmFzZURyaXZlcn0gZHJpdmVyIC0gdGhlIGRyaXZlciB0byB1c2UgZm9yIGNvbW1hbmRzXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjbWQgLSB0aGUgbmFtZSBvZiB0aGUgZHJpdmVyIGNvbW1hbmRcbiAgICogQHBhcmFtIHtzdHJpbmd9IGltZ0VsSWQgLSB0aGUgaWQgb2YgdGhlIEltYWdlRWxlbWVudCB0byB3b3JrIHdpdGhcbiAgICogQHBhcmFtIHtBcnJheX0gYXJncyAtIFJlc3Qgb2YgYXJndW1lbnRzIGZvciBleGVjdXRlU2NyaXB0c1xuICAgKlxuICAgKiBAcmV0dXJucyB7T2JqZWN0fSAtIHRoZSByZXN1bHQgb2YgcnVubmluZyBhIGNvbW1hbmRcbiAgICovXG4gIHN0YXRpYyBhc3luYyBleGVjdXRlIChkcml2ZXIsIGNtZCwgaW1nRWxJZCwgLi4uYXJncykge1xuICAgIGlmICghZHJpdmVyLl9pbWdFbENhY2hlLmhhcyhpbWdFbElkKSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbWdFbCA9IGRyaXZlci5faW1nRWxDYWNoZS5nZXQoaW1nRWxJZCk7XG5cbiAgICBzd2l0Y2ggKGNtZCkge1xuICAgICAgY2FzZSAnY2xpY2snOlxuICAgICAgICByZXR1cm4gYXdhaXQgaW1nRWwuY2xpY2soZHJpdmVyKTtcbiAgICAgIGNhc2UgJ2VsZW1lbnREaXNwbGF5ZWQnOlxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIGNhc2UgJ2dldFNpemUnOlxuICAgICAgICByZXR1cm4gaW1nRWwuc2l6ZTtcbiAgICAgIGNhc2UgJ2dldExvY2F0aW9uJzpcbiAgICAgIGNhc2UgJ2dldExvY2F0aW9uSW5WaWV3JzpcbiAgICAgICAgcmV0dXJuIGltZ0VsLmxvY2F0aW9uO1xuICAgICAgY2FzZSAnZ2V0RWxlbWVudFJlY3QnOlxuICAgICAgICByZXR1cm4gaW1nRWwucmVjdDtcbiAgICAgIGNhc2UgJ2dldEF0dHJpYnV0ZSc6XG4gICAgICAgIC8vIC9zZXNzaW9uLzpzZXNzaW9uSWQvZWxlbWVudC86ZWxlbWVudElkL2F0dHJpYnV0ZS86bmFtZVxuICAgICAgICAvLyAvc2Vzc2lvbi86c2Vzc2lvbklkL2VsZW1lbnQvOmVsZW1lbnRJZC9hdHRyaWJ1dGUvdmlzdWFsIHNob3VsZCByZXR1biB0aGUgdmlzdWFsIGRhdGFcbiAgICAgICAgLy8gZS5nLiBbXCJjb250ZW50LWRlc2NcIixcImFwcGl1bS1pbWFnZS1lbGVtZW50LXh4eHh4XCIsXCJ4eHh4eFwiXSwgW1widmlzdWFsXCIsXCJhcHBpdW0taW1hZ2UtZWxlbWVudC14eHh4eFwiLFwieHh4eHhcIl1cbiAgICAgICAgc3dpdGNoIChhcmdzWzBdKSB7XG4gICAgICAgICAgY2FzZSAndmlzdWFsJzpcbiAgICAgICAgICAgIHJldHVybiBpbWdFbC5tYXRjaGVkSW1hZ2U7XG4gICAgICAgICAgY2FzZSAnc2NvcmUnOlxuICAgICAgICAgICAgcmV0dXJuIGltZ0VsLnNjb3JlO1xuICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoKTtcbiAgICAgICAgfVxuICAgICAgZGVmYXVsdDogdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKCk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIG1ha2VJbWFnZUVsZW1lbnRDYWNoZSAobWF4ID0gTUFYX0NBQ0hFX1NJWkUpIHtcbiAgcmV0dXJuIG5ldyBMUlUoe1xuICAgIG1heCxcbiAgICBsZW5ndGg6IChlbCkgPT4gZWwudGVtcGxhdGUubGVuZ3RoLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2V0SW1nRWxGcm9tQXJncyAoYXJncykge1xuICBmb3IgKGxldCBhcmcgb2YgYXJncykge1xuICAgIGlmIChfLmlzU3RyaW5nKGFyZykgJiYgYXJnLnN0YXJ0c1dpdGgoSU1BR0VfRUxFTUVOVF9QUkVGSVgpKSB7XG4gICAgICByZXR1cm4gYXJnO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQge1xuICBJbWFnZUVsZW1lbnQsIGdldEltZ0VsRnJvbUFyZ3MsIG1ha2VJbWFnZUVsZW1lbnRDYWNoZSxcbiAgSU1BR0VfRUxfVEFQX1NUUkFURUdZX01KU09OV1AsIElNQUdFX0VMX1RBUF9TVFJBVEVHWV9XM0MsXG4gIERFRkFVTFRfVEVNUExBVEVfSU1BR0VfU0NBTEVcbn07XG4iXSwiZmlsZSI6ImxpYi9iYXNlZHJpdmVyL2ltYWdlLWVsZW1lbnQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
