"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.CUSTOM_STRATEGY = exports.IMAGE_STRATEGY = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

var _2 = require("../../..");

var _images = require("./images");

var _imageElement = require("../image-element");

const commands = {},
      helpers = {},
      extensions = {};
exports.helpers = helpers;
exports.commands = commands;
const IMAGE_STRATEGY = '-image';
exports.IMAGE_STRATEGY = IMAGE_STRATEGY;
const CUSTOM_STRATEGY = '-custom';
exports.CUSTOM_STRATEGY = CUSTOM_STRATEGY;
const FLOAT_PRECISION = 100000;

helpers.findElOrElsWithProcessing = async function findElOrElsWithProcessing(strategy, selector, mult, context) {
  this.validateLocatorStrategy(strategy);

  try {
    return await this.findElOrEls(strategy, selector, mult, context);
  } catch (err) {
    if (this.opts.printPageSourceOnFindFailure) {
      const src = await this.getPageSource();

      _logger.default.debug(`Error finding element${mult ? 's' : ''}: ${err.message}`);

      _logger.default.debug(`Page source requested through 'printPageSourceOnFindFailure':`);

      _logger.default.debug(src);
    }

    throw err;
  }
};

commands.findElement = async function findElement(strategy, selector) {
  if (strategy === IMAGE_STRATEGY) {
    return await this.findByImage(selector, {
      multiple: false
    });
  } else if (strategy === CUSTOM_STRATEGY) {
    return await this.findByCustom(selector, false);
  }

  return await this.findElOrElsWithProcessing(strategy, selector, false);
};

commands.findElements = async function findElements(strategy, selector) {
  if (strategy === IMAGE_STRATEGY) {
    return await this.findByImage(selector, {
      multiple: true
    });
  } else if (strategy === CUSTOM_STRATEGY) {
    return await this.findByCustom(selector, true);
  }

  return await this.findElOrElsWithProcessing(strategy, selector, true);
};

commands.findElementFromElement = async function findElementFromElement(strategy, selector, elementId) {
  return await this.findElOrElsWithProcessing(strategy, selector, false, elementId);
};

commands.findElementsFromElement = async function findElementsFromElement(strategy, selector, elementId) {
  return await this.findElOrElsWithProcessing(strategy, selector, true, elementId);
};

commands.findByCustom = async function findByCustom(selector, multiple) {
  const plugins = this.opts.customFindModules;

  if (!plugins) {
    throw new Error('Finding an element using a plugin is currently an ' + 'incubating feature. To use it you must manually install one or more ' + 'plugin modules in a way that they can be required by Appium, for ' + 'example installing them from the Appium directory, installing them ' + 'globally, or installing them elsewhere and passing an absolute path as ' + 'the capability. Then construct an object where the key is the shortcut ' + 'name for this plugin and the value is the module name or absolute path, ' + 'for example: {"p1": "my-find-plugin"}, and pass this in as the ' + "'customFindModules' capability.");
  }

  if (!_lodash.default.isPlainObject(plugins)) {
    throw new Error("Invalid format for the 'customFindModules' capability. " + 'It should be an object with keys corresponding to the short names and ' + 'values corresponding to the full names of the element finding plugins');
  }

  let [plugin, realSelector] = selector.split(':');

  if (_lodash.default.size(plugins) > 1 && !realSelector) {
    throw new Error(`Multiple element finding plugins were registered ` + `(${_lodash.default.keys(plugins)}), but your selector did not indicate which plugin ` + `to use. Ensure you put the short name of the plugin followed by ':' as ` + `the initial part of the selector string.`);
  }

  if (_lodash.default.size(plugins) === 1 && !realSelector) {
    realSelector = plugin;
    plugin = _lodash.default.keys(plugins)[0];
  }

  if (!plugins[plugin]) {
    throw new Error(`Selector specified use of element finding plugin ` + `'${plugin}' but it was not registered in the 'customFindModules' ` + `capability.`);
  }

  let finder;

  try {
    _logger.default.debug(`Find plugin '${plugin}' requested; will attempt to use it ` + `from '${plugins[plugin]}'`);

    finder = require(plugins[plugin]);
  } catch (err) {
    throw new Error(`Could not load your custom find module '${plugin}'. Did ` + `you put it somewhere Appium can 'require' it? Original error: ${err}`);
  }

  if (!finder || !_lodash.default.isFunction(finder.find)) {
    throw new Error('Your custom find module did not appear to be constructed ' + 'correctly. It needs to export an object with a `find` method.');
  }

  const customFinderLog = _appiumSupport.logger.getLogger(plugin);

  let elements;

  const condition = async () => {
    elements = await finder.find(this, customFinderLog, realSelector, multiple);

    if (!_lodash.default.isEmpty(elements) || multiple) {
      return true;
    }

    return false;
  };

  try {
    await this.implicitWaitForCondition(condition);
  } catch (err) {
    if (err.message.match(/Condition unmet/)) {
      throw new _2.errors.NoSuchElementError();
    }

    throw err;
  }

  return multiple ? elements : elements[0];
};

helpers.findByImage = async function findByImage(b64Template, {
  shouldCheckStaleness = false,
  multiple = false,
  ignoreDefaultImageTemplateScale = false
}) {
  const {
    imageMatchThreshold: threshold,
    fixImageTemplateSize,
    fixImageTemplateScale,
    defaultImageTemplateScale,
    getMatchedImageResult: visualize
  } = this.settings.getSettings();

  _logger.default.info(`Finding image element with match threshold ${threshold}`);

  if (!this.getWindowSize) {
    throw new Error("This driver does not support the required 'getWindowSize' command");
  }

  const {
    width: screenWidth,
    height: screenHeight
  } = await this.getWindowSize();

  if (fixImageTemplateSize) {
    b64Template = await this.ensureTemplateSize(b64Template, screenWidth, screenHeight);
  }

  let rect = null;
  let b64Matched = null;
  let score = 0;

  const condition = async () => {
    try {
      const {
        b64Screenshot,
        scale
      } = await this.getScreenshotForImageFind(screenWidth, screenHeight);
      b64Template = await this.fixImageTemplateScale(b64Template, {
        defaultImageTemplateScale,
        ignoreDefaultImageTemplateScale,
        fixImageTemplateScale,
        ...scale
      });
      const comparedImage = await this.compareImages(_images.MATCH_TEMPLATE_MODE, b64Screenshot, b64Template, {
        threshold,
        visualize
      });
      rect = comparedImage.rect;
      b64Matched = comparedImage.visualization;
      score = comparedImage.score;
      return true;
    } catch (err) {
      if (err.message.match(/Cannot find any occurrences/)) {
        return false;
      }

      throw err;
    }
  };

  try {
    await this.implicitWaitForCondition(condition);
  } catch (err) {
    if (!err.message.match(/Condition unmet/)) {
      throw err;
    }
  }

  if (!rect) {
    if (multiple) {
      return [];
    }

    throw new _2.errors.NoSuchElementError();
  }

  _logger.default.info(`Image template matched: ${JSON.stringify(rect)}`);

  if (b64Matched) {
    _logger.default.info(`Matched base64 data: ${b64Matched.substring(0, 200)}...`);
  }

  const imgEl = new _imageElement.ImageElement(b64Template, rect, score, b64Matched);

  if (shouldCheckStaleness) {
    return imgEl;
  }

  const protocolEl = this.registerImageElement(imgEl);
  return multiple ? [protocolEl] : protocolEl;
};

helpers.ensureTemplateSize = async function ensureTemplateSize(b64Template, screenWidth, screenHeight) {
  let imgObj = await _appiumSupport.imageUtil.getJimpImage(b64Template);
  let {
    width: tplWidth,
    height: tplHeight
  } = imgObj.bitmap;

  _logger.default.info(`Template image is ${tplWidth}x${tplHeight}. Screen size is ${screenWidth}x${screenHeight}`);

  if (tplWidth <= screenWidth && tplHeight <= screenHeight) {
    return b64Template;
  }

  _logger.default.info(`Scaling template image from ${tplWidth}x${tplHeight} to match ` + `screen at ${screenWidth}x${screenHeight}`);

  imgObj = imgObj.scaleToFit(screenWidth, screenHeight);
  return (await imgObj.getBuffer(_appiumSupport.imageUtil.MIME_PNG)).toString('base64');
};

helpers.getScreenshotForImageFind = async function getScreenshotForImageFind(screenWidth, screenHeight) {
  if (!this.getScreenshot) {
    throw new Error("This driver does not support the required 'getScreenshot' command");
  }

  let b64Screenshot = await this.getScreenshot();

  if (!this.settings.getSettings().fixImageFindScreenshotDims) {
    _logger.default.info(`Not verifying screenshot dimensions match screen`);

    return {
      b64Screenshot
    };
  }

  if (screenWidth < 1 || screenHeight < 1) {
    _logger.default.warn(`The retrieved screen size ${screenWidth}x${screenHeight} does ` + `not seem to be valid. No changes will be applied to the screenshot`);

    return {
      b64Screenshot
    };
  }

  _logger.default.info('Verifying screenshot size and aspect ratio');

  let imgObj = await _appiumSupport.imageUtil.getJimpImage(b64Screenshot);
  let {
    width: shotWidth,
    height: shotHeight
  } = imgObj.bitmap;

  if (shotWidth < 1 || shotHeight < 1) {
    _logger.default.warn(`The retrieved screenshot size ${shotWidth}x${shotHeight} does ` + `not seem to be valid. No changes will be applied to the screenshot`);

    return {
      b64Screenshot
    };
  }

  if (screenWidth === shotWidth && screenHeight === shotHeight) {
    _logger.default.info('Screenshot size matched screen size');

    return {
      b64Screenshot
    };
  }

  const scale = {
    xScale: 1.0,
    yScale: 1.0
  };
  const screenAR = screenWidth / screenHeight;
  const shotAR = shotWidth / shotHeight;

  if (Math.round(screenAR * FLOAT_PRECISION) === Math.round(shotAR * FLOAT_PRECISION)) {
    _logger.default.info(`Screenshot aspect ratio '${shotAR}' (${shotWidth}x${shotHeight}) matched ` + `screen aspect ratio '${screenAR}' (${screenWidth}x${screenHeight})`);
  } else {
    _logger.default.warn(`When trying to find an element, determined that the screen ` + `aspect ratio and screenshot aspect ratio are different. Screen ` + `is ${screenWidth}x${screenHeight} whereas screenshot is ` + `${shotWidth}x${shotHeight}.`);

    const xScale = 1.0 * shotWidth / screenWidth;
    const yScale = 1.0 * shotHeight / screenHeight;
    const scaleFactor = xScale >= yScale ? yScale : xScale;

    _logger.default.warn(`Resizing screenshot to ${shotWidth * scaleFactor}x${shotHeight * scaleFactor} to match ` + `screen aspect ratio so that image element coordinates have a ` + `greater chance of being correct.`);

    imgObj = imgObj.resize(shotWidth * scaleFactor, shotHeight * scaleFactor);
    scale.xScale *= scaleFactor;
    scale.yScale *= scaleFactor;
    shotWidth = imgObj.bitmap.width;
    shotHeight = imgObj.bitmap.height;
  }

  if (screenWidth !== shotWidth && screenHeight !== shotHeight) {
    _logger.default.info(`Scaling screenshot from ${shotWidth}x${shotHeight} to match ` + `screen at ${screenWidth}x${screenHeight}`);

    imgObj = imgObj.resize(screenWidth, screenHeight);
    scale.xScale *= 1.0 * screenWidth / shotWidth;
    scale.yScale *= 1.0 * screenHeight / shotHeight;
  }

  b64Screenshot = (await imgObj.getBuffer(_appiumSupport.imageUtil.MIME_PNG)).toString('base64');
  return {
    b64Screenshot,
    scale
  };
};

const DEFAULT_FIX_IMAGE_TEMPLATE_SCALE = 1;

helpers.fixImageTemplateScale = async function fixImageTemplateScale(b64Template, opts = {}) {
  if (!opts) {
    return b64Template;
  }

  let {
    fixImageTemplateScale = false,
    defaultImageTemplateScale = _imageElement.DEFAULT_TEMPLATE_IMAGE_SCALE,
    ignoreDefaultImageTemplateScale = false,
    xScale = DEFAULT_FIX_IMAGE_TEMPLATE_SCALE,
    yScale = DEFAULT_FIX_IMAGE_TEMPLATE_SCALE
  } = opts;

  if (ignoreDefaultImageTemplateScale) {
    defaultImageTemplateScale = _imageElement.DEFAULT_TEMPLATE_IMAGE_SCALE;
  }

  if (defaultImageTemplateScale === _imageElement.DEFAULT_TEMPLATE_IMAGE_SCALE && !fixImageTemplateScale) {
    return b64Template;
  }

  if (fixImageTemplateScale) {
    xScale *= defaultImageTemplateScale;
    yScale *= defaultImageTemplateScale;
  } else {
    xScale = yScale = 1 * defaultImageTemplateScale;
  }

  if (!parseFloat(xScale) || !parseFloat(yScale)) {
    return b64Template;
  }

  if (Math.round(xScale * FLOAT_PRECISION) === Math.round(DEFAULT_FIX_IMAGE_TEMPLATE_SCALE * FLOAT_PRECISION) && Math.round(yScale * FLOAT_PRECISION === Math.round(DEFAULT_FIX_IMAGE_TEMPLATE_SCALE * FLOAT_PRECISION))) {
    return b64Template;
  }

  let imgTempObj = await _appiumSupport.imageUtil.getJimpImage(b64Template);
  let {
    width: baseTempWidth,
    height: baseTempHeigh
  } = imgTempObj.bitmap;
  const scaledWidth = baseTempWidth * xScale;
  const scaledHeight = baseTempHeigh * yScale;

  _logger.default.info(`Scaling template image from ${baseTempWidth}x${baseTempHeigh}` + ` to ${scaledWidth}x${scaledHeight}`);

  _logger.default.info(`The ratio is ${xScale} and ${yScale}`);

  imgTempObj = await imgTempObj.resize(scaledWidth, scaledHeight);
  return (await imgTempObj.getBuffer(_appiumSupport.imageUtil.MIME_PNG)).toString('base64');
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL2ZpbmQuanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJoZWxwZXJzIiwiZXh0ZW5zaW9ucyIsIklNQUdFX1NUUkFURUdZIiwiQ1VTVE9NX1NUUkFURUdZIiwiRkxPQVRfUFJFQ0lTSU9OIiwiZmluZEVsT3JFbHNXaXRoUHJvY2Vzc2luZyIsInN0cmF0ZWd5Iiwic2VsZWN0b3IiLCJtdWx0IiwiY29udGV4dCIsInZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5IiwiZmluZEVsT3JFbHMiLCJlcnIiLCJvcHRzIiwicHJpbnRQYWdlU291cmNlT25GaW5kRmFpbHVyZSIsInNyYyIsImdldFBhZ2VTb3VyY2UiLCJsb2ciLCJkZWJ1ZyIsIm1lc3NhZ2UiLCJmaW5kRWxlbWVudCIsImZpbmRCeUltYWdlIiwibXVsdGlwbGUiLCJmaW5kQnlDdXN0b20iLCJmaW5kRWxlbWVudHMiLCJmaW5kRWxlbWVudEZyb21FbGVtZW50IiwiZWxlbWVudElkIiwiZmluZEVsZW1lbnRzRnJvbUVsZW1lbnQiLCJwbHVnaW5zIiwiY3VzdG9tRmluZE1vZHVsZXMiLCJFcnJvciIsIl8iLCJpc1BsYWluT2JqZWN0IiwicGx1Z2luIiwicmVhbFNlbGVjdG9yIiwic3BsaXQiLCJzaXplIiwia2V5cyIsImZpbmRlciIsInJlcXVpcmUiLCJpc0Z1bmN0aW9uIiwiZmluZCIsImN1c3RvbUZpbmRlckxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsImVsZW1lbnRzIiwiY29uZGl0aW9uIiwiaXNFbXB0eSIsImltcGxpY2l0V2FpdEZvckNvbmRpdGlvbiIsIm1hdGNoIiwiZXJyb3JzIiwiTm9TdWNoRWxlbWVudEVycm9yIiwiYjY0VGVtcGxhdGUiLCJzaG91bGRDaGVja1N0YWxlbmVzcyIsImlnbm9yZURlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUiLCJpbWFnZU1hdGNoVGhyZXNob2xkIiwidGhyZXNob2xkIiwiZml4SW1hZ2VUZW1wbGF0ZVNpemUiLCJmaXhJbWFnZVRlbXBsYXRlU2NhbGUiLCJkZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlIiwiZ2V0TWF0Y2hlZEltYWdlUmVzdWx0IiwidmlzdWFsaXplIiwic2V0dGluZ3MiLCJnZXRTZXR0aW5ncyIsImluZm8iLCJnZXRXaW5kb3dTaXplIiwid2lkdGgiLCJzY3JlZW5XaWR0aCIsImhlaWdodCIsInNjcmVlbkhlaWdodCIsImVuc3VyZVRlbXBsYXRlU2l6ZSIsInJlY3QiLCJiNjRNYXRjaGVkIiwic2NvcmUiLCJiNjRTY3JlZW5zaG90Iiwic2NhbGUiLCJnZXRTY3JlZW5zaG90Rm9ySW1hZ2VGaW5kIiwiY29tcGFyZWRJbWFnZSIsImNvbXBhcmVJbWFnZXMiLCJNQVRDSF9URU1QTEFURV9NT0RFIiwidmlzdWFsaXphdGlvbiIsIkpTT04iLCJzdHJpbmdpZnkiLCJzdWJzdHJpbmciLCJpbWdFbCIsIkltYWdlRWxlbWVudCIsInByb3RvY29sRWwiLCJyZWdpc3RlckltYWdlRWxlbWVudCIsImltZ09iaiIsImltYWdlVXRpbCIsImdldEppbXBJbWFnZSIsInRwbFdpZHRoIiwidHBsSGVpZ2h0IiwiYml0bWFwIiwic2NhbGVUb0ZpdCIsImdldEJ1ZmZlciIsIk1JTUVfUE5HIiwidG9TdHJpbmciLCJnZXRTY3JlZW5zaG90IiwiZml4SW1hZ2VGaW5kU2NyZWVuc2hvdERpbXMiLCJ3YXJuIiwic2hvdFdpZHRoIiwic2hvdEhlaWdodCIsInhTY2FsZSIsInlTY2FsZSIsInNjcmVlbkFSIiwic2hvdEFSIiwiTWF0aCIsInJvdW5kIiwic2NhbGVGYWN0b3IiLCJyZXNpemUiLCJERUZBVUxUX0ZJWF9JTUFHRV9URU1QTEFURV9TQ0FMRSIsIkRFRkFVTFRfVEVNUExBVEVfSU1BR0VfU0NBTEUiLCJwYXJzZUZsb2F0IiwiaW1nVGVtcE9iaiIsImJhc2VUZW1wV2lkdGgiLCJiYXNlVGVtcEhlaWdoIiwic2NhbGVkV2lkdGgiLCJzY2FsZWRIZWlnaHQiLCJPYmplY3QiLCJhc3NpZ24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FB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QUFQLENBQWN2SCxVQUFkLEVBQTBCRixRQUExQixFQUFvQ0MsT0FBcEM7ZUFFZUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGxvZ2dlciwgaW1hZ2VVdGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJy4uLy4uLy4uJztcbmltcG9ydCB7IE1BVENIX1RFTVBMQVRFX01PREUgfSBmcm9tICcuL2ltYWdlcyc7XG5pbXBvcnQgeyBJbWFnZUVsZW1lbnQsIERFRkFVTFRfVEVNUExBVEVfSU1BR0VfU0NBTEUgfSBmcm9tICcuLi9pbWFnZS1lbGVtZW50JztcblxuXG5jb25zdCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29uc3QgSU1BR0VfU1RSQVRFR1kgPSAnLWltYWdlJztcbmNvbnN0IENVU1RPTV9TVFJBVEVHWSA9ICctY3VzdG9tJztcblxuLy8gVXNlZCB0byBjb21wYXJlIHJhdGlvIGFuZCBzY3JlZW4gd2lkdGhcbi8vIFBpeGVsIGlzIGJhc2ljYWxseSB1bmRlciAxMDgwIGZvciBleGFtcGxlLiAxMDBLIGlzIHByb2JhYmx5IGVub3VnaCBmbyBhIHdoaWxlLlxuY29uc3QgRkxPQVRfUFJFQ0lTSU9OID0gMTAwMDAwO1xuXG4vLyBPdmVycmlkZSB0aGUgZm9sbG93aW5nIGZ1bmN0aW9uIGZvciB5b3VyIG93biBkcml2ZXIsIGFuZCB0aGUgcmVzdCBpcyB0YWtlblxuLy8gY2FyZSBvZiFcblxuLy8gaGVscGVycy5maW5kRWxPckVscyA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpIHt9XG4vLyAgIHN0cmF0ZWd5OiBsb2NhdG9yIHN0cmF0ZWd5XG4vLyAgIHNlbGVjdG9yOiB0aGUgYWN0dWFsIHNlbGVjdG9yIGZvciBmaW5kaW5nIGFuIGVsZW1lbnRcbi8vICAgbXVsdDogbXVsdGlwbGUgZWxlbWVudHMgb3IganVzdCBvbmU/XG4vLyAgIGNvbnRleHQ6IGZpbmRpbmcgYW4gZWxlbWVudCBmcm9tIHRoZSByb290IGNvbnRleHQ/IG9yIHN0YXJ0aW5nIGZyb20gYW5vdGhlciBlbGVtZW50XG4vL1xuLy8gUmV0dXJucyBhbiBvYmplY3Qgd2hpY2ggYWRoZXJlcyB0byB0aGUgd2F5IHRoZSBKU09OIFdpcmUgUHJvdG9jb2wgcmVwcmVzZW50cyBlbGVtZW50czpcbi8vIHsgRUxFTUVOVDogIyB9ICAgIGVnOiB7IEVMRU1FTlQ6IDMgfSAgb3IgeyBFTEVNRU5UOiAxLjAyMyB9XG5cbmhlbHBlcnMuZmluZEVsT3JFbHNXaXRoUHJvY2Vzc2luZyA9IGFzeW5jIGZ1bmN0aW9uIGZpbmRFbE9yRWxzV2l0aFByb2Nlc3NpbmcgKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCkge1xuICB0aGlzLnZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5KHN0cmF0ZWd5KTtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kRWxPckVscyhzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAodGhpcy5vcHRzLnByaW50UGFnZVNvdXJjZU9uRmluZEZhaWx1cmUpIHtcbiAgICAgIGNvbnN0IHNyYyA9IGF3YWl0IHRoaXMuZ2V0UGFnZVNvdXJjZSgpO1xuICAgICAgbG9nLmRlYnVnKGBFcnJvciBmaW5kaW5nIGVsZW1lbnQke211bHQgPyAncycgOiAnJ306ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICBsb2cuZGVidWcoYFBhZ2Ugc291cmNlIHJlcXVlc3RlZCB0aHJvdWdoICdwcmludFBhZ2VTb3VyY2VPbkZpbmRGYWlsdXJlJzpgKTtcbiAgICAgIGxvZy5kZWJ1ZyhzcmMpO1xuICAgIH1cbiAgICAvLyBzdGlsbCB3YW50IHRoZSBlcnJvciB0byBvY2N1clxuICAgIHRocm93IGVycjtcbiAgfVxufTtcblxuY29tbWFuZHMuZmluZEVsZW1lbnQgPSBhc3luYyBmdW5jdGlvbiBmaW5kRWxlbWVudCAoc3RyYXRlZ3ksIHNlbGVjdG9yKSB7XG4gIGlmIChzdHJhdGVneSA9PT0gSU1BR0VfU1RSQVRFR1kpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kQnlJbWFnZShzZWxlY3Rvciwge211bHRpcGxlOiBmYWxzZX0pO1xuICB9IGVsc2UgaWYgKHN0cmF0ZWd5ID09PSBDVVNUT01fU1RSQVRFR1kpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kQnlDdXN0b20oc2VsZWN0b3IsIGZhbHNlKTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCB0aGlzLmZpbmRFbE9yRWxzV2l0aFByb2Nlc3Npbmcoc3RyYXRlZ3ksIHNlbGVjdG9yLCBmYWxzZSk7XG59O1xuXG5jb21tYW5kcy5maW5kRWxlbWVudHMgPSBhc3luYyBmdW5jdGlvbiBmaW5kRWxlbWVudHMgKHN0cmF0ZWd5LCBzZWxlY3Rvcikge1xuICBpZiAoc3RyYXRlZ3kgPT09IElNQUdFX1NUUkFURUdZKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEJ5SW1hZ2Uoc2VsZWN0b3IsIHttdWx0aXBsZTogdHJ1ZX0pO1xuICB9IGVsc2UgaWYgKHN0cmF0ZWd5ID09PSBDVVNUT01fU1RSQVRFR1kpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kQnlDdXN0b20oc2VsZWN0b3IsIHRydWUpO1xuICB9XG5cbiAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEVsT3JFbHNXaXRoUHJvY2Vzc2luZyhzdHJhdGVneSwgc2VsZWN0b3IsIHRydWUpO1xufTtcblxuY29tbWFuZHMuZmluZEVsZW1lbnRGcm9tRWxlbWVudCA9IGFzeW5jIGZ1bmN0aW9uIGZpbmRFbGVtZW50RnJvbUVsZW1lbnQgKHN0cmF0ZWd5LCBzZWxlY3RvciwgZWxlbWVudElkKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLmZpbmRFbE9yRWxzV2l0aFByb2Nlc3Npbmcoc3RyYXRlZ3ksIHNlbGVjdG9yLCBmYWxzZSwgZWxlbWVudElkKTtcbn07XG5cbmNvbW1hbmRzLmZpbmRFbGVtZW50c0Zyb21FbGVtZW50ID0gYXN5bmMgZnVuY3Rpb24gZmluZEVsZW1lbnRzRnJvbUVsZW1lbnQgKHN0cmF0ZWd5LCBzZWxlY3RvciwgZWxlbWVudElkKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLmZpbmRFbE9yRWxzV2l0aFByb2Nlc3Npbmcoc3RyYXRlZ3ksIHNlbGVjdG9yLCB0cnVlLCBlbGVtZW50SWQpO1xufTtcblxuLyoqXG4gKiBGaW5kIGFuIGVsZW1lbnQgdXNpbmcgYSBjdXN0b20gcGx1Z2luIHNwZWNpZmllZCBieSB0aGUgY3VzdG9tRmluZE1vZHVsZXMgY2FwLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBzZWxlY3RvciAtIHRoZSBzZWxlY3RvciB3aGljaCB0aGUgcGx1Z2luIHdpbGwgdXNlIHRvIGZpbmRcbiAqIGVsZW1lbnRzXG4gKiBAcGFyYW0ge2Jvb2xlYW59IG11bHRpcGxlIC0gd2hldGhlciB3ZSB3YW50IG9uZSBlbGVtZW50IG9yIG11bHRpcGxlXG4gKlxuICogQHJldHVybnMge1dlYkVsZW1lbnR9IC0gV2ViRHJpdmVyIGVsZW1lbnQgb3IgbGlzdCBvZiBlbGVtZW50c1xuICovXG5jb21tYW5kcy5maW5kQnlDdXN0b20gPSBhc3luYyBmdW5jdGlvbiBmaW5kQnlDdXN0b20gKHNlbGVjdG9yLCBtdWx0aXBsZSkge1xuICBjb25zdCBwbHVnaW5zID0gdGhpcy5vcHRzLmN1c3RvbUZpbmRNb2R1bGVzO1xuXG4gIC8vIGZpcnN0IGVuc3VyZSB0aGUgdXNlciBoYXMgcmVnaXN0ZXJlZCBvbmUgb3IgbW9yZSBmaW5kIHBsdWdpbnNcbiAgaWYgKCFwbHVnaW5zKSB7XG4gICAgLy8gVE9ETyB0aGlzIGluZm8gc2hvdWxkIGdvIGluIGRvY3MgaW5zdGVhZDsgdXBkYXRlIHdoZW4gZG9jcyBmb3IgdGhpc1xuICAgIC8vIGZlYXR1cmUgZXhpc3RcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZpbmRpbmcgYW4gZWxlbWVudCB1c2luZyBhIHBsdWdpbiBpcyBjdXJyZW50bHkgYW4gJyArXG4gICAgICAnaW5jdWJhdGluZyBmZWF0dXJlLiBUbyB1c2UgaXQgeW91IG11c3QgbWFudWFsbHkgaW5zdGFsbCBvbmUgb3IgbW9yZSAnICtcbiAgICAgICdwbHVnaW4gbW9kdWxlcyBpbiBhIHdheSB0aGF0IHRoZXkgY2FuIGJlIHJlcXVpcmVkIGJ5IEFwcGl1bSwgZm9yICcgK1xuICAgICAgJ2V4YW1wbGUgaW5zdGFsbGluZyB0aGVtIGZyb20gdGhlIEFwcGl1bSBkaXJlY3RvcnksIGluc3RhbGxpbmcgdGhlbSAnICtcbiAgICAgICdnbG9iYWxseSwgb3IgaW5zdGFsbGluZyB0aGVtIGVsc2V3aGVyZSBhbmQgcGFzc2luZyBhbiBhYnNvbHV0ZSBwYXRoIGFzICcgK1xuICAgICAgJ3RoZSBjYXBhYmlsaXR5LiBUaGVuIGNvbnN0cnVjdCBhbiBvYmplY3Qgd2hlcmUgdGhlIGtleSBpcyB0aGUgc2hvcnRjdXQgJyArXG4gICAgICAnbmFtZSBmb3IgdGhpcyBwbHVnaW4gYW5kIHRoZSB2YWx1ZSBpcyB0aGUgbW9kdWxlIG5hbWUgb3IgYWJzb2x1dGUgcGF0aCwgJyArXG4gICAgICAnZm9yIGV4YW1wbGU6IHtcInAxXCI6IFwibXktZmluZC1wbHVnaW5cIn0sIGFuZCBwYXNzIHRoaXMgaW4gYXMgdGhlICcgK1xuICAgICAgXCInY3VzdG9tRmluZE1vZHVsZXMnIGNhcGFiaWxpdHkuXCIpO1xuICB9XG5cbiAgLy8gdGhlbiBkbyBzb21lIGJhc2ljIGNoZWNraW5nIG9mIHRoZSB0eXBlIG9mIHRoZSBjYXBhYmlsaXR5XG4gIGlmICghXy5pc1BsYWluT2JqZWN0KHBsdWdpbnMpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBmb3JtYXQgZm9yIHRoZSAnY3VzdG9tRmluZE1vZHVsZXMnIGNhcGFiaWxpdHkuIFwiICtcbiAgICAgICdJdCBzaG91bGQgYmUgYW4gb2JqZWN0IHdpdGgga2V5cyBjb3JyZXNwb25kaW5nIHRvIHRoZSBzaG9ydCBuYW1lcyBhbmQgJyArXG4gICAgICAndmFsdWVzIGNvcnJlc3BvbmRpbmcgdG8gdGhlIGZ1bGwgbmFtZXMgb2YgdGhlIGVsZW1lbnQgZmluZGluZyBwbHVnaW5zJyk7XG4gIH1cblxuICAvLyBnZXQgdGhlIG5hbWUgb2YgdGhlIHBhcnRpY3VsYXIgcGx1Z2luIHVzZWQgZm9yIHRoaXMgaW52b2NhdGlvbiBvZiBmaW5kLFxuICAvLyBhbmQgc2VwYXJhdGUgaXQgZnJvbSB0aGUgc2VsZWN0b3Igd2Ugd2lsbCBwYXNzIHRvIHRoZSBwbHVnaW5cbiAgbGV0IFtwbHVnaW4sIHJlYWxTZWxlY3Rvcl0gPSBzZWxlY3Rvci5zcGxpdCgnOicpO1xuXG4gIC8vIGlmIHRoZSB1c2VyIGRpZG4ndCBzcGVjaWZ5IGEgcGx1Z2luIGZvciB0aGlzIGZpbmQgaW52b2NhdGlvbiwgYW5kIHdlIGhhZFxuICAvLyBtdWx0aXBsZSBwbHVnaW5zIHJlZ2lzdGVyZWQsIHRoYXQncyBhIHByb2JsZW1cbiAgaWYgKF8uc2l6ZShwbHVnaW5zKSA+IDEgJiYgIXJlYWxTZWxlY3Rvcikge1xuICAgIHRocm93IG5ldyBFcnJvcihgTXVsdGlwbGUgZWxlbWVudCBmaW5kaW5nIHBsdWdpbnMgd2VyZSByZWdpc3RlcmVkIGAgK1xuICAgICAgYCgke18ua2V5cyhwbHVnaW5zKX0pLCBidXQgeW91ciBzZWxlY3RvciBkaWQgbm90IGluZGljYXRlIHdoaWNoIHBsdWdpbiBgICtcbiAgICAgIGB0byB1c2UuIEVuc3VyZSB5b3UgcHV0IHRoZSBzaG9ydCBuYW1lIG9mIHRoZSBwbHVnaW4gZm9sbG93ZWQgYnkgJzonIGFzIGAgK1xuICAgICAgYHRoZSBpbml0aWFsIHBhcnQgb2YgdGhlIHNlbGVjdG9yIHN0cmluZy5gKTtcbiAgfVxuXG4gIC8vIGJ1dCBpZiB0aGV5IGRpZCBub3Qgc3BlY2lmeSBhIHBsdWdpbiBhbmQgd2Ugb25seSBoYXZlIG9uZSBwbHVnaW4sIGp1c3QgdXNlXG4gIC8vIHRoYXQgb25lXG4gIGlmIChfLnNpemUocGx1Z2lucykgPT09IDEgJiYgIXJlYWxTZWxlY3Rvcikge1xuICAgIHJlYWxTZWxlY3RvciA9IHBsdWdpbjtcbiAgICBwbHVnaW4gPSBfLmtleXMocGx1Z2lucylbMF07XG4gIH1cblxuICBpZiAoIXBsdWdpbnNbcGx1Z2luXSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgU2VsZWN0b3Igc3BlY2lmaWVkIHVzZSBvZiBlbGVtZW50IGZpbmRpbmcgcGx1Z2luIGAgK1xuICAgICAgYCcke3BsdWdpbn0nIGJ1dCBpdCB3YXMgbm90IHJlZ2lzdGVyZWQgaW4gdGhlICdjdXN0b21GaW5kTW9kdWxlcycgYCArXG4gICAgICBgY2FwYWJpbGl0eS5gKTtcbiAgfVxuXG4gIGxldCBmaW5kZXI7XG4gIHRyeSB7XG4gICAgbG9nLmRlYnVnKGBGaW5kIHBsdWdpbiAnJHtwbHVnaW59JyByZXF1ZXN0ZWQ7IHdpbGwgYXR0ZW1wdCB0byB1c2UgaXQgYCArXG4gICAgICBgZnJvbSAnJHtwbHVnaW5zW3BsdWdpbl19J2ApO1xuICAgIGZpbmRlciA9IHJlcXVpcmUocGx1Z2luc1twbHVnaW5dKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgbG9hZCB5b3VyIGN1c3RvbSBmaW5kIG1vZHVsZSAnJHtwbHVnaW59Jy4gRGlkIGAgK1xuICAgICAgYHlvdSBwdXQgaXQgc29tZXdoZXJlIEFwcGl1bSBjYW4gJ3JlcXVpcmUnIGl0PyBPcmlnaW5hbCBlcnJvcjogJHtlcnJ9YCk7XG4gIH1cblxuICBpZiAoIWZpbmRlciB8fCAhXy5pc0Z1bmN0aW9uKGZpbmRlci5maW5kKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignWW91ciBjdXN0b20gZmluZCBtb2R1bGUgZGlkIG5vdCBhcHBlYXIgdG8gYmUgY29uc3RydWN0ZWQgJyArXG4gICAgICAgICdjb3JyZWN0bHkuIEl0IG5lZWRzIHRvIGV4cG9ydCBhbiBvYmplY3Qgd2l0aCBhIGBmaW5kYCBtZXRob2QuJyk7XG4gIH1cblxuICBjb25zdCBjdXN0b21GaW5kZXJMb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKHBsdWdpbik7XG5cbiAgbGV0IGVsZW1lbnRzO1xuICBjb25zdCBjb25kaXRpb24gPSBhc3luYyAoKSA9PiB7XG4gICAgLy8gZ2V0IGEgbGlzdCBvZiBtYXRjaGVkIGVsZW1lbnRzIGZyb20gdGhlIGN1c3RvbSBmaW5kZXIsIHdoaWNoIGNhblxuICAgIC8vIHBvdGVudGlhbGx5IHVzZSB0aGUgZW50aXJlIHN1aXRlIG9mIG1ldGhvZHMgdGhlIGN1cnJlbnQgZHJpdmVyIHByb3ZpZGVzLlxuICAgIC8vIHRoZSBmaW5kZXIgc2hvdWxkIGFsd2F5cyByZXR1cm4gYSBsaXN0IG9mIGVsZW1lbnRzLCBidXQgbWF5IHVzZSB0aGVcbiAgICAvLyBrbm93bGVkZ2Ugb2Ygd2hldGhlciB3ZSBhcmUgbG9va2luZyBmb3Igb25lIG9yIG1hbnkgdG8gcGVyZm9ybSBpbnRlcm5hbFxuICAgIC8vIG9wdGltaXphdGlvbnNcbiAgICBlbGVtZW50cyA9IGF3YWl0IGZpbmRlci5maW5kKHRoaXMsIGN1c3RvbUZpbmRlckxvZywgcmVhbFNlbGVjdG9yLCBtdWx0aXBsZSk7XG5cbiAgICAvLyBpZiB3ZSdyZSBsb29raW5nIGZvciBtdWx0aXBsZSBlbGVtZW50cywgb3IgaWYgd2UncmUgbG9va2luZyBmb3Igb25seVxuICAgIC8vIG9uZSBhbmQgZm91bmQgaXQsIHdlJ3JlIGRvbmVcbiAgICBpZiAoIV8uaXNFbXB0eShlbGVtZW50cykgfHwgbXVsdGlwbGUpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIG90aGVyd2lzZSB3ZSBzaG91bGQgcmV0cnksIHNvIHJldHVybiBmYWxzZSB0byB0cmlnZ2VyIHRoZSByZXRyeSBsb29wXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9O1xuXG4gIHRyeSB7XG4gICAgLy8gbWFrZSBzdXJlIHdlIHJlc3BlY3QgaW1wbGljaXQgd2FpdFxuICAgIGF3YWl0IHRoaXMuaW1wbGljaXRXYWl0Rm9yQ29uZGl0aW9uKGNvbmRpdGlvbik7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnIubWVzc2FnZS5tYXRjaCgvQ29uZGl0aW9uIHVubWV0LykpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG4gICAgfVxuICAgIHRocm93IGVycjtcbiAgfVxuXG4gIHJldHVybiBtdWx0aXBsZSA/IGVsZW1lbnRzIDogZWxlbWVudHNbMF07XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IEZpbmRCeUltYWdlT3B0aW9uc1xuICogQHByb3BlcnR5IHtib29sZWFufSBbc2hvdWxkQ2hlY2tTdGFsZW5lc3M9ZmFsc2VdIC0gd2hldGhlciB0aGlzIGNhbGwgdG8gZmluZCBhblxuICogaW1hZ2UgaXMgbWVyZWx5IHRvIGNoZWNrIHN0YWxlbmVzcy4gSWYgc28gd2UgY2FuIGJ5cGFzcyBhIGxvdCBvZiBsb2dpY1xuICogQHByb3BlcnR5IHtib29sZWFufSBbbXVsdGlwbGU9ZmFsc2VdIC0gV2hldGhlciB3ZSBhcmUgZmluZGluZyBvbmUgZWxlbWVudCBvclxuICogbXVsdGlwbGVcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW2lnbm9yZURlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGU9ZmFsc2VdIC0gV2hldGhlciB3ZVxuICogaWdub3JlIGRlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUuIEl0IGNhbiBiZSB1c2VkIHdoZW4geW91IHdvdWxkIGxpa2UgdG9cbiAqIHNjYWxlIGI2NFRlbXBsYXRlIHdpdGggZGVmYXVsdEltYWdlVGVtcGxhdGVTY2FsZSBzZXR0aW5nLlxuICovXG5cbi8qKlxuICogRmluZCBhIHNjcmVlbiByZWN0IHJlcHJlc2VudGVkIGJ5IGFuIEltYWdlRWxlbWVudCBjb3JyZXNwb25kaW5nIHRvIGFuIGltYWdlXG4gKiB0ZW1wbGF0ZSBzZW50IGluIGJ5IHRoZSBjbGllbnRcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYjY0VGVtcGxhdGUgLSBiYXNlNjQtZW5jb2RlZCBpbWFnZSB1c2VkIGFzIGEgdGVtcGxhdGUgdG8gYmVcbiAqIG1hdGNoZWQgaW4gdGhlIHNjcmVlbnNob3RcbiAqIEBwYXJhbSB7RmluZEJ5SW1hZ2VPcHRpb25zfSAtIGFkZGl0aW9uYWwgb3B0aW9uc1xuICpcbiAqIEByZXR1cm5zIHtXZWJFbGVtZW50fSAtIFdlYkRyaXZlciBlbGVtZW50IHdpdGggYSBzcGVjaWFsIGlkIHByZWZpeFxuICovXG5oZWxwZXJzLmZpbmRCeUltYWdlID0gYXN5bmMgZnVuY3Rpb24gZmluZEJ5SW1hZ2UgKGI2NFRlbXBsYXRlLCB7XG4gIHNob3VsZENoZWNrU3RhbGVuZXNzID0gZmFsc2UsXG4gIG11bHRpcGxlID0gZmFsc2UsXG4gIGlnbm9yZURlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUgPSBmYWxzZSxcbn0pIHtcbiAgY29uc3Qge1xuICAgIGltYWdlTWF0Y2hUaHJlc2hvbGQ6IHRocmVzaG9sZCxcbiAgICBmaXhJbWFnZVRlbXBsYXRlU2l6ZSxcbiAgICBmaXhJbWFnZVRlbXBsYXRlU2NhbGUsXG4gICAgZGVmYXVsdEltYWdlVGVtcGxhdGVTY2FsZSxcbiAgICBnZXRNYXRjaGVkSW1hZ2VSZXN1bHQ6IHZpc3VhbGl6ZVxuICB9ID0gdGhpcy5zZXR0aW5ncy5nZXRTZXR0aW5ncygpO1xuXG4gIGxvZy5pbmZvKGBGaW5kaW5nIGltYWdlIGVsZW1lbnQgd2l0aCBtYXRjaCB0aHJlc2hvbGQgJHt0aHJlc2hvbGR9YCk7XG4gIGlmICghdGhpcy5nZXRXaW5kb3dTaXplKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiVGhpcyBkcml2ZXIgZG9lcyBub3Qgc3VwcG9ydCB0aGUgcmVxdWlyZWQgJ2dldFdpbmRvd1NpemUnIGNvbW1hbmRcIik7XG4gIH1cbiAgY29uc3Qge3dpZHRoOiBzY3JlZW5XaWR0aCwgaGVpZ2h0OiBzY3JlZW5IZWlnaHR9ID0gYXdhaXQgdGhpcy5nZXRXaW5kb3dTaXplKCk7XG5cbiAgLy8gc29tZW9uZSBtaWdodCBoYXZlIHNlbnQgaW4gYSB0ZW1wbGF0ZSB0aGF0J3MgbGFyZ2VyIHRoYW4gdGhlIHNjcmVlblxuICAvLyBkaW1lbnNpb25zLiBJZiBzbyBsZXQncyBjaGVjayBhbmQgY3V0IGl0IGRvd24gdG8gc2l6ZSBzaW5jZSB0aGUgYWxnb3JpdGhtXG4gIC8vIHdpbGwgbm90IHdvcmsgdW5sZXNzIHdlIGRvLiBCdXQgYmVjYXVzZSBpdCByZXF1aXJlcyBzb21lIHBvdGVudGlhbGx5XG4gIC8vIGV4cGVuc2l2ZSBjb21tYW5kcywgb25seSBkbyB0aGlzIGlmIHRoZSB1c2VyIGhhcyByZXF1ZXN0ZWQgaXQgaW4gc2V0dGluZ3MuXG4gIGlmIChmaXhJbWFnZVRlbXBsYXRlU2l6ZSkge1xuICAgIGI2NFRlbXBsYXRlID0gYXdhaXQgdGhpcy5lbnN1cmVUZW1wbGF0ZVNpemUoYjY0VGVtcGxhdGUsIHNjcmVlbldpZHRoLFxuICAgICAgc2NyZWVuSGVpZ2h0KTtcbiAgfVxuXG4gIGxldCByZWN0ID0gbnVsbDtcbiAgbGV0IGI2NE1hdGNoZWQgPSBudWxsO1xuICBsZXQgc2NvcmUgPSAwO1xuICBjb25zdCBjb25kaXRpb24gPSBhc3luYyAoKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHtiNjRTY3JlZW5zaG90LCBzY2FsZX0gPSBhd2FpdCB0aGlzLmdldFNjcmVlbnNob3RGb3JJbWFnZUZpbmQoc2NyZWVuV2lkdGgsIHNjcmVlbkhlaWdodCk7XG5cbiAgICAgIGI2NFRlbXBsYXRlID0gYXdhaXQgdGhpcy5maXhJbWFnZVRlbXBsYXRlU2NhbGUoYjY0VGVtcGxhdGUsIHtcbiAgICAgICAgZGVmYXVsdEltYWdlVGVtcGxhdGVTY2FsZSwgaWdub3JlRGVmYXVsdEltYWdlVGVtcGxhdGVTY2FsZSxcbiAgICAgICAgZml4SW1hZ2VUZW1wbGF0ZVNjYWxlLCAuLi5zY2FsZVxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGNvbXBhcmVkSW1hZ2UgPSBhd2FpdCB0aGlzLmNvbXBhcmVJbWFnZXMoTUFUQ0hfVEVNUExBVEVfTU9ERSwgYjY0U2NyZWVuc2hvdCwgYjY0VGVtcGxhdGUsIHt0aHJlc2hvbGQsIHZpc3VhbGl6ZX0pO1xuICAgICAgcmVjdCA9IGNvbXBhcmVkSW1hZ2UucmVjdDtcbiAgICAgIGI2NE1hdGNoZWQgPSBjb21wYXJlZEltYWdlLnZpc3VhbGl6YXRpb247XG4gICAgICBzY29yZSA9IGNvbXBhcmVkSW1hZ2Uuc2NvcmU7XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gaWYgY29tcGFyZUltYWdlcyBmYWlscywgd2UnbGwgZ2V0IGEgc3BlY2lmaWMgZXJyb3IsIGJ1dCB3ZSBzaG91bGRcbiAgICAgIC8vIHJldHJ5LCBzbyB0cmFwIHRoYXQgYW5kIGp1c3QgcmV0dXJuIGZhbHNlIHRvIHRyaWdnZXIgdGhlIG5leHQgcm91bmQgb2ZcbiAgICAgIC8vIGltcGxpY2l0bHkgd2FpdGluZy4gRm9yIG90aGVyIGVycm9ycywgdGhyb3cgdGhlbSB0byBnZXQgb3V0IG9mIHRoZVxuICAgICAgLy8gaW1wbGljaXQgd2FpdCBsb29wXG4gICAgICBpZiAoZXJyLm1lc3NhZ2UubWF0Y2goL0Nhbm5vdCBmaW5kIGFueSBvY2N1cnJlbmNlcy8pKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH07XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmltcGxpY2l0V2FpdEZvckNvbmRpdGlvbihjb25kaXRpb24pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICAvLyB0aGlzIGBpbXBsaWNpdFdhaXRGb3JDb25kaXRpb25gIG1ldGhvZCB3aWxsIHRocm93IGEgJ0NvbmRpdGlvbiB1bm1ldCdcbiAgICAvLyBlcnJvciBpZiBhbiBlbGVtZW50IGlzIG5vdCBmb3VuZCBldmVudHVhbGx5LiBJbiB0aGF0IGNhc2UsIHdlIHdpbGxcbiAgICAvLyBoYW5kbGUgdGhlIGVsZW1lbnQgbm90IGZvdW5kIHJlc3BvbnNlIGJlbG93LiBJbiB0aGUgY2FzZSB3aGVyZSBnZXQgc29tZVxuICAgIC8vIF9vdGhlcl8ga2luZCBvZiBlcnJvciwgaXQgbWVhbnMgc29tZXRoaW5nIGJsZXcgdXAgdG90YWxseSBhcGFydCBmcm9tIHRoZVxuICAgIC8vIGltcGxpY2l0IHdhaXQgdGltZW91dC4gV2Ugc2hvdWxkIG5vdCBtYXNrIHRoYXQgZXJyb3IgYW5kIGluc3RlYWQgdGhyb3dcbiAgICAvLyBpdCBzdHJhaWdodGF3YXlcbiAgICBpZiAoIWVyci5tZXNzYWdlLm1hdGNoKC9Db25kaXRpb24gdW5tZXQvKSkge1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfVxuXG4gIGlmICghcmVjdCkge1xuICAgIGlmIChtdWx0aXBsZSkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICB9XG5cbiAgbG9nLmluZm8oYEltYWdlIHRlbXBsYXRlIG1hdGNoZWQ6ICR7SlNPTi5zdHJpbmdpZnkocmVjdCl9YCk7XG4gIGlmIChiNjRNYXRjaGVkKSB7XG4gICAgbG9nLmluZm8oYE1hdGNoZWQgYmFzZTY0IGRhdGE6ICR7YjY0TWF0Y2hlZC5zdWJzdHJpbmcoMCwgMjAwKX0uLi5gKTtcbiAgfVxuICBjb25zdCBpbWdFbCA9IG5ldyBJbWFnZUVsZW1lbnQoYjY0VGVtcGxhdGUsIHJlY3QsIHNjb3JlLCBiNjRNYXRjaGVkKTtcblxuICAvLyBpZiB3ZSdyZSBqdXN0IGNoZWNraW5nIHN0YWxlbmVzcywgcmV0dXJuIHN0cmFpZ2h0YXdheSBzbyB3ZSBkb24ndCBhZGRcbiAgLy8gYSBuZXcgZWxlbWVudCB0byB0aGUgY2FjaGUuIHNob3VsZENoZWNrU3RhbGVuZXNzIGRvZXMgbm90IHN1cHBvcnQgbXVsdGlwbGVcbiAgLy8gZWxlbWVudHMsIHNpbmNlIGl0IGlzIGEgcHVyZWx5IGludGVybmFsIG1lY2hhbmlzbVxuICBpZiAoc2hvdWxkQ2hlY2tTdGFsZW5lc3MpIHtcbiAgICByZXR1cm4gaW1nRWw7XG4gIH1cblxuICBjb25zdCBwcm90b2NvbEVsID0gdGhpcy5yZWdpc3RlckltYWdlRWxlbWVudChpbWdFbCk7XG5cbiAgcmV0dXJuIG11bHRpcGxlID8gW3Byb3RvY29sRWxdIDogcHJvdG9jb2xFbDtcbn07XG5cbi8qKlxuICogRW5zdXJlIHRoYXQgdGhlIGltYWdlIHRlbXBsYXRlIHNlbnQgaW4gZm9yIGEgZmluZCBpcyBvZiBhIHN1aXRhYmxlIHNpemVcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYjY0VGVtcGxhdGUgLSBiYXNlNjQtZW5jb2RlZCBpbWFnZVxuICogQHBhcmFtIHtpbnR9IHNjcmVlbldpZHRoIC0gd2lkdGggb2Ygc2NyZWVuXG4gKiBAcGFyYW0ge2ludH0gc2NyZWVuSGVpZ2h0IC0gaGVpZ2h0IG9mIHNjcmVlblxuICpcbiAqIEByZXR1cm5zIHtzdHJpbmd9IGJhc2U2NC1lbmNvZGVkIGltYWdlLCBwb3RlbnRpYWxseSByZXNpemVkXG4gKi9cbmhlbHBlcnMuZW5zdXJlVGVtcGxhdGVTaXplID0gYXN5bmMgZnVuY3Rpb24gZW5zdXJlVGVtcGxhdGVTaXplIChiNjRUZW1wbGF0ZSwgc2NyZWVuV2lkdGgsIHNjcmVlbkhlaWdodCkge1xuICBsZXQgaW1nT2JqID0gYXdhaXQgaW1hZ2VVdGlsLmdldEppbXBJbWFnZShiNjRUZW1wbGF0ZSk7XG4gIGxldCB7d2lkdGg6IHRwbFdpZHRoLCBoZWlnaHQ6IHRwbEhlaWdodH0gPSBpbWdPYmouYml0bWFwO1xuXG4gIGxvZy5pbmZvKGBUZW1wbGF0ZSBpbWFnZSBpcyAke3RwbFdpZHRofXgke3RwbEhlaWdodH0uIFNjcmVlbiBzaXplIGlzICR7c2NyZWVuV2lkdGh9eCR7c2NyZWVuSGVpZ2h0fWApO1xuICAvLyBpZiB0aGUgdGVtcGxhdGUgZml0cyBpbnNpZGUgdGhlIHNjcmVlbiBkaW1lbnNpb25zLCB3ZSdyZSBnb29kXG4gIGlmICh0cGxXaWR0aCA8PSBzY3JlZW5XaWR0aCAmJiB0cGxIZWlnaHQgPD0gc2NyZWVuSGVpZ2h0KSB7XG4gICAgcmV0dXJuIGI2NFRlbXBsYXRlO1xuICB9XG5cbiAgbG9nLmluZm8oYFNjYWxpbmcgdGVtcGxhdGUgaW1hZ2UgZnJvbSAke3RwbFdpZHRofXgke3RwbEhlaWdodH0gdG8gbWF0Y2ggYCArXG4gICAgICAgICAgIGBzY3JlZW4gYXQgJHtzY3JlZW5XaWR0aH14JHtzY3JlZW5IZWlnaHR9YCk7XG4gIC8vIG90aGVyd2lzZSwgc2NhbGUgaXQgdG8gZml0IGluc2lkZSB0aGUgc2NyZWVuIGRpbWVuc2lvbnNcbiAgaW1nT2JqID0gaW1nT2JqLnNjYWxlVG9GaXQoc2NyZWVuV2lkdGgsIHNjcmVlbkhlaWdodCk7XG4gIHJldHVybiAoYXdhaXQgaW1nT2JqLmdldEJ1ZmZlcihpbWFnZVV0aWwuTUlNRV9QTkcpKS50b1N0cmluZygnYmFzZTY0Jyk7XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFNjcmVlbnNob3RcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBiNjRTY3JlZW5zaG90IC0gYmFzZTY0IGJhc2VkIHNjcmVlbnNob3Qgc3RyaW5nXG4gKi9cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU2NyZWVuc2hvdFNjYWxlXG4gKiBAcHJvcGVydHkge2Zsb2F0fSB4U2NhbGUgLSBTY2FsZSByYXRpbyBmb3Igd2lkdGhcbiAqIEBwcm9wZXJ0eSB7ZmxvYXR9IHlTY2FsZSAtIFNjYWxlIHJhdGlvIGZvciBoZWlnaHRcbiAqL1xuLyoqXG4gKiBHZXQgdGhlIHNjcmVlbnNob3QgaW1hZ2UgdGhhdCB3aWxsIGJlIHVzZWQgZm9yIGZpbmQgYnkgZWxlbWVudCwgcG90ZW50aWFsbHlcbiAqIGFsdGVyaW5nIGl0IGluIHZhcmlvdXMgd2F5cyBiYXNlZCBvbiB1c2VyLXJlcXVlc3RlZCBzZXR0aW5nc1xuICpcbiAqIEBwYXJhbSB7aW50fSBzY3JlZW5XaWR0aCAtIHdpZHRoIG9mIHNjcmVlblxuICogQHBhcmFtIHtpbnR9IHNjcmVlbkhlaWdodCAtIGhlaWdodCBvZiBzY3JlZW5cbiAqXG4gKiBAcmV0dXJucyB7U2NyZWVuc2hvdCwgP1NjcmVlbnNob3RTY2FsZX0gYmFzZTY0LWVuY29kZWQgc2NyZWVuc2hvdCBhbmQgU2NyZWVuc2hvdFNjYWxlXG4gKi9cbmhlbHBlcnMuZ2V0U2NyZWVuc2hvdEZvckltYWdlRmluZCA9IGFzeW5jIGZ1bmN0aW9uIGdldFNjcmVlbnNob3RGb3JJbWFnZUZpbmQgKHNjcmVlbldpZHRoLCBzY3JlZW5IZWlnaHQpIHtcbiAgaWYgKCF0aGlzLmdldFNjcmVlbnNob3QpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJUaGlzIGRyaXZlciBkb2VzIG5vdCBzdXBwb3J0IHRoZSByZXF1aXJlZCAnZ2V0U2NyZWVuc2hvdCcgY29tbWFuZFwiKTtcbiAgfVxuXG4gIGxldCBiNjRTY3JlZW5zaG90ID0gYXdhaXQgdGhpcy5nZXRTY3JlZW5zaG90KCk7XG5cbiAgLy8gaWYgdGhlIHVzZXIgaGFzIHJlcXVlc3RlZCBub3QgdG8gY29ycmVjdCBmb3IgYXNwZWN0IG9yIHNpemUgZGlmZmVyZW5jZXNcbiAgLy8gYmV0d2VlbiB0aGUgc2NyZWVuc2hvdCBhbmQgdGhlIHNjcmVlbiwganVzdCByZXR1cm4gdGhlIHNjcmVlbnNob3Qgbm93XG4gIGlmICghdGhpcy5zZXR0aW5ncy5nZXRTZXR0aW5ncygpLmZpeEltYWdlRmluZFNjcmVlbnNob3REaW1zKSB7XG4gICAgbG9nLmluZm8oYE5vdCB2ZXJpZnlpbmcgc2NyZWVuc2hvdCBkaW1lbnNpb25zIG1hdGNoIHNjcmVlbmApO1xuICAgIHJldHVybiB7YjY0U2NyZWVuc2hvdH07XG4gIH1cblxuICBpZiAoc2NyZWVuV2lkdGggPCAxIHx8IHNjcmVlbkhlaWdodCA8IDEpIHtcbiAgICBsb2cud2FybihgVGhlIHJldHJpZXZlZCBzY3JlZW4gc2l6ZSAke3NjcmVlbldpZHRofXgke3NjcmVlbkhlaWdodH0gZG9lcyBgICtcbiAgICAgIGBub3Qgc2VlbSB0byBiZSB2YWxpZC4gTm8gY2hhbmdlcyB3aWxsIGJlIGFwcGxpZWQgdG8gdGhlIHNjcmVlbnNob3RgKTtcbiAgICByZXR1cm4ge2I2NFNjcmVlbnNob3R9O1xuICB9XG5cbiAgLy8gb3RoZXJ3aXNlLCBkbyBzb21lIHZlcmlmaWNhdGlvbiBvbiB0aGUgc2NyZWVuc2hvdCB0byBtYWtlIHN1cmUgaXQgbWF0Y2hlc1xuICAvLyB0aGUgc2NyZWVuIHNpemUgYW5kIGFzcGVjdCByYXRpb1xuICBsb2cuaW5mbygnVmVyaWZ5aW5nIHNjcmVlbnNob3Qgc2l6ZSBhbmQgYXNwZWN0IHJhdGlvJyk7XG5cbiAgbGV0IGltZ09iaiA9IGF3YWl0IGltYWdlVXRpbC5nZXRKaW1wSW1hZ2UoYjY0U2NyZWVuc2hvdCk7XG4gIGxldCB7d2lkdGg6IHNob3RXaWR0aCwgaGVpZ2h0OiBzaG90SGVpZ2h0fSA9IGltZ09iai5iaXRtYXA7XG5cbiAgaWYgKHNob3RXaWR0aCA8IDEgfHwgc2hvdEhlaWdodCA8IDEpIHtcbiAgICBsb2cud2FybihgVGhlIHJldHJpZXZlZCBzY3JlZW5zaG90IHNpemUgJHtzaG90V2lkdGh9eCR7c2hvdEhlaWdodH0gZG9lcyBgICtcbiAgICAgIGBub3Qgc2VlbSB0byBiZSB2YWxpZC4gTm8gY2hhbmdlcyB3aWxsIGJlIGFwcGxpZWQgdG8gdGhlIHNjcmVlbnNob3RgKTtcbiAgICByZXR1cm4ge2I2NFNjcmVlbnNob3R9O1xuICB9XG5cbiAgaWYgKHNjcmVlbldpZHRoID09PSBzaG90V2lkdGggJiYgc2NyZWVuSGVpZ2h0ID09PSBzaG90SGVpZ2h0KSB7XG4gICAgLy8gdGhlIGhlaWdodCBhbmQgd2lkdGggb2YgdGhlIHNjcmVlbnNob3QgYW5kIHRoZSBkZXZpY2Ugc2NyZWVuIG1hdGNoLCB3aGljaFxuICAgIC8vIG1lYW5zIHdlIHNob3VsZCBiZSBzYWZlIHdoZW4gZG9pbmcgdGVtcGxhdGUgbWF0Y2hlc1xuICAgIGxvZy5pbmZvKCdTY3JlZW5zaG90IHNpemUgbWF0Y2hlZCBzY3JlZW4gc2l6ZScpO1xuICAgIHJldHVybiB7YjY0U2NyZWVuc2hvdH07XG4gIH1cblxuICAvLyBvdGhlcndpc2UsIGlmIHRoZXkgZG9uJ3QgbWF0Y2gsIGl0IGNvdWxkIHNwZWxsIHByb2JsZW1zIGZvciB0aGUgYWNjdXJhY3lcbiAgLy8gb2YgY29vcmRpbmF0ZXMgcmV0dXJuZWQgYnkgdGhlIGltYWdlIG1hdGNoIGFsZ29yaXRobSwgc2luY2Ugd2UgbWF0Y2ggYmFzZWRcbiAgLy8gb24gdGhlIHNjcmVlbnNob3QgY29vcmRpbmF0ZXMgbm90IHRoZSBkZXZpY2UgY29vcmRpbmF0ZXMgdGhlbXNlbHZlcy4gVGhlcmVcbiAgLy8gYXJlIHR3byBwb3RlbnRpYWwgdHlwZXMgb2YgbWlzbWF0Y2g6IGFzcGVjdCByYXRpbyBtaXNtYXRjaCBhbmQgc2NhbGVcbiAgLy8gbWlzbWF0Y2guIFdlIG5lZWQgdG8gZGV0ZWN0IGFuZCBmaXggYm90aFxuXG4gIGNvbnN0IHNjYWxlID0ge3hTY2FsZTogMS4wLCB5U2NhbGU6IDEuMH07XG5cbiAgY29uc3Qgc2NyZWVuQVIgPSBzY3JlZW5XaWR0aCAvIHNjcmVlbkhlaWdodDtcbiAgY29uc3Qgc2hvdEFSID0gc2hvdFdpZHRoIC8gc2hvdEhlaWdodDtcbiAgaWYgKE1hdGgucm91bmQoc2NyZWVuQVIgKiBGTE9BVF9QUkVDSVNJT04pID09PSBNYXRoLnJvdW5kKHNob3RBUiAqIEZMT0FUX1BSRUNJU0lPTikpIHtcbiAgICBsb2cuaW5mbyhgU2NyZWVuc2hvdCBhc3BlY3QgcmF0aW8gJyR7c2hvdEFSfScgKCR7c2hvdFdpZHRofXgke3Nob3RIZWlnaHR9KSBtYXRjaGVkIGAgK1xuICAgICAgYHNjcmVlbiBhc3BlY3QgcmF0aW8gJyR7c2NyZWVuQVJ9JyAoJHtzY3JlZW5XaWR0aH14JHtzY3JlZW5IZWlnaHR9KWApO1xuICB9IGVsc2Uge1xuICAgIGxvZy53YXJuKGBXaGVuIHRyeWluZyB0byBmaW5kIGFuIGVsZW1lbnQsIGRldGVybWluZWQgdGhhdCB0aGUgc2NyZWVuIGAgK1xuICAgICAgICAgICAgIGBhc3BlY3QgcmF0aW8gYW5kIHNjcmVlbnNob3QgYXNwZWN0IHJhdGlvIGFyZSBkaWZmZXJlbnQuIFNjcmVlbiBgICtcbiAgICAgICAgICAgICBgaXMgJHtzY3JlZW5XaWR0aH14JHtzY3JlZW5IZWlnaHR9IHdoZXJlYXMgc2NyZWVuc2hvdCBpcyBgICtcbiAgICAgICAgICAgICBgJHtzaG90V2lkdGh9eCR7c2hvdEhlaWdodH0uYCk7XG5cbiAgICAvLyBJbiB0aGUgY2FzZSB3aGVyZSB0aGUgeC1zY2FsZSBhbmQgeS1zY2FsZSBhcmUgZGlmZmVyZW50LCB3ZSBuZWVkIHRvIGRlY2lkZVxuICAgIC8vIHdoaWNoIG9uZSB0byByZXNwZWN0LCBvdGhlcndpc2UgdGhlIHNjcmVlbnNob3QgYW5kIHRlbXBsYXRlIHdpbGwgZW5kIHVwXG4gICAgLy8gYmVpbmcgcmVzaXplZCBpbiBhIHdheSB0aGF0IGNoYW5nZXMgaXRzIGFzcGVjdCByYXRpbyAoZGlzdG9ydHMgaXQpLiBGb3IgZXhhbXBsZSwgbGV0J3Mgc2F5OlxuICAgIC8vIHRoaXMuZ2V0U2NyZWVuc2hvdChzaG90V2lkdGgsIHNob3RIZWlnaHQpIGlzIDU0MHgzOTcsXG4gICAgLy8gdGhpcy5nZXREZXZpY2VTaXplKHNjcmVlbldpZHRoLCBzY3JlZW5IZWlnaHQpIGlzIDEwODB4MTkyMC5cbiAgICAvLyBUaGUgcmF0aW8gd291bGQgdGhlbiBiZSB7eFNjYWxlOiAwLjUsIHlTY2FsZTogMC4yfS5cbiAgICAvLyBJbiB0aGlzIGNhc2UsIHdlIG11c3Qgc2hvdWxkIGB5U2NhbGU6IDAuMmAgYXMgc2NhbGVGYWN0b3IsIGJlY2F1c2VcbiAgICAvLyBpZiB3ZSBzZWxlY3QgdGhlIHhTY2FsZSwgdGhlIGhlaWdodCB3aWxsIGJlIGJpZ2dlciB0aGFuIHJlYWwgc2NyZWVuc2hvdCBzaXplXG4gICAgLy8gd2hpY2ggaXMgdXNlZCB0byBpbWFnZSBjb21wYXJpc29uIGJ5IE9wZW5DViBhcyBhIGJhc2UgaW1hZ2UuXG4gICAgLy8gQWxsIG9mIHRoaXMgaXMgcHJpbWFyaWx5IHVzZWZ1bCB3aGVuIHRoZSBzY3JlZW5zaG90IGlzIGEgaG9yaXpvbnRhbCBzbGljZSB0YWtlbiBvdXQgb2YgdGhlXG4gICAgLy8gc2NyZWVuIChmb3IgZXhhbXBsZSBub3QgaW5jbHVkaW5nIHRvcC9ib3R0b20gbmF2IGJhcnMpXG4gICAgY29uc3QgeFNjYWxlID0gKDEuMCAqIHNob3RXaWR0aCkgLyBzY3JlZW5XaWR0aDtcbiAgICBjb25zdCB5U2NhbGUgPSAoMS4wICogc2hvdEhlaWdodCkgLyBzY3JlZW5IZWlnaHQ7XG4gICAgY29uc3Qgc2NhbGVGYWN0b3IgPSB4U2NhbGUgPj0geVNjYWxlID8geVNjYWxlIDogeFNjYWxlO1xuXG4gICAgbG9nLndhcm4oYFJlc2l6aW5nIHNjcmVlbnNob3QgdG8gJHtzaG90V2lkdGggKiBzY2FsZUZhY3Rvcn14JHtzaG90SGVpZ2h0ICogc2NhbGVGYWN0b3J9IHRvIG1hdGNoIGAgK1xuICAgICAgICAgICAgIGBzY3JlZW4gYXNwZWN0IHJhdGlvIHNvIHRoYXQgaW1hZ2UgZWxlbWVudCBjb29yZGluYXRlcyBoYXZlIGEgYCArXG4gICAgICAgICAgICAgYGdyZWF0ZXIgY2hhbmNlIG9mIGJlaW5nIGNvcnJlY3QuYCk7XG4gICAgaW1nT2JqID0gaW1nT2JqLnJlc2l6ZShzaG90V2lkdGggKiBzY2FsZUZhY3Rvciwgc2hvdEhlaWdodCAqIHNjYWxlRmFjdG9yKTtcblxuICAgIHNjYWxlLnhTY2FsZSAqPSBzY2FsZUZhY3RvcjtcbiAgICBzY2FsZS55U2NhbGUgKj0gc2NhbGVGYWN0b3I7XG5cbiAgICBzaG90V2lkdGggPSBpbWdPYmouYml0bWFwLndpZHRoO1xuICAgIHNob3RIZWlnaHQgPSBpbWdPYmouYml0bWFwLmhlaWdodDtcbiAgfVxuXG4gIC8vIFJlc2l6ZSBiYXNlZCBvbiB0aGUgc2NyZWVuIGRpbWVuc2lvbnMgb25seSBpZiBib3RoIHdpZHRoIGFuZCBoZWlnaHQgYXJlIG1pc21hdGNoZWRcbiAgLy8gc2luY2UgZXhjZXB0IGZvciB0aGF0LCBpdCBtaWdodCBiZSBhIHNpdHVhdGlvbiB3aGljaCBpcyBkaWZmZXJlbnQgd2luZG93IHJlY3QgYW5kXG4gIC8vIHNjcmVlbnNob3Qgc2l6ZSBsaWtlIGBAZHJpdmVyLndpbmRvd19yZWN0ICM9Png9MCwgeT0wLCB3aWR0aD0xMDgwLCBoZWlnaHQ9MTc5NGAgYW5kXG4gIC8vIGBcImRldmljZVNjcmVlblNpemVcIj0+XCIxMDgweDE5MjBcImBcbiAgaWYgKHNjcmVlbldpZHRoICE9PSBzaG90V2lkdGggJiYgc2NyZWVuSGVpZ2h0ICE9PSBzaG90SGVpZ2h0KSB7XG4gICAgbG9nLmluZm8oYFNjYWxpbmcgc2NyZWVuc2hvdCBmcm9tICR7c2hvdFdpZHRofXgke3Nob3RIZWlnaHR9IHRvIG1hdGNoIGAgK1xuICAgICAgICAgICAgIGBzY3JlZW4gYXQgJHtzY3JlZW5XaWR0aH14JHtzY3JlZW5IZWlnaHR9YCk7XG4gICAgaW1nT2JqID0gaW1nT2JqLnJlc2l6ZShzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0KTtcblxuICAgIHNjYWxlLnhTY2FsZSAqPSAoMS4wICogc2NyZWVuV2lkdGgpIC8gc2hvdFdpZHRoO1xuICAgIHNjYWxlLnlTY2FsZSAqPSAoMS4wICogc2NyZWVuSGVpZ2h0KSAvIHNob3RIZWlnaHQ7XG4gIH1cblxuICBiNjRTY3JlZW5zaG90ID0gKGF3YWl0IGltZ09iai5nZXRCdWZmZXIoaW1hZ2VVdGlsLk1JTUVfUE5HKSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuICByZXR1cm4ge2I2NFNjcmVlbnNob3QsIHNjYWxlfTtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gSW1hZ2VUZW1wbGF0ZVNldHRpbmdzXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IGZpeEltYWdlVGVtcGxhdGVTY2FsZSAtIGZpeEltYWdlVGVtcGxhdGVTY2FsZSBpbiBkZXZpY2Utc2V0dGluZ3NcbiAqIEBwcm9wZXJ0eSB7ZmxvYXR9IGRlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUgLSBkZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlIGluIGRldmljZS1zZXR0aW5nc1xuICogQHByb3BlcnR5IHtib29sZWFufSBpZ25vcmVEZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlIC0gSWdub3JlIGRlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUgaWYgaXQgaGFzIHRydWUuXG4gKiBJZiBiNjRUZW1wbGF0ZSBoYXMgYmVlbiBzY2FsZWQgdG8gZGVmYXVsdEltYWdlVGVtcGxhdGVTY2FsZSBvciBzaG91bGQgaWdub3JlIHRoZSBzY2FsZSxcbiAqIHRoaXMgcGFyYW1ldGVyIHNob3VsZCBiZSB0cnVlLiBlLmcuIGNsaWNrIGluIGltYWdlLWVsZW1lbnQgbW9kdWxlXG4gKiBAcHJvcGVydHkge2Zsb2F0fSB4U2NhbGUgLSBTY2FsZSByYXRpbyBmb3Igd2lkdGhcbiAqIEBwcm9wZXJ0eSB7ZmxvYXR9IHlTY2FsZSAtIFNjYWxlIHJhdGlvIGZvciBoZWlnaHRcblxuICovXG4vKipcbiAqIEdldCBhIGltYWdlIHRoYXQgd2lsbCBiZSB1c2VkIGZvciB0ZW1wbGF0ZSBtYWNoaW5nLlxuICogUmV0dXJucyBzY2FsZWQgaW1hZ2UgaWYgc2NhbGUgcmF0aW8gaXMgcHJvdmlkZWQuXG4gKlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBiNjRUZW1wbGF0ZSAtIGJhc2U2NC1lbmNvZGVkIGltYWdlIHVzZWQgYXMgYSB0ZW1wbGF0ZSB0byBiZVxuICogbWF0Y2hlZCBpbiB0aGUgc2NyZWVuc2hvdFxuICogQHBhcmFtIHtJbWFnZVRlbXBsYXRlU2V0dGluZ3N9IG9wdHMgLSBJbWFnZSB0ZW1wbGF0ZSBzY2FsZSByZWxhdGVkIG9wdGlvbnNcbiAqXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBiYXNlNjQtZW5jb2RlZCBzY2FsZWQgdGVtcGxhdGUgc2NyZWVuc2hvdFxuICovXG5jb25zdCBERUZBVUxUX0ZJWF9JTUFHRV9URU1QTEFURV9TQ0FMRSA9IDE7XG5oZWxwZXJzLmZpeEltYWdlVGVtcGxhdGVTY2FsZSA9IGFzeW5jIGZ1bmN0aW9uIGZpeEltYWdlVGVtcGxhdGVTY2FsZSAoYjY0VGVtcGxhdGUsIG9wdHMgPSB7fSkge1xuICBpZiAoIW9wdHMpIHtcbiAgICByZXR1cm4gYjY0VGVtcGxhdGU7XG4gIH1cblxuICBsZXQge1xuICAgIGZpeEltYWdlVGVtcGxhdGVTY2FsZSA9IGZhbHNlLFxuICAgIGRlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUgPSBERUZBVUxUX1RFTVBMQVRFX0lNQUdFX1NDQUxFLFxuICAgIGlnbm9yZURlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUgPSBmYWxzZSxcbiAgICB4U2NhbGUgPSBERUZBVUxUX0ZJWF9JTUFHRV9URU1QTEFURV9TQ0FMRSxcbiAgICB5U2NhbGUgPSBERUZBVUxUX0ZJWF9JTUFHRV9URU1QTEFURV9TQ0FMRVxuICB9ID0gb3B0cztcblxuICBpZiAoaWdub3JlRGVmYXVsdEltYWdlVGVtcGxhdGVTY2FsZSkge1xuICAgIGRlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUgPSBERUZBVUxUX1RFTVBMQVRFX0lNQUdFX1NDQUxFO1xuICB9XG5cbiAgLy8gRGVmYXVsdFxuICBpZiAoZGVmYXVsdEltYWdlVGVtcGxhdGVTY2FsZSA9PT0gREVGQVVMVF9URU1QTEFURV9JTUFHRV9TQ0FMRSAmJiAhZml4SW1hZ2VUZW1wbGF0ZVNjYWxlKSB7XG4gICAgcmV0dXJuIGI2NFRlbXBsYXRlO1xuICB9XG5cbiAgLy8gQ2FsY3VsYXRlIHhTY2FsZSBhbmQgeVNjYWxlIEFwcGl1bSBzaG91bGQgc2NhbGVcbiAgaWYgKGZpeEltYWdlVGVtcGxhdGVTY2FsZSkge1xuICAgIHhTY2FsZSAqPSBkZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlO1xuICAgIHlTY2FsZSAqPSBkZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlO1xuICB9IGVsc2Uge1xuICAgIHhTY2FsZSA9IHlTY2FsZSA9IDEgKiBkZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlO1xuICB9XG5cbiAgLy8geFNjYWxlIGFuZCB5U2NhbGUgY2FuIGJlIE5hTiBpZiBkZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlIGlzIHN0cmluZywgZm9yIGV4YW1wbGVcbiAgaWYgKCFwYXJzZUZsb2F0KHhTY2FsZSkgfHwgIXBhcnNlRmxvYXQoeVNjYWxlKSkge1xuICAgIHJldHVybiBiNjRUZW1wbGF0ZTtcbiAgfVxuXG4gIC8vIFJldHVybiBpZiB0aGUgc2NhbGUgaXMgZGVmYXVsdCwgMSwgdmFsdWVcbiAgaWYgKE1hdGgucm91bmQoeFNjYWxlICogRkxPQVRfUFJFQ0lTSU9OKSA9PT0gTWF0aC5yb3VuZChERUZBVUxUX0ZJWF9JTUFHRV9URU1QTEFURV9TQ0FMRSAqIEZMT0FUX1BSRUNJU0lPTilcbiAgICAgICYmIE1hdGgucm91bmQoeVNjYWxlICogRkxPQVRfUFJFQ0lTSU9OID09PSBNYXRoLnJvdW5kKERFRkFVTFRfRklYX0lNQUdFX1RFTVBMQVRFX1NDQUxFICogRkxPQVRfUFJFQ0lTSU9OKSkpIHtcbiAgICByZXR1cm4gYjY0VGVtcGxhdGU7XG4gIH1cblxuICBsZXQgaW1nVGVtcE9iaiA9IGF3YWl0IGltYWdlVXRpbC5nZXRKaW1wSW1hZ2UoYjY0VGVtcGxhdGUpO1xuICBsZXQge3dpZHRoOiBiYXNlVGVtcFdpZHRoLCBoZWlnaHQ6IGJhc2VUZW1wSGVpZ2h9ID0gaW1nVGVtcE9iai5iaXRtYXA7XG5cbiAgY29uc3Qgc2NhbGVkV2lkdGggPSBiYXNlVGVtcFdpZHRoICogeFNjYWxlO1xuICBjb25zdCBzY2FsZWRIZWlnaHQgPSBiYXNlVGVtcEhlaWdoICogeVNjYWxlO1xuICBsb2cuaW5mbyhgU2NhbGluZyB0ZW1wbGF0ZSBpbWFnZSBmcm9tICR7YmFzZVRlbXBXaWR0aH14JHtiYXNlVGVtcEhlaWdofWAgK1xuICAgICAgICAgICAgYCB0byAke3NjYWxlZFdpZHRofXgke3NjYWxlZEhlaWdodH1gKTtcbiAgbG9nLmluZm8oYFRoZSByYXRpbyBpcyAke3hTY2FsZX0gYW5kICR7eVNjYWxlfWApO1xuICBpbWdUZW1wT2JqID0gYXdhaXQgaW1nVGVtcE9iai5yZXNpemUoc2NhbGVkV2lkdGgsIHNjYWxlZEhlaWdodCk7XG4gIHJldHVybiAoYXdhaXQgaW1nVGVtcE9iai5nZXRCdWZmZXIoaW1hZ2VVdGlsLk1JTUVfUE5HKSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycywgSU1BR0VfU1RSQVRFR1ksIENVU1RPTV9TVFJBVEVHWSB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2Jhc2Vkcml2ZXIvY29tbWFuZHMvZmluZC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLiJ9
