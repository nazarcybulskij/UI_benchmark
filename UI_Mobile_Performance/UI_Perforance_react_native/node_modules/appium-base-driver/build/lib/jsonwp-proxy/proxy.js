"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.JWProxy = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _status = require("../jsonwp-status/status");

var _errors = require("../protocol/errors");

var _protocol = require("../protocol");

var _protocolConverter = _interopRequireDefault(require("./protocol-converter"));

var _helpers = require("../protocol/helpers");

var _sessionsCache = _interopRequireDefault(require("../protocol/sessions-cache"));

const log = _appiumSupport.logger.getLogger('WD Proxy');

const LOG_OBJ_LENGTH = 1024;
const DEFAULT_REQUEST_TIMEOUT = 240000;
const {
  MJSONWP,
  W3C
} = _protocol.PROTOCOLS;

class JWProxy {
  constructor(opts = {}) {
    Object.assign(this, {
      scheme: 'http',
      server: 'localhost',
      port: 4444,
      base: _protocol.DEFAULT_BASE_PATH,
      reqBasePath: _protocol.DEFAULT_BASE_PATH,
      sessionId: null,
      timeout: DEFAULT_REQUEST_TIMEOUT,
      keepAlive: false
    }, opts);
    this.scheme = this.scheme.toLowerCase();
    this._activeRequests = [];
    this._downstreamProtocol = null;
    this.protocolConverter = new _protocolConverter.default(this.proxy.bind(this));
  }

  async request(...args) {
    const currentRequest = (0, _requestPromise.default)(...args);

    this._activeRequests.push(currentRequest);

    return await currentRequest.finally(() => _lodash.default.pull(this._activeRequests, currentRequest));
  }

  getActiveRequestsCount() {
    return this._activeRequests.length;
  }

  cancelActiveRequests() {
    try {
      for (let r of this._activeRequests) {
        r.cancel();
      }
    } finally {
      this._activeRequests = [];
    }
  }

  endpointRequiresSessionId(endpoint) {
    return !_lodash.default.includes(['/session', '/sessions', '/status'], endpoint);
  }

  set downstreamProtocol(value) {
    this._downstreamProtocol = value;
    this.protocolConverter.downstreamProtocol = value;
  }

  get downstreamProtocol() {
    return this._downstreamProtocol;
  }

  getUrlForProxy(url) {
    if (url === '') {
      url = '/';
    }

    const proxyBase = `${this.scheme}://${this.server}:${this.port}${this.base}`;
    const endpointRe = '(/(session|status))';
    let remainingUrl = '';

    if (/^http/.test(url)) {
      const first = new RegExp(`(https?://.+)${endpointRe}`).exec(url);

      if (!first) {
        throw new Error('Got a complete url but could not extract JWP endpoint');
      }

      remainingUrl = url.replace(first[1], '');
    } else if (new RegExp('^/').test(url)) {
      remainingUrl = url;
    } else {
      throw new Error(`Did not know what to do with url '${url}'`);
    }

    const stripPrefixRe = new RegExp('^.*?(/(session|status).*)$');

    if (stripPrefixRe.test(remainingUrl)) {
      remainingUrl = stripPrefixRe.exec(remainingUrl)[1];
    }

    if (!new RegExp(endpointRe).test(remainingUrl)) {
      remainingUrl = `/session/${this.sessionId}${remainingUrl}`;
    }

    const requiresSessionId = this.endpointRequiresSessionId(remainingUrl);

    if (requiresSessionId && this.sessionId === null) {
      throw new Error('Trying to proxy a session command without session id');
    }

    const sessionBaseRe = new RegExp('^/session/([^/]+)');

    if (sessionBaseRe.test(remainingUrl)) {
      const match = sessionBaseRe.exec(remainingUrl);
      remainingUrl = remainingUrl.replace(match[1], this.sessionId);
    } else if (requiresSessionId) {
      throw new Error(`Could not find :session section for url: ${remainingUrl}`);
    }

    remainingUrl = remainingUrl.replace(/\/$/, '');
    return proxyBase + remainingUrl;
  }

  async proxy(url, method, body = null) {
    method = method.toUpperCase();
    const newUrl = this.getUrlForProxy(url);

    const truncateBody = content => _lodash.default.truncate(_lodash.default.isString(content) ? content : JSON.stringify(content), {
      length: LOG_OBJ_LENGTH
    });

    const reqOpts = {
      url: newUrl,
      method,
      headers: {
        'content-type': 'application/json; charset=utf-8',
        'user-agent': 'appium',
        accept: 'application/json, */*'
      },
      resolveWithFullResponse: true,
      timeout: this.timeout
    };

    if (this.keepAlive) {
      reqOpts.forever = true;
    } else {
      reqOpts.agent = false;
    }

    if (_appiumSupport.util.hasValue(body)) {
      if (typeof body !== 'object') {
        try {
          reqOpts.json = JSON.parse(body);
        } catch (e) {
          throw new Error(`Cannot interpret the request body as valid JSON: ${truncateBody(body)}`);
        }
      } else {
        reqOpts.json = body;
      }
    }

    if (method === 'GET') {
      reqOpts.json = null;
    }

    log.debug(`Proxying [${method} ${url || '/'}] to [${method} ${newUrl}] ` + (body ? `with body: ${truncateBody(body)}` : 'with no body'));

    const throwProxyError = error => {
      const message = `The request to ${url} has failed`;
      const err = new Error(message);
      err.message = message;
      err.error = error;
      err.statusCode = 500;
      throw err;
    };

    let isResponseLogged = false;

    try {
      const res = await this.request(reqOpts);

      const resBodyObj = _appiumSupport.util.safeJsonParse(res.body);

      if (!_lodash.default.isPlainObject(resBodyObj)) {
        throwProxyError(res.body);
      }

      log.debug(`Got response with status ${res.statusCode}: ${truncateBody(res.body)}`);
      isResponseLogged = true;
      const isSessionCreationRequest = /\/session$/.test(url) && method === 'POST';

      if (isSessionCreationRequest) {
        if (res.statusCode === 200) {
          this.sessionId = resBodyObj.sessionId || (resBodyObj.value || {}).sessionId;
        }

        this.downstreamProtocol = this.getProtocolFromResBody(resBodyObj);
        log.info(`Determined the downstream protocol as '${this.downstreamProtocol}'`);
      }

      if (res.statusCode < 400 && _lodash.default.has(resBodyObj, 'status') && parseInt(resBodyObj.status, 10) !== 0) {
        throwProxyError(resBodyObj);
      }

      return [res, resBodyObj];
    } catch (e) {
      if (_appiumSupport.util.hasValue(e.error)) {
        if (!isResponseLogged) {
          const error = truncateBody(e.error);
          log.info(_appiumSupport.util.hasValue(e.statusCode) ? `Got response with status ${e.statusCode}: ${error}` : `Got response with unknown status: ${error}`);
        }
      } else {
        log.warn(e.message);
        log.debug(e.stack);
      }

      throw new _errors.errors.ProxyRequestError(`Could not proxy command to remote server. ` + `Original error: ${e.message}`, e.error, e.statusCode);
    }
  }

  getProtocolFromResBody(resObj) {
    if (_lodash.default.isInteger(resObj.status)) {
      return MJSONWP;
    }

    if (!_lodash.default.isUndefined(resObj.value)) {
      return W3C;
    }
  }

  requestToCommandName(url, method) {
    const extractCommandName = pattern => {
      const pathMatch = pattern.exec(url);
      return pathMatch ? (0, _protocol.routeToCommandName)(pathMatch[1], method, this.reqBasePath) : null;
    };

    let commandName = (0, _protocol.routeToCommandName)(url, method, this.reqBasePath);

    if (!commandName && _lodash.default.includes(url, `${this.reqBasePath}/session/`)) {
      commandName = extractCommandName(new RegExp(`${_lodash.default.escapeRegExp(this.reqBasePath)}/session/[^/]+(.+)`));
    }

    if (!commandName && _lodash.default.includes(url, this.reqBasePath)) {
      commandName = extractCommandName(new RegExp(`${_lodash.default.escapeRegExp(this.reqBasePath)}(/.+)`));
    }

    return commandName;
  }

  async proxyCommand(url, method, body = null) {
    const commandName = this.requestToCommandName(url, method);

    if (!commandName) {
      return await this.proxy(url, method, body);
    }

    log.debug(`Matched '${url}' to command name '${commandName}'`);
    return await this.protocolConverter.convertAndProxy(commandName, url, method, body);
  }

  async command(url, method, body = null) {
    let response;
    let resBodyObj;

    try {
      [response, resBodyObj] = await this.proxyCommand(url, method, body);
    } catch (err) {
      if ((0, _errors.isErrorType)(err, _errors.errors.ProxyRequestError)) {
        throw err.getActualError();
      }

      throw new _errors.errors.UnknownError(err.message);
    }

    const protocol = this.getProtocolFromResBody(resBodyObj);

    if (protocol === MJSONWP) {
      if (response.statusCode === 200 && resBodyObj.status === 0) {
        return resBodyObj.value;
      }

      const status = parseInt(resBodyObj.status, 10);

      if (!isNaN(status) && status !== 0) {
        let message = resBodyObj.value;

        if (_lodash.default.has(message, 'message')) {
          message = message.message;
        }

        throw (0, _errors.errorFromMJSONWPStatusCode)(status, _lodash.default.isEmpty(message) ? (0, _status.getSummaryByCode)(status) : message);
      }
    } else if (protocol === W3C) {
      if (response.statusCode < 300) {
        return resBodyObj.value;
      }

      if (_lodash.default.isPlainObject(resBodyObj.value) && resBodyObj.value.error) {
        throw (0, _errors.errorFromW3CJsonCode)(resBodyObj.value.error, resBodyObj.value.message, resBodyObj.value.stacktrace);
      }
    } else if (response.statusCode === 200) {
      return resBodyObj;
    }

    throw new _errors.errors.UnknownError(`Did not know what to do with response code '${response.statusCode}' ` + `and response body '${_lodash.default.truncate(JSON.stringify(resBodyObj), {
      length: 300
    })}'`);
  }

  getSessionIdFromUrl(url) {
    const match = url.match(/\/session\/([^/]+)/);
    return match ? match[1] : null;
  }

  async proxyReqRes(req, res) {
    const [response, resBodyObj] = await this.proxyCommand(req.originalUrl, req.method, req.body);
    res.headers = response.headers;
    res.set('content-type', response.headers['content-type']);
    const reqSessionId = this.getSessionIdFromUrl(req.originalUrl);

    if (_lodash.default.has(resBodyObj, 'sessionId')) {
      if (reqSessionId) {
        log.info(`Replacing sessionId ${resBodyObj.sessionId} with ${reqSessionId}`);
        resBodyObj.sessionId = reqSessionId;
      } else if (this.sessionId) {
        log.info(`Replacing sessionId ${resBodyObj.sessionId} with ${this.sessionId}`);
        resBodyObj.sessionId = this.sessionId;
      }
    }

    resBodyObj.value = (0, _helpers.formatResponseValue)(resBodyObj.value);
    (0, _helpers.formatStatus)(resBodyObj, res.statusCode, _sessionsCache.default.getProtocol(reqSessionId));
    res.status(response.statusCode).send(JSON.stringify(resBodyObj));
  }

}

exports.JWProxy = JWProxy;
var _default = JWProxy;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9qc29ud3AtcHJveHkvcHJveHkuanMiXSwibmFtZXMiOlsibG9nIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwiTE9HX09CSl9MRU5HVEgiLCJERUZBVUxUX1JFUVVFU1RfVElNRU9VVCIsIk1KU09OV1AiLCJXM0MiLCJQUk9UT0NPTFMiLCJKV1Byb3h5IiwiY29uc3RydWN0b3IiLCJvcHRzIiwiT2JqZWN0IiwiYXNzaWduIiwic2NoZW1lIiwic2VydmVyIiwicG9ydCIsImJhc2UiLCJERUZBVUxUX0JBU0VfUEFUSCIsInJlcUJhc2VQYXRoIiwic2Vzc2lvbklkIiwidGltZW91dCIsImtlZXBBbGl2ZSIsInRvTG93ZXJDYXNlIiwiX2FjdGl2ZVJlcXVlc3RzIiwiX2Rvd25zdHJlYW1Qcm90b2NvbCIsInByb3RvY29sQ29udmVydGVyIiwiUHJvdG9jb2xDb252ZXJ0ZXIiLCJwcm94eSIsImJpbmQiLCJyZXF1ZXN0IiwiYXJncyIsImN1cnJlbnRSZXF1ZXN0IiwicHVzaCIsImZpbmFsbHkiLCJfIiwicHVsbCIsImdldEFjdGl2ZVJlcXVlc3RzQ291bnQiLCJsZW5ndGgiLCJjYW5jZWxBY3RpdmVSZXF1ZXN0cyIsInIiLCJjYW5jZWwiLCJlbmRwb2ludFJlcXVpcmVzU2Vzc2lvbklkIiwiZW5kcG9pbnQiLCJpbmNsdWRlcyIsImRvd25zdHJlYW1Qcm90b2NvbCIsInZhbHVlIiwiZ2V0VXJsRm9yUHJveHkiLCJ1cmwiLCJwcm94eUJhc2UiLCJlbmRwb2ludFJlIiwicmVtYWluaW5nVXJsIiwidGVzdCIsImZpcnN0IiwiUmVnRXhwIiwiZXhlYyIsIkVycm9yIiwicmVwbGFjZSIsInN0cmlwUHJlZml4UmUiLCJyZXF1aXJlc1Nlc3Npb25JZCIsInNlc3Npb25CYXNlUmUiLCJtYXRjaCIsIm1ldGhvZCIsImJvZHkiLCJ0b1VwcGVyQ2FzZSIsIm5ld1VybCIsInRydW5jYXRlQm9keSIsImNvbnRlbnQiLCJ0cnVuY2F0ZSIsImlzU3RyaW5nIiwiSlNPTiIsInN0cmluZ2lmeSIsInJlcU9wdHMiLCJoZWFkZXJzIiwiYWNjZXB0IiwicmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2UiLCJmb3JldmVyIiwiYWdlbnQiLCJ1dGlsIiwiaGFzVmFsdWUiLCJqc29uIiwicGFyc2UiLCJlIiwiZGVidWciLCJ0aHJvd1Byb3h5RXJyb3IiLCJlcnJvciIsIm1lc3NhZ2UiLCJlcnIiLCJzdGF0dXNDb2RlIiwiaXNSZXNwb25zZUxvZ2dlZCIsInJlcyIsInJlc0JvZHlPYmoiLCJzYWZlSnNvblBhcnNlIiwiaXNQbGFpbk9iamVjdCIsImlzU2Vzc2lvbkNyZWF0aW9uUmVxdWVzdCIsImdldFByb3RvY29sRnJvbVJlc0JvZHkiLCJpbmZvIiwiaGFzIiwicGFyc2VJbnQiLCJzdGF0dXMiLCJ3YXJuIiwic3RhY2siLCJlcnJvcnMiLCJQcm94eVJlcXVlc3RFcnJvciIsInJlc09iaiIsImlzSW50ZWdlciIsImlzVW5kZWZpbmVkIiwicmVxdWVzdFRvQ29tbWFuZE5hbWUiLCJleHRyYWN0Q29tbWFuZE5hbWUiLCJwYXR0ZXJuIiwicGF0aE1hdGNoIiwiY29tbWFuZE5hbWUiLCJlc2NhcGVSZWdFeHAiLCJwcm94eUNvbW1hbmQiLCJjb252ZXJ0QW5kUHJveHkiLCJjb21tYW5kIiwicmVzcG9uc2UiLCJnZXRBY3R1YWxFcnJvciIsIlVua25vd25FcnJvciIsInByb3RvY29sIiwiaXNOYU4iLCJpc0VtcHR5Iiwic3RhY2t0cmFjZSIsImdldFNlc3Npb25JZEZyb21VcmwiLCJwcm94eVJlcVJlcyIsInJlcSIsIm9yaWdpbmFsVXJsIiwic2V0IiwicmVxU2Vzc2lvbklkIiwiU0VTU0lPTlNfQ0FDSEUiLCJnZXRQcm90b2NvbCIsInNlbmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsR0FBRyxHQUFHQyxzQkFBT0MsU0FBUCxDQUFpQixVQUFqQixDQUFaOztBQUVBLE1BQU1DLGNBQWMsR0FB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RyxDQUFDK0YsSUFBSixDQUFVLHVCQUFzQkwsVUFBVSxDQUFDdkUsU0FBVSxTQUFRNEcsWUFBYSxFQUExRTtBQUNBckMsUUFBQUEsVUFBVSxDQUFDdkUsU0FBWCxHQUF1QjRHLFlBQXZCO0FBQ0QsT0FIRCxNQUdPLElBQUksS0FBSzVHLFNBQVQsRUFBb0I7QUFDekJuQixRQUFBQSxHQUFHLENBQUMrRixJQUFKLENBQVUsdUJBQXNCTCxVQUFVLENBQUN2RSxTQUFVLFNBQVEsS0FBS0EsU0FBVSxFQUE1RTtBQUNBdUUsUUFBQUEsVUFBVSxDQUFDdkUsU0FBWCxHQUF1QixLQUFLQSxTQUE1QjtBQUNEO0FBQ0Y7O0FBQ0R1RSxJQUFBQSxVQUFVLENBQUM3QyxLQUFYLEdBQW1CLGtDQUFvQjZDLFVBQVUsQ0FBQzdDLEtBQS9CLENBQW5CO0FBQ0EsK0JBQWE2QyxVQUFiLEVBQXlCRCxHQUFHLENBQUNGLFVBQTdCLEVBQXlDeUMsdUJBQWVDLFdBQWYsQ0FBMkJGLFlBQTNCLENBQXpDO0FBQ0F0QyxJQUFBQSxHQUFHLENBQUNTLE1BQUosQ0FBV2lCLFFBQVEsQ0FBQzVCLFVBQXBCLEVBQWdDMkMsSUFBaEMsQ0FBcUM3RCxJQUFJLENBQUNDLFNBQUwsQ0FBZW9CLFVBQWYsQ0FBckM7QUFDRDs7QUFoVFc7OztlQW9UQ2xGLE8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgbG9nZ2VyLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCB7IGdldFN1bW1hcnlCeUNvZGUgfSBmcm9tICcuLi9qc29ud3Atc3RhdHVzL3N0YXR1cyc7XG5pbXBvcnQge1xuICBlcnJvcnMsIGlzRXJyb3JUeXBlLCBlcnJvckZyb21NSlNPTldQU3RhdHVzQ29kZSwgZXJyb3JGcm9tVzNDSnNvbkNvZGVcbn0gZnJvbSAnLi4vcHJvdG9jb2wvZXJyb3JzJztcbmltcG9ydCB7IFBST1RPQ09MUywgcm91dGVUb0NvbW1hbmROYW1lLCBERUZBVUxUX0JBU0VfUEFUSCB9IGZyb20gJy4uL3Byb3RvY29sJztcbmltcG9ydCBQcm90b2NvbENvbnZlcnRlciBmcm9tICcuL3Byb3RvY29sLWNvbnZlcnRlcic7XG5pbXBvcnQgeyBmb3JtYXRSZXNwb25zZVZhbHVlLCBmb3JtYXRTdGF0dXMgfSBmcm9tICcuLi9wcm90b2NvbC9oZWxwZXJzJztcbmltcG9ydCBTRVNTSU9OU19DQUNIRSBmcm9tICcuLi9wcm90b2NvbC9zZXNzaW9ucy1jYWNoZSc7XG5cbmNvbnN0IGxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ1dEIFByb3h5Jyk7XG4vLyBUT0RPOiBNYWtlIHRoaXMgdmFsdWUgY29uZmlndXJhYmxlIGFzIGEgc2VydmVyIHNpZGUgY2FwYWJpbGl0eVxuY29uc3QgTE9HX09CSl9MRU5HVEggPSAxMDI0OyAvLyBNQVggTEVOR1RIIExvZ2dlZCB0byBmaWxlIC8gY29uc29sZVxuY29uc3QgREVGQVVMVF9SRVFVRVNUX1RJTUVPVVQgPSAyNDAwMDA7XG5cbmNvbnN0IHtNSlNPTldQLCBXM0N9ID0gUFJPVE9DT0xTO1xuXG5jbGFzcyBKV1Byb3h5IHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIE9iamVjdC5hc3NpZ24odGhpcywge1xuICAgICAgc2NoZW1lOiAnaHR0cCcsXG4gICAgICBzZXJ2ZXI6ICdsb2NhbGhvc3QnLFxuICAgICAgcG9ydDogNDQ0NCxcbiAgICAgIGJhc2U6IERFRkFVTFRfQkFTRV9QQVRILFxuICAgICAgcmVxQmFzZVBhdGg6IERFRkFVTFRfQkFTRV9QQVRILFxuICAgICAgc2Vzc2lvbklkOiBudWxsLFxuICAgICAgdGltZW91dDogREVGQVVMVF9SRVFVRVNUX1RJTUVPVVQsXG4gICAgICBrZWVwQWxpdmU6IGZhbHNlLFxuICAgIH0sIG9wdHMpO1xuICAgIHRoaXMuc2NoZW1lID0gdGhpcy5zY2hlbWUudG9Mb3dlckNhc2UoKTtcbiAgICB0aGlzLl9hY3RpdmVSZXF1ZXN0cyA9IFtdO1xuICAgIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCA9IG51bGw7XG4gICAgdGhpcy5wcm90b2NvbENvbnZlcnRlciA9IG5ldyBQcm90b2NvbENvbnZlcnRlcih0aGlzLnByb3h5LmJpbmQodGhpcykpO1xuICB9XG5cbiAgLy8gYWJzdHJhY3QgdGhlIGNhbGwgYmVoaW5kIGEgbWVtYmVyIGZ1bmN0aW9uXG4gIC8vIHNvIHRoYXQgd2UgY2FuIG1vY2sgaXQgaW4gdGVzdHNcbiAgYXN5bmMgcmVxdWVzdCAoLi4uYXJncykge1xuICAgIGNvbnN0IGN1cnJlbnRSZXF1ZXN0ID0gcmVxdWVzdCguLi5hcmdzKTtcbiAgICB0aGlzLl9hY3RpdmVSZXF1ZXN0cy5wdXNoKGN1cnJlbnRSZXF1ZXN0KTtcbiAgICByZXR1cm4gYXdhaXQgY3VycmVudFJlcXVlc3QuZmluYWxseSgoKSA9PiBfLnB1bGwodGhpcy5fYWN0aXZlUmVxdWVzdHMsIGN1cnJlbnRSZXF1ZXN0KSk7XG4gIH1cblxuICBnZXRBY3RpdmVSZXF1ZXN0c0NvdW50ICgpIHtcbiAgICByZXR1cm4gdGhpcy5fYWN0aXZlUmVxdWVzdHMubGVuZ3RoO1xuICB9XG5cbiAgY2FuY2VsQWN0aXZlUmVxdWVzdHMgKCkge1xuICAgIHRyeSB7XG4gICAgICBmb3IgKGxldCByIG9mIHRoaXMuX2FjdGl2ZVJlcXVlc3RzKSB7XG4gICAgICAgIHIuY2FuY2VsKCk7XG4gICAgICB9XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRoaXMuX2FjdGl2ZVJlcXVlc3RzID0gW107XG4gICAgfVxuICB9XG5cbiAgZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZCAoZW5kcG9pbnQpIHtcbiAgICByZXR1cm4gIV8uaW5jbHVkZXMoWycvc2Vzc2lvbicsICcvc2Vzc2lvbnMnLCAnL3N0YXR1cyddLCBlbmRwb2ludCk7XG4gIH1cblxuICBzZXQgZG93bnN0cmVhbVByb3RvY29sICh2YWx1ZSkge1xuICAgIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCA9IHZhbHVlO1xuICAgIHRoaXMucHJvdG9jb2xDb252ZXJ0ZXIuZG93bnN0cmVhbVByb3RvY29sID0gdmFsdWU7XG4gIH1cblxuICBnZXQgZG93bnN0cmVhbVByb3RvY29sICgpIHtcbiAgICByZXR1cm4gdGhpcy5fZG93bnN0cmVhbVByb3RvY29sO1xuICB9XG5cbiAgZ2V0VXJsRm9yUHJveHkgKHVybCkge1xuICAgIGlmICh1cmwgPT09ICcnKSB7XG4gICAgICB1cmwgPSAnLyc7XG4gICAgfVxuICAgIGNvbnN0IHByb3h5QmFzZSA9IGAke3RoaXMuc2NoZW1lfTovLyR7dGhpcy5zZXJ2ZXJ9OiR7dGhpcy5wb3J0fSR7dGhpcy5iYXNlfWA7XG4gICAgY29uc3QgZW5kcG9pbnRSZSA9ICcoLyhzZXNzaW9ufHN0YXR1cykpJztcbiAgICBsZXQgcmVtYWluaW5nVXJsID0gJyc7XG4gICAgaWYgKC9eaHR0cC8udGVzdCh1cmwpKSB7XG4gICAgICBjb25zdCBmaXJzdCA9IChuZXcgUmVnRXhwKGAoaHR0cHM/Oi8vLispJHtlbmRwb2ludFJlfWApKS5leGVjKHVybCk7XG4gICAgICBpZiAoIWZpcnN0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignR290IGEgY29tcGxldGUgdXJsIGJ1dCBjb3VsZCBub3QgZXh0cmFjdCBKV1AgZW5kcG9pbnQnKTtcbiAgICAgIH1cbiAgICAgIHJlbWFpbmluZ1VybCA9IHVybC5yZXBsYWNlKGZpcnN0WzFdLCAnJyk7XG4gICAgfSBlbHNlIGlmICgobmV3IFJlZ0V4cCgnXi8nKSkudGVzdCh1cmwpKSB7XG4gICAgICByZW1haW5pbmdVcmwgPSB1cmw7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRGlkIG5vdCBrbm93IHdoYXQgdG8gZG8gd2l0aCB1cmwgJyR7dXJsfSdgKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdHJpcFByZWZpeFJlID0gbmV3IFJlZ0V4cCgnXi4qPygvKHNlc3Npb258c3RhdHVzKS4qKSQnKTtcbiAgICBpZiAoc3RyaXBQcmVmaXhSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHN0cmlwUHJlZml4UmUuZXhlYyhyZW1haW5pbmdVcmwpWzFdO1xuICAgIH1cblxuICAgIGlmICghKG5ldyBSZWdFeHAoZW5kcG9pbnRSZSkpLnRlc3QocmVtYWluaW5nVXJsKSkge1xuICAgICAgcmVtYWluaW5nVXJsID0gYC9zZXNzaW9uLyR7dGhpcy5zZXNzaW9uSWR9JHtyZW1haW5pbmdVcmx9YDtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1aXJlc1Nlc3Npb25JZCA9IHRoaXMuZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZChyZW1haW5pbmdVcmwpO1xuXG4gICAgaWYgKHJlcXVpcmVzU2Vzc2lvbklkICYmIHRoaXMuc2Vzc2lvbklkID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyeWluZyB0byBwcm94eSBhIHNlc3Npb24gY29tbWFuZCB3aXRob3V0IHNlc3Npb24gaWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBzZXNzaW9uQmFzZVJlID0gbmV3IFJlZ0V4cCgnXi9zZXNzaW9uLyhbXi9dKyknKTtcbiAgICBpZiAoc2Vzc2lvbkJhc2VSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIC8vIHdlIGhhdmUgc29tZXRoaW5nIGxpa2UgL3Nlc3Npb24vOmlkL2Zvb2Jhciwgc28gd2UgbmVlZCB0byByZXBsYWNlXG4gICAgICAvLyB0aGUgc2Vzc2lvbiBpZFxuICAgICAgY29uc3QgbWF0Y2ggPSBzZXNzaW9uQmFzZVJlLmV4ZWMocmVtYWluaW5nVXJsKTtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHJlbWFpbmluZ1VybC5yZXBsYWNlKG1hdGNoWzFdLCB0aGlzLnNlc3Npb25JZCk7XG4gICAgfSBlbHNlIGlmIChyZXF1aXJlc1Nlc3Npb25JZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCA6c2Vzc2lvbiBzZWN0aW9uIGZvciB1cmw6ICR7cmVtYWluaW5nVXJsfWApO1xuICAgIH1cbiAgICByZW1haW5pbmdVcmwgPSByZW1haW5pbmdVcmwucmVwbGFjZSgvXFwvJC8sICcnKTsgLy8gY2FuJ3QgaGF2ZSB0cmFpbGluZyBzbGFzaGVzXG5cbiAgICByZXR1cm4gcHJveHlCYXNlICsgcmVtYWluaW5nVXJsO1xuICB9XG5cbiAgYXN5bmMgcHJveHkgKHVybCwgbWV0aG9kLCBib2R5ID0gbnVsbCkge1xuICAgIG1ldGhvZCA9IG1ldGhvZC50b1VwcGVyQ2FzZSgpO1xuICAgIGNvbnN0IG5ld1VybCA9IHRoaXMuZ2V0VXJsRm9yUHJveHkodXJsKTtcbiAgICBjb25zdCB0cnVuY2F0ZUJvZHkgPSAoY29udGVudCkgPT4gXy50cnVuY2F0ZShcbiAgICAgIF8uaXNTdHJpbmcoY29udGVudCkgPyBjb250ZW50IDogSlNPTi5zdHJpbmdpZnkoY29udGVudCksXG4gICAgICB7IGxlbmd0aDogTE9HX09CSl9MRU5HVEggfSk7XG4gICAgY29uc3QgcmVxT3B0cyA9IHtcbiAgICAgIHVybDogbmV3VXJsLFxuICAgICAgbWV0aG9kLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgnLFxuICAgICAgICAndXNlci1hZ2VudCc6ICdhcHBpdW0nLFxuICAgICAgICBhY2NlcHQ6ICdhcHBsaWNhdGlvbi9qc29uLCAqLyonLFxuICAgICAgfSxcbiAgICAgIHJlc29sdmVXaXRoRnVsbFJlc3BvbnNlOiB0cnVlLFxuICAgICAgdGltZW91dDogdGhpcy50aW1lb3V0LFxuICAgIH07XG4gICAgaWYgKHRoaXMua2VlcEFsaXZlKSB7XG4gICAgICByZXFPcHRzLmZvcmV2ZXIgPSB0cnVlO1xuICAgICAgLy8gU2V0dGluZyBgZm9yZXZlcmAgb3B0aW9uIHRvIGB0cnVlYCBpbXBsaWNpdGx5IGFzc2lnbnNcbiAgICAgIC8vIGBhZ2VudGAgb3B0aW9uIHRvIGBodHRwKHMpLkFnZW50KHtrZWVwQWxpdmU6dHJ1ZX0pYFxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBTZXR0aW5nIGBhZ2VudGAgb3B0aW9uIHRvIGBmYWxzZWAgcHJldmVudHMgdGhlIHJlcXVlc3RzXG4gICAgICAvLyBtb2R1bGUgZnJvbSB1c2luZyBhbnkgY29ubmVjdGlvbiBwb29scywgd2hpY2ggZW5mb3JjZXNcbiAgICAgIC8vIG5ldyBzb2NrZXQgY3JlYXRpb24gZm9yIGVhY2ggSFRUUChTKSByZXF1ZXN0XG4gICAgICAvLyAodGhlIGRlZmF1bHQgSFRUUCAxLjAgYmVoYXZpb3IpXG4gICAgICByZXFPcHRzLmFnZW50ID0gZmFsc2U7XG4gICAgfVxuICAgIGlmICh1dGlsLmhhc1ZhbHVlKGJvZHkpKSB7XG4gICAgICBpZiAodHlwZW9mIGJvZHkgIT09ICdvYmplY3QnKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgcmVxT3B0cy5qc29uID0gSlNPTi5wYXJzZShib2R5KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGludGVycHJldCB0aGUgcmVxdWVzdCBib2R5IGFzIHZhbGlkIEpTT046ICR7dHJ1bmNhdGVCb2R5KGJvZHkpfWApO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXFPcHRzLmpzb24gPSBib2R5O1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEdFVCBtZXRob2RzIHNob3VsZG4ndCBoYXZlIGFueSBib2R5LiBNb3N0IHNlcnZlcnMgYXJlIE9LIHdpdGggdGhpcywgYnV0IFdlYkRyaXZlckFnZW50IHRocm93cyA0MDAgZXJyb3JzXG4gICAgaWYgKG1ldGhvZCA9PT0gJ0dFVCcpIHtcbiAgICAgIHJlcU9wdHMuanNvbiA9IG51bGw7XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKGBQcm94eWluZyBbJHttZXRob2R9ICR7dXJsIHx8ICcvJ31dIHRvIFske21ldGhvZH0gJHtuZXdVcmx9XSBgICtcbiAgICAgIChib2R5ID8gYHdpdGggYm9keTogJHt0cnVuY2F0ZUJvZHkoYm9keSl9YCA6ICd3aXRoIG5vIGJvZHknKSk7XG5cbiAgICBjb25zdCB0aHJvd1Byb3h5RXJyb3IgPSAoZXJyb3IpID0+IHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBgVGhlIHJlcXVlc3QgdG8gJHt1cmx9IGhhcyBmYWlsZWRgO1xuICAgICAgY29uc3QgZXJyID0gbmV3IEVycm9yKG1lc3NhZ2UpO1xuICAgICAgZXJyLm1lc3NhZ2UgPSBtZXNzYWdlO1xuICAgICAgZXJyLmVycm9yID0gZXJyb3I7XG4gICAgICBlcnIuc3RhdHVzQ29kZSA9IDUwMDtcbiAgICAgIHRocm93IGVycjtcbiAgICB9O1xuICAgIGxldCBpc1Jlc3BvbnNlTG9nZ2VkID0gZmFsc2U7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMucmVxdWVzdChyZXFPcHRzKTtcbiAgICAgIC8vIGByZXMuYm9keWAgbWlnaHQgYmUgcmVhbGx5IGJpZ1xuICAgICAgLy8gQmUgY2FyZWZ1bCB3aGlsZSBoYW5kbGluZyBpdCB0byBhdm9pZCBtZW1vcnkgbGVha3NcbiAgICAgIGNvbnN0IHJlc0JvZHlPYmogPSB1dGlsLnNhZmVKc29uUGFyc2UocmVzLmJvZHkpO1xuICAgICAgaWYgKCFfLmlzUGxhaW5PYmplY3QocmVzQm9keU9iaikpIHtcbiAgICAgICAgLy8gVGhlIHJlc3BvbnNlIHNob3VsZCBiZSBhIHZhbGlkIEpTT04gb2JqZWN0XG4gICAgICAgIC8vIElmIGl0IGNhbm5vdCBiZSBjb2VyY2VkIHRvIGFuIG9iamVjdCB0aGVuIHRoZSByZXNwb25zZSBpcyB3cm9uZ1xuICAgICAgICB0aHJvd1Byb3h5RXJyb3IocmVzLmJvZHkpO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGBHb3QgcmVzcG9uc2Ugd2l0aCBzdGF0dXMgJHtyZXMuc3RhdHVzQ29kZX06ICR7dHJ1bmNhdGVCb2R5KHJlcy5ib2R5KX1gKTtcbiAgICAgIGlzUmVzcG9uc2VMb2dnZWQgPSB0cnVlO1xuICAgICAgY29uc3QgaXNTZXNzaW9uQ3JlYXRpb25SZXF1ZXN0ID0gL1xcL3Nlc3Npb24kLy50ZXN0KHVybCkgJiYgbWV0aG9kID09PSAnUE9TVCc7XG4gICAgICBpZiAoaXNTZXNzaW9uQ3JlYXRpb25SZXF1ZXN0KSB7XG4gICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICAgICAgdGhpcy5zZXNzaW9uSWQgPSByZXNCb2R5T2JqLnNlc3Npb25JZCB8fCAocmVzQm9keU9iai52YWx1ZSB8fCB7fSkuc2Vzc2lvbklkO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZG93bnN0cmVhbVByb3RvY29sID0gdGhpcy5nZXRQcm90b2NvbEZyb21SZXNCb2R5KHJlc0JvZHlPYmopO1xuICAgICAgICBsb2cuaW5mbyhgRGV0ZXJtaW5lZCB0aGUgZG93bnN0cmVhbSBwcm90b2NvbCBhcyAnJHt0aGlzLmRvd25zdHJlYW1Qcm90b2NvbH0nYCk7XG4gICAgICB9XG4gICAgICBpZiAocmVzLnN0YXR1c0NvZGUgPCA0MDAgJiYgXy5oYXMocmVzQm9keU9iaiwgJ3N0YXR1cycpICYmIHBhcnNlSW50KHJlc0JvZHlPYmouc3RhdHVzLCAxMCkgIT09IDApIHtcbiAgICAgICAgLy8gU29tZSBzZXJ2ZXJzLCBsaWtlIGNocm9tZWRyaXZlciBtYXkgcmV0dXJuIHJlc3BvbnNlIGNvZGUgMjAwIGZvciBub24temVybyBKU09OV1Agc3RhdHVzZXNcbiAgICAgICAgdGhyb3dQcm94eUVycm9yKHJlc0JvZHlPYmopO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFtyZXMsIHJlc0JvZHlPYmpdO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIC8vIFdlIG9ubHkgY29uc2lkZXIgYW4gZXJyb3IgdW5leHBlY3RlZCBpZiB0aGlzIHdhcyBub3RcbiAgICAgIC8vIGFuIGFzeW5jIHJlcXVlc3QgbW9kdWxlIGVycm9yIG9yIGlmIHRoZSByZXNwb25zZSBjYW5ub3QgYmUgY2FzdCB0b1xuICAgICAgLy8gYSB2YWxpZCBKU09OXG4gICAgICBpZiAodXRpbC5oYXNWYWx1ZShlLmVycm9yKSkge1xuICAgICAgICBpZiAoIWlzUmVzcG9uc2VMb2dnZWQpIHtcbiAgICAgICAgICBjb25zdCBlcnJvciA9IHRydW5jYXRlQm9keShlLmVycm9yKTtcbiAgICAgICAgICBsb2cuaW5mbyh1dGlsLmhhc1ZhbHVlKGUuc3RhdHVzQ29kZSlcbiAgICAgICAgICAgID8gYEdvdCByZXNwb25zZSB3aXRoIHN0YXR1cyAke2Uuc3RhdHVzQ29kZX06ICR7ZXJyb3J9YFxuICAgICAgICAgICAgOiBgR290IHJlc3BvbnNlIHdpdGggdW5rbm93biBzdGF0dXM6ICR7ZXJyb3J9YCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy53YXJuKGUubWVzc2FnZSk7XG4gICAgICAgIGxvZy5kZWJ1ZyhlLnN0YWNrKTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBlcnJvcnMuUHJveHlSZXF1ZXN0RXJyb3IoYENvdWxkIG5vdCBwcm94eSBjb21tYW5kIHRvIHJlbW90ZSBzZXJ2ZXIuIGAgK1xuICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWAsIGUuZXJyb3IsIGUuc3RhdHVzQ29kZSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0UHJvdG9jb2xGcm9tUmVzQm9keSAocmVzT2JqKSB7XG4gICAgaWYgKF8uaXNJbnRlZ2VyKHJlc09iai5zdGF0dXMpKSB7XG4gICAgICByZXR1cm4gTUpTT05XUDtcbiAgICB9XG4gICAgaWYgKCFfLmlzVW5kZWZpbmVkKHJlc09iai52YWx1ZSkpIHtcbiAgICAgIHJldHVybiBXM0M7XG4gICAgfVxuICB9XG5cbiAgcmVxdWVzdFRvQ29tbWFuZE5hbWUgKHVybCwgbWV0aG9kKSB7XG4gICAgY29uc3QgZXh0cmFjdENvbW1hbmROYW1lID0gKHBhdHRlcm4pID0+IHtcbiAgICAgIGNvbnN0IHBhdGhNYXRjaCA9IHBhdHRlcm4uZXhlYyh1cmwpO1xuICAgICAgcmV0dXJuIHBhdGhNYXRjaCA/IHJvdXRlVG9Db21tYW5kTmFtZShwYXRoTWF0Y2hbMV0sIG1ldGhvZCwgdGhpcy5yZXFCYXNlUGF0aCkgOiBudWxsO1xuICAgIH07XG4gICAgbGV0IGNvbW1hbmROYW1lID0gcm91dGVUb0NvbW1hbmROYW1lKHVybCwgbWV0aG9kLCB0aGlzLnJlcUJhc2VQYXRoKTtcbiAgICBpZiAoIWNvbW1hbmROYW1lICYmIF8uaW5jbHVkZXModXJsLCBgJHt0aGlzLnJlcUJhc2VQYXRofS9zZXNzaW9uL2ApKSB7XG4gICAgICBjb21tYW5kTmFtZSA9IGV4dHJhY3RDb21tYW5kTmFtZShuZXcgUmVnRXhwKGAke18uZXNjYXBlUmVnRXhwKHRoaXMucmVxQmFzZVBhdGgpfS9zZXNzaW9uL1teL10rKC4rKWApKTtcbiAgICB9XG4gICAgaWYgKCFjb21tYW5kTmFtZSAmJiBfLmluY2x1ZGVzKHVybCwgdGhpcy5yZXFCYXNlUGF0aCkpIHtcbiAgICAgIGNvbW1hbmROYW1lID0gZXh0cmFjdENvbW1hbmROYW1lKG5ldyBSZWdFeHAoYCR7Xy5lc2NhcGVSZWdFeHAodGhpcy5yZXFCYXNlUGF0aCl9KC8uKylgKSk7XG4gICAgfVxuICAgIHJldHVybiBjb21tYW5kTmFtZTtcbiAgfVxuXG4gIGFzeW5jIHByb3h5Q29tbWFuZCAodXJsLCBtZXRob2QsIGJvZHkgPSBudWxsKSB7XG4gICAgY29uc3QgY29tbWFuZE5hbWUgPSB0aGlzLnJlcXVlc3RUb0NvbW1hbmROYW1lKHVybCwgbWV0aG9kKTtcbiAgICBpZiAoIWNvbW1hbmROYW1lKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eSh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgTWF0Y2hlZCAnJHt1cmx9JyB0byBjb21tYW5kIG5hbWUgJyR7Y29tbWFuZE5hbWV9J2ApO1xuXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJvdG9jb2xDb252ZXJ0ZXIuY29udmVydEFuZFByb3h5KGNvbW1hbmROYW1lLCB1cmwsIG1ldGhvZCwgYm9keSk7XG4gIH1cblxuICBhc3luYyBjb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSA9IG51bGwpIHtcbiAgICBsZXQgcmVzcG9uc2U7XG4gICAgbGV0IHJlc0JvZHlPYmo7XG4gICAgdHJ5IHtcbiAgICAgIFtyZXNwb25zZSwgcmVzQm9keU9ial0gPSBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoaXNFcnJvclR5cGUoZXJyLCBlcnJvcnMuUHJveHlSZXF1ZXN0RXJyb3IpKSB7XG4gICAgICAgIHRocm93IGVyci5nZXRBY3R1YWxFcnJvcigpO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoZXJyLm1lc3NhZ2UpO1xuICAgIH1cbiAgICBjb25zdCBwcm90b2NvbCA9IHRoaXMuZ2V0UHJvdG9jb2xGcm9tUmVzQm9keShyZXNCb2R5T2JqKTtcbiAgICBpZiAocHJvdG9jb2wgPT09IE1KU09OV1ApIHtcbiAgICAgIC8vIEdvdCByZXNwb25zZSBpbiBNSlNPTldQIGZvcm1hdFxuICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDIwMCAmJiByZXNCb2R5T2JqLnN0YXR1cyA9PT0gMCkge1xuICAgICAgICByZXR1cm4gcmVzQm9keU9iai52YWx1ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHN0YXR1cyA9IHBhcnNlSW50KHJlc0JvZHlPYmouc3RhdHVzLCAxMCk7XG4gICAgICBpZiAoIWlzTmFOKHN0YXR1cykgJiYgc3RhdHVzICE9PSAwKSB7XG4gICAgICAgIGxldCBtZXNzYWdlID0gcmVzQm9keU9iai52YWx1ZTtcbiAgICAgICAgaWYgKF8uaGFzKG1lc3NhZ2UsICdtZXNzYWdlJykpIHtcbiAgICAgICAgICBtZXNzYWdlID0gbWVzc2FnZS5tZXNzYWdlO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlKHN0YXR1cywgXy5pc0VtcHR5KG1lc3NhZ2UpID8gZ2V0U3VtbWFyeUJ5Q29kZShzdGF0dXMpIDogbWVzc2FnZSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChwcm90b2NvbCA9PT0gVzNDKSB7XG4gICAgICAvLyBHb3QgcmVzcG9uc2UgaW4gVzNDIGZvcm1hdFxuICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPCAzMDApIHtcbiAgICAgICAgcmV0dXJuIHJlc0JvZHlPYmoudmFsdWU7XG4gICAgICB9XG4gICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KHJlc0JvZHlPYmoudmFsdWUpICYmIHJlc0JvZHlPYmoudmFsdWUuZXJyb3IpIHtcbiAgICAgICAgdGhyb3cgZXJyb3JGcm9tVzNDSnNvbkNvZGUocmVzQm9keU9iai52YWx1ZS5lcnJvciwgcmVzQm9keU9iai52YWx1ZS5tZXNzYWdlLCByZXNCb2R5T2JqLnZhbHVlLnN0YWNrdHJhY2UpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICAvLyBVbmtub3duIHByb3RvY29sLiBLZWVwaW5nIGl0IGJlY2F1c2Ugb2YgdGhlIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbiAgICAgIHJldHVybiByZXNCb2R5T2JqO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihgRGlkIG5vdCBrbm93IHdoYXQgdG8gZG8gd2l0aCByZXNwb25zZSBjb2RlICcke3Jlc3BvbnNlLnN0YXR1c0NvZGV9JyBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgYW5kIHJlc3BvbnNlIGJvZHkgJyR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShyZXNCb2R5T2JqKSwge2xlbmd0aDogMzAwfSl9J2ApO1xuICB9XG5cbiAgZ2V0U2Vzc2lvbklkRnJvbVVybCAodXJsKSB7XG4gICAgY29uc3QgbWF0Y2ggPSB1cmwubWF0Y2goL1xcL3Nlc3Npb25cXC8oW14vXSspLyk7XG4gICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBudWxsO1xuICB9XG5cbiAgYXN5bmMgcHJveHlSZXFSZXMgKHJlcSwgcmVzKSB7XG4gICAgY29uc3QgW3Jlc3BvbnNlLCByZXNCb2R5T2JqXSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKHJlcS5vcmlnaW5hbFVybCwgcmVxLm1ldGhvZCwgcmVxLmJvZHkpO1xuXG4gICAgcmVzLmhlYWRlcnMgPSByZXNwb25zZS5oZWFkZXJzO1xuICAgIHJlcy5zZXQoJ2NvbnRlbnQtdHlwZScsIHJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddKTtcbiAgICAvLyBpZiB0aGUgcHJveGllZCByZXNwb25zZSBjb250YWlucyBhIHNlc3Npb25JZCB0aGF0IHRoZSBkb3duc3RyZWFtXG4gICAgLy8gZHJpdmVyIGhhcyBnZW5lcmF0ZWQsIHdlIGRvbid0IHdhbnQgdG8gcmV0dXJuIHRoYXQgdG8gdGhlIGNsaWVudC5cbiAgICAvLyBJbnN0ZWFkLCByZXR1cm4gdGhlIGlkIGZyb20gdGhlIHJlcXVlc3Qgb3IgZnJvbSBjdXJyZW50IHNlc3Npb25cbiAgICBjb25zdCByZXFTZXNzaW9uSWQgPSB0aGlzLmdldFNlc3Npb25JZEZyb21VcmwocmVxLm9yaWdpbmFsVXJsKTtcbiAgICBpZiAoXy5oYXMocmVzQm9keU9iaiwgJ3Nlc3Npb25JZCcpKSB7XG4gICAgICBpZiAocmVxU2Vzc2lvbklkKSB7XG4gICAgICAgIGxvZy5pbmZvKGBSZXBsYWNpbmcgc2Vzc2lvbklkICR7cmVzQm9keU9iai5zZXNzaW9uSWR9IHdpdGggJHtyZXFTZXNzaW9uSWR9YCk7XG4gICAgICAgIHJlc0JvZHlPYmouc2Vzc2lvbklkID0gcmVxU2Vzc2lvbklkO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLnNlc3Npb25JZCkge1xuICAgICAgICBsb2cuaW5mbyhgUmVwbGFjaW5nIHNlc3Npb25JZCAke3Jlc0JvZHlPYmouc2Vzc2lvbklkfSB3aXRoICR7dGhpcy5zZXNzaW9uSWR9YCk7XG4gICAgICAgIHJlc0JvZHlPYmouc2Vzc2lvbklkID0gdGhpcy5zZXNzaW9uSWQ7XG4gICAgICB9XG4gICAgfVxuICAgIHJlc0JvZHlPYmoudmFsdWUgPSBmb3JtYXRSZXNwb25zZVZhbHVlKHJlc0JvZHlPYmoudmFsdWUpO1xuICAgIGZvcm1hdFN0YXR1cyhyZXNCb2R5T2JqLCByZXMuc3RhdHVzQ29kZSwgU0VTU0lPTlNfQ0FDSEUuZ2V0UHJvdG9jb2wocmVxU2Vzc2lvbklkKSk7XG4gICAgcmVzLnN0YXR1cyhyZXNwb25zZS5zdGF0dXNDb2RlKS5zZW5kKEpTT04uc3RyaW5naWZ5KHJlc0JvZHlPYmopKTtcbiAgfVxufVxuXG5leHBvcnQgeyBKV1Byb3h5IH07XG5leHBvcnQgZGVmYXVsdCBKV1Byb3h5O1xuIl0sImZpbGUiOiJsaWIvanNvbndwLXByb3h5L3Byb3h5LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
