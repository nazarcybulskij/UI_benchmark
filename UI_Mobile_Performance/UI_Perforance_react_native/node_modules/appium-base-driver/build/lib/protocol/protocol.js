"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.routeConfiguringFunction = routeConfiguringFunction;
exports.isSessionCommand = isSessionCommand;
exports.driverShouldDoJwpProxy = driverShouldDoJwpProxy;
exports.determineProtocol = determineProtocol;
Object.defineProperty(exports, "MJSONWP_ELEMENT_KEY", {
  enumerable: true,
  get: function () {
    return _helpers.MJSONWP_ELEMENT_KEY;
  }
});
Object.defineProperty(exports, "W3C_ELEMENT_KEY", {
  enumerable: true,
  get: function () {
    return _helpers.W3C_ELEMENT_KEY;
  }
});
exports.PROTOCOLS = exports.DEFAULT_BASE_PATH = exports.IMAGE_ELEMENT_PREFIX = exports.Protocol = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _validators = require("./validators");

var _errors = require("./errors");

var _routes = require("./routes");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _helpers = require("./helpers");

var _sessionsCache = _interopRequireDefault(require("./sessions-cache"));

const PROTOCOLS = {
  W3C: 'W3C',
  MJSONWP: 'MJSONWP'
};
exports.PROTOCOLS = PROTOCOLS;
const LOG_OBJ_LENGTH = 1024;
const IMAGE_ELEMENT_PREFIX = 'appium-image-element-';
exports.IMAGE_ELEMENT_PREFIX = IMAGE_ELEMENT_PREFIX;
const CREATE_SESSION_COMMAND = 'createSession';
const DELETE_SESSION_COMMAND = 'deleteSession';
const DEFAULT_BASE_PATH = '/wd/hub';
exports.DEFAULT_BASE_PATH = DEFAULT_BASE_PATH;
const IMG_EL_BODY_RE = new RegExp(`"(${_helpers.W3C_ELEMENT_KEY}|${_helpers.MJSONWP_ELEMENT_KEY})":\s*` + `"${IMAGE_ELEMENT_PREFIX}[^"]+"`);
const IMG_EL_URL_RE = new RegExp(`/(element|screenshot)` + `/${IMAGE_ELEMENT_PREFIX}[^/]+`);

class Protocol {}

exports.Protocol = Protocol;

function determineProtocol(desiredCapabilities, requiredCapabilities, capabilities) {
  return _lodash.default.isPlainObject(capabilities) ? PROTOCOLS.W3C : PROTOCOLS.MJSONWP;
}

function extractProtocol(driver, sessionId = null) {
  const dstDriver = _lodash.default.isFunction(driver.driverForSession) ? driver.driverForSession(sessionId) : driver;

  if (dstDriver === driver) {
    return driver.protocol;
  }

  return dstDriver ? dstDriver.protocol : _sessionsCache.default.getProtocol(sessionId);
}

function isSessionCommand(command) {
  return !_lodash.default.includes(_routes.NO_SESSION_ID_COMMANDS, command);
}

function wrapParams(paramSets, jsonObj) {
  let res = jsonObj;

  if (_lodash.default.isArray(jsonObj) || !_lodash.default.isObject(jsonObj)) {
    res = {};
    res[paramSets.wrap] = jsonObj;
  }

  return res;
}

function unwrapParams(paramSets, jsonObj) {
  let res = jsonObj;

  if (_lodash.default.isObject(jsonObj)) {
    if (jsonObj[paramSets.unwrap]) {
      res = jsonObj[paramSets.unwrap];
    }
  }

  return res;
}

function checkParams(paramSets, jsonObj, protocol) {
  let requiredParams = [];
  let optionalParams = [];

  let receivedParams = _lodash.default.keys(jsonObj);

  if (paramSets) {
    if (paramSets.required) {
      if (!_lodash.default.isArray(_lodash.default.first(paramSets.required))) {
        requiredParams = [paramSets.required];
      } else {
        requiredParams = paramSets.required;
      }
    }

    if (paramSets.optional) {
      optionalParams = paramSets.optional;
    }

    if (paramSets.validate) {
      let message = paramSets.validate(jsonObj, protocol);

      if (message) {
        throw new _errors.errors.BadParametersError(message, jsonObj);
      }
    }
  }

  if (requiredParams.length === 0) {
    return;
  }

  if (optionalParams.indexOf('sessionId') === -1) {
    optionalParams.push('sessionId');
  }

  if (optionalParams.indexOf('id') === -1) {
    optionalParams.push('id');
  }

  for (let params of requiredParams) {
    if (_lodash.default.difference(receivedParams, params, optionalParams).length === 0 && _lodash.default.difference(params, receivedParams).length === 0) {
      return;
    }
  }

  throw new _errors.errors.BadParametersError(paramSets, receivedParams);
}

function makeArgs(requestParams, jsonObj, payloadParams, protocol) {
  let urlParams = _lodash.default.keys(requestParams).reverse();

  let requiredParams = payloadParams.required;

  if (_lodash.default.isArray(_lodash.default.first(payloadParams.required))) {
    let keys = _lodash.default.keys(jsonObj);

    for (let params of payloadParams.required) {
      if (_lodash.default.without(params, ...keys).length === 0) {
        requiredParams = params;
        break;
      }
    }
  }

  let args;

  if (_lodash.default.isFunction(payloadParams.makeArgs)) {
    args = payloadParams.makeArgs(jsonObj, protocol);
  } else {
    args = _lodash.default.flatten(requiredParams).map(p => jsonObj[p]);

    if (payloadParams.optional) {
      args = args.concat(_lodash.default.flatten(payloadParams.optional).map(p => jsonObj[p]));
    }
  }

  args = args.concat(urlParams.map(u => requestParams[u]));
  return args;
}

function routeConfiguringFunction(driver) {
  if (!driver.sessionExists) {
    throw new Error('Drivers used with MJSONWP must implement `sessionExists`');
  }

  if (!(driver.executeCommand || driver.execute)) {
    throw new Error('Drivers used with MJSONWP must implement `executeCommand` or `execute`');
  }

  return function addRoutes(app, basePath = DEFAULT_BASE_PATH) {
    driver.basePath = basePath;

    for (const [path, methods] of _lodash.default.toPairs(_routes.METHOD_MAP)) {
      for (const [method, spec] of _lodash.default.toPairs(methods)) {
        buildHandler(app, method, `${basePath}${path}`, spec, driver, isSessionCommand(spec.command));
      }
    }
  };
}

function buildHandler(app, method, path, spec, driver, isSessCmd) {
  let asyncHandler = async (req, res) => {
    let jsonObj = req.body;
    let httpResBody = {};
    let httpStatus = 200;
    let newSessionId;
    let currentProtocol = extractProtocol(driver, req.params.sessionId);
    let terminateSocket = false;

    try {
      if (isSessCmd && !driver.sessionExists(req.params.sessionId)) {
        terminateSocket = true;
        throw new _errors.errors.NoSuchDriverError();
      }

      if (isSessCmd && driverShouldDoJwpProxy(driver, req, spec.command)) {
        await doJwpProxy(driver, req, res);
        return;
      }

      if (!spec.command) {
        throw new _errors.errors.NotImplementedError();
      }

      if (spec.payloadParams && spec.payloadParams.wrap) {
        jsonObj = wrapParams(spec.payloadParams, jsonObj);
      }

      if (spec.payloadParams && spec.payloadParams.unwrap) {
        jsonObj = unwrapParams(spec.payloadParams, jsonObj);
      }

      if (spec.command === CREATE_SESSION_COMMAND) {
        currentProtocol = determineProtocol(...makeArgs(req.params, jsonObj, spec.payloadParams || {}));
      }

      checkParams(spec.payloadParams, jsonObj, currentProtocol);
      let args = makeArgs(req.params, jsonObj, spec.payloadParams || {}, currentProtocol);
      let driverRes;

      if (_validators.validators[spec.command]) {
        _validators.validators[spec.command](...args);
      }

      _sessionsCache.default.getLogger(req.params.sessionId, currentProtocol).debug(`Calling ` + `${driver.constructor.name}.${spec.command}() with args: ` + _lodash.default.truncate(JSON.stringify(args), {
        length: LOG_OBJ_LENGTH
      }));

      if (driver.executeCommand) {
        driverRes = await driver.executeCommand(spec.command, ...args);
      } else {
        driverRes = await driver.execute(spec.command, ...args);
      }

      currentProtocol = extractProtocol(driver, req.params.sessionId) || currentProtocol;

      if (_lodash.default.isPlainObject(driverRes) && _lodash.default.has(driverRes, 'protocol')) {
        currentProtocol = driverRes.protocol || currentProtocol;

        if (driverRes.error) {
          throw driverRes.error;
        }

        driverRes = driverRes.value;
      }

      if (spec.command === CREATE_SESSION_COMMAND) {
        newSessionId = driverRes[0];

        _sessionsCache.default.putSession(newSessionId, currentProtocol);

        _sessionsCache.default.getLogger(newSessionId, currentProtocol).debug(`Cached the protocol value '${currentProtocol}' for the new session ${newSessionId}`);

        if (currentProtocol === PROTOCOLS.MJSONWP) {
          driverRes = driverRes[1];
        } else if (currentProtocol === PROTOCOLS.W3C) {
          driverRes = {
            capabilities: driverRes[1]
          };
        }
      }

      driverRes = (0, _helpers.formatResponseValue)(driverRes);

      if (spec.command === DELETE_SESSION_COMMAND) {
        terminateSocket = true;

        _sessionsCache.default.getLogger(req.params.sessionId, currentProtocol).debug(`Received response: ${_lodash.default.truncate(JSON.stringify(driverRes), {
          length: LOG_OBJ_LENGTH
        })}`);

        _sessionsCache.default.getLogger(req.params.sessionId, currentProtocol).debug('But deleting session, so not returning');

        driverRes = null;
      }

      if (_appiumSupport.util.hasValue(driverRes)) {
        if (_appiumSupport.util.hasValue(driverRes.status) && !isNaN(driverRes.status) && parseInt(driverRes.status, 10) !== 0) {
          throw (0, _errors.errorFromMJSONWPStatusCode)(driverRes.status, driverRes.value);
        } else if (_lodash.default.isPlainObject(driverRes.value) && driverRes.value.error) {
          throw (0, _errors.errorFromW3CJsonCode)(driverRes.value.error, driverRes.value.message, driverRes.value.stacktrace);
        }
      }

      httpResBody.value = driverRes;

      _sessionsCache.default.getLogger(req.params.sessionId || newSessionId, currentProtocol).debug(`Responding ` + `to client with driver.${spec.command}() result: ${_lodash.default.truncate(JSON.stringify(driverRes), {
        length: LOG_OBJ_LENGTH
      })}`);

      if (spec.command === DELETE_SESSION_COMMAND) {
        _sessionsCache.default.resetLogger(req.params.sessionId);
      }
    } catch (err) {
      let actualErr = err;
      currentProtocol = currentProtocol || extractProtocol(driver, req.params.sessionId || newSessionId);
      let errMsg = err.stacktrace || err.stack;

      if (!_lodash.default.includes(errMsg, err.message)) {
        errMsg = `${err.message}${errMsg ? '\n' + errMsg : ''}`;
      }

      _sessionsCache.default.getLogger(req.params.sessionId || newSessionId, currentProtocol).debug(`Encountered ` + `internal error running command: ${errMsg}`);

      if ((0, _errors.isErrorType)(err, _errors.errors.ProxyRequestError)) {
        actualErr = err.getActualError();
      }

      if (currentProtocol === PROTOCOLS.W3C) {
        [httpStatus, httpResBody] = (0, _errors.getResponseForW3CError)(actualErr);
      } else if (currentProtocol === PROTOCOLS.MJSONWP) {
        [httpStatus, httpResBody] = (0, _errors.getResponseForJsonwpError)(actualErr);
      } else {
        let jsonwpRes = (0, _errors.getResponseForJsonwpError)(actualErr);
        let w3cRes = (0, _errors.getResponseForW3CError)(actualErr);
        httpResBody = { ...jsonwpRes[1],
          ...w3cRes[1]
        };
        httpStatus = jsonwpRes[0];
      }

      if (spec.command === CREATE_SESSION_COMMAND) {
        terminateSocket = true;
      }
    }

    if (_lodash.default.isString(httpResBody)) {
      res.status(httpStatus).send(httpResBody);
    } else {
      if (newSessionId) {
        if (currentProtocol === PROTOCOLS.W3C) {
          httpResBody.value.sessionId = newSessionId;
        } else {
          httpResBody.sessionId = newSessionId;
        }
      } else {
        httpResBody.sessionId = req.params.sessionId || null;
      }

      if (currentProtocol === PROTOCOLS.W3C) {
        delete httpResBody.sessionId;
      }

      httpResBody = (0, _helpers.formatStatus)(httpResBody, httpStatus, currentProtocol);
      res.status(httpStatus).json(httpResBody);
    }

    if (terminateSocket) {
      _sessionsCache.default.getLogger(req.params.sessionId || newSessionId, currentProtocol).debug(`Destroying socket connection`);

      res.socket.destroy();
    }
  };

  app[method.toLowerCase()](path, (req, res) => {
    _bluebird.default.resolve(asyncHandler(req, res)).done();
  });
}

function driverShouldDoJwpProxy(driver, req, command) {
  if (!driver.proxyActive(req.params.sessionId)) {
    return false;
  }

  if (command === 'deleteSession') {
    return false;
  }

  if (driver.proxyRouteIsAvoided(req.params.sessionId, req.method, req.originalUrl)) {
    return false;
  }

  if (IMG_EL_URL_RE.test(req.originalUrl)) {
    return false;
  }

  const stringBody = JSON.stringify(req.body);

  if (stringBody && IMG_EL_BODY_RE.test(stringBody)) {
    return false;
  }

  return true;
}

async function doJwpProxy(driver, req, res) {
  _sessionsCache.default.getLogger(req.params.sessionId, extractProtocol(driver, req.params.sessionId)).info('Driver proxy active, passing request on via HTTP proxy');

  if (!driver.canProxy(req.params.sessionId)) {
    throw new Error('Trying to proxy to a JSONWP server but driver is unable to proxy');
  }

  try {
    const proxiedRes = await driver.executeCommand('proxyReqRes', req, res, req.params.sessionId);
    if (proxiedRes && proxiedRes.error) throw proxiedRes.error;
  } catch (err) {
    if ((0, _errors.isErrorType)(err, _errors.errors.ProxyRequestError)) {
      throw err;
    } else {
      throw new Error(`Could not proxy. Proxy error: ${err.message}`);
    }
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9wcm90b2NvbC9wcm90b2NvbC5qcyJdLCJuYW1lcyI6WyJQUk9UT0NPTFMiLCJXM0MiLCJNSlNPTldQIiwiTE9HX09CSl9MRU5HVEgiLCJJTUFHRV9FTEVNRU5UX1BSRUZJWCIsIkNSRUFURV9TRVNTSU9OX0NPTU1BTkQiLCJERUxFVEVfU0VTU0lPTl9DT01NQU5EIiwiREVGQVVMVF9CQVNFX1BBVEgiLCJJTUdfRUxfQk9EWV9SRSIsIlJlZ0V4cCIsIlczQ19FTEVNRU5UX0tFWSIsIk1KU09OV1BfRUxFTUVOVF9LRVkiLCJJTUdfRUxfVVJMX1JFIiwiUHJvdG9jb2wiLCJkZXRlcm1pbmVQcm90b2NvbCIsImRlc2lyZWRDYXBhYmlsaXRpZXMiLCJyZXF1aXJlZENhcGFiaWxpdGllcyIsImNhcGFiaWxpdGllcyIsIl8iLCJpc1BsYWluT2JqZWN0IiwiZXh0cmFjdFByb3RvY29sIiwiZHJpdmVyIiwic2Vzc2lvbklkIiwiZHN0RHJpdmVyIiwiaXNGdW5jdGlvbiIsImRyaXZlckZvclNlc3Npb24iLCJwcm90b2NvbCIsIlNFU1NJT05TX0NBQ0hFIiwiZ2V0UHJvdG9jb2wiLCJpc1Nlc3Npb25Db21tYW5kIiwiY29tbWFuZCIsImluY2x1ZGVzIiwiTk9fU0VTU0lPTl9JRF9DT01NQU5EUyIsIndyYXBQYXJhbXMiLCJwYXJhbVNldHMiLCJqc29uT2JqIiwicmVzIiwiaXNBcnJheSIsImlzT2JqZWN0Iiwid3JhcCIsInVud3JhcFBhcmFtcyIsInVud3JhcCIsImNoZWNrUGFyYW1zIiwicmVxdWlyZWRQYXJhbXMiLCJvcHRpb25hbFBhcmFtcyIsInJlY2VpdmVkUGFyYW1zIiwia2V5cyIsInJlcXVpcmVkIiwiZmlyc3QiLCJvcHRpb25hbCIsInZhbGlkYXRlIiwibWVzc2FnZSIsImVycm9ycyIsIkJhZFBhcmFtZXRlcnNFcnJvciIsImxlbmd0aCIsImluZGV4T2YiLCJwdXNoIiwicGFyYW1zIiwiZGlmZmVyZW5jZSIsIm1ha2VBcmdzIiwicmVxdWVzdFBhcmFtcyIsInBheWxvYWRQYXJhbXMiLCJ1cmxQYXJhbXMiLCJyZXZlcnNlIiwid2l0aG91dCIsImFyZ3MiLCJmbGF0dGVuIiwibWFwIiwicCIsImNvbmNhdCIsInUiLCJyb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24iLCJzZXNzaW9uRXhpc3RzIiwiRXJyb3IiLCJleGVjdXRlQ29tbWFuZCIsImV4ZWN1dGUiLCJhZGRSb3V0ZXMiLCJhcHAiLCJiYXNlUGF0aCIsInBhdGgiLCJtZXRob2RzIiwidG9QYWlycyIsIk1FVEhPRF9NQVAiLCJtZXRob2QiLCJzcGVjIiwiYnVpbGRIYW5kbGVyIiwiaXNTZXNzQ21kIiwiYXN5bmNIYW5kbGVyIiwicmVxIiwiYm9keSIsImh0dHBSZXNCb2R5IiwiaHR0cFN0YXR1cyIsIm5ld1Nlc3Npb25JZCIsImN1cnJlbnRQcm90b2NvbCIsInRlcm1pbmF0ZVNvY2tldCIsIk5vU3VjaERyaXZlckVycm9yIiwiZHJpdmVyU2hvdWxkRG9Kd3BQcm94eSIsImRvSndwUHJveHkiLCJOb3RJbXBsZW1lbnRlZEVycm9yIiwiZHJpdmVyUmVzIiwidmFsaWRhdG9ycyIsImdldExvZ2dlciIsImRlYnVnIiwiY29uc3RydWN0b3IiLCJuYW1lIiwidHJ1bmNhdGUiLCJKU09OIiwic3RyaW5naWZ5IiwiaGFzIiwiZXJyb3IiLCJ2YWx1ZSIsInB1dFNlc3Npb24iLCJ1dGlsIiwiaGFzVmFsdWUiLCJzdGF0dXMiLCJpc05hTiIsInBhcnNlSW50Iiwic3RhY2t0cmFjZSIsInJlc2V0TG9nZ2VyIiwiZXJyIiwiYWN0dWFsRXJyIiwiZXJyTXNnIiwic3RhY2siLCJQcm94eVJlcXVlc3RFcnJvciIsImdldEFjdHVhbEVycm9yIiwianNvbndwUmVzIiwidzNjUmVzIiwiaXNTdHJpbmciLCJzZW5kIiwianNvbiIsInNvY2tldCIsImRlc3Ryb3kiLCJ0b0xvd2VyQ2FzZSIsIkIiLCJyZXNvbHZlIiwiZG9uZSIsInByb3h5QWN0aXZlIiwicHJveHlSb3V0ZUlzQXZvaWRlZCIsIm9yaWdpbmFsVXJsIiwidGVzdCIs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aUJBQXhCLENBQUosRUFBZ0Q7QUFDOUMsWUFBTUosR0FBTjtBQUNELEtBRkQsTUFFTztBQUNMLFlBQU0sSUFBSTlDLEtBQUosQ0FBVyxpQ0FBZ0M4QyxHQUFHLENBQUNwRSxPQUFRLEVBQXZELENBQU47QUFDRDtBQUNGO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IHZhbGlkYXRvcnMgfSBmcm9tICcuL3ZhbGlkYXRvcnMnO1xuaW1wb3J0IHtcbiAgZXJyb3JzLCBpc0Vycm9yVHlwZSwgZ2V0UmVzcG9uc2VGb3JXM0NFcnJvciwgZ2V0UmVzcG9uc2VGb3JKc29ud3BFcnJvcixcbiAgZXJyb3JGcm9tTUpTT05XUFN0YXR1c0NvZGUsIGVycm9yRnJvbVczQ0pzb25Db2RlLFxufSBmcm9tICcuL2Vycm9ycyc7XG5pbXBvcnQgeyBNRVRIT0RfTUFQLCBOT19TRVNTSU9OX0lEX0NPTU1BTkRTIH0gZnJvbSAnLi9yb3V0ZXMnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHtcbiAgTUpTT05XUF9FTEVNRU5UX0tFWSwgVzNDX0VMRU1FTlRfS0VZLCBmb3JtYXRSZXNwb25zZVZhbHVlLCBmb3JtYXRTdGF0dXMsXG59IGZyb20gJy4vaGVscGVycyc7XG5pbXBvcnQgU0VTU0lPTlNfQ0FDSEUgZnJvbSAnLi9zZXNzaW9ucy1jYWNoZSc7XG5cblxuY29uc3QgUFJPVE9DT0xTID0ge1xuICBXM0M6ICdXM0MnLFxuICBNSlNPTldQOiAnTUpTT05XUCcsXG59O1xuXG4vLyBUT0RPOiBNYWtlIHRoaXMgdmFsdWUgY29uZmlndXJhYmxlIGFzIGEgc2VydmVyIHNpZGUgY2FwYWJpbGl0eVxuY29uc3QgTE9HX09CSl9MRU5HVEggPSAxMDI0OyAvLyBNQVggTEVOR1RIIExvZ2dlZCB0byBmaWxlIC8gY29uc29sZVxuXG5jb25zdCBJTUFHRV9FTEVNRU5UX1BSRUZJWCA9ICdhcHBpdW0taW1hZ2UtZWxlbWVudC0nO1xuXG5jb25zdCBDUkVBVEVfU0VTU0lPTl9DT01NQU5EID0gJ2NyZWF0ZVNlc3Npb24nO1xuY29uc3QgREVMRVRFX1NFU1NJT05fQ09NTUFORCA9ICdkZWxldGVTZXNzaW9uJztcblxuLy8gZm9yIGhpc3RvcmljYWwgcmVhc29ucywgU2VsZW5pdW0vQXBwaXVtIHNlcnZlcnMgb2Z0ZW4gaGlkIHRoZSBlbnRpcmUgQVBJXG4vLyBiZWhpbmQgYSAvd2QvaHViIHByZWZpeC4gVGhpcyBzaG91bGQgYmUgb3B0aW9uYWwgYW5kIGluZGVlZCB0aGUgc2VydmVyXG4vLyBhZG1pbmlzdHJhdG9yIHNob3VsZCBiZSBhYmxlIHRvIGhvc3QgdGhlIEFQSSBiZWhpbmQgYW55IHByZWZpeDsgYnV0IGZvciBub3dcbi8vIGl0IGlzIHRoZSBkZWZhdWx0LlxuY29uc3QgREVGQVVMVF9CQVNFX1BBVEggPSAnL3dkL2h1Yic7XG5cbmNvbnN0IElNR19FTF9CT0RZX1JFID0gbmV3IFJlZ0V4cChcbiAgYFwiKCR7VzNDX0VMRU1FTlRfS0VZfXwke01KU09OV1BfRUxFTUVOVF9LRVl9KVwiOlxccypgICsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11c2VsZXNzLWVzY2FwZVxuICBgXCIke0lNQUdFX0VMRU1FTlRfUFJFRklYfVteXCJdK1wiYFxuKTtcbmNvbnN0IElNR19FTF9VUkxfUkUgPSBuZXcgUmVnRXhwKFxuICBgLyhlbGVtZW50fHNjcmVlbnNob3QpYCArXG4gIGAvJHtJTUFHRV9FTEVNRU5UX1BSRUZJWH1bXi9dK2Bcbik7XG5cbmNsYXNzIFByb3RvY29sIHt9XG5cbmZ1bmN0aW9uIGRldGVybWluZVByb3RvY29sIChkZXNpcmVkQ2FwYWJpbGl0aWVzLCByZXF1aXJlZENhcGFiaWxpdGllcywgY2FwYWJpbGl0aWVzKSB7XG4gIHJldHVybiBfLmlzUGxhaW5PYmplY3QoY2FwYWJpbGl0aWVzKSA/XG4gICAgUFJPVE9DT0xTLlczQyA6XG4gICAgUFJPVE9DT0xTLk1KU09OV1A7XG59XG5cbmZ1bmN0aW9uIGV4dHJhY3RQcm90b2NvbCAoZHJpdmVyLCBzZXNzaW9uSWQgPSBudWxsKSB7XG4gIGNvbnN0IGRzdERyaXZlciA9IF8uaXNGdW5jdGlvbihkcml2ZXIuZHJpdmVyRm9yU2Vzc2lvbilcbiAgICA/IGRyaXZlci5kcml2ZXJGb3JTZXNzaW9uKHNlc3Npb25JZClcbiAgICA6IGRyaXZlcjtcbiAgaWYgKGRzdERyaXZlciA9PT0gZHJpdmVyKSB7XG4gICAgLy8gU2hvcnRjaXJjdWl0IGlmIHRoZSBkcml2ZXIgaW5zdGFuY2UgaXMgbm90IGFuIHVtYnJlbGxhIGRyaXZlclxuICAgIC8vIG9yIGl0IGlzIEZha2UgZHJpdmVyIGluc3RhbmNlLCB3aGVyZSBgZHJpdmVyLmRyaXZlckZvclNlc3Npb25gXG4gICAgLy8gYWx3YXlzIHJldHVybnMgc2VsZiBpbnN0YW5jZVxuICAgIHJldHVybiBkcml2ZXIucHJvdG9jb2w7XG4gIH1cblxuICAvLyBFeHRyYWN0IHRoZSBwcm90b2NvbCBmb3IgdGhlIGN1cnJlbnQgc2Vzc2lvbiBpZiB0aGUgZ2l2ZW4gZHJpdmVyIGlzIHRoZSB1bWJyZWxsYSBvbmVcbiAgcmV0dXJuIGRzdERyaXZlciA/IGRzdERyaXZlci5wcm90b2NvbCA6IFNFU1NJT05TX0NBQ0hFLmdldFByb3RvY29sKHNlc3Npb25JZCk7XG59XG5cbmZ1bmN0aW9uIGlzU2Vzc2lvbkNvbW1hbmQgKGNvbW1hbmQpIHtcbiAgcmV0dXJuICFfLmluY2x1ZGVzKE5PX1NFU1NJT05fSURfQ09NTUFORFMsIGNvbW1hbmQpO1xufVxuXG5mdW5jdGlvbiB3cmFwUGFyYW1zIChwYXJhbVNldHMsIGpzb25PYmopIHtcbiAgLyogVGhlcmUgYXJlIGNvbW1hbmRzIGxpa2UgcGVyZm9ybVRvdWNoIHdoaWNoIHRha2UgYSBzaW5nbGUgcGFyYW1ldGVyIChwcmltaXRpdmUgdHlwZSBvciBhcnJheSkuXG4gICAqIFNvbWUgZHJpdmVycyBjaG9vc2UgdG8gcGFzcyB0aGlzIHBhcmFtZXRlciBhcyBhIHZhbHVlIChlZy4gW2FjdGlvbjEsIGFjdGlvbjIuLi5dKSB3aGlsZSBvdGhlcnMgdG9cbiAgICogd3JhcCBpdCB3aXRoaW4gYW4gb2JqZWN0KGVnJyB7Z2VzdHVyZTogIFthY3Rpb24xLCBhY3Rpb24yLi4uXX0pLCB3aGljaCBtYWtlcyBpdCBoYXJkIHRvIHZhbGlkYXRlLlxuICAgKiBUaGUgd3JhcCBvcHRpb24gaW4gdGhlIHNwZWMgZW5mb3JjZSB3cmFwcGluZyBiZWZvcmUgdmFsaWRhdGlvbiwgc28gdGhhdCBhbGwgcGFyYW1zIGFyZSB3cmFwcGVkIGF0XG4gICAqIHRoZSB0aW1lIHRoZXkgYXJlIHZhbGlkYXRlZCBhbmQgbGF0ZXIgcGFzc2VkIHRvIHRoZSBjb21tYW5kcy5cbiAgICovXG4gIGxldCByZXMgPSBqc29uT2JqO1xuICBpZiAoXy5pc0FycmF5KGpzb25PYmopIHx8ICFfLmlzT2JqZWN0KGpzb25PYmopKSB7XG4gICAgcmVzID0ge307XG4gICAgcmVzW3BhcmFtU2V0cy53cmFwXSA9IGpzb25PYmo7XG4gIH1cbiAgcmV0dXJuIHJlcztcbn1cblxuZnVuY3Rpb24gdW53cmFwUGFyYW1zIChwYXJhbVNldHMsIGpzb25PYmopIHtcbiAgLyogVGhlcmUgYXJlIGNvbW1hbmRzIGxpa2Ugc2V0TmV0d29ya0Nvbm5lY3Rpb24gd2hpY2ggc2VuZCBwYXJhbWV0ZXJzIHdyYXBwZWQgaW5zaWRlIGEga2V5IHN1Y2ggYXNcbiAgICogXCJwYXJhbWV0ZXJzXCIuIFRoaXMgZnVuY3Rpb24gdW53cmFwcyB0aGVtIChlZy4ge1wicGFyYW1ldGVyc1wiOiB7XCJ0eXBlXCI6IDF9fSBiZWNvbWVzIHtcInR5cGVcIjogMX0pLlxuICAgKi9cbiAgbGV0IHJlcyA9IGpzb25PYmo7XG4gIGlmIChfLmlzT2JqZWN0KGpzb25PYmopKSB7XG4gICAgLy8gc29tZSBjbGllbnRzLCBsaWtlIHJ1YnksIGRvbid0IHdyYXBcbiAgICBpZiAoanNvbk9ialtwYXJhbVNldHMudW53cmFwXSkge1xuICAgICAgcmVzID0ganNvbk9ialtwYXJhbVNldHMudW53cmFwXTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlcztcbn1cblxuZnVuY3Rpb24gY2hlY2tQYXJhbXMgKHBhcmFtU2V0cywganNvbk9iaiwgcHJvdG9jb2wpIHtcbiAgbGV0IHJlcXVpcmVkUGFyYW1zID0gW107XG4gIGxldCBvcHRpb25hbFBhcmFtcyA9IFtdO1xuICBsZXQgcmVjZWl2ZWRQYXJhbXMgPSBfLmtleXMoanNvbk9iaik7XG5cbiAgaWYgKHBhcmFtU2V0cykge1xuICAgIGlmIChwYXJhbVNldHMucmVxdWlyZWQpIHtcbiAgICAgIC8vIHdlIG1pZ2h0IGhhdmUgYW4gYXJyYXkgb2YgcGFyYW1ldGVycyxcbiAgICAgIC8vIG9yIGFuIGFycmF5IG9mIGFycmF5cyBvZiBwYXJhbWV0ZXJzLCBzbyBzdGFuZGFyZGl6ZVxuICAgICAgaWYgKCFfLmlzQXJyYXkoXy5maXJzdChwYXJhbVNldHMucmVxdWlyZWQpKSkge1xuICAgICAgICByZXF1aXJlZFBhcmFtcyA9IFtwYXJhbVNldHMucmVxdWlyZWRdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVxdWlyZWRQYXJhbXMgPSBwYXJhbVNldHMucmVxdWlyZWQ7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIG9wdGlvbmFsIHBhcmFtZXRlcnMgYXJlIGp1c3QgYW4gYXJyYXlcbiAgICBpZiAocGFyYW1TZXRzLm9wdGlvbmFsKSB7XG4gICAgICBvcHRpb25hbFBhcmFtcyA9IHBhcmFtU2V0cy5vcHRpb25hbDtcbiAgICB9XG5cbiAgICAvLyBJZiBhIGZ1bmN0aW9uIHdhcyBwcm92aWRlZCBhcyB0aGUgJ3ZhbGlkYXRlJyBrZXksIGl0IHdpbGwgaGVyZSBiZSBjYWxsZWQgd2l0aFxuICAgIC8vIGpzb25PYmogYXMgdGhlIHBhcmFtLiBJZiBpdCByZXR1cm5zIHNvbWV0aGluZyBmYWxzeSwgdmVyaWZpY2F0aW9uIHdpbGwgYmVcbiAgICAvLyBjb25zaWRlcmVkIHRvIGhhdmUgcGFzc2VkLiBJZiBpdCByZXR1cm5zIHNvbWV0aGluZyBlbHNlLCB0aGF0IHdpbGwgYmUgdGhlXG4gICAgLy8gYXJndW1lbnQgdG8gYW4gZXJyb3Igd2hpY2ggaXMgdGhyb3duIHRvIHRoZSB1c2VyXG4gICAgaWYgKHBhcmFtU2V0cy52YWxpZGF0ZSkge1xuICAgICAgbGV0IG1lc3NhZ2UgPSBwYXJhbVNldHMudmFsaWRhdGUoanNvbk9iaiwgcHJvdG9jb2wpO1xuICAgICAgaWYgKG1lc3NhZ2UpIHtcbiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5CYWRQYXJhbWV0ZXJzRXJyb3IobWVzc2FnZSwganNvbk9iaik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gaWYgd2UgaGF2ZSBubyByZXF1aXJlZCBwYXJhbWV0ZXJzLCBhbGwgaXMgd2VsbFxuICBpZiAocmVxdWlyZWRQYXJhbXMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gc29tZSBjbGllbnRzIHBhc3MgaW4gdGhlIHNlc3Npb24gaWQgaW4gdGhlIHBhcmFtc1xuICBpZiAob3B0aW9uYWxQYXJhbXMuaW5kZXhPZignc2Vzc2lvbklkJykgPT09IC0xKSB7XG4gICAgb3B0aW9uYWxQYXJhbXMucHVzaCgnc2Vzc2lvbklkJyk7XG4gIH1cblxuICAvLyBzb21lIGNsaWVudHMgcGFzcyBpbiBhbiBlbGVtZW50IGlkIGluIHRoZSBwYXJhbXNcbiAgaWYgKG9wdGlvbmFsUGFyYW1zLmluZGV4T2YoJ2lkJykgPT09IC0xKSB7XG4gICAgb3B0aW9uYWxQYXJhbXMucHVzaCgnaWQnKTtcbiAgfVxuXG4gIC8vIGdvIHRocm91Z2ggdGhlIHJlcXVpcmVkIHBhcmFtZXRlcnMgYW5kIGNoZWNrIGFnYWluc3Qgb3VyIGFyZ3VtZW50c1xuICBmb3IgKGxldCBwYXJhbXMgb2YgcmVxdWlyZWRQYXJhbXMpIHtcbiAgICBpZiAoXy5kaWZmZXJlbmNlKHJlY2VpdmVkUGFyYW1zLCBwYXJhbXMsIG9wdGlvbmFsUGFyYW1zKS5sZW5ndGggPT09IDAgJiZcbiAgICAgICAgXy5kaWZmZXJlbmNlKHBhcmFtcywgcmVjZWl2ZWRQYXJhbXMpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgLy8gd2UgaGF2ZSBhIHNldCBvZiBwYXJhbWV0ZXJzIHRoYXQgaXMgY29ycmVjdFxuICAgICAgLy8gc28gc2hvcnQtY2lyY3VpdFxuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfVxuICB0aHJvdyBuZXcgZXJyb3JzLkJhZFBhcmFtZXRlcnNFcnJvcihwYXJhbVNldHMsIHJlY2VpdmVkUGFyYW1zKTtcbn1cblxuLypcbiAqIFRoaXMgbWV0aG9kIHRha2VzIDMgcGllY2VzIG9mIGRhdGE6IHJlcXVlc3QgcGFyYW1ldGVycyAoJ3JlcXVlc3RQYXJhbXMnKSxcbiAqIGEgcmVxdWVzdCBKU09OIGJvZHkgKCdqc29uT2JqJyksIGFuZCAncGF5bG9hZFBhcmFtcycsIHdoaWNoIGlzIHRoZSBzZWN0aW9uXG4gKiBmcm9tIHRoZSByb3V0ZSBkZWZpbml0aW9uIGZvciBhIHBhcnRpY3VsYXIgZW5kcG9pbnQgd2hpY2ggaGFzIGluc3RydWN0aW9uc1xuICogb24gaGFuZGxpbmcgcGFyYW1ldGVycy4gVGhpcyBtZXRob2QgcmV0dXJucyBhbiBhcnJheSBvZiBhcmd1bWVudHMgd2hpY2ggd2lsbFxuICogYmUgYXBwbGllZCB0byBhIGNvbW1hbmQuXG4gKi9cbmZ1bmN0aW9uIG1ha2VBcmdzIChyZXF1ZXN0UGFyYW1zLCBqc29uT2JqLCBwYXlsb2FkUGFyYW1zLCBwcm90b2NvbCkge1xuICAvLyBXZSB3YW50IHRvIHBhc3MgdGhlIFwidXJsXCIgcGFyYW1ldGVycyB0byB0aGUgY29tbWFuZHMgaW4gcmV2ZXJzZSBvcmRlclxuICAvLyBzaW5jZSB0aGUgY29tbWFuZCB3aWxsIHNvbWV0aW1lcyB3YW50IHRvIGlnbm9yZSwgc2F5LCB0aGUgc2Vzc2lvbklkLlxuICAvLyBUaGlzIGhhcyB0aGUgZWZmZWN0IG9mIHB1dHRpbmcgc2Vzc2lvbklkIGxhc3QsIHdoaWNoIG1lYW5zIGluIEpTIHdlIGNhblxuICAvLyBvbWl0IGl0IGZyb20gdGhlIGZ1bmN0aW9uIHNpZ25hdHVyZSBpZiB3ZSdyZSBub3QgZ29pbmcgdG8gdXNlIGl0LlxuICBsZXQgdXJsUGFyYW1zID0gXy5rZXlzKHJlcXVlc3RQYXJhbXMpLnJldmVyc2UoKTtcblxuICAvLyBJbiB0aGUgc2ltcGxlIGNhc2UsIHRoZSByZXF1aXJlZCBwYXJhbWV0ZXJzIGFyZSBhIGJhc2ljIGFycmF5IGluXG4gIC8vIHBheWxvYWRQYXJhbXMucmVxdWlyZWQsIHNvIHN0YXJ0IHRoZXJlLiBJdCdzIHBvc3NpYmxlIHRoYXQgdGhlcmUgYXJlXG4gIC8vIG11bHRpcGxlIG9wdGlvbmFsIHNldHMgb2YgcmVxdWlyZWQgcGFyYW1zLCB0aG91Z2gsIHNvIGhhbmRsZSB0aGF0IGNhc2VcbiAgLy8gdG9vLlxuICBsZXQgcmVxdWlyZWRQYXJhbXMgPSBwYXlsb2FkUGFyYW1zLnJlcXVpcmVkO1xuICBpZiAoXy5pc0FycmF5KF8uZmlyc3QocGF5bG9hZFBhcmFtcy5yZXF1aXJlZCkpKSB7XG4gICAgLy8gSWYgdGhlcmUgYXJlIG9wdGlvbmFsIHNldHMgb2YgcmVxdWlyZWQgcGFyYW1zLCB0aGVuIHdlIHdpbGwgaGF2ZSBhblxuICAgIC8vIGFycmF5IG9mIGFycmF5cyBpbiBwYXlsb2FkUGFyYW1zLnJlcXVpcmVkLCBzbyBsb29wIHRocm91Z2ggZWFjaCBzZXQgYW5kXG4gICAgLy8gcGljayB0aGUgb25lIHRoYXQgbWF0Y2hlcyB3aGljaCBKU09OIHBhcmFtcyB3ZXJlIGFjdHVhbGx5IHNlbnQuIFdlJ3ZlXG4gICAgLy8gYWxyZWFkeSBiZWVuIHRocm91Z2ggdmFsaWRhdGlvbiBzbyB3ZSdyZSBndWFyYW50ZWVkIHRvIGZpbmQgYSBtYXRjaC5cbiAgICBsZXQga2V5cyA9IF8ua2V5cyhqc29uT2JqKTtcbiAgICBmb3IgKGxldCBwYXJhbXMgb2YgcGF5bG9hZFBhcmFtcy5yZXF1aXJlZCkge1xuICAgICAgaWYgKF8ud2l0aG91dChwYXJhbXMsIC4uLmtleXMpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXF1aXJlZFBhcmFtcyA9IHBhcmFtcztcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gTm93IHdlIGNvbnN0cnVjdCBvdXIgbGlzdCBvZiBhcmd1bWVudHMgd2hpY2ggd2lsbCBiZSBwYXNzZWQgdG8gdGhlIGNvbW1hbmRcbiAgbGV0IGFyZ3M7XG4gIGlmIChfLmlzRnVuY3Rpb24ocGF5bG9hZFBhcmFtcy5tYWtlQXJncykpIHtcbiAgICAvLyBJbiB0aGUgcm91dGUgc3BlYywgYSBwYXJ0aWN1bGFyIHJvdXRlIG1pZ2h0IGRlZmluZSBhICdtYWtlQXJncycgZnVuY3Rpb25cbiAgICAvLyBpZiBpdCB3YW50cyBmdWxsIGNvbnRyb2wgb3ZlciBob3cgdG8gdHVybiBKU09OIHBhcmFtZXRlcnMgaW50byBjb21tYW5kXG4gICAgLy8gYXJndW1lbnRzLiBTbyB3ZSBwYXNzIGl0IHRoZSBKU09OIHBhcmFtZXRlcnMgYW5kIGl0IHJldHVybnMgYW4gYXJyYXlcbiAgICAvLyB3aGljaCB3aWxsIGJlIGFwcGxpZWQgdG8gdGhlIGhhbmRsaW5nIGNvbW1hbmQuIEZvciBleGFtcGxlIGlmIGl0IHJldHVybnNcbiAgICAvLyBbMSwgMiwgM10sIHdlIHdpbGwgY2FsbCBgY29tbWFuZCgxLCAyLCAzLCAuLi4pYCAodXJsIHBhcmFtcyBhcmUgc2VwYXJhdGVcbiAgICAvLyBmcm9tIEpTT04gcGFyYW1zIGFuZCBnZXQgY29uY2F0ZW5hdGVkIGJlbG93KS5cbiAgICBhcmdzID0gcGF5bG9hZFBhcmFtcy5tYWtlQXJncyhqc29uT2JqLCBwcm90b2NvbCk7XG4gIH0gZWxzZSB7XG4gICAgLy8gT3RoZXJ3aXNlLCBjb2xsZWN0IGFsbCB0aGUgcmVxdWlyZWQgYW5kIG9wdGlvbmFsIHBhcmFtcyBhbmQgZmxhdHRlbiB0aGVtXG4gICAgLy8gaW50byBhbiBhcmd1bWVudCBhcnJheVxuICAgIGFyZ3MgPSBfLmZsYXR0ZW4ocmVxdWlyZWRQYXJhbXMpLm1hcCgocCkgPT4ganNvbk9ialtwXSk7XG4gICAgaWYgKHBheWxvYWRQYXJhbXMub3B0aW9uYWwpIHtcbiAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChfLmZsYXR0ZW4ocGF5bG9hZFBhcmFtcy5vcHRpb25hbCkubWFwKChwKSA9PiBqc29uT2JqW3BdKSk7XG4gICAgfVxuICB9XG4gIC8vIEZpbmFsbHksIGdldCBvdXIgdXJsIHBhcmFtcyAoc2Vzc2lvbiBpZCwgZWxlbWVudCBpZCwgZXRjLi4uKSBvbiB0aGUgZW5kIG9mXG4gIC8vIHRoZSBsaXN0XG4gIGFyZ3MgPSBhcmdzLmNvbmNhdCh1cmxQYXJhbXMubWFwKCh1KSA9PiByZXF1ZXN0UGFyYW1zW3VdKSk7XG4gIHJldHVybiBhcmdzO1xufVxuXG5mdW5jdGlvbiByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24gKGRyaXZlcikge1xuICBpZiAoIWRyaXZlci5zZXNzaW9uRXhpc3RzKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdEcml2ZXJzIHVzZWQgd2l0aCBNSlNPTldQIG11c3QgaW1wbGVtZW50IGBzZXNzaW9uRXhpc3RzYCcpO1xuICB9XG5cbiAgaWYgKCEoZHJpdmVyLmV4ZWN1dGVDb21tYW5kIHx8IGRyaXZlci5leGVjdXRlKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignRHJpdmVycyB1c2VkIHdpdGggTUpTT05XUCBtdXN0IGltcGxlbWVudCBgZXhlY3V0ZUNvbW1hbmRgIG9yIGBleGVjdXRlYCcpO1xuICB9XG5cbiAgLy8gcmV0dXJuIGEgZnVuY3Rpb24gd2hpY2ggd2lsbCBhZGQgYWxsIHRoZSByb3V0ZXMgdG8gdGhlIGRyaXZlclxuICByZXR1cm4gZnVuY3Rpb24gYWRkUm91dGVzIChhcHAsIGJhc2VQYXRoID0gREVGQVVMVF9CQVNFX1BBVEgpIHtcbiAgICAvLyBzdG9yZSBiYXNlUGF0aCBvbiB0aGUgZHJpdmVyIGluc3RhbmNlIHNvIGl0IGNhbiB1c2UgaXQgaWYgbmVjZXNzYXJ5XG4gICAgLy8gZm9yIGV4YW1wbGUgaW4gZGV0ZXJtaW5pbmcgcHJveHkgYXZvaWRhbmNlXG4gICAgZHJpdmVyLmJhc2VQYXRoID0gYmFzZVBhdGg7XG5cbiAgICBmb3IgKGNvbnN0IFtwYXRoLCBtZXRob2RzXSBvZiBfLnRvUGFpcnMoTUVUSE9EX01BUCkpIHtcbiAgICAgIGZvciAoY29uc3QgW21ldGhvZCwgc3BlY10gb2YgXy50b1BhaXJzKG1ldGhvZHMpKSB7XG4gICAgICAgIC8vIHNldCB1cCB0aGUgZXhwcmVzcyByb3V0ZSBoYW5kbGVyXG4gICAgICAgIGJ1aWxkSGFuZGxlcihhcHAsIG1ldGhvZCwgYCR7YmFzZVBhdGh9JHtwYXRofWAsIHNwZWMsIGRyaXZlciwgaXNTZXNzaW9uQ29tbWFuZChzcGVjLmNvbW1hbmQpKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG59XG5cbmZ1bmN0aW9uIGJ1aWxkSGFuZGxlciAoYXBwLCBtZXRob2QsIHBhdGgsIHNwZWMsIGRyaXZlciwgaXNTZXNzQ21kKSB7XG4gIGxldCBhc3luY0hhbmRsZXIgPSBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBsZXQganNvbk9iaiA9IHJlcS5ib2R5O1xuICAgIGxldCBodHRwUmVzQm9keSA9IHt9O1xuICAgIGxldCBodHRwU3RhdHVzID0gMjAwO1xuICAgIGxldCBuZXdTZXNzaW9uSWQ7XG4gICAgbGV0IGN1cnJlbnRQcm90b2NvbCA9IGV4dHJhY3RQcm90b2NvbChkcml2ZXIsIHJlcS5wYXJhbXMuc2Vzc2lvbklkKTtcblxuICAgIGxldCB0ZXJtaW5hdGVTb2NrZXQgPSBmYWxzZTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBpZiB0aGlzIGlzIGEgc2Vzc2lvbiBjb21tYW5kIGJ1dCB3ZSBkb24ndCBoYXZlIGEgc2Vzc2lvbixcbiAgICAgIC8vIGVycm9yIG91dCBlYXJseSAoZXNwZWNpYWxseSBiZWZvcmUgcHJveHlpbmcpXG4gICAgICBpZiAoaXNTZXNzQ21kICYmICFkcml2ZXIuc2Vzc2lvbkV4aXN0cyhyZXEucGFyYW1zLnNlc3Npb25JZCkpIHtcbiAgICAgICAgdGVybWluYXRlU29ja2V0ID0gdHJ1ZTtcbiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hEcml2ZXJFcnJvcigpO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiB0aGUgZHJpdmVyIGlzIGN1cnJlbnRseSBwcm94eWluZyBjb21tYW5kcyB0byBhbm90aGVyIEpTT05XUFxuICAgICAgLy8gc2VydmVyLCBieXBhc3MgYWxsIG91ciBjaGVja3MgYW5kIGFzc3VtZSB0aGUgdXBzdHJlYW0gc2VydmVyIGtub3dzXG4gICAgICAvLyB3aGF0IGl0J3MgZG9pbmcuIEJ1dCBrZWVwIHRoaXMgaW4gdGhlIHRyeS9jYXRjaCBibG9jayBzbyBpZiBwcm94eWluZ1xuICAgICAgLy8gaXRzZWxmIGZhaWxzLCB3ZSBnaXZlIGEgbWVzc2FnZSB0byB0aGUgY2xpZW50LiBPZiBjb3Vyc2Ugd2Ugb25seVxuICAgICAgLy8gd2FudCB0byBkbyB0aGVzZSB3aGVuIHdlIGhhdmUgYSBzZXNzaW9uIGNvbW1hbmQ7IHRoZSBBcHBpdW0gZHJpdmVyXG4gICAgICAvLyBtdXN0IGJlIHJlc3BvbnNpYmxlIGZvciBzdGFydC9zdG9wIHNlc3Npb24sIGV0Yy4uLlxuICAgICAgaWYgKGlzU2Vzc0NtZCAmJiBkcml2ZXJTaG91bGREb0p3cFByb3h5KGRyaXZlciwgcmVxLCBzcGVjLmNvbW1hbmQpKSB7XG4gICAgICAgIGF3YWl0IGRvSndwUHJveHkoZHJpdmVyLCByZXEsIHJlcyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gaWYgYSBjb21tYW5kIGlzIG5vdCBpbiBvdXIgbWV0aG9kIG1hcCwgaXQncyBiZWNhdXNlIHdlXG4gICAgICAvLyBoYXZlIG5vIHBsYW5zIHRvIGV2ZXIgaW1wbGVtZW50IGl0XG4gICAgICBpZiAoIXNwZWMuY29tbWFuZCkge1xuICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdEltcGxlbWVudGVkRXJyb3IoKTtcbiAgICAgIH1cblxuICAgICAgLy8gd3JhcCBwYXJhbXMgaWYgbmVjZXNzYXJ5XG4gICAgICBpZiAoc3BlYy5wYXlsb2FkUGFyYW1zICYmIHNwZWMucGF5bG9hZFBhcmFtcy53cmFwKSB7XG4gICAgICAgIGpzb25PYmogPSB3cmFwUGFyYW1zKHNwZWMucGF5bG9hZFBhcmFtcywganNvbk9iaik7XG4gICAgICB9XG5cbiAgICAgIC8vIHVud3JhcCBwYXJhbXMgaWYgbmVjZXNzYXJ5XG4gICAgICBpZiAoc3BlYy5wYXlsb2FkUGFyYW1zICYmIHNwZWMucGF5bG9hZFBhcmFtcy51bndyYXApIHtcbiAgICAgICAganNvbk9iaiA9IHVud3JhcFBhcmFtcyhzcGVjLnBheWxvYWRQYXJhbXMsIGpzb25PYmopO1xuICAgICAgfVxuXG4gICAgICBpZiAoc3BlYy5jb21tYW5kID09PSBDUkVBVEVfU0VTU0lPTl9DT01NQU5EKSB7XG4gICAgICAgIC8vIHRyeSB0byBkZXRlcm1pbmUgcHJvdG9jb2wgYnkgc2Vzc2lvbiBjcmVhdGlvbiBhcmdzLCBzbyB3ZSBjYW4gdGhyb3cgYVxuICAgICAgICAvLyBwcm9wZXJseSBmb3JtYXR0ZWQgZXJyb3IgaWYgYXJndW1lbnRzIHZhbGlkYXRpb24gZmFpbHNcbiAgICAgICAgY3VycmVudFByb3RvY29sID0gZGV0ZXJtaW5lUHJvdG9jb2woLi4ubWFrZUFyZ3MocmVxLnBhcmFtcywganNvbk9iaiwgc3BlYy5wYXlsb2FkUGFyYW1zIHx8IHt9KSk7XG4gICAgICB9XG5cbiAgICAgIC8vIGVuc3VyZSB0aGF0IHRoZSBqc29uIHBheWxvYWQgY29uZm9ybXMgdG8gdGhlIHNwZWNcbiAgICAgIGNoZWNrUGFyYW1zKHNwZWMucGF5bG9hZFBhcmFtcywganNvbk9iaiwgY3VycmVudFByb3RvY29sKTtcblxuICAgICAgLy8gdHVybiB0aGUgY29tbWFuZCBhbmQganNvbiBwYXlsb2FkIGludG8gYW4gYXJndW1lbnQgbGlzdCBmb3JcbiAgICAgIC8vIHRoZSBkcml2ZXIgbWV0aG9kc1xuICAgICAgbGV0IGFyZ3MgPSBtYWtlQXJncyhyZXEucGFyYW1zLCBqc29uT2JqLCBzcGVjLnBheWxvYWRQYXJhbXMgfHwge30sIGN1cnJlbnRQcm90b2NvbCk7XG4gICAgICBsZXQgZHJpdmVyUmVzO1xuICAgICAgLy8gdmFsaWRhdGUgY29tbWFuZCBhcmdzIGFjY29yZGluZyB0byBNSlNPTldQXG4gICAgICBpZiAodmFsaWRhdG9yc1tzcGVjLmNvbW1hbmRdKSB7XG4gICAgICAgIHZhbGlkYXRvcnNbc3BlYy5jb21tYW5kXSguLi5hcmdzKTtcbiAgICAgIH1cblxuICAgICAgLy8gcnVuIHRoZSBkcml2ZXIgY29tbWFuZCB3cmFwcGVkIGluc2lkZSB0aGUgYXJndW1lbnQgdmFsaWRhdG9yc1xuICAgICAgU0VTU0lPTlNfQ0FDSEUuZ2V0TG9nZ2VyKHJlcS5wYXJhbXMuc2Vzc2lvbklkLCBjdXJyZW50UHJvdG9jb2wpLmRlYnVnKGBDYWxsaW5nIGAgK1xuICAgICAgICBgJHtkcml2ZXIuY29uc3RydWN0b3IubmFtZX0uJHtzcGVjLmNvbW1hbmR9KCkgd2l0aCBhcmdzOiBgICtcbiAgICAgICAgXy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShhcmdzKSwge2xlbmd0aDogTE9HX09CSl9MRU5HVEh9KSk7XG5cbiAgICAgIGlmIChkcml2ZXIuZXhlY3V0ZUNvbW1hbmQpIHtcbiAgICAgICAgZHJpdmVyUmVzID0gYXdhaXQgZHJpdmVyLmV4ZWN1dGVDb21tYW5kKHNwZWMuY29tbWFuZCwgLi4uYXJncyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkcml2ZXJSZXMgPSBhd2FpdCBkcml2ZXIuZXhlY3V0ZShzcGVjLmNvbW1hbmQsIC4uLmFyZ3MpO1xuICAgICAgfVxuXG4gICAgICAvLyBHZXQgdGhlIHByb3RvY29sIGFmdGVyIGV4ZWN1dGVDb21tYW5kXG4gICAgICBjdXJyZW50UHJvdG9jb2wgPSBleHRyYWN0UHJvdG9jb2woZHJpdmVyLCByZXEucGFyYW1zLnNlc3Npb25JZCkgfHwgY3VycmVudFByb3RvY29sO1xuXG4gICAgICAvLyBJZiBgZXhlY3V0ZUNvbW1hbmRgIHdhcyBvdmVycmlkZGVuIGFuZCB0aGUgbWV0aG9kIHJldHVybnMgYW4gb2JqZWN0XG4gICAgICAvLyB3aXRoIGEgcHJvdG9jb2wgYW5kIHZhbHVlL2Vycm9yIHByb3BlcnR5LCByZS1hc3NpZ24gdGhlIHByb3RvY29sXG4gICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KGRyaXZlclJlcykgJiYgXy5oYXMoZHJpdmVyUmVzLCAncHJvdG9jb2wnKSkge1xuICAgICAgICBjdXJyZW50UHJvdG9jb2wgPSBkcml2ZXJSZXMucHJvdG9jb2wgfHwgY3VycmVudFByb3RvY29sO1xuICAgICAgICBpZiAoZHJpdmVyUmVzLmVycm9yKSB7XG4gICAgICAgICAgdGhyb3cgZHJpdmVyUmVzLmVycm9yO1xuICAgICAgICB9XG4gICAgICAgIGRyaXZlclJlcyA9IGRyaXZlclJlcy52YWx1ZTtcbiAgICAgIH1cblxuICAgICAgLy8gdW5wYWNrIGNyZWF0ZVNlc3Npb24gcmVzcG9uc2VcbiAgICAgIGlmIChzcGVjLmNvbW1hbmQgPT09IENSRUFURV9TRVNTSU9OX0NPTU1BTkQpIHtcbiAgICAgICAgbmV3U2Vzc2lvbklkID0gZHJpdmVyUmVzWzBdO1xuICAgICAgICBTRVNTSU9OU19DQUNIRS5wdXRTZXNzaW9uKG5ld1Nlc3Npb25JZCwgY3VycmVudFByb3RvY29sKTtcbiAgICAgICAgU0VTU0lPTlNfQ0FDSEUuZ2V0TG9nZ2VyKG5ld1Nlc3Npb25JZCwgY3VycmVudFByb3RvY29sKVxuICAgICAgICAgIC5kZWJ1ZyhgQ2FjaGVkIHRoZSBwcm90b2NvbCB2YWx1ZSAnJHtjdXJyZW50UHJvdG9jb2x9JyBmb3IgdGhlIG5ldyBzZXNzaW9uICR7bmV3U2Vzc2lvbklkfWApO1xuICAgICAgICBpZiAoY3VycmVudFByb3RvY29sID09PSBQUk9UT0NPTFMuTUpTT05XUCkge1xuICAgICAgICAgIGRyaXZlclJlcyA9IGRyaXZlclJlc1sxXTtcbiAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50UHJvdG9jb2wgPT09IFBST1RPQ09MUy5XM0MpIHtcbiAgICAgICAgICBkcml2ZXJSZXMgPSB7XG4gICAgICAgICAgICBjYXBhYmlsaXRpZXM6IGRyaXZlclJlc1sxXSxcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGRyaXZlclJlcyA9IGZvcm1hdFJlc3BvbnNlVmFsdWUoZHJpdmVyUmVzKTtcblxuICAgICAgLy8gZGVsZXRlIHNob3VsZCBub3QgcmV0dXJuIGFueXRoaW5nIGV2ZW4gaWYgc3VjY2Vzc2Z1bFxuICAgICAgaWYgKHNwZWMuY29tbWFuZCA9PT0gREVMRVRFX1NFU1NJT05fQ09NTUFORCkge1xuICAgICAgICB0ZXJtaW5hdGVTb2NrZXQgPSB0cnVlO1xuICAgICAgICBTRVNTSU9OU19DQUNIRS5nZXRMb2dnZXIocmVxLnBhcmFtcy5zZXNzaW9uSWQsIGN1cnJlbnRQcm90b2NvbClcbiAgICAgICAgICAuZGVidWcoYFJlY2VpdmVkIHJlc3BvbnNlOiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkoZHJpdmVyUmVzKSwge2xlbmd0aDogTE9HX09CSl9MRU5HVEh9KX1gKTtcbiAgICAgICAgU0VTU0lPTlNfQ0FDSEUuZ2V0TG9nZ2VyKHJlcS5wYXJhbXMuc2Vzc2lvbklkLCBjdXJyZW50UHJvdG9jb2wpLmRlYnVnKCdCdXQgZGVsZXRpbmcgc2Vzc2lvbiwgc28gbm90IHJldHVybmluZycpO1xuICAgICAgICBkcml2ZXJSZXMgPSBudWxsO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiB0aGUgc3RhdHVzIGlzIG5vdCAwLCAgdGhyb3cgdGhlIGFwcHJvcHJpYXRlIGVycm9yIGZvciBzdGF0dXMgY29kZS5cbiAgICAgIGlmICh1dGlsLmhhc1ZhbHVlKGRyaXZlclJlcykpIHtcbiAgICAgICAgaWYgKHV0aWwuaGFzVmFsdWUoZHJpdmVyUmVzLnN0YXR1cykgJiYgIWlzTmFOKGRyaXZlclJlcy5zdGF0dXMpICYmIHBhcnNlSW50KGRyaXZlclJlcy5zdGF0dXMsIDEwKSAhPT0gMCkge1xuICAgICAgICAgIHRocm93IGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlKGRyaXZlclJlcy5zdGF0dXMsIGRyaXZlclJlcy52YWx1ZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoXy5pc1BsYWluT2JqZWN0KGRyaXZlclJlcy52YWx1ZSkgJiYgZHJpdmVyUmVzLnZhbHVlLmVycm9yKSB7XG4gICAgICAgICAgdGhyb3cgZXJyb3JGcm9tVzNDSnNvbkNvZGUoZHJpdmVyUmVzLnZhbHVlLmVycm9yLCBkcml2ZXJSZXMudmFsdWUubWVzc2FnZSwgZHJpdmVyUmVzLnZhbHVlLnN0YWNrdHJhY2UpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGh0dHBSZXNCb2R5LnZhbHVlID0gZHJpdmVyUmVzO1xuICAgICAgU0VTU0lPTlNfQ0FDSEUuZ2V0TG9nZ2VyKHJlcS5wYXJhbXMuc2Vzc2lvbklkIHx8IG5ld1Nlc3Npb25JZCwgY3VycmVudFByb3RvY29sKS5kZWJ1ZyhgUmVzcG9uZGluZyBgICtcbiAgICAgICAgYHRvIGNsaWVudCB3aXRoIGRyaXZlci4ke3NwZWMuY29tbWFuZH0oKSByZXN1bHQ6ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShkcml2ZXJSZXMpLCB7bGVuZ3RoOiBMT0dfT0JKX0xFTkdUSH0pfWApO1xuXG4gICAgICBpZiAoc3BlYy5jb21tYW5kID09PSBERUxFVEVfU0VTU0lPTl9DT01NQU5EKSB7XG4gICAgICAgIC8vIFdlIGRvbid0IHdhbnQgdG8ga2VlcCB0aGUgbG9nZ2VyIGluc3RhbmNlIGluIHRoZSBjYWNoZVxuICAgICAgICAvLyBhZnRlciB0aGUgc2Vzc2lvbiBpcyBkZWxldGVkLCBiZWNhdXNlIGl0IGNvbnRhaW5zIHRoZSBsb2dnaW5nIGhpc3RvcnlcbiAgICAgICAgLy8gYW5kIGNvbnN1bWVzIHRoZSBtZW1vcnlcbiAgICAgICAgU0VTU0lPTlNfQ0FDSEUucmVzZXRMb2dnZXIocmVxLnBhcmFtcy5zZXNzaW9uSWQpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gaWYgYW55dGhpbmcgZ29lcyB3cm9uZywgZmlndXJlIG91dCB3aGF0IG91ciByZXNwb25zZSBzaG91bGQgYmVcbiAgICAgIC8vIGJhc2VkIG9uIHRoZSB0eXBlIG9mIGVycm9yIHRoYXQgd2UgZW5jb3VudGVyZWRcbiAgICAgIGxldCBhY3R1YWxFcnIgPSBlcnI7XG5cbiAgICAgIGN1cnJlbnRQcm90b2NvbCA9IGN1cnJlbnRQcm90b2NvbCB8fCBleHRyYWN0UHJvdG9jb2woZHJpdmVyLCByZXEucGFyYW1zLnNlc3Npb25JZCB8fCBuZXdTZXNzaW9uSWQpO1xuXG4gICAgICBsZXQgZXJyTXNnID0gZXJyLnN0YWNrdHJhY2UgfHwgZXJyLnN0YWNrO1xuICAgICAgaWYgKCFfLmluY2x1ZGVzKGVyck1zZywgZXJyLm1lc3NhZ2UpKSB7XG4gICAgICAgIC8vIGlmIHRoZSBtZXNzYWdlIGhhcyBtb3JlIGluZm9ybWF0aW9uLCBhZGQgaXQuIGJ1dCBvZnRlbiB0aGUgbWVzc2FnZVxuICAgICAgICAvLyBpcyB0aGUgZmlyc3QgcGFydCBvZiB0aGUgc3RhY2sgdHJhY2VcbiAgICAgICAgZXJyTXNnID0gYCR7ZXJyLm1lc3NhZ2V9JHtlcnJNc2cgPyAoJ1xcbicgKyBlcnJNc2cpIDogJyd9YDtcbiAgICAgIH1cbiAgICAgIFNFU1NJT05TX0NBQ0hFLmdldExvZ2dlcihyZXEucGFyYW1zLnNlc3Npb25JZCB8fCBuZXdTZXNzaW9uSWQsIGN1cnJlbnRQcm90b2NvbCkuZGVidWcoYEVuY291bnRlcmVkIGAgK1xuICAgICAgICBgaW50ZXJuYWwgZXJyb3IgcnVubmluZyBjb21tYW5kOiAke2Vyck1zZ31gKTtcbiAgICAgIGlmIChpc0Vycm9yVHlwZShlcnIsIGVycm9ycy5Qcm94eVJlcXVlc3RFcnJvcikpIHtcbiAgICAgICAgYWN0dWFsRXJyID0gZXJyLmdldEFjdHVhbEVycm9yKCk7XG4gICAgICB9XG5cbiAgICAgIGlmIChjdXJyZW50UHJvdG9jb2wgPT09IFBST1RPQ09MUy5XM0MpIHtcbiAgICAgICAgW2h0dHBTdGF0dXMsIGh0dHBSZXNCb2R5XSA9IGdldFJlc3BvbnNlRm9yVzNDRXJyb3IoYWN0dWFsRXJyKTtcbiAgICAgIH0gZWxzZSBpZiAoY3VycmVudFByb3RvY29sID09PSBQUk9UT0NPTFMuTUpTT05XUCkge1xuICAgICAgICBbaHR0cFN0YXR1cywgaHR0cFJlc0JvZHldID0gZ2V0UmVzcG9uc2VGb3JKc29ud3BFcnJvcihhY3R1YWxFcnIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gSWYgaXQncyB1bmtub3duIHdoYXQgdGhlIHByb3RvY29sIGlzIChsaWtlIGlmIGl0J3MgYGdldFN0YXR1c2AgcHJpb3IgdG8gYGNyZWF0ZVNlc3Npb25gKSwgbWVyZ2UgdGhlIHJlc3BvbnNlc1xuICAgICAgICAvLyB0b2dldGhlciB0byBiZSBwcm90b2NvbC1hZ25vc3RpY1xuICAgICAgICBsZXQganNvbndwUmVzID0gZ2V0UmVzcG9uc2VGb3JKc29ud3BFcnJvcihhY3R1YWxFcnIpO1xuICAgICAgICBsZXQgdzNjUmVzID0gZ2V0UmVzcG9uc2VGb3JXM0NFcnJvcihhY3R1YWxFcnIpO1xuXG4gICAgICAgIGh0dHBSZXNCb2R5ID0ge1xuICAgICAgICAgIC4uLmpzb253cFJlc1sxXSxcbiAgICAgICAgICAuLi53M2NSZXNbMV0sXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gVXNlIHRoZSBKU09OV1Agc3RhdHVzIGNvZGUgKHdoaWNoIGlzIHVzdWFsbHkgNTAwKVxuICAgICAgICBodHRwU3RhdHVzID0ganNvbndwUmVzWzBdO1xuICAgICAgfVxuXG4gICAgICAvLyBhbnkgZXJyb3Igd2hpbGUgY3JlYXRpbmcgYSBzZXNzaW9uIHNob3VsZCBub3QgY29udGludWUgaG9sZGluZyBvbnRvXG4gICAgICAvLyB0aGUgc29ja2V0XG4gICAgICBpZiAoc3BlYy5jb21tYW5kID09PSBDUkVBVEVfU0VTU0lPTl9DT01NQU5EKSB7XG4gICAgICAgIHRlcm1pbmF0ZVNvY2tldCA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gZGVjb2RlIHRoZSByZXNwb25zZSwgd2hpY2ggaXMgZWl0aGVyIGEgc3RyaW5nIG9yIGpzb25cbiAgICBpZiAoXy5pc1N0cmluZyhodHRwUmVzQm9keSkpIHtcbiAgICAgIHJlcy5zdGF0dXMoaHR0cFN0YXR1cykuc2VuZChodHRwUmVzQm9keSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChuZXdTZXNzaW9uSWQpIHtcbiAgICAgICAgaWYgKGN1cnJlbnRQcm90b2NvbCA9PT0gUFJPVE9DT0xTLlczQykge1xuICAgICAgICAgIGh0dHBSZXNCb2R5LnZhbHVlLnNlc3Npb25JZCA9IG5ld1Nlc3Npb25JZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBodHRwUmVzQm9keS5zZXNzaW9uSWQgPSBuZXdTZXNzaW9uSWQ7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGh0dHBSZXNCb2R5LnNlc3Npb25JZCA9IHJlcS5wYXJhbXMuc2Vzc2lvbklkIHx8IG51bGw7XG4gICAgICB9XG4gICAgICAvLyBEb24ndCBpbmNsdWRlIHNlc3Npb25JZCBpbiBXM0MgcmVzcG9uc2VzXG4gICAgICBpZiAoY3VycmVudFByb3RvY29sID09PSBQUk9UT0NPTFMuVzNDKSB7XG4gICAgICAgIGRlbGV0ZSBodHRwUmVzQm9keS5zZXNzaW9uSWQ7XG4gICAgICB9XG5cbiAgICAgIGh0dHBSZXNCb2R5ID0gZm9ybWF0U3RhdHVzKGh0dHBSZXNCb2R5LCBodHRwU3RhdHVzLCBjdXJyZW50UHJvdG9jb2wpO1xuICAgICAgcmVzLnN0YXR1cyhodHRwU3RhdHVzKS5qc29uKGh0dHBSZXNCb2R5KTtcbiAgICB9XG5cbiAgICAvLyBpbiBjZXJ0YWluIHNpdHVhdGlvbnMgdGhlIHNvY2tldCBzaG91bGQgbm90IGJlIGtlcHQgYWxpdmVcbiAgICBpZiAodGVybWluYXRlU29ja2V0KSB7XG4gICAgICBTRVNTSU9OU19DQUNIRS5nZXRMb2dnZXIocmVxLnBhcmFtcy5zZXNzaW9uSWQgfHwgbmV3U2Vzc2lvbklkLCBjdXJyZW50UHJvdG9jb2wpLmRlYnVnKGBEZXN0cm95aW5nIHNvY2tldCBjb25uZWN0aW9uYCk7XG4gICAgICByZXMuc29ja2V0LmRlc3Ryb3koKTtcbiAgICB9XG4gIH07XG4gIC8vIGFkZCB0aGUgbWV0aG9kIHRvIHRoZSBhcHBcbiAgYXBwW21ldGhvZC50b0xvd2VyQ2FzZSgpXShwYXRoLCAocmVxLCByZXMpID0+IHtcbiAgICBCLnJlc29sdmUoYXN5bmNIYW5kbGVyKHJlcSwgcmVzKSkuZG9uZSgpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gZHJpdmVyU2hvdWxkRG9Kd3BQcm94eSAoZHJpdmVyLCByZXEsIGNvbW1hbmQpIHtcbiAgLy8gZHJpdmVycyBuZWVkIHRvIGV4cGxpY2l0bHkgc2F5IHdoZW4gdGhlIHByb3h5IGlzIGFjdGl2ZVxuICBpZiAoIWRyaXZlci5wcm94eUFjdGl2ZShyZXEucGFyYW1zLnNlc3Npb25JZCkpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvLyB3ZSBzaG91bGQgbmV2ZXIgcHJveHkgZGVsZXRlU2Vzc2lvbiBiZWNhdXNlIHdlIG5lZWQgdG8gZ2l2ZSB0aGUgY29udGFpbmluZ1xuICAvLyBkcml2ZXIgYW4gb3Bwb3J0dW5pdHkgdG8gY2xlYW4gaXRzZWxmIHVwXG4gIGlmIChjb21tYW5kID09PSAnZGVsZXRlU2Vzc2lvbicpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvLyB2YWxpZGF0ZSBhdm9pZGFuY2Ugc2NoZW1hLCBhbmQgc2F5IHdlIHNob3VsZG4ndCBwcm94eSBpZiBhbnl0aGluZyBpbiB0aGVcbiAgLy8gYXZvaWQgbGlzdCBtYXRjaGVzIG91ciByZXFcbiAgaWYgKGRyaXZlci5wcm94eVJvdXRlSXNBdm9pZGVkKHJlcS5wYXJhbXMuc2Vzc2lvbklkLCByZXEubWV0aG9kLCByZXEub3JpZ2luYWxVcmwpKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLy8gaWYgaXQgbG9va3MgbGlrZSB3ZSBoYXZlIGFuIGltYWdlIGVsZW1lbnQgaW4gdGhlIHVybCAoYXMgYSByb3V0ZVxuICAvLyBwYXJhbWV0ZXIpLCBuZXZlciBwcm94eS4gSnVzdCBsb29rIGZvciBvdXIgaW1hZ2UgZWxlbWVudCBwcmVmaXggaW4gYWxsb3dlZFxuICAvLyBwb3NpdGlvbnMgKGVpdGhlciBhZnRlciBhbiAnZWxlbWVudCcgb3IgJ3NjcmVlbnNob3QnIHBhdGggc2VnbWVudCksIGFuZFxuICAvLyBlbnN1cmUgdGhlIHByZWZpeCBpcyBmb2xsb3dlZCBieSBzb21ldGhpbmdcbiAgaWYgKElNR19FTF9VUkxfUkUudGVzdChyZXEub3JpZ2luYWxVcmwpKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cblxuICAvLyBhbHNvIGlmIGl0IGxvb2tzIGxpa2Ugd2UgaGF2ZSBhbiBpbWFnZSBlbGVtZW50IGluIHRoZSByZXF1ZXN0IGJvZHkgKGFzXG4gIC8vIGEgSlNPTiBwYXJhbWV0ZXIpLCBuZXZlciBwcm94eS4gQmFzaWNhbGx5IGNoZWNrIGFnYWluc3QgYSByZWdleHAgb2YgdGhlXG4gIC8vIGpzb24gc3RyaW5nIG9mIHRoZSBib2R5LCB3aGVyZSB3ZSBrbm93IHdoYXQgdGhlIGZvcm0gb2YgYW4gaW1hZ2UgZWxlbWVudFxuICAvLyBtdXN0IGJlXG4gIGNvbnN0IHN0cmluZ0JvZHkgPSBKU09OLnN0cmluZ2lmeShyZXEuYm9keSk7XG4gIGlmIChzdHJpbmdCb2R5ICYmIElNR19FTF9CT0RZX1JFLnRlc3Qoc3RyaW5nQm9keSkpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICByZXR1cm4gdHJ1ZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZG9Kd3BQcm94eSAoZHJpdmVyLCByZXEsIHJlcykge1xuICBTRVNTSU9OU19DQUNIRS5nZXRMb2dnZXIocmVxLnBhcmFtcy5zZXNzaW9uSWQsIGV4dHJhY3RQcm90b2NvbChkcml2ZXIsIHJlcS5wYXJhbXMuc2Vzc2lvbklkKSlcbiAgICAuaW5mbygnRHJpdmVyIHByb3h5IGFjdGl2ZSwgcGFzc2luZyByZXF1ZXN0IG9uIHZpYSBIVFRQIHByb3h5Jyk7XG5cbiAgLy8gY2hlY2sgdGhhdCB0aGUgaW5uZXIgZHJpdmVyIGhhcyBhIHByb3h5IGZ1bmN0aW9uXG4gIGlmICghZHJpdmVyLmNhblByb3h5KHJlcS5wYXJhbXMuc2Vzc2lvbklkKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignVHJ5aW5nIHRvIHByb3h5IHRvIGEgSlNPTldQIHNlcnZlciBidXQgZHJpdmVyIGlzIHVuYWJsZSB0byBwcm94eScpO1xuICB9XG4gIHRyeSB7XG4gICAgY29uc3QgcHJveGllZFJlcyA9IGF3YWl0IGRyaXZlci5leGVjdXRlQ29tbWFuZCgncHJveHlSZXFSZXMnLCByZXEsIHJlcywgcmVxLnBhcmFtcy5zZXNzaW9uSWQpO1xuICAgIGlmIChwcm94aWVkUmVzICYmIHByb3hpZWRSZXMuZXJyb3IpIHRocm93IHByb3hpZWRSZXMuZXJyb3I7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKGlzRXJyb3JUeXBlKGVyciwgZXJyb3JzLlByb3h5UmVxdWVzdEVycm9yKSkge1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBwcm94eS4gUHJveHkgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG59XG5cblxuZXhwb3J0IHtcbiAgUHJvdG9jb2wsIHJvdXRlQ29uZmlndXJpbmdGdW5jdGlvbiwgaXNTZXNzaW9uQ29tbWFuZCxcbiAgTUpTT05XUF9FTEVNRU5UX0tFWSwgVzNDX0VMRU1FTlRfS0VZLCBJTUFHRV9FTEVNRU5UX1BSRUZJWCxcbiAgZHJpdmVyU2hvdWxkRG9Kd3BQcm94eSwgREVGQVVMVF9CQVNFX1BBVEgsIGRldGVybWluZVByb3RvY29sLCBQUk9UT0NPTFNcbn07XG4iXSwiZmlsZSI6ImxpYi9wcm90b2NvbC9wcm90b2NvbC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
