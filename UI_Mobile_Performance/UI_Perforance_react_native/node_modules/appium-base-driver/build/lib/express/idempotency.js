"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.handleIdempotency = handleIdempotency;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _appiumSupport = require("appium-support");

var _os = _interopRequireDefault(require("os"));

var _path = _interopRequireDefault(require("path"));

var _events = require("events");

const CACHE_SIZE = 1024;
const IDEMPOTENT_RESPONSES = new _lruCache.default({
  max: CACHE_SIZE,
  updateAgeOnGet: true,

  dispose(key, {
    response
  }) {
    if (response) {
      _appiumSupport.fs.rimrafSync(response);
    }
  }

});
const MONITORED_METHODS = ['POST', 'PATCH'];
const IDEMPOTENCY_KEY_HEADER = 'x-idempotency-key';
process.on('exit', () => IDEMPOTENT_RESPONSES.reset());

function cacheResponse(key, req, res) {
  const responseStateListener = new _events.EventEmitter();
  IDEMPOTENT_RESPONSES.set(key, {
    method: req.method,
    path: req.path,
    response: null,
    responseStateListener
  });

  const tmpFile = _path.default.resolve(_os.default.tmpdir(), `${_appiumSupport.util.uuidV4()}.response`);

  const responseListener = _appiumSupport.fs.createWriteStream(tmpFile, {
    emitClose: true
  });

  const originalSocketWriter = res.socket.write.bind(res.socket);

  const patchedWriter = (chunk, encoding, next) => {
    if (responseListener.writable) {
      responseListener.write(chunk);
    }

    return originalSocketWriter(chunk, encoding, next);
  };

  res.socket.write = patchedWriter;
  let writeError = null;
  let isResponseFullySent = false;
  responseListener.once('error', e => {
    writeError = e;
  });
  res.once('finish', () => {
    isResponseFullySent = true;
    responseListener.end();
  });
  res.once('close', () => {
    if (!isResponseFullySent) {
      responseListener.end();
    }
  });
  responseListener.once('close', () => {
    var _res$socket;

    if (((_res$socket = res.socket) === null || _res$socket === void 0 ? void 0 : _res$socket.write) === patchedWriter) {
      res.socket.write = originalSocketWriter;
    }

    if (!IDEMPOTENT_RESPONSES.has(key)) {
      const msg = `Could not cache the response identified by '${key}'. ` + `Cache consistency has been damaged`;

      _logger.default.info(msg);

      return responseStateListener.emit('error', new Error(msg));
    }

    if (writeError) {
      _logger.default.info(`Could not cache the response identified by '${key}': ${writeError.message}`);

      IDEMPOTENT_RESPONSES.del(key);
      return responseStateListener.emit('error', writeError);
    }

    if (!isResponseFullySent) {
      const msg = `Could not cache the response identified by '${key}', ` + `because it has not been completed`;

      _logger.default.info(msg);

      _logger.default.info('Does the client terminate connections too early?');

      IDEMPOTENT_RESPONSES.del(key);
      return responseStateListener.emit('error', new Error(msg));
    }

    IDEMPOTENT_RESPONSES.get(key).response = tmpFile;
    responseStateListener.emit('ready', tmpFile);
  });
}

async function handleIdempotency(req, res, next) {
  const key = req.headers[IDEMPOTENCY_KEY_HEADER];

  if (!key) {
    return next();
  }

  if (!MONITORED_METHODS.includes(req.method)) {
    return next();
  }

  _logger.default.debug(`Request idempotency key: ${key}`);

  if (!IDEMPOTENT_RESPONSES.has(key)) {
    cacheResponse(key, req, res);
    return next();
  }

  const {
    method: storedMethod,
    path: storedPath,
    response,
    responseStateListener
  } = IDEMPOTENT_RESPONSES.get(key);

  if (req.method !== storedMethod || req.path !== storedPath) {
    _logger.default.warn(`Got two different requests with the same idempotency key '${key}'`);

    _logger.default.warn('Is the client generating idempotency keys properly?');

    return next();
  }

  const rerouteCachedResponse = async cachedResPath => {
    if (!(await _appiumSupport.fs.exists(cachedResPath))) {
      IDEMPOTENT_RESPONSES.del(key);

      _logger.default.warn(`Could not read the cached response identified by key '${key}'`);

      _logger.default.warn('The temporary storage is not accessible anymore');

      return next();
    }

    _appiumSupport.fs.createReadStream(cachedResPath).pipe(res.socket);
  };

  if (response) {
    _logger.default.info(`The same request with the idempotency key '${key}' has been already processed`);

    _logger.default.info(`Rerouting its response to the current request`);

    await rerouteCachedResponse(response);
  } else {
    _logger.default.info(`The same request with the idempotency key '${key}' is being processed`);

    _logger.default.info(`Waiting for the response to be rerouted to the current request`);

    responseStateListener.once('error', () => next());
    responseStateListener.once('ready', rerouteCachedResponse);
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9leHByZXNzL2lkZW1wb3RlbmN5LmpzIl0sIm5hbWVzIjpbIkNBQ0hFX1NJWkUiLCJJREVNUE9URU5UX1JFU1BPTlNFUyIsIkxSVSIsIm1heCIsInVwZGF0ZUFnZU9uR2V0IiwiZGlzcG9zZSIsImtleSIsInJlc3BvbnNlIiwiZnMiLCJyaW1yYWZTeW5jIiwiTU9OSVRPUkVEX01FVEhPRFMiLCJJREVNUE9URU5DWV9LRVlfSEVBREVSIiwicHJvY2VzcyIsIm9uIiwicmVzZXQiLCJjYWNoZVJlc3BvbnNlIiwicmVxIiwicmVzIiwicmVzcG9uc2VTdGF0ZUxpc3RlbmVyIiwiRXZlbnRFbWl0dGVyIiwic2V0IiwibWV0aG9kIiwicGF0aCIsInRtcEZpbGUiLCJyZXNvbHZlIiwib3MiLCJ0bXBkaXIiLCJ1dGlsIiwidXVpZFY0IiwicmVzcG9uc2VMaXN0ZW5lciIsImNyZWF0ZVdyaXRlU3RyZWFtIiwiZW1pdENsb3NlIiwib3JpZ2luYWxTb2NrZXRXcml0ZXIiLCJzb2NrZXQiLCJ3cml0ZSIsImJpbmQiLCJwYXRjaGVkV3JpdGVyIiwiY2h1bmsiLCJlbmNvZGluZyIsIm5leHQiLCJ3cml0YWJsZSIsIndyaXRlRXJyb3IiLCJpc1Jlc3BvbnNlRnVsbHlTZW50Iiwib25jZSIsImUiLCJlbmQiLCJoYXMiLCJtc2ciLCJsb2ciLCJpbmZvIiwiZW1pdCIsIkVycm9yIiwibWVzc2FnZSIsImRlbCIsImdldCIsImhhbmRsZUlkZW1wb3RlbmN5IiwiaGVhZGVycyIsImluY2x1ZGVzIiwiZGVidWciLCJzdG9yZWRNZXRob2QiLCJzdG9yZWRQYXRoIiwid2FybiIsInJlcm91dGVDYWNoZWRSZXNwb25zZSIsImNhY2hlZFJlc1BhdGgiLCJleGlzdHMiLCJjcmVhdGVSZWFkU3RyZWFtIiwicGlwZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxVQUFVLEdBQUcsSUFBbkI7QUFDQSxNQUFN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QVYsQ0FBUCxDQUFKLEVBQXFDO0FBQ25DOUQsTUFBQUEsb0JBQW9CLENBQUNvRCxHQUFyQixDQUF5Qi9DLEdBQXpCOztBQUNBMEMsc0JBQUlhLElBQUosQ0FBVSx5REFBd0R2RCxHQUFJLEdBQXRFOztBQUNBMEMsc0JBQUlhLElBQUosQ0FBUyxpREFBVDs7QUFDQSxhQUFPdEIsSUFBSSxFQUFYO0FBQ0Q7O0FBQ0QvQixzQkFBR3lELGdCQUFILENBQW9CRixhQUFwQixFQUFtQ0csSUFBbkMsQ0FBd0NqRCxHQUFHLENBQUNnQixNQUE1QztBQUNELEdBUkQ7O0FBVUEsTUFBSTFCLFFBQUosRUFBYztBQUNaeUMsb0JBQUlDLElBQUosQ0FBVSw4Q0FBNkMzQyxHQUFJLDhCQUEzRDs7QUFDQTBDLG9CQUFJQyxJQUFKLENBQVUsK0NBQVY7O0FBQ0EsVUFBTWEscUJBQXFCLENBQUN2RCxRQUFELENBQTNCO0FBQ0QsR0FKRCxNQUlPO0FBQ0x5QyxvQkFBSUMsSUFBSixDQUFVLDhDQUE2QzNDLEdBQUksc0JBQTNEOztBQUNBMEMsb0JBQUlDLElBQUosQ0FBVSxnRUFBVjs7QUFDQS9CLElBQUFBLHFCQUFxQixDQUFDeUIsSUFBdEIsQ0FBMkIsT0FBM0IsRUFBb0MsTUFBTUosSUFBSSxFQUE5QztBQUNBckIsSUFBQUEscUJBQXFCLENBQUN5QixJQUF0QixDQUEyQixPQUEzQixFQUFvQ21CLHFCQUFwQztBQUNEO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBMUlUgZnJvbSAnbHJ1LWNhY2hlJztcbmltcG9ydCB7IGZzLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcblxuXG5jb25zdCBDQUNIRV9TSVpFID0gMTAyNDtcbmNvbnN0IElERU1QT1RFTlRfUkVTUE9OU0VTID0gbmV3IExSVSh7XG4gIG1heDogQ0FDSEVfU0laRSxcbiAgdXBkYXRlQWdlT25HZXQ6IHRydWUsXG4gIGRpc3Bvc2UgKGtleSwge3Jlc3BvbnNlfSkge1xuICAgIGlmIChyZXNwb25zZSkge1xuICAgICAgZnMucmltcmFmU3luYyhyZXNwb25zZSk7XG4gICAgfVxuICB9LFxufSk7XG5jb25zdCBNT05JVE9SRURfTUVUSE9EUyA9IFsnUE9TVCcsICdQQVRDSCddO1xuY29uc3QgSURFTVBPVEVOQ1lfS0VZX0hFQURFUiA9ICd4LWlkZW1wb3RlbmN5LWtleSc7XG5cbnByb2Nlc3Mub24oJ2V4aXQnLCAoKSA9PiBJREVNUE9URU5UX1JFU1BPTlNFUy5yZXNldCgpKTtcblxuXG5mdW5jdGlvbiBjYWNoZVJlc3BvbnNlIChrZXksIHJlcSwgcmVzKSB7XG4gIGNvbnN0IHJlc3BvbnNlU3RhdGVMaXN0ZW5lciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgSURFTVBPVEVOVF9SRVNQT05TRVMuc2V0KGtleSwge1xuICAgIG1ldGhvZDogcmVxLm1ldGhvZCxcbiAgICBwYXRoOiByZXEucGF0aCxcbiAgICByZXNwb25zZTogbnVsbCxcbiAgICByZXNwb25zZVN0YXRlTGlzdGVuZXIsXG4gIH0pO1xuICBjb25zdCB0bXBGaWxlID0gcGF0aC5yZXNvbHZlKG9zLnRtcGRpcigpLCBgJHt1dGlsLnV1aWRWNCgpfS5yZXNwb25zZWApO1xuICBjb25zdCByZXNwb25zZUxpc3RlbmVyID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0odG1wRmlsZSwge1xuICAgIGVtaXRDbG9zZTogdHJ1ZSxcbiAgfSk7XG4gIGNvbnN0IG9yaWdpbmFsU29ja2V0V3JpdGVyID0gcmVzLnNvY2tldC53cml0ZS5iaW5kKHJlcy5zb2NrZXQpO1xuICBjb25zdCBwYXRjaGVkV3JpdGVyID0gKGNodW5rLCBlbmNvZGluZywgbmV4dCkgPT4ge1xuICAgIGlmIChyZXNwb25zZUxpc3RlbmVyLndyaXRhYmxlKSB7XG4gICAgICByZXNwb25zZUxpc3RlbmVyLndyaXRlKGNodW5rKTtcbiAgICB9XG4gICAgcmV0dXJuIG9yaWdpbmFsU29ja2V0V3JpdGVyKGNodW5rLCBlbmNvZGluZywgbmV4dCk7XG4gIH07XG4gIHJlcy5zb2NrZXQud3JpdGUgPSBwYXRjaGVkV3JpdGVyO1xuICBsZXQgd3JpdGVFcnJvciA9IG51bGw7XG4gIGxldCBpc1Jlc3BvbnNlRnVsbHlTZW50ID0gZmFsc2U7XG4gIHJlc3BvbnNlTGlzdGVuZXIub25jZSgnZXJyb3InLCAoZSkgPT4ge1xuICAgIHdyaXRlRXJyb3IgPSBlO1xuICB9KTtcbiAgcmVzLm9uY2UoJ2ZpbmlzaCcsICgpID0+IHtcbiAgICBpc1Jlc3BvbnNlRnVsbHlTZW50ID0gdHJ1ZTtcbiAgICByZXNwb25zZUxpc3RlbmVyLmVuZCgpO1xuICB9KTtcbiAgcmVzLm9uY2UoJ2Nsb3NlJywgKCkgPT4ge1xuICAgIGlmICghaXNSZXNwb25zZUZ1bGx5U2VudCkge1xuICAgICAgcmVzcG9uc2VMaXN0ZW5lci5lbmQoKTtcbiAgICB9XG4gIH0pO1xuICByZXNwb25zZUxpc3RlbmVyLm9uY2UoJ2Nsb3NlJywgKCkgPT4ge1xuICAgIGlmIChyZXMuc29ja2V0Py53cml0ZSA9PT0gcGF0Y2hlZFdyaXRlcikge1xuICAgICAgcmVzLnNvY2tldC53cml0ZSA9IG9yaWdpbmFsU29ja2V0V3JpdGVyO1xuICAgIH1cblxuICAgIGlmICghSURFTVBPVEVOVF9SRVNQT05TRVMuaGFzKGtleSkpIHtcbiAgICAgIGNvbnN0IG1zZyA9IGBDb3VsZCBub3QgY2FjaGUgdGhlIHJlc3BvbnNlIGlkZW50aWZpZWQgYnkgJyR7a2V5fScuIGAgK1xuICAgICAgICBgQ2FjaGUgY29uc2lzdGVuY3kgaGFzIGJlZW4gZGFtYWdlZGA7XG4gICAgICBsb2cuaW5mbyhtc2cpO1xuICAgICAgcmV0dXJuIHJlc3BvbnNlU3RhdGVMaXN0ZW5lci5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcihtc2cpKTtcbiAgICB9XG4gICAgaWYgKHdyaXRlRXJyb3IpIHtcbiAgICAgIGxvZy5pbmZvKGBDb3VsZCBub3QgY2FjaGUgdGhlIHJlc3BvbnNlIGlkZW50aWZpZWQgYnkgJyR7a2V5fSc6ICR7d3JpdGVFcnJvci5tZXNzYWdlfWApO1xuICAgICAgSURFTVBPVEVOVF9SRVNQT05TRVMuZGVsKGtleSk7XG4gICAgICByZXR1cm4gcmVzcG9uc2VTdGF0ZUxpc3RlbmVyLmVtaXQoJ2Vycm9yJywgd3JpdGVFcnJvcik7XG4gICAgfVxuICAgIGlmICghaXNSZXNwb25zZUZ1bGx5U2VudCkge1xuICAgICAgY29uc3QgbXNnID0gYENvdWxkIG5vdCBjYWNoZSB0aGUgcmVzcG9uc2UgaWRlbnRpZmllZCBieSAnJHtrZXl9JywgYCArXG4gICAgICAgIGBiZWNhdXNlIGl0IGhhcyBub3QgYmVlbiBjb21wbGV0ZWRgO1xuICAgICAgbG9nLmluZm8obXNnKTtcbiAgICAgIGxvZy5pbmZvKCdEb2VzIHRoZSBjbGllbnQgdGVybWluYXRlIGNvbm5lY3Rpb25zIHRvbyBlYXJseT8nKTtcbiAgICAgIElERU1QT1RFTlRfUkVTUE9OU0VTLmRlbChrZXkpO1xuICAgICAgcmV0dXJuIHJlc3BvbnNlU3RhdGVMaXN0ZW5lci5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcihtc2cpKTtcbiAgICB9XG5cbiAgICBJREVNUE9URU5UX1JFU1BPTlNFUy5nZXQoa2V5KS5yZXNwb25zZSA9IHRtcEZpbGU7XG4gICAgcmVzcG9uc2VTdGF0ZUxpc3RlbmVyLmVtaXQoJ3JlYWR5JywgdG1wRmlsZSk7XG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBoYW5kbGVJZGVtcG90ZW5jeSAocmVxLCByZXMsIG5leHQpIHtcbiAgY29uc3Qga2V5ID0gcmVxLmhlYWRlcnNbSURFTVBPVEVOQ1lfS0VZX0hFQURFUl07XG4gIGlmICgha2V5KSB7XG4gICAgcmV0dXJuIG5leHQoKTtcbiAgfVxuICBpZiAoIU1PTklUT1JFRF9NRVRIT0RTLmluY2x1ZGVzKHJlcS5tZXRob2QpKSB7XG4gICAgLy8gR0VULCBERUxFVEUsIGV0Yy4gcmVxdWVzdHMgYXJlIGlkZW1wb3RlbnQgYnkgZGVmYXVsdFxuICAgIC8vIHRoZXJlIGlzIG5vIG5lZWQgdG8gY2FjaGUgdGhlbVxuICAgIHJldHVybiBuZXh0KCk7XG4gIH1cblxuICBsb2cuZGVidWcoYFJlcXVlc3QgaWRlbXBvdGVuY3kga2V5OiAke2tleX1gKTtcbiAgaWYgKCFJREVNUE9URU5UX1JFU1BPTlNFUy5oYXMoa2V5KSkge1xuICAgIGNhY2hlUmVzcG9uc2Uoa2V5LCByZXEsIHJlcyk7XG4gICAgcmV0dXJuIG5leHQoKTtcbiAgfVxuXG4gIGNvbnN0IHtcbiAgICBtZXRob2Q6IHN0b3JlZE1ldGhvZCxcbiAgICBwYXRoOiBzdG9yZWRQYXRoLFxuICAgIHJlc3BvbnNlLFxuICAgIHJlc3BvbnNlU3RhdGVMaXN0ZW5lcixcbiAgfSA9IElERU1QT1RFTlRfUkVTUE9OU0VTLmdldChrZXkpO1xuICBpZiAocmVxLm1ldGhvZCAhPT0gc3RvcmVkTWV0aG9kIHx8IHJlcS5wYXRoICE9PSBzdG9yZWRQYXRoKSB7XG4gICAgbG9nLndhcm4oYEdvdCB0d28gZGlmZmVyZW50IHJlcXVlc3RzIHdpdGggdGhlIHNhbWUgaWRlbXBvdGVuY3kga2V5ICcke2tleX0nYCk7XG4gICAgbG9nLndhcm4oJ0lzIHRoZSBjbGllbnQgZ2VuZXJhdGluZyBpZGVtcG90ZW5jeSBrZXlzIHByb3Blcmx5PycpO1xuICAgIHJldHVybiBuZXh0KCk7XG4gIH1cblxuICBjb25zdCByZXJvdXRlQ2FjaGVkUmVzcG9uc2UgPSBhc3luYyAoY2FjaGVkUmVzUGF0aCkgPT4ge1xuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKGNhY2hlZFJlc1BhdGgpKSB7XG4gICAgICBJREVNUE9URU5UX1JFU1BPTlNFUy5kZWwoa2V5KTtcbiAgICAgIGxvZy53YXJuKGBDb3VsZCBub3QgcmVhZCB0aGUgY2FjaGVkIHJlc3BvbnNlIGlkZW50aWZpZWQgYnkga2V5ICcke2tleX0nYCk7XG4gICAgICBsb2cud2FybignVGhlIHRlbXBvcmFyeSBzdG9yYWdlIGlzIG5vdCBhY2Nlc3NpYmxlIGFueW1vcmUnKTtcbiAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgfVxuICAgIGZzLmNyZWF0ZVJlYWRTdHJlYW0oY2FjaGVkUmVzUGF0aCkucGlwZShyZXMuc29ja2V0KTtcbiAgfTtcblxuICBpZiAocmVzcG9uc2UpIHtcbiAgICBsb2cuaW5mbyhgVGhlIHNhbWUgcmVxdWVzdCB3aXRoIHRoZSBpZGVtcG90ZW5jeSBrZXkgJyR7a2V5fScgaGFzIGJlZW4gYWxyZWFkeSBwcm9jZXNzZWRgKTtcbiAgICBsb2cuaW5mbyhgUmVyb3V0aW5nIGl0cyByZXNwb25zZSB0byB0aGUgY3VycmVudCByZXF1ZXN0YCk7XG4gICAgYXdhaXQgcmVyb3V0ZUNhY2hlZFJlc3BvbnNlKHJlc3BvbnNlKTtcbiAgfSBlbHNlIHtcbiAgICBsb2cuaW5mbyhgVGhlIHNhbWUgcmVxdWVzdCB3aXRoIHRoZSBpZGVtcG90ZW5jeSBrZXkgJyR7a2V5fScgaXMgYmVpbmcgcHJvY2Vzc2VkYCk7XG4gICAgbG9nLmluZm8oYFdhaXRpbmcgZm9yIHRoZSByZXNwb25zZSB0byBiZSByZXJvdXRlZCB0byB0aGUgY3VycmVudCByZXF1ZXN0YCk7XG4gICAgcmVzcG9uc2VTdGF0ZUxpc3RlbmVyLm9uY2UoJ2Vycm9yJywgKCkgPT4gbmV4dCgpKTtcbiAgICByZXNwb25zZVN0YXRlTGlzdGVuZXIub25jZSgncmVhZHknLCByZXJvdXRlQ2FjaGVkUmVzcG9uc2UpO1xuICB9XG59XG5cbmV4cG9ydCB7IGhhbmRsZUlkZW1wb3RlbmN5IH07XG4iXSwiZmlsZSI6ImxpYi9leHByZXNzL2lkZW1wb3RlbmN5LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
