"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.server = server;
exports.configureServer = configureServer;
exports.normalizeBasePath = normalizeBasePath;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _express = _interopRequireDefault(require("express"));

var _http = _interopRequireDefault(require("http"));

var _serveFavicon = _interopRequireDefault(require("serve-favicon"));

var _bodyParser = _interopRequireDefault(require("body-parser"));

var _methodOverride = _interopRequireDefault(require("method-override"));

var _logger = _interopRequireDefault(require("./logger"));

var _expressLogging = require("./express-logging");

var _middleware = require("./middleware");

var _static = require("./static");

var _crash = require("./crash");

var _websocket = require("./websocket");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _protocol = require("../protocol");

const KEEP_ALIVE_TIMEOUT_MS = 60 * 10 * 1000;

async function server(opts = {}) {
  const {
    routeConfiguringFunction,
    port,
    hostname = null,
    allowCors = true,
    basePath = _protocol.DEFAULT_BASE_PATH
  } = opts;
  const app = (0, _express.default)();

  let httpServer = _http.default.createServer(app);

  httpServer.addWebSocketHandler = _websocket.addWebSocketHandler;
  httpServer.removeWebSocketHandler = _websocket.removeWebSocketHandler;
  httpServer.removeAllWebSocketHandlers = _websocket.removeAllWebSocketHandlers;
  httpServer.getWebSocketHandlers = _websocket.getWebSocketHandlers;
  const close = httpServer.close.bind(httpServer);

  httpServer.close = async () => await new _bluebird.default((resolve, reject) => {
    httpServer.on('close', resolve);
    close(err => {
      if (err) reject(err);
    });
  });

  return await new _bluebird.default((resolve, reject) => {
    httpServer.on('error', err => {
      if (err.code === 'EADDRNOTAVAIL') {
        _logger.default.error('Could not start REST http interface listener. ' + 'Requested address is not available.');
      } else {
        _logger.default.error('Could not start REST http interface listener. The requested ' + 'port may already be in use. Please make sure there is no ' + 'other instance of this server running already.');
      }

      reject(err);
    });
    httpServer.on('connection', socket => {
      socket.setTimeout(KEEP_ALIVE_TIMEOUT_MS);
      socket.on('error', reject);
    });
    configureServer(app, routeConfiguringFunction, allowCors, basePath);
    let serverArgs = [port];

    if (hostname) {
      serverArgs.push(hostname);
    }

    httpServer.listen(...serverArgs, err => {
      if (err) {
        reject(err);
      }

      resolve(httpServer);
    });
    httpServer.keepAliveTimeout = KEEP_ALIVE_TIMEOUT_MS;
    httpServer.headersTimeout = KEEP_ALIVE_TIMEOUT_MS + 5 * 1000;
  });
}

function normalizeBasePath(basePath) {
  if (!_lodash.default.isString(basePath)) {
    throw new Error(`Invalid path prefix ${basePath}`);
  }

  basePath = basePath.replace(/\/$/, '');

  if (basePath !== '' && basePath[0] !== '/') {
    basePath = `/${basePath}`;
  }

  return basePath;
}

function configureServer(app, routeConfiguringFunction, allowCors = true, basePath = _protocol.DEFAULT_BASE_PATH) {
  basePath = normalizeBasePath(basePath);
  app.use(_expressLogging.endLogFormatter);
  app.use((0, _serveFavicon.default)(_path.default.resolve(_static.STATIC_DIR, 'favicon.ico')));
  app.use(_express.default.static(_static.STATIC_DIR));
  app.use(`${basePath}/produce_error`, _crash.produceError);
  app.use(`${basePath}/crash`, _crash.produceCrash);

  if (allowCors) {
    app.use(_middleware.allowCrossDomain);
  } else {
    app.use((0, _middleware.allowCrossDomainAsyncExecute)(basePath));
  }

  app.use(_middleware.handleIdempotency);
  app.use((0, _middleware.fixPythonContentType)(basePath));
  app.use(_middleware.defaultToJSONContentType);
  app.use(_bodyParser.default.urlencoded({
    extended: true
  }));
  app.use((0, _methodOverride.default)());
  app.use(_middleware.catch4XXHandler);
  app.use(_middleware.catchAllHandler);
  app.use(_bodyParser.default.json({
    limit: '1gb'
  }));
  app.use(_expressLogging.startLogFormatter);
  routeConfiguringFunction(app, basePath);
  app.all('/welcome', _static.welcome);
  app.all('/test/guinea-pig', _static.guineaPig);
  app.all('/test/guinea-pig-scrollable', _static.guineaPigScrollable);
  app.all('/test/guinea-pig-app-banner', _static.guineaPigAppBanner);
  app.use(_middleware.catch404Handler);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9leHByZXNzL3NlcnZlci5qcyJdLCJuYW1lcyI6WyJLRUVQX0FMSVZFX1RJTUVPVVRfTVMiLCJzZXJ2ZXIiLCJvcHRzIiwicm91dGVDb25maWd1cmluZ0Z1bmN0aW9uIiwicG9ydCIsImhvc3RuYW1lIiwiYWxsb3dDb3JzIiwiYmFzZVBhdGgiLCJERUZBVUxUX0JBU0VfUEFUSCIsImFwcCIsImh0dHBTZXJ2ZXIiLCJodHRwIiwiY3JlYXRlU2VydmVyIiwiYWRkV2ViU29ja2V0SGFuZGxlciIsInJlbW92ZVdlYlNvY2tldEhhbmRsZXIiLCJyZW1vdmVBbGxXZWJTb2NrZXRIYW5kbGVycyIsImdldFdlYlNvY2tldEhhbmRsZXJzIiwiY2xvc2UiLCJiaW5kIiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJvbiIsImVyciIsImNvZGUiLCJsb2ciLCJlcnJvciIsInNvY2tldCIsInNldFRpbWVvdXQiLCJjb25maWd1cmVTZXJ2ZXIiLCJzZXJ2ZXJBcmdzIiwicHVzaCIsImxpc3RlbiIsImtlZXBBbGl2ZVRpbWVvdXQiLCJoZWFkZXJzVGltZW91dCIsIm5vcm1hbGl6ZUJhc2VQYXRoIiwiXyIsImlzU3RyaW5nIiwiRXJyb3IiLCJyZXBsYWNlIiwidXNlIiwiZW5kTG9nRm9ybWF0dGVyIiwicGF0aCIsIlNUQVRJQ19ESVIiLCJleHByZXNzIiwic3RhdGljIiwicHJvZHVjZUVycm9yIiwicHJvZHVjZUNyYXNoIiwiYWxsb3dDcm9zc0RvbWFpbiIsImhhbmRsZUlkZW1wb3RlbmN5IiwiZGVmYXVsdFRvSlNPTkNvbnRlbnRUeXBlIiwiYm9keVBhcnNlciIsInVybGVuY29kZWQiLCJleHRlbmRlZCIsImNhdGNoNFhYSGFuZGxlciIsImNhdGNoQWxsSGFuZGxlciIsImpzb24iLCJsaW1pdCIsInN0YXJ0TG9nRm9ybWF0dGVyIiwiYWxsIiwid2VsY29tZSIsImd1aW5lYVBpZyIsImd1aW5lYVBpZ1Njcm9sbGFibGUiLCJndWluZWFQaWdBcHBCYW5uZXIiLCJjYXRjaDQw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Q0ksMEJBQXZDO0FBR0F0RCxFQUFBQSxHQUFHLENBQUMrQixHQUFKLENBQVF3QiwyQkFBUjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgaHR0cCBmcm9tICdodHRwJztcbmltcG9ydCBmYXZpY29uIGZyb20gJ3NlcnZlLWZhdmljb24nO1xuaW1wb3J0IGJvZHlQYXJzZXIgZnJvbSAnYm9keS1wYXJzZXInO1xuaW1wb3J0IG1ldGhvZE92ZXJyaWRlIGZyb20gJ21ldGhvZC1vdmVycmlkZSc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IHN0YXJ0TG9nRm9ybWF0dGVyLCBlbmRMb2dGb3JtYXR0ZXIgfSBmcm9tICcuL2V4cHJlc3MtbG9nZ2luZyc7XG5pbXBvcnQge1xuICBhbGxvd0Nyb3NzRG9tYWluLCBmaXhQeXRob25Db250ZW50VHlwZSwgZGVmYXVsdFRvSlNPTkNvbnRlbnRUeXBlLFxuICBjYXRjaEFsbEhhbmRsZXIsIGNhdGNoNDA0SGFuZGxlciwgY2F0Y2g0WFhIYW5kbGVyLFxuICBhbGxvd0Nyb3NzRG9tYWluQXN5bmNFeGVjdXRlLCBoYW5kbGVJZGVtcG90ZW5jeSxcbn0gZnJvbSAnLi9taWRkbGV3YXJlJztcbmltcG9ydCB7IGd1aW5lYVBpZywgZ3VpbmVhUGlnU2Nyb2xsYWJsZSwgZ3VpbmVhUGlnQXBwQmFubmVyLCB3ZWxjb21lLCBTVEFUSUNfRElSIH0gZnJvbSAnLi9zdGF0aWMnO1xuaW1wb3J0IHsgcHJvZHVjZUVycm9yLCBwcm9kdWNlQ3Jhc2ggfSBmcm9tICcuL2NyYXNoJztcbmltcG9ydCB7XG4gIGFkZFdlYlNvY2tldEhhbmRsZXIsIHJlbW92ZVdlYlNvY2tldEhhbmRsZXIsIHJlbW92ZUFsbFdlYlNvY2tldEhhbmRsZXJzLFxuICBnZXRXZWJTb2NrZXRIYW5kbGVyc1xufSBmcm9tICcuL3dlYnNvY2tldCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBERUZBVUxUX0JBU0VfUEFUSCB9IGZyb20gJy4uL3Byb3RvY29sJztcblxuXG5jb25zdCBLRUVQX0FMSVZFX1RJTUVPVVRfTVMgPSA2MCAqIDEwICogMTAwMDsgLy8gMTAgbWludXRlc1xuXG5cbmFzeW5jIGZ1bmN0aW9uIHNlcnZlciAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24sXG4gICAgcG9ydCxcbiAgICBob3N0bmFtZSA9IG51bGwsXG4gICAgYWxsb3dDb3JzID0gdHJ1ZSxcbiAgICBiYXNlUGF0aCA9IERFRkFVTFRfQkFTRV9QQVRILFxuICB9ID0gb3B0cztcblxuICAvLyBjcmVhdGUgdGhlIGFjdHVhbCBodHRwIHNlcnZlclxuICBjb25zdCBhcHAgPSBleHByZXNzKCk7XG4gIGxldCBodHRwU2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoYXBwKTtcbiAgaHR0cFNlcnZlci5hZGRXZWJTb2NrZXRIYW5kbGVyID0gYWRkV2ViU29ja2V0SGFuZGxlcjtcbiAgaHR0cFNlcnZlci5yZW1vdmVXZWJTb2NrZXRIYW5kbGVyID0gcmVtb3ZlV2ViU29ja2V0SGFuZGxlcjtcbiAgaHR0cFNlcnZlci5yZW1vdmVBbGxXZWJTb2NrZXRIYW5kbGVycyA9IHJlbW92ZUFsbFdlYlNvY2tldEhhbmRsZXJzO1xuICBodHRwU2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzID0gZ2V0V2ViU29ja2V0SGFuZGxlcnM7XG5cbiAgLy8gaHR0cC5TZXJ2ZXIuY2xvc2UoKSBvbmx5IHN0b3BzIG5ldyBjb25uZWN0aW9ucywgYnV0IHdlIG5lZWQgdG8gd2FpdCB1bnRpbFxuICAvLyBhbGwgY29ubmVjdGlvbnMgYXJlIGNsb3NlZCBhbmQgdGhlIGBjbG9zZWAgZXZlbnQgaXMgZW1pdHRlZFxuICBjb25zdCBjbG9zZSA9IGh0dHBTZXJ2ZXIuY2xvc2UuYmluZChodHRwU2VydmVyKTtcbiAgaHR0cFNlcnZlci5jbG9zZSA9IGFzeW5jICgpID0+IGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBodHRwU2VydmVyLm9uKCdjbG9zZScsIHJlc29sdmUpO1xuICAgIGNsb3NlKChlcnIpID0+IHtcbiAgICAgIGlmIChlcnIpIHJlamVjdChlcnIpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG4gICAgfSk7XG4gIH0pO1xuXG4gIHJldHVybiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgaHR0cFNlcnZlci5vbignZXJyb3InLCAoZXJyKSA9PiB7XG4gICAgICBpZiAoZXJyLmNvZGUgPT09ICdFQUREUk5PVEFWQUlMJykge1xuICAgICAgICBsb2cuZXJyb3IoJ0NvdWxkIG5vdCBzdGFydCBSRVNUIGh0dHAgaW50ZXJmYWNlIGxpc3RlbmVyLiAnICtcbiAgICAgICAgICAgICAgICAgICdSZXF1ZXN0ZWQgYWRkcmVzcyBpcyBub3QgYXZhaWxhYmxlLicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmVycm9yKCdDb3VsZCBub3Qgc3RhcnQgUkVTVCBodHRwIGludGVyZmFjZSBsaXN0ZW5lci4gVGhlIHJlcXVlc3RlZCAnICtcbiAgICAgICAgICAgICAgICAgICdwb3J0IG1heSBhbHJlYWR5IGJlIGluIHVzZS4gUGxlYXNlIG1ha2Ugc3VyZSB0aGVyZSBpcyBubyAnICtcbiAgICAgICAgICAgICAgICAgICdvdGhlciBpbnN0YW5jZSBvZiB0aGlzIHNlcnZlciBydW5uaW5nIGFscmVhZHkuJyk7XG4gICAgICB9XG4gICAgICByZWplY3QoZXJyKTtcbiAgICB9KTtcbiAgICBodHRwU2VydmVyLm9uKCdjb25uZWN0aW9uJywgKHNvY2tldCkgPT4ge1xuICAgICAgc29ja2V0LnNldFRpbWVvdXQoS0VFUF9BTElWRV9USU1FT1VUX01TKTtcbiAgICAgIHNvY2tldC5vbignZXJyb3InLCByZWplY3QpO1xuICAgIH0pO1xuICAgIGNvbmZpZ3VyZVNlcnZlcihhcHAsIHJvdXRlQ29uZmlndXJpbmdGdW5jdGlvbiwgYWxsb3dDb3JzLCBiYXNlUGF0aCk7XG5cbiAgICBsZXQgc2VydmVyQXJncyA9IFtwb3J0XTtcbiAgICBpZiAoaG9zdG5hbWUpIHtcbiAgICAgIC8vIElmIHRoZSBob3N0bmFtZSBpcyBvbWl0dGVkLCB0aGUgc2VydmVyIHdpbGwgYWNjZXB0XG4gICAgICAvLyBjb25uZWN0aW9ucyBvbiBhbnkgSVAgYWRkcmVzc1xuICAgICAgc2VydmVyQXJncy5wdXNoKGhvc3RuYW1lKTtcbiAgICB9XG4gICAgaHR0cFNlcnZlci5saXN0ZW4oLi4uc2VydmVyQXJncywgKGVycikgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICAgIHJlc29sdmUoaHR0cFNlcnZlcik7XG4gICAgfSk7XG4gICAgaHR0cFNlcnZlci5rZWVwQWxpdmVUaW1lb3V0ID0gS0VFUF9BTElWRV9USU1FT1VUX01TO1xuICAgIC8vIGhlYWRlcnMgdGltZW91dCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBrZWVwQWxpdmVUaW1lb3V0XG4gICAgaHR0cFNlcnZlci5oZWFkZXJzVGltZW91dCA9IEtFRVBfQUxJVkVfVElNRU9VVF9NUyArIDUgKiAxMDAwO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gbm9ybWFsaXplQmFzZVBhdGggKGJhc2VQYXRoKSB7XG4gIGlmICghXy5pc1N0cmluZyhiYXNlUGF0aCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcGF0aCBwcmVmaXggJHtiYXNlUGF0aH1gKTtcbiAgfVxuXG4gIC8vIGVuc3VyZSB0aGUgcGF0aCBwcmVmaXggZG9lcyBub3QgZW5kIGluICcvJywgc2luY2Ugb3VyIG1ldGhvZCBtYXBcbiAgLy8gc3RhcnRzIGFsbCBwYXRocyB3aXRoICcvJ1xuICBiYXNlUGF0aCA9IGJhc2VQYXRoLnJlcGxhY2UoL1xcLyQvLCAnJyk7XG5cbiAgLy8gbGlrZXdpc2UsIGVuc3VyZSB0aGUgcGF0aCBwcmVmaXggZG9lcyBhbHdheXMgU1RBUlQgd2l0aCAvLCB1bmxlc3MgdGhlIHBhdGhcbiAgLy8gaXMgZW1wdHkgbWVhbmluZyBubyBiYXNlIHBhdGggYXQgYWxsXG4gIGlmIChiYXNlUGF0aCAhPT0gJycgJiYgYmFzZVBhdGhbMF0gIT09ICcvJykge1xuICAgIGJhc2VQYXRoID0gYC8ke2Jhc2VQYXRofWA7XG4gIH1cblxuICByZXR1cm4gYmFzZVBhdGg7XG59XG5cbmZ1bmN0aW9uIGNvbmZpZ3VyZVNlcnZlciAoYXBwLCByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24sIGFsbG93Q29ycyA9IHRydWUsIGJhc2VQYXRoID0gREVGQVVMVF9CQVNFX1BBVEgpIHtcbiAgYmFzZVBhdGggPSBub3JtYWxpemVCYXNlUGF0aChiYXNlUGF0aCk7XG5cbiAgYXBwLnVzZShlbmRMb2dGb3JtYXR0ZXIpO1xuXG4gIC8vIHNldCB1cCBzdGF0aWMgYXNzZXRzXG4gIGFwcC51c2UoZmF2aWNvbihwYXRoLnJlc29sdmUoU1RBVElDX0RJUiwgJ2Zhdmljb24uaWNvJykpKTtcbiAgYXBwLnVzZShleHByZXNzLnN0YXRpYyhTVEFUSUNfRElSKSk7XG5cbiAgLy8gY3Jhc2ggcm91dGVzLCBmb3IgdGVzdGluZ1xuICBhcHAudXNlKGAke2Jhc2VQYXRofS9wcm9kdWNlX2Vycm9yYCwgcHJvZHVjZUVycm9yKTtcbiAgYXBwLnVzZShgJHtiYXNlUGF0aH0vY3Jhc2hgLCBwcm9kdWNlQ3Jhc2gpO1xuXG4gIC8vIGFkZCBtaWRkbGV3YXJlc1xuICBpZiAoYWxsb3dDb3JzKSB7XG4gICAgYXBwLnVzZShhbGxvd0Nyb3NzRG9tYWluKTtcbiAgfSBlbHNlIHtcbiAgICBhcHAudXNlKGFsbG93Q3Jvc3NEb21haW5Bc3luY0V4ZWN1dGUoYmFzZVBhdGgpKTtcbiAgfVxuICBhcHAudXNlKGhhbmRsZUlkZW1wb3RlbmN5KTtcbiAgYXBwLnVzZShmaXhQeXRob25Db250ZW50VHlwZShiYXNlUGF0aCkpO1xuICBhcHAudXNlKGRlZmF1bHRUb0pTT05Db250ZW50VHlwZSk7XG4gIGFwcC51c2UoYm9keVBhcnNlci51cmxlbmNvZGVkKHtleHRlbmRlZDogdHJ1ZX0pKTtcbiAgYXBwLnVzZShtZXRob2RPdmVycmlkZSgpKTtcbiAgYXBwLnVzZShjYXRjaDRYWEhhbmRsZXIpO1xuICBhcHAudXNlKGNhdGNoQWxsSGFuZGxlcik7XG5cbiAgLy8gbWFrZSBzdXJlIGFwcGl1bSBuZXZlciBmYWlscyBiZWNhdXNlIG9mIGEgZmlsZSBzaXplIHVwbG9hZCBsaW1pdFxuICBhcHAudXNlKGJvZHlQYXJzZXIuanNvbih7bGltaXQ6ICcxZ2InfSkpO1xuXG4gIC8vIHNldCB1cCBzdGFydCBsb2dnaW5nICh3aGljaCBkZXBlbmRzIG9uIGJvZHlQYXJzZXIgZG9pbmcgaXRzIHRoaW5nKVxuICBhcHAudXNlKHN0YXJ0TG9nRm9ybWF0dGVyKTtcblxuICByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24oYXBwLCBiYXNlUGF0aCk7XG5cbiAgLy8gZHluYW1pYyByb3V0ZXMgZm9yIHRlc3RpbmcsIGV0Yy5cbiAgYXBwLmFsbCgnL3dlbGNvbWUnLCB3ZWxjb21lKTtcbiAgYXBwLmFsbCgnL3Rlc3QvZ3VpbmVhLXBpZycsIGd1aW5lYVBpZyk7XG4gIGFwcC5hbGwoJy90ZXN0L2d1aW5lYS1waWctc2Nyb2xsYWJsZScsIGd1aW5lYVBpZ1Njcm9sbGFibGUpO1xuICBhcHAuYWxsKCcvdGVzdC9ndWluZWEtcGlnLWFwcC1iYW5uZXInLCBndWluZWFQaWdBcHBCYW5uZXIpO1xuXG4gIC8vIGNhdGNoIHRoaXMgbGFzdCwgc28gYW55dGhpbmcgdGhhdCBmYWxscyB0aHJvdWdoIGlzIDQwNGVkXG4gIGFwcC51c2UoY2F0Y2g0MDRIYW5kbGVyKTtcbn1cblxuZXhwb3J0IHsgc2VydmVyLCBjb25maWd1cmVTZXJ2ZXIsIG5vcm1hbGl6ZUJhc2VQYXRoIH07XG4iXSwiZmlsZSI6ImxpYi9leHByZXNzL3NlcnZlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
