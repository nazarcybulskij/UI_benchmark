"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.fs = void 0;

require("source-map-support/register");

var _fs2 = _interopRequireDefault(require("fs"));

var _rimraf = _interopRequireDefault(require("rimraf"));

var _md5File = _interopRequireDefault(require("md5-file"));

var _ncp = _interopRequireDefault(require("ncp"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _mv = _interopRequireDefault(require("mv"));

var _which = _interopRequireDefault(require("which"));

var _glob = _interopRequireDefault(require("glob"));

var _crypto = _interopRequireDefault(require("crypto"));

var _klaw = _interopRequireDefault(require("klaw"));

var _sanitizeFilename = _interopRequireDefault(require("sanitize-filename"));

var _util = require("./util");

var _logger = _interopRequireDefault(require("./logger"));

var _timing = _interopRequireDefault(require("./timing"));

const md5 = _bluebird.default.promisify(_md5File.default);

let fs = {
  async hasAccess(path) {
    try {
      await this.access(path, _fs2.default.R_OK);
    } catch (err) {
      return false;
    }

    return true;
  },

  exists(path) {
    return this.hasAccess(path);
  },

  rimraf: _bluebird.default.promisify(_rimraf.default),
  rimrafSync: _rimraf.default.sync.bind(_rimraf.default),

  async mkdir(dirName) {
    let _mkdir = _bluebird.default.promisify(_fs2.default.mkdir);

    try {
      await _mkdir(dirName);
    } catch (err) {
      if (err && err.code !== 'EEXIST') {
        throw err;
      }
    }
  },

  async copyFile(source, destination, ...otherArgs) {
    if (!(await this.hasAccess(source))) {
      throw new Error(`The file at '${source}' does not exist or is not accessible`);
    }

    return await _bluebird.default.promisify(_ncp.default)(source, destination, ...otherArgs);
  },

  async md5(filePath) {
    return await md5(filePath);
  },

  mv: _bluebird.default.promisify(_mv.default),
  which: _bluebird.default.promisify(_which.default),
  glob: _bluebird.default.promisify(_glob.default),
  sanitizeName: _sanitizeFilename.default,

  async hash(filePath, algorithm = 'sha1') {
    return await new _bluebird.default((resolve, reject) => {
      const fileHash = _crypto.default.createHash(algorithm);

      const readStream = _fs2.default.createReadStream(filePath);

      readStream.on('error', e => reject(new Error(`Cannot calculate ${algorithm} hash for '${filePath}'. Original error: ${e.message}`)));
      readStream.on('data', chunk => fileHash.update(chunk));
      readStream.on('end', () => resolve(fileHash.digest('hex')));
    });
  },

  async walkDir(dir, recursive, callback) {
    let isValidRoot = false;
    let errMsg = null;

    try {
      isValidRoot = (await fs.stat(dir)).isDirectory();
    } catch (e) {
      errMsg = e.message;
    }

    if (!isValidRoot) {
      throw Error(`'${dir}' is not a valid root directory` + (errMsg ? `. Original error: ${errMsg}` : ''));
    }

    let walker;
    let fileCount = 0;
    let directoryCount = 0;
    const timer = new _timing.default().start();
    return await new _bluebird.default(function (resolve, reject) {
      let lastFileProcessed = _bluebird.default.resolve();

      walker = (0, _klaw.default)(dir, {
        depthLimit: recursive ? -1 : 0
      });
      walker.on('data', function (item) {
        walker.pause();

        if (!item.stats.isDirectory()) {
          fileCount++;
        } else {
          directoryCount++;
        }

        lastFileProcessed = _bluebird.default.try(async () => await callback(item.path, item.stats.isDirectory())).then(function (done = false) {
          if (done) {
            resolve(item.path);
          } else {
            walker.resume();
          }
        }).catch(reject);
      }).on('error', function (err, item) {
        _logger.default.warn(`Got an error while walking '${item.path}': ${err.message}`);

        if (err.code === 'ENOENT') {
          _logger.default.warn('All files may not have been accessed');

          reject(err);
        }
      }).on('end', function () {
        lastFileProcessed.then(resolve).catch(function (err) {
          _logger.default.warn(`Unexpected error: ${err.message}`);

          reject(err);
        });
      });
    }).finally(function () {
      _logger.default.debug(`Traversed ${(0, _util.pluralize)('directory', directoryCount, true)} ` + `and ${(0, _util.pluralize)('file', fileCount, true)} ` + `in ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);

      if (walker) {
        walker.destroy();
      }
    });
  }

};
exports.fs = fs;
const simples = ['open', 'close', 'access', 'readFile', 'writeFile', 'write', 'read', 'readlink', 'chmod', 'unlink', 'readdir', 'stat', 'rename', 'lstat'];

for (const s of simples) {
  fs[s] = _bluebird.default.promisify(_fs2.default[s]);
}

const syncFunctions = ['createReadStream', 'createWriteStream'];

for (const s of syncFunctions) {
  fs[s] = _fs2.default[s];
}

const constants = ['F_OK', 'R_OK', 'W_OK', 'X_OK', 'constants'];

for (const c of constants) {
  fs[c] = _fs2.default[c];
}

var _default = fs;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9mcy5qcyJdLCJuYW1lcyI6WyJtZDUiLCJCIiwicHJvbWlzaWZ5IiwibWQ1ZmlsZSIsImZzIiwiaGFzQWNjZXNzIiwicGF0aCIsImFjY2VzcyIsIl9mcyIsIlJfT0siLCJlcnIiLCJleGlzdHMiLCJyaW1yYWYiLCJyaW1yYWZTeW5jIiwic3luYyIsImJpbmQiLCJta2RpciIsImRpck5hbWUiLCJfbWtkaXIiLCJjb2RlIiwiY29weUZpbGUiLCJzb3VyY2UiLCJkZXN0aW5hdGlvbiIsIm90aGVyQXJncyIsIkVycm9yIiwibmNwIiwiZmlsZVBhdGgiLCJtdiIsIndoaWNoIiwiZ2xvYiIsInNhbml0aXplTmFtZSIsInNhbml0aXplIiwiaGFzaCIsImFsZ29yaXRobSIsInJlc29sdmUiLCJyZWplY3QiLCJmaWxlSGFzaCIsImNyeXB0byIsImNyZWF0ZUhhc2giLCJyZWFkU3RyZWFtIiwiY3JlYXRlUmVhZFN0cmVhbSIsIm9uIiwiZSIsIm1lc3NhZ2UiLCJjaHVuayIsInVwZGF0ZSIsImRpZ2VzdCIsIndhbGtEaXIiLCJkaXIiLCJyZWN1cnNpdmUiLCJjYWxsYmFjayIsImlzVmFsaWRSb290IiwiZXJyTXNnIiwic3RhdCIsImlzRGlyZWN0b3J5Iiwid2Fsa2VyIiwiZmlsZUNvdW50IiwiZGlyZWN0b3J5Q291bnQiLCJ0aW1lciIsIlRpbWVyIiwic3RhcnQiLCJsYXN0RmlsZVByb2Nlc3NlZCIsImRlcHRoTGltaXQiLCJpdGVtIiwicGF1c2UiLCJzdGF0cyIsInRyeSIsInRoZW4iLCJkb25lIiwicmVzdW1lIiwiY2F0Y2giLCJsb2ciLCJ3YXJuIiwiZmluYWxseSIsImRlYnVnIiwiZ2V0RHVyYXRpb24iLCJhc01pbGxpU2Vjb25kcyIsInRvRml4ZWQiLCJkZXN0cm95Iiwic2ltcGxlcyIsInMiLCJzeW5jRnVuY3Rpb25zIiwiY29uc3RhbnRzIiwiYyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7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Q0FBQzRFLENBQUQsQ0FBRixHQUFReEUsYUFBSXdFLENBQUosQ0FBUjtBQUNEOztBQUdELE1BQU1FLFNBQVMsR0FBRyxDQUNoQixNQURnQixFQUNSLE1BRFEsRUFDQSxNQURBLEVBQ1EsTUFEUixFQUNnQixXQURoQixDQUFsQjs7QUFHQSxLQUFLLE1BQU1DLENBQVgsSUFBZ0JELFNBQWhCLEVBQTJCO0FBQ3pCOUUsRUFBQUEsRUFBRSxDQUFDK0UsQ0FBRCxDQUFGLEdBQVEzRSxhQUFJMkUsQ0FBSixDQUFSO0FBQ0Q7O2VBR2MvRSxFIiwic291cmNlc0NvbnRlbnQiOlsiLy8ganNoaW50IGlnbm9yZTogc3RhcnRcbmltcG9ydCBfZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHJpbXJhZiBmcm9tICdyaW1yYWYnO1xuaW1wb3J0IG1kNWZpbGUgZnJvbSAnbWQ1LWZpbGUnO1xuaW1wb3J0IG5jcCBmcm9tICduY3AnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IG12IGZyb20gJ212JztcbmltcG9ydCB3aGljaCBmcm9tICd3aGljaCc7XG5pbXBvcnQgZ2xvYiBmcm9tICdnbG9iJztcbmltcG9ydCBjcnlwdG8gZnJvbSAnY3J5cHRvJztcbmltcG9ydCBrbGF3IGZyb20gJ2tsYXcnO1xuaW1wb3J0IHNhbml0aXplIGZyb20gJ3Nhbml0aXplLWZpbGVuYW1lJztcbmltcG9ydCB7IHBsdXJhbGl6ZSB9IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBUaW1lciBmcm9tICcuL3RpbWluZyc7XG5cblxuY29uc3QgbWQ1ID0gQi5wcm9taXNpZnkobWQ1ZmlsZSk7XG5cbmxldCBmcyA9IHtcbiAgYXN5bmMgaGFzQWNjZXNzIChwYXRoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuYWNjZXNzKHBhdGgsIF9mcy5SX09LKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH0sXG4gIGV4aXN0cyAocGF0aCkgeyByZXR1cm4gdGhpcy5oYXNBY2Nlc3MocGF0aCk7IH0sXG4gIHJpbXJhZjogQi5wcm9taXNpZnkocmltcmFmKSxcbiAgcmltcmFmU3luYzogcmltcmFmLnN5bmMuYmluZChyaW1yYWYpLFxuICBhc3luYyBta2RpciAoZGlyTmFtZSkge1xuICAgIGxldCBfbWtkaXIgPSBCLnByb21pc2lmeShfZnMubWtkaXIpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBfbWtkaXIoZGlyTmFtZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyICYmIGVyci5jb2RlICE9PSAnRUVYSVNUJykge1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgfVxuICB9LFxuICBhc3luYyBjb3B5RmlsZSAoc291cmNlLCBkZXN0aW5hdGlvbiwgLi4ub3RoZXJBcmdzKSB7XG4gICAgaWYgKCFhd2FpdCB0aGlzLmhhc0FjY2Vzcyhzb3VyY2UpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBmaWxlIGF0ICcke3NvdXJjZX0nIGRvZXMgbm90IGV4aXN0IG9yIGlzIG5vdCBhY2Nlc3NpYmxlYCk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCAoQi5wcm9taXNpZnkobmNwKSkoc291cmNlLCBkZXN0aW5hdGlvbiwgLi4ub3RoZXJBcmdzKTtcbiAgfSxcbiAgYXN5bmMgbWQ1IChmaWxlUGF0aCkge1xuICAgIHJldHVybiBhd2FpdCBtZDUoZmlsZVBhdGgpO1xuICB9LFxuICBtdjogQi5wcm9taXNpZnkobXYpLFxuICB3aGljaDogQi5wcm9taXNpZnkod2hpY2gpLFxuICBnbG9iOiBCLnByb21pc2lmeShnbG9iKSxcbiAgc2FuaXRpemVOYW1lOiBzYW5pdGl6ZSxcbiAgYXN5bmMgaGFzaCAoZmlsZVBhdGgsIGFsZ29yaXRobSA9ICdzaGExJykge1xuICAgIHJldHVybiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBmaWxlSGFzaCA9IGNyeXB0by5jcmVhdGVIYXNoKGFsZ29yaXRobSk7XG4gICAgICBjb25zdCByZWFkU3RyZWFtID0gX2ZzLmNyZWF0ZVJlYWRTdHJlYW0oZmlsZVBhdGgpO1xuICAgICAgcmVhZFN0cmVhbS5vbignZXJyb3InLCAoZSkgPT4gcmVqZWN0KFxuICAgICAgICBuZXcgRXJyb3IoYENhbm5vdCBjYWxjdWxhdGUgJHthbGdvcml0aG19IGhhc2ggZm9yICcke2ZpbGVQYXRofScuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKSkpO1xuICAgICAgcmVhZFN0cmVhbS5vbignZGF0YScsIChjaHVuaykgPT4gZmlsZUhhc2gudXBkYXRlKGNodW5rKSk7XG4gICAgICByZWFkU3RyZWFtLm9uKCdlbmQnLCAoKSA9PiByZXNvbHZlKGZpbGVIYXNoLmRpZ2VzdCgnaGV4JykpKTtcbiAgICB9KTtcbiAgfSxcbiAgLyoqIFRoZSBjYWxsYmFjayBmdW5jdGlvbiB3aGljaCB3aWxsIGJlIGNhbGxlZCBkdXJpbmcgdGhlIGRpcmVjdG9yeSB3YWxraW5nXG4gICAqIEBuYW1lIFdhbGtEaXJDYWxsYmFja1xuICAgKiBAZnVuY3Rpb25cbiAgICogQHBhcmFtIHtzdHJpbmd9IGl0ZW1QYXRoIFRoZSBwYXRoIG9mIHRoZSBmaWxlIG9yIGZvbGRlclxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzRGlyZWN0b3J5IFNob3dzIGlmIGl0IGlzIGEgZGlyZWN0b3J5IG9yIGEgZmlsZVxuICAgKiBAcmV0dXJuIHtib29sZWFufSByZXR1cm4gdHJ1ZSBpZiB5b3Ugd2FudCB0byBzdG9wIHdhbGtpbmdcbiAgKi9cblxuICAvKipcbiAgICogV2Fsa3MgYSBkaXJlY3RvcnkgZ2l2ZW4gYWNjb3JkaW5nIHRvIHRoZSBwYXJhbWV0ZXJzIGdpdmVuLiBUaGUgY2FsbGJhY2sgd2lsbCBiZSBpbnZva2VkIHdpdGggYSBwYXRoIGpvaW5lZCB3aXRoIHRoZSBkaXIgcGFyYW1ldGVyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBkaXIgRGlyZWN0b3J5IHBhdGggd2hlcmUgd2Ugd2lsbCBzdGFydCB3YWxraW5nXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gcmVjdXJzaXZlIFNldCBpdCB0byB0cnVlIGlmIHlvdSB3YW50IHRvIGNvbnRpbnVlIHdhbGtpbmcgc3ViIGRpcmVjdG9yaWVzXG4gICAqIEBwYXJhbSB7V2Fsa0RpckNhbGxiYWNrfSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgdG8gYmUgY2FsbGVkIHdoZW4gYSBuZXcgcGF0aCBpcyBmb3VuZFxuICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIGBkaXJgIHBhcmFtZXRlciBjb250YWlucyBhIHBhdGggdG8gYW4gaW52YWxpZCBmb2xkZXJcbiAgICogQHJldHVybiB7P3N0cmluZ30gcmV0dXJucyB0aGUgZm91bmQgcGF0aCBvciBudWxsIGlmIHRoZSBpdGVtIHdhcyBub3QgZm91bmRcbiAgICovXG4gIGFzeW5jIHdhbGtEaXIgKGRpciwgcmVjdXJzaXZlLCBjYWxsYmFjaykgeyAvL2VzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzXG4gICAgbGV0IGlzVmFsaWRSb290ID0gZmFsc2U7XG4gICAgbGV0IGVyck1zZyA9IG51bGw7XG4gICAgdHJ5IHtcbiAgICAgIGlzVmFsaWRSb290ID0gKGF3YWl0IGZzLnN0YXQoZGlyKSkuaXNEaXJlY3RvcnkoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBlcnJNc2cgPSBlLm1lc3NhZ2U7XG4gICAgfVxuICAgIGlmICghaXNWYWxpZFJvb3QpIHtcbiAgICAgIHRocm93IEVycm9yKGAnJHtkaXJ9JyBpcyBub3QgYSB2YWxpZCByb290IGRpcmVjdG9yeWAgKyAoZXJyTXNnID8gYC4gT3JpZ2luYWwgZXJyb3I6ICR7ZXJyTXNnfWAgOiAnJykpO1xuICAgIH1cblxuICAgIGxldCB3YWxrZXI7XG4gICAgbGV0IGZpbGVDb3VudCA9IDA7XG4gICAgbGV0IGRpcmVjdG9yeUNvdW50ID0gMDtcbiAgICBjb25zdCB0aW1lciA9IG5ldyBUaW1lcigpLnN0YXJ0KCk7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgIGxldCBsYXN0RmlsZVByb2Nlc3NlZCA9IEIucmVzb2x2ZSgpO1xuICAgICAgd2Fsa2VyID0ga2xhdyhkaXIsIHtcbiAgICAgICAgZGVwdGhMaW1pdDogcmVjdXJzaXZlID8gLTEgOiAwLFxuICAgICAgfSk7XG4gICAgICB3YWxrZXIub24oJ2RhdGEnLCBmdW5jdGlvbiAoaXRlbSkge1xuICAgICAgICB3YWxrZXIucGF1c2UoKTtcblxuICAgICAgICBpZiAoIWl0ZW0uc3RhdHMuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgIGZpbGVDb3VudCsrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGRpcmVjdG9yeUNvdW50Kys7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzXG4gICAgICAgIGxhc3RGaWxlUHJvY2Vzc2VkID0gQi50cnkoYXN5bmMgKCkgPT4gYXdhaXQgY2FsbGJhY2soaXRlbS5wYXRoLCBpdGVtLnN0YXRzLmlzRGlyZWN0b3J5KCkpKVxuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChkb25lID0gZmFsc2UpIHtcbiAgICAgICAgICAgIGlmIChkb25lKSB7XG4gICAgICAgICAgICAgIHJlc29sdmUoaXRlbS5wYXRoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHdhbGtlci5yZXN1bWUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICAgIC5jYXRjaChyZWplY3QpO1xuICAgICAgfSlcbiAgICAgIC5vbignZXJyb3InLCBmdW5jdGlvbiAoZXJyLCBpdGVtKSB7XG4gICAgICAgIGxvZy53YXJuKGBHb3QgYW4gZXJyb3Igd2hpbGUgd2Fsa2luZyAnJHtpdGVtLnBhdGh9JzogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgICAgLy8ga2xhdyBjYW5ub3QgZ2V0IGJhY2sgZnJvbSBhbiBFTk9FTlQgZXJyb3JcbiAgICAgICAgaWYgKGVyci5jb2RlID09PSAnRU5PRU5UJykge1xuICAgICAgICAgIGxvZy53YXJuKCdBbGwgZmlsZXMgbWF5IG5vdCBoYXZlIGJlZW4gYWNjZXNzZWQnKTtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC5vbignZW5kJywgZnVuY3Rpb24gKCkge1xuICAgICAgICBsYXN0RmlsZVByb2Nlc3NlZFxuICAgICAgICAgIC50aGVuKHJlc29sdmUpXG4gICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgIGxvZy53YXJuKGBVbmV4cGVjdGVkIGVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KS5maW5hbGx5KGZ1bmN0aW9uICgpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgVHJhdmVyc2VkICR7cGx1cmFsaXplKCdkaXJlY3RvcnknLCBkaXJlY3RvcnlDb3VudCwgdHJ1ZSl9IGAgK1xuICAgICAgICBgYW5kICR7cGx1cmFsaXplKCdmaWxlJywgZmlsZUNvdW50LCB0cnVlKX0gYCArXG4gICAgICAgIGBpbiAke3RpbWVyLmdldER1cmF0aW9uKCkuYXNNaWxsaVNlY29uZHMudG9GaXhlZCgwKX1tc2ApO1xuICAgICAgaWYgKHdhbGtlcikge1xuICAgICAgICB3YWxrZXIuZGVzdHJveSgpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG59O1xuXG4vLyBhZGQgdGhlIHN1cHBvcnRlZCBgZnNgIGZ1bmN0aW9uc1xuY29uc3Qgc2ltcGxlcyA9IFtcbiAgJ29wZW4nLCAnY2xvc2UnLCAnYWNjZXNzJywgJ3JlYWRGaWxlJywgJ3dyaXRlRmlsZScsICd3cml0ZScsICdyZWFkJyxcbiAgJ3JlYWRsaW5rJywgJ2NobW9kJywgJ3VubGluaycsICdyZWFkZGlyJywgJ3N0YXQnLCAncmVuYW1lJywgJ2xzdGF0Jyxcbl07XG5mb3IgKGNvbnN0IHMgb2Ygc2ltcGxlcykge1xuICBmc1tzXSA9IEIucHJvbWlzaWZ5KF9mc1tzXSk7XG59XG5cbmNvbnN0IHN5bmNGdW5jdGlvbnMgPSBbXG4gICdjcmVhdGVSZWFkU3RyZWFtJyxcbiAgJ2NyZWF0ZVdyaXRlU3RyZWFtJyxcbl07XG5mb3IgKGNvbnN0IHMgb2Ygc3luY0Z1bmN0aW9ucykge1xuICBmc1tzXSA9IF9mc1tzXTtcbn1cblxuLy8gYWRkIHRoZSBjb25zdGFudHMgZnJvbSBgZnNgXG5jb25zdCBjb25zdGFudHMgPSBbXG4gICdGX09LJywgJ1JfT0snLCAnV19PSycsICdYX09LJywgJ2NvbnN0YW50cycsXG5dO1xuZm9yIChjb25zdCBjIG9mIGNvbnN0YW50cykge1xuICBmc1tjXSA9IF9mc1tjXTtcbn1cblxuZXhwb3J0IHsgZnMgfTtcbmV4cG9ydCBkZWZhdWx0IGZzO1xuIl0sImZpbGUiOiJsaWIvZnMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
